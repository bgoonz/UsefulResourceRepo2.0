<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<link rel="stylesheet" href="./prism.css">
<script async defer src="./prism.js"></script>
</head>
<body>;
<h1 id="week-10-relational-databases" data-ignore="true">WEEK 10<br><em>Relational Databases</em></h1>
<hr />
<!-- code_chunk_output -->
<p><a href="#make-it-pretty-learning-objectives"><strong>Make It Pretty Learning Objectives</strong></a> - <a href="#make-it-pretty-practice"><strong>Make It Pretty Practice</strong></a> - <a href="#what-recruiters-are-looking-for">What Recruiters Are Looking For</a> - <a href="#attributes-of-great-looking-websites">Attributes of Great Looking Websites</a> - <a href="#additional-requirements">Additional requirements</a> - <a href="#avoid-these-things">Avoid these things</a> - <a href="#exercise">Exercise</a></p>
<p><a href="#rdbms-and-database-entity-learning-objectives"><strong>RDBMS And Database Entity Learning Objectives</strong></a> - <a href="#database-lingobrthe-relational-database-management-system"><strong>Database Lingo: Relational Database Management System</strong></a> - <a href="#rdbms">RDBMS</a> - <a href="#what-is-postgresql">What is PostgreSQL?</a> - <a href="#what-is-sql">What is SQL?</a> - <a href="#installing-postgresql-12-and-postbird-on-windows"><strong>Installing PostgreSQL 12 and Postbird on Windows</strong></a> - <a href="#installing-postgresql-12-and-postbird-on-macos"><strong>Installing PostgreSQL 12 and Postbird on macOS</strong></a> - <a href="#user-management-walk-through"><strong>User Management Walk-Through</strong></a> - <a href="#naming-a-user">Naming a user</a> - <a href="#creating-a-superuser">Creating a superuser</a> - <a href="#creating-a-limited-user">Creating a limited user</a> - <a href="#removing-a-user">Removing a user</a> - <a href="#case-sensitivity">Case sensitivity</a> - <a href="#database-management-walk-through"><strong>Database Management Walk-Through</strong></a> - <a href="#naming-a-database">Naming a database</a> - <a href="#creating-a-database-for-your-user">Creating a database for your user</a> - <a href="#creating-other-users-and-databases">Creating other users and databases</a> - <a href="#applying-security-to-databases">Applying security to databases</a> - <a href="#listing-databases-and-granting-privileges">Listing databases and granting privileges</a> - <a href="#time-to-clean-up">Time to clean up</a> - <a href="#table-management-walk-through-part-i"><strong>Table Management Walk-Through - Part I</strong></a> - <a href="#what-is-a-table">What is a table?</a> - <a href="#defining-tables">Defining tables</a> - <a href="#other-data-types">Other data types</a> - <a href="#naming-a-table">Naming a table</a> - <a href="#writing-the-sql">Writing the SQL</a> - <a href="#listing-tables-and-table-definitions">Listing tables and table definitions</a> - <a href="#deleting-a-table">Deleting a table</a> - <a href="#table-management-walk-through-part-ii"><strong>Table Management Walk-Through - Part II</strong></a> - <a href="#nullable-columns">Nullable columns</a> - <a href="#default-values">Default values</a> - <a href="#primary-keys">Primary keys</a> - <a href="#unique-values">Unique values</a> - <a href="#refactor-for-data-integrity">Refactor for data integrity</a> - <a href="#order-of-table-declarations">Order of table declarations</a> - <a href="#database-management-project"><em>Database Management Project</em></a></p>
<p><a href="#sql-learning-objectives"><strong>SQL Learning Objectives</strong></a> - <a
        href="#retrieving-rows-from-a-table-using-select"><strong>Retrieving Rows From A Table Using SELECT</strong></a>
    - <a href="#what-is-a-query">What is a query?</a> - <a href="#example-table">Example table</a> - <a
        href="#using-psql-in-the-terminal">Using psql in the terminal</a> - <a href="#simple-select-query">Simple SELECT
        Query</a> - <a href="#formatting-select-statements">Formatting SELECT statements</a> - <a
        href="#selecting-table-rows-using-where-and-common-operators"><strong>Selecting Table Rows Using WHERE And
            Common Operators</strong></a> - <a href="#using-select-and-where">Using SELECT and WHERE</a> - <a
        href="#inserting-data-into-a-table"><strong>Inserting Data Into A Table</strong></a> - <a
        href="#foreign-keys-and-the-join-operation"><strong>Foreign Keys And The JOIN Operation</strong></a> - <a
        href="#setting-up-the-database">Setting up the database</a> - <a
        href="#using-join-to-retrieve-rows-from-multiple-tables">Using JOIN to retrieve rows from multiple tables</a> -
    <a href="#helpful-links">Helpful links:</a> - <a href="#writing-and-running-a-seed-file-in-psql"><strong>Writing And
            Running A Seed File In PSQL</strong></a> - <a href="#creating-a-seed-file">Creating a seed file</a> - <a
        href="#populating-a-database-via-left-caret">Populating a database via &lt; ("left caret")</a> - <a
        href="#populating-the-database-via-pipe">Populating the database via | ("pipe")</a> - <a
        href="#create-and-seed-a-database-project"><em>Create And Seed A Database Project</em></a> - <a
        href="#solving-the-sql-menagerie-project"><em>Solving The SQL Menagerie Project</em></a> - <a
        href="#creating-a-schema-for-relational-database-design"><strong>Creating A Schema For Relational Database
            Design</strong></a> - <a href="#what-is-relational-database-design">What is Relational Database Design?</a>
    - <a href="#stages-of-relational-database-design">Stages of Relational Database Design</a> - <a
        href="#schema-design-tools">Schema design tools</a> - <a href="#using-sql-transactions"><strong>Using SQL
            Transactions</strong></a> - <a href="#what-is-a-transaction">What is a transaction?</a> - <a
        href="#implicit-vs-explicit-transactions">Implicit vs.Â explicit transactions</a> - <a
        href="#when-to-use-transactions-and-why">When to use transactions and why</a> - <a
        href="#transaction-properties-acid">Transaction properties: ACID</a> - <a href="#helpful-links-1">Helpful
        links:</a> - <a href="#joins-vs-subqueries"><strong>Joins vs.Â Subqueries</strong></a> - <a
        href="#what-is-a-join">What is a JOIN?</a> - <a href="#what-is-a-subquery">What is a subquery?</a> - <a
        href="#using-joins-vs-subqueries">Using joins vs.Â subqueries</a> - <a href="#helpful-links-2">Helpful links:</a>
    - <a href="#postgresql-indexes"><strong>PostgreSQL Indexes</strong></a> - <a href="#what-is-a-postgresql-index">What
        is a PostgreSQL index?</a> - <a href="#how-to-create-an-index">How to create an index</a> - <a
        href="#when-to-use-an-index">When to use an index</a> - <a
        href="#node-postgres-and-prepared-statements"><strong>Node-Postgres And Prepared Statements</strong></a> - <a
        href="#connecting">Connecting</a> - <a href="#prepared-statement">Prepared Statement</a> - <a
        href="#try-it-out-for-yourself">Try it out for yourself</a> - <a href="#recipe-box-project"><em>Recipe Box
            Project</em></a></p>
<p><a href="#orm-learning-objectives"><strong>ORM Learning Objectives</strong></a> - <a href="#installing-and-using-sequelize"><strong>Installing And Using Sequelize</strong></a> - <a href="#what-is-an-orm">What Is An ORM?</a> - <a href="#how-to-install-sequelize">How To Install Sequelize</a> - <a href="#how-to-initialize-sequelize">How To Initialize Sequelize</a> - <a href="#verifying-that-sequelize-can-connect-to-the-database">Verifying That Sequelize Can Connect To The Database</a> - <a href="#our-preexisting-database-schema">Our Preexisting Database Schema</a> - <a href="#using-sequelize-to-generate-the-model-file">Using Sequelize To Generate The Model File</a> - <a href="#examining-and-modifying-a-sequelize-model-file">Examining (And Modifying) A Sequelize Model File</a> - <a href="#using-the-cat-model-to-fetch-and-update-sql-data">Using The <code>Cat</code> Model To Fetch And Update SQL Data</a> - <a href="#reading-and-changing-record-attributes">Reading And Changing Record Attributes</a> - <a href="#using-database-migrations"><strong>Using Database Migrations</strong></a> - <a href="#sequelize-migration-files">Sequelize Migration Files</a> - <a href="#running-a-migration">Running A Migration</a> - <a href="#rolling-back-a-migration">Rolling Back A Migration</a> - <a href="#editing-a-migration-file">Editing A Migration File</a> - <a href="#up-and-down-are-asynchronous"><code>up</code> And <code>down</code> are Asynchronous</a> - <a href="#writing-a-down-method">Writing A <code>down</code> Method</a> - <a href="#advantages-of-migrations">Advantages Of Migrations</a> - <a href="#crud-operations-using-sequelize"><strong>CRUD Operations Using Sequelize</strong></a> - <a href="#creating-a-new-record">Creating A New Record</a> - <a href="#reading-a-record-by-primary-key">Reading A Record By Primary Key</a> - <a href="#updating-a-record">Updating A Record</a> - <a href="#destroying-a-record">Destroying A Record</a> - <a href="#class-methods-for-crud">Class Methods For CRUD</a> - <a href="#querying-using-sequelize"><strong>Querying Using Sequelize</strong></a> - <a href="#basic-usage-of-findall-to-retrieve-multiple-records">Basic Usage Of <code>findAll</code> To Retrieve Multiple Records</a> - <a href="#using-findall-to-find-objects-not-matching-a-criterion">Using <code>findAll</code> To Find Objects Not Matching A Criterion</a> - <a href="#combining-criteria-with-opand">Combining Criteria with <code>Op.and</code></a> - <a href="#combining-criteria-with-opor">Combining Criteria with <code>Op.or</code></a> - <a href="#querying-with-comparisons">Querying With Comparisons</a> - <a href="#ordering-results">Ordering Results</a> - <a href="#limiting-results-and-findone">Limiting Results and <code>findOne</code></a> - <a href="#model-validations-with-sequelize"><strong>Model Validations With Sequelize</strong></a> - <a href="#validating-that-an-attribute-is-not-null">Validating That An Attribute Is Not <code>NULL</code></a> - <a href="#the-notempty-validation">The <code>notEmpty</code> Validation</a> - <a href="#forbidding-long-string-values">Forbidding Long String Values</a> - <a href="#validating-that-a-numeric-value-is-within-a-specified-range">Validating That A Numeric Value Is Within A Specified Range</a> - <a href="#validating-that-an-attribute-is-among-a-finite-set-of-values">Validating That An Attribute Is Among A Finite Set Of Values</a> - <a href="#transactions-with-sequelize"><strong>Transactions With Sequelize</strong></a> - <a href="#the-problem-database-updates-can-fail">The Problem: Database Updates Can Fail</a> - <a href="#the-solution-database-transactions">The Solution: Database Transactions</a> - <a href="#the-bankaccounts-schema">The <code>BankAccounts</code> Schema</a> - <a href="#example-an-update-fails-because-of-validation-failure">Example: An Update Fails Because Of Validation Failure</a> - <a href="#incorrect-solutions">Incorrect Solutions</a> - <a href="#using-a-database-transaction-with-sequelize">Using A Database Transaction With Sequelize</a> - <a href="#aside-what-is-the-transaction-object">Aside: What Is The <code>Transaction</code> Object?</a> - <a href="#transactions-prevent-_race-conditions_">Transactions Prevent <em>Race Conditions</em></a> - <a href="#recipe-box-with-sequelize-project"><em>Recipe Box With Sequelize Project</em></a></p>
<!-- /code_chunk_output -->
<hr />
<h1 id="week-10-day-1-hello-database" data-ignore="true">WEEK-10 DAY-1<br><em>Hello, Database!</em></h1>
<hr />
<h1 id="make-it-pretty-learning-objectives">Make It Pretty Learning Objectives</h1>
<p>It is really important that you make the best impression that you can with the projects that you will soon start. To that end, the objectives for your learning with this section should allow you to</p>
<ul>
<li>Recall the items recruiters are most interested</li>
<li>Explain the aspects of good looking Web application</li>
<li>Identify â€™s expectations of your projects for after you graduate</li>
<li>Practice good code hygiene when making projects live</li>
</ul>
<hr />
<h1 id="make-it-pretty-practice">Make It Pretty Practice</h1>
<p>Your portfolio projects are the first impression that a company has of you. Imagine you are a non-technical person looking to hire a developer to build your website. What would you think if you reviewed a site that looked unfinished, or poorly styled, even if the functionality worked perfectly? Would you have the perspective to tell the difference from a poorly implemented site and one that is robust, but not visually polished?</p>
<p>Non-technical people will be looking at your projects before engineers, and they canâ€™t see the amount of work it takes to get a backend up and running. All they see is the visual appearance, so unless you take care of your frontend youâ€™ll never even get the chance to talk about the backend work you did.</p>
<p>This material should make it so that you can</p>
<ul>
<li>Evaluate your site against industry-standard visual styles</li>
<li>Identify the attributes of current trends in website presentation</li>
<li>Identify gaps that can cause a website to be perceived as incomplete</li>
</ul>
<h2 id="what-recruiters-are-looking-for">What Recruiters Are Looking For</h2>
<p>Recruiters expect professionalism and good design (weâ€™ll discuss more about what good design means below). A good litmus test is: if you were to stumble upon your portfolio sight unexpectedly, would you be able to tell that this wasnâ€™t done by a professional dev? In other words, does your website look on par with the millions of other production sites that exist on the internet?</p>
<p>In response to what recruiters and interviewers might ask about how you choose different styles for your Web applications, review TopTalâ€™s <a href="https://www.toptal.com/designers/web/interview-questions">12 Essential Web Interview Questions</a>.</p>
<h2 id="attributes-of-great-looking-websites">Attributes of Great Looking Websites</h2>
<p>Unless you know exactly what you are doing when deciding on a visual approach, you should select and follow a modern design framework, or use a template.</p>
<p>The first thing to pay attention to is padding and margin. Every element should have padding so that its inner contents are not butting up against its edges and margin so that the element itself is not butting up against any other elements. In general sibling elements should NOT touch or overlap. A good way to estimate the correct amount is to imagine a lower-case <code>a</code> in the same size and font of nearby text. You should be able to fit this <code>a</code> in both the padding and the margin such that it just barely touches the edge/text on each side.</p>
<p>Be sure to balance whitespace when laying out your elements and adding margin/padding. If you have 20px of whitespace to the left of the element you should probably have 20px to the right as well. Make sure things are centered correctly (horizontally and vertically) and be consistent! I.E. If you have a row of buttons in the header they should all be aligned vertically with consistent margin and padding.</p>
<p>Use a <a href="https://99designs.com/blog/tips/the-7-step-guide-to-understanding-color-theory/">color palette</a> to determine your websiteâ€™s themes and avoid color clashes. You should have a primary color, a secondary color, and 1 or 2 accent colors. Your primary color is going to be the most abundant on the site followed by your secondary color. The accent color is used for things like buttons, tools, and other areas that you want to draw the userâ€™s eye to. Use it sparingly!</p>
<p>Use <a href="https://fonts.google.com/">Google Font Pairing</a> recommendations to find good fonts. In general, you should not have more than 2 fonts in a web app and you should avoid mixing serif and sans-serif fonts.</p>
<p>Pay attention to font-size and weight! You should use <a href="https://blog.designcrowd.com/article/867/understanding-the-hierarchy-of-text">textual hierarchies</a> to break up your text and make it easier to read. Prefer multiple short lines to fewer long lines of text when displaying info to the user. Your headers should be large and paragraphs should be slightly smaller font size. Having widely varying and inconsistent font sizes is one of the surest signs that a website was designed by a beginner. When in doubt, simplify.</p>
<p>Make sure your color and text choices pass <a href="https://webaim.org/resources/contrastchecker/">contrast requirements</a>.</p>
<p>Most modern websites slightly round the corners of buttons and background cards/modals. <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/border-radius">You should, too</a>. Also, take advantage of advanced CSS features like transitions and shadows to make your site pop. Make sure you let your user know what parts of the site are alive through affordances.</p>
<h2 id="additional-requirements">Additional requirements</h2>
<p>In addition to the above recommendations, also expects your projects to include the following:</p>
<ul>
<li><strong>Seed Data</strong>: Make sure your seeds are plentiful and appropriate. Even an excellently designed site will fail to impress if you donâ€™t have a good seed data.</li>
<li><strong>Favicon</strong>: Make sure your website has a <a href="https://www.abeautifulsite.net/what-are-favicons">favicon</a>.</li>
<li><strong>Demo Login</strong>: Make sure your website has a demo login. Most recruiters will not sign up for your website with their own email address as the chance for misuse of said email address is too high.</li>
<li><strong>Console output</strong>: Be sure that your console is free of logs and error messages. Nothing screams amateur more than seeing a ton of console.logs when visiting a potential candidateâ€™s website.</li>
<li><strong>Personal Links</strong>: Any links to your GitHub, LinkedIn, or Angel List should open in a new tab.</li>
<li><strong>Scorecard</strong>: After you graduate, youâ€™ll stop using Progress Tracker and start using InterviewDB, another one of our applications. When you go to turn in your project on InterviewDB, be sure to include the scorecard so that your advisor can grade your work. Note that youâ€™ll need to make your own copy and save it to your google drive before adding the link to InterviewDB.</li>
</ul>
<h2 id="avoid-these-things">Avoid these things</h2>
<p>We have collected a lot of feedback from recruiters and hiring managers over the years. These are the tips and tricks that they tell us will turn them off to reviewing a studentâ€™s project.</p>
<ul>
<li>Avoid fonts that look like handwriting</li>
<li>Avoid over using accent colors</li>
<li>Avoid themes that relate to specific holidays (ie. donâ€™t make a Christmas themed app)</li>
<li>Dead Links. If you didnâ€™t implement a feature then donâ€™t put a link to it. If you do, then youâ€™re forcing recruiters to find the needle of implemented features in a haystack of unimplemented features. Your site will be perceived as incomplete or broken</li>
<li>Avoid linking to the actual site that you are cloning</li>
<li>Avoid neon, bright, or crazy colors</li>
<li>Avoid having too many different colors in your app.</li>
<li>Avoid putting affordances on things that canâ€™t be clicked or interacted with</li>
<li>Avoid blinking, spinning or flashing images</li>
<li>Avoid busy tiled background images with any color text</li>
<li>Avoid having everything centered. When in doubt, do not center. Do not center more than three lines of text</li>
<li>Avoid too many images or huge images. Minify all images that are not of a product and do not need to be examined closely</li>
<li>Avoid long lists of links</li>
<li>Avoid too many headlines</li>
<li>Do not use blinking or flashing text, images, or transitions</li>
</ul>
<h2 id="exercise">Exercise</h2>
<p>Select three sites from <a href="https://www.producthunt.com/">Product Hunt</a>. For each site, list the:</p>
<ul>
<li>Fonts Used</li>
<li>Colors in Palette</li>
<li>Contrast ratio of the main text and itâ€™s background (<a href="https://webaim.org/resources/contrastchecker/">Use the contrast checker</a>)</li>
<li>The size of padding/margins compared to a lowercase â€˜aâ€™</li>
<li>The maximum number of lines in a row center-justified anywhere on the site</li>
<li>Load Time</li>
<li>Theme or style based on (Bootstrap, Material, etc.)</li>
<li>Number of broken or under construction pages</li>
</ul>
<hr />
<h1 id="rdbms-and-database-entity-learning-objectives">RDBMS And Database Entity Learning Objectives</h1>
<p>Databases are an essential part of many Web applications. There are lots of things we could store in a database and use in a Web app, including user information, product information, review information, and more. Learning how to create databases and retrieve information stored in a database to display in a Web app is a foundational development skill.</p>
<p>In this section, you will be able to:</p>
<ul>
<li>Define what a relational database management system is</li>
<li>Describe what relational data is</li>
<li>Define what a database is</li>
<li>Define what a database table is</li>
<li>Describe the purpose of a primary key</li>
<li>Describe the purpose of a foreign key</li>
<li>Describe how to properly name things in PostgreSQL</li>
<li>Install and configure PostgreSQL 12, its client tools, and a GUI client for it named Postbird</li>
<li>Connect to an instance of PostgreSQL with the command line tool <code>psql</code></li>
<li>Identify whether a user is a normal user or a superuser by the prompt in the <code>psql</code> shell</li>
<li>Create a user for the relational database management system</li>
<li>Create a database in the database management system</li>
<li>Configure a database so that only the owner (and superusers) can connect to it</li>
<li>View a list of databases in an installation of PostgreSQL</li>
<li>Create tables in a database</li>
<li>View a list of tables in a database</li>
<li>Identify and describe the common data types used in PostgreSQL</li>
<li>Describe the purpose of the UNIQUE and NOT NULL constraints, and create columns in database tables that have them</li>
<li>Create a primary key for a table</li>
<li>Create foreign key constraints to relate tables</li>
<li>Explain that SQL is not case sensitive for its keywords but is for its entity names</li>
</ul>
<hr />
<h1 id="database-lingo-the-relational-database-management-system">Database Lingo<br><em>The Relational Database Management System</em></h1>
<p>Databases are an essential part of many Web applications. There are lots of things we could store in a database and use in a Web app, including user information, product information, review information, and more. Learning how to create databases and retrieve information stored in a database to display in a Web app is a foundational development skill.</p>
<p>The most popular kind of database is called a <em>relational database</em>. Thatâ€™s what youâ€™ll primarily use in this
    course. There are other databases called "document databases", "non-relational databases", or "NoSQL databases" that
    have become popular since the mid-2000s. They serve a different purpose that relational databases by storing data in
    ways that are different than the way relational databases store their data.</p>
<p>In this reading, you will learn about <strong>relational database management systems</strong>. Then, you will install one. Then, you will start using it!</p>
<h2 id="rdbms">RDBMS</h2>
<p>Thatâ€™s quite an ugly acronym, but itâ€™s what developers have when referring to the software application that manages databases for us. Hereâ€™s an important difference for you to understand.</p>
<p>The <strong>RDBMS</strong> is a software application that you run that your programs can connect to that they can store, modify, and retrieve data. The RDBS that you will use in this course is called <a href="https://www.postgresql.org/">PostgreSQL</a>, often shortened to just "postgres", pronounced like itâ€™s spelled. It is an "open-source" RDBMS which means that you can go read the source code for it, copy it, modify it, and make your own specialized version of an RDBMS. Often, developers will talk about the "database server". That is the computer on which the RDBMS is running.</p>
<p>A <strong>database</strong> (or more properly <strong>relational database</strong>) is a collection of structured data that the RDBMS manages for you. A single running RDBMS can have hundreds of databases in it that it manages.</p>
<p>Software developers will often use the term "database" to refer to the RDBMS. They will also say that "the data is in postgres" or "the data is in Oracle" which is terribly ambiguous because those are the names of the RDBMSes, not a database where the data is stored. Thatâ€™d be like asking someone their address and them replying "Chicago".</p>
<p>Just be aware that the language around these terms is loose.</p>
<h2 id="what-is-postgresql">What is PostgreSQL?</h2>
<p>Again, PostgreSQL is software. Specifically, it is an open-source, relational database management system. It is derived from the POSTGRES package written at UC Berkeley. The specific name "PostgreSQL" was coined in 1996, after SQL was implemented as its core query language. PostgreSQL provided a new program (new for 1996) for interactive SQL queries called <code>[psql]</code>, which is terminal-based front-end to PostgreSQL that lets you to type in queries interactively, issue them to PostgreSQL, and see the query results.</p>
<p>You install PostgreSQL onto a computer. It then runs as a "service", that is, a program that runs in the background that should not stop until the machine does. You will install it on your computer. It will quietly run in the background, eagerly awaiting for you to connect to it and interact with it from the command line, from a GUI tool, or from your application.</p>
<p>When you do connect with it, you will interact with it through a small set of its own commands and SQL.</p>
<h2 id="what-is-sql">What is SQL?</h2>
<p>SQL (pronounced "sequel" or "s-q-l") stands for "Structured Query Language". It is not a programming language like JavaScript. JavaScript, as you well know, has <em>control flow</em>, with <code>for</code> loops and <code>if</code> statements. Most SQL that you write doesnâ€™t have all that. Instead, it is a <em>declarative</em> programming language. You tell the database what computation you want it to do, and it does it. In that way, SQL is more like CSS than JavaScript.</p>
<p>Whereas JavaScript works on variables and arrays of single values, most SQL works on <em>sets</em> of records. Youâ€™ll see more what that means later, but just know that in the SQL that you learn, you wonâ€™t declare a single variable in that SQL.</p>
<p>SQL, the language, is the primary way that you will interact with the RDBMS to affect the data in a single database or the structure of the database itself. The process of using SQL takes two steps:</p>
<ol type="1">
<li>Connect to an RDBMS specifying
<ul>
<li>credentials, user name and password</li>
<li>the name of the database that you want to use</li>
</ul></li>
<li>Issue one or more SQL statements to interact with
<ul>
<li>the structure of the database</li>
<li>the data in the database</li>
</ul></li>
</ol>
<p>Some vendor-specific variants of SQL <em>do</em> have loops and if-statements. However, you will be learning the general kind of SQL, the one managed by the American National Standards Institute, called ANSI SQL which defines the way that we get data out of, put data into, modify data in, and remove data from a database. This type of SQL is <em>portable</em> between different types of database management systems. That means most of what you learn in this course, you will be able to use on <em>any</em> relational database management system that supports ANSI SQL, RDBMSes such as</p>
<ul>
<li><strong>Informix</strong>, a commercial RDBMS from IBM intended to run on servers and mainframes</li>
<li><strong>Microsoft Access</strong>, a commercial RDBMS from Microsoft intended for personal use</li>
<li><strong>Microsoft SQL Server</strong>, a commercial RDBMS from Microsoft intended to run on servers</li>
<li><strong>MySQL</strong>, an open-source RDBMS comparable to PostgreSQL</li>
<li><strong>Oracle DB</strong>, a commercial RDBMS from Microsoft intended to run on servers</li>
<li><strong>SQLite</strong>, an open-source RDBMS that many applications <em>embed</em> into the program to efficiently store the applicationâ€™s data relational data</li>
</ul>
<p>Now that this preamble is out of the way, the next step is to install PostgreSQL!</p>
<h2 id="what-we-learned">What we learned:</h2>
<p>In this article you learned that</p>
<ul>
<li>A <em>relational database management</em> system is software that usually runs as a service that manages collections of structured data called databases.</li>
<li>PostgreSQL is one of many relational database management systems and the one that you will mostly use in this course</li>
<li>A <em>database</em> is a collection of structured data that an RDBMS manages for you.</li>
<li>The Structured Query Language (SQL) is a programming language that allows you to interact with the structure of the database and the actual data thatâ€™s stored in it.</li>
</ul>
<hr />
<h1 id="installing-postgresql-12-and-postbird-on-windows">Installing PostgreSQL 12 and Postbird on Windows</h1>
<p>You will install three pieces of software so that you can start using PostgreSQL. You will install PostgreSQL itself on your Windows installation. Then, you will install <code>psql</code> in your Ubuntu installation. Then you will also install Postbird, a cross-platform graphical user interface that makes working with SQL and PostgreSQL better than just using the command line tool <code>psql</code>.</p>
<p>When you read "installation", that means the actual OS thatâ€™s running on your machine. So, you have a Windows installation, Windows 10, thatâ€™s running when you boot your computer. Then, when you start the Ubuntu installation, itâ€™s as if thereâ€™s a completely separate computer running inside your computer. Itâ€™s like having two completely different laptops.</p>
<h2 id="installing-postgresql-12">Installing PostgreSQL 12</h2>
<p>To install PostgreSQL 12, you need to download the installer from the Internet. PostgreSQLâ€™s commercial company, Enterprise DB, offers installers for PostgreSQL for every major platform.</p>
<p>Open https://www.enterprisedb.com/downloads/postgres-postgresql-downloads. Click the link for PostgreSQL 12 for Windows x86-64.</p>
<figure>
<img src="images/download-postgresql.png" alt="Download PostgreSQL" /><figcaption>Download PostgreSQL</figcaption>
</figure>
<p>Once that installer downloads, run it. You need to go through the normal steps of installing software.</p>
<ul>
<li>Yes, Windows, let the installer make changes to <em>my</em> device.</li>
<li>Thanks for the welcome. Next.</li>
<li>Yeah, thatâ€™s a good place to install it. Next.</li>
<li><p>I donâ€™t want that pgAdmin nor the Stack Builder things. Uncheck. Uncheck. Next.</p>
<figure>
<img src="images/postgresql-installation-uncheck-components.png" alt="Deselect pgAdmin 4 and Stack Builder components" /><figcaption>Deselect pgAdmin 4 and Stack Builder components</figcaption>
</figure></li>
<li>Also, great looking directory. Thanks. Next.</li>
<li>Oooh! A password! Iâ€™ll enter ********. I sure wonâ€™t forget that because, if I do, Iâ€™ll have to uninstall and reinstall PostgreSQL and lose all of my hard work. <strong>Seriously, write down this password or use one you will not forget.</strong> Next.</li>
<li>Sure. 5432. Good to go. Next.</li>
<li>Not even sure what that means. Default! Next.</li>
<li>Yep. Looks good. Next.</li>
<li>Geez. Really? Thanks. Next.</li>
<li><em>Time to get a tea.</em></li>
<li><p>All right! All done. Finish!</p></li>
</ul>
<h2 id="installing-postgresql-client-tools-on-ubuntu">Installing PostgreSQL Client Tools on Ubuntu</h2>
<p>Now, to install the PostgreSQL Client tools for Ubuntu. You need to do this so that the Node.js (and later Python) programs running on your Ubuntu installation can access the PostgreSQL server running on your Windows installation. You need to tell <code>apt</code>, the package manager, that you want it to go find the PostgreSQL 12 client tools from PostgreSQL itself rather than the common package repositories. You do that by issuing the following two commands. Copy and paste them one at a time into your shell. (If your Ubuntu shell isnâ€™t running, start one.)</p>
<p><strong>Pro-tip</strong>: Copy those commands because youâ€™re not going to type them, right? After you copy one of them, you can just right-click on the Ubuntu shell. That should paste them in there for you.</p>
<pre class="shell"><code>wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -</code></pre>
<p>If prompted for your password, type it.</p>
<pre class="shell"><code>echo &quot;deb http://apt.postgresql.org/pub/repos/apt/ `lsb_release -cs`-pgdg main&quot; | sudo tee  /etc/apt/sources.list.d/pgdg.list</code></pre>
<p>The last line of output of those two commands running should read "OK". If it does not, try copying and pasting them one at a time.</p>
<p>Now that youâ€™ve registered the PostgreSQL repositories as a source to look for PostgreSQL, you need to update the <code>apt</code> registry. You should do this before you install <em>any</em> software on Ubuntu.</p>
<pre class="shell"><code>sudo apt update</code></pre>
<p>Once thatâ€™s finished running, the new entries for PostgreSQL 12 should be in the repository. Now, you can install them with the following command.</p>
<pre class="shell"><code>sudo apt install postgresql-client-12 postgresql-common</code></pre>
<p>If it asks you if you want to install them, please tell it "Y".</p>
<p>Test that it installed by typing <code>psql --version</code>. You should see it print out information about the version of the installed tools. If it tells you that it canâ€™t find the command, try these instructions over.</p>
<h2 id="configuring-the-client-tools">Configuring the client tools</h2>
<p>Since youâ€™re going to be accessing the PosgreSQL installation from your Ubuntu installation on your Windows installation, youâ€™re going to have to type that you want to access it over and over, which means extra typing. To prevent you from having to do this, you can customize your shell to always add the extra commands for you.</p>
<p>This assumes youâ€™re still using Bash. If you changed the shell that your Ubuntu installation uses, please follow that shellâ€™s directions for adding an alias to its startup file.</p>
<p>Make sure youâ€™re in your Ubuntu home directory. You can do that by typing <code>cd</code> and hitting enter. Use <code>ls</code> to find out if you have a <code>.bashrc</code> file. Type <code>ls .bashrc</code>. If it shows you that one exists, thatâ€™s the one you will add the alias to. If it tells you that there is no file named that, then type <code>ls .profile</code>. If it shows you that one exists, thatâ€™s the one you will add the alias to. If it shows you that it does not exist, then use the file name <code>.bashrc</code> in the following section.</p>
<p>Now that you know which profile file to use, type <code>code Â«profile file nameÂ»</code> where "profile file name" is the name of the file you determined from the last section. Once Visual Studio Code starts up with your file, at the end of it (or if youâ€™ve already added aliases, in that section), type the following.</p>
<pre class="shell"><code>alias psql=&quot;psql -h localhost&quot;</code></pre>
<p>When you run <code>psql</code> from the command line, it will now always add the part about wanting to connect to <em>localhost</em> every time. You would have to type that each time, otherwise.</p>
<p>To make sure that you set that up correctly, type <code>psql -U postgres postgres</code>. This tells the <code>psql</code> client that you want to connect as the user "postgres" (<code>-U postgres</code>) to the database postgres (<code>postgres</code> at the end), which is the default database created when PostgreSQL is installed. It will prompt you for a password. Type the password that you used when you installed PostgrSQL, earlier. If the alias works correctly and you type the correct password, then you should see something like the following output.</p>
<pre class="shell"><code>psql (12.2 (Ubuntu 12.2-2.pgdg18.04+1))
Type &quot;help&quot; for help.

postgres=#</code></pre>
<p>Type <code>\q</code> and hit Enter to exit the PostgreSQL client tool.</p>
<p>Now, you will add a user for your Ubuntu identity so that you donâ€™t have to specify it all the time. Then, you will create a file that PostgreSQL will use to automatically send your password every time.</p>
<p>Copy and paste the following into your Ubuntu shell. Think of a password that you want to use for your user. <strong>Replace the password in the single quotes in the command with the password that you want.</strong> It <em>has</em> to be a non-empty string. PostgreSQL doesnâ€™t like it when itâ€™s not.</p>
<pre class="shell"><code>psql -U postgres -c &quot;CREATE USER `whoami` WITH PASSWORD &#39;password&#39; SUPERUSER&quot;</code></pre>
<p>It should prompt you for a password. Type the password that you created when you installed PostgreSQL. Once you type the correct password, you should see "CREATE ROLE".</p>
<p>Now you will create your PostgreSQL password file. Type the following into your Ubuntu shell to open Visual Studio Code and create a new file.</p>
<pre class="shell"><code>code ~/.pgpass</code></pre>
<p>In that file, you will add this line, which tells it that on localhost for port 5432 (where PostgreSQL is running), for all databases (*), <strong>use your Ubuntu user name and the password that you just created for that user with the <code>psql</code> command you just typed.</strong> (If you have forgotten your Ubuntu user name, type <code>whoami</code> on the command line.) Your entry in the file should have this format.</p>
<pre><code>localhost:5432:*:Â«your Ubuntu user nameÂ»:Â«the password you just usedÂ»</code></pre>
<p>For the curriculum writersâ€™ systems, it looks like this in Visual Studio Code.</p>
<figure>
<img src="images/windows-pgpass-configuration.png" alt="pgpass file" /><figcaption>pgpass file</figcaption>
</figure>
<p>Once you have that information in the file, save it, and close Visual Studio Code.</p>
<p>The last step you have to take is change the permission on that file so that it is only readable by your user. PostgreSQL will ignore it if just anyone can read and write to it. This is for <em>your</em> security. Change the file permissions so only you can read and write to it. You did this once upon a time. Hereâ€™s the command.</p>
<pre class="shell"><code>chmod go-rw ~/.pgpass</code></pre>
<p>You can confirm that only you have read/write permission by typing <code>ls -al ~/.pgpass</code>. That should return output that looks like this, <strong>with your Ubuntu user name instead of "".</strong></p>
<pre class="shell"><code>-rw------- 1   37 Mar 28 21:20 /home//.pgpass</code></pre>
<p>Now, try connecting to PostreSQL by typing <code>psql postgres</code>. Because you added the alias to your startup script, and because you created your <strong>.pgpass</strong> file, it should now connect without prompting you for any credentials! Type <code>\q</code> and press Enter to exit the PostgreSQL command line client.</p>
<h2 id="installing-postbird">Installing Postbird</h2>
<p>Head over to the <a href="https://github.com/Paxa/postbird/releases">Postbird releases page on GitHub</a>. Click the installer for Windows which you can recognize because itâ€™s the only file in the list that ends with ".exe".</p>
<figure>
<img src="images/download-postbird.png" alt="Download Postbird" /><figcaption>Download Postbird</figcaption>
</figure>
<p>After that installer downloads, run it. You will get a warning from Windows that this is from an unidentified developer. If you donâ€™t want to install this, find a PostgreSQL GUI client that you do trust and install it or do everything from the command line.</p>
<figure>
<img src="images/postbird-installation-warning.png" alt="Postbird installation warning" /><figcaption>Postbird installation warning</figcaption>
</figure>
<p>You should get used to seeing this because many open-source applications arenâ€™t signed with the Microsoft Store for monetary and philosophical reasons.</p>
<p>Otherwise, if you trust Paxa like and tens of thousands of other developers do, then click the link that reads "More info" and the "Run anyway" button.</p>
<figure>
<img src="images/postbird-installation-run-anyway.png" alt="Postbird run anyway" /><figcaption>Postbird run anyway</figcaption>
</figure>
<p>When itâ€™s done installing, it will launch itself. Test it out by typing the "postgres" into the "Username" field and the password from your installation in the "Password" field. Click the Connect button. It should properly connect to the running</p>
<p>You can close it for now. It also installed an icon on your desktop. You can launch it from there or your Start Menu at any time.</p>
<h2 id="what-you-did">What you did</h2>
<p>You installed and configured PosgreSQL 12, a relational database management system, and tools to use it! Well done!</p>
<hr />
<h1 id="installing-postgresql-12-and-postbird-on-macos">Installing PostgreSQL 12 and Postbird on macOS</h1>
<p>You will install two pieces of software so that you can start using PostgreSQL. You sill install PostgreSQL itself along with all of its tools. Then you will also install Postbird, a cross-platform graphical user interface that makes working with SQL and PostgreSQL better than just using the command line tool <code>psql</code>.</p>
<p>You can install both of these products using Homebrew. Your Windows-using classmates donâ€™t have this convenience, so pretend youâ€™re having a hard time doing this. ðŸ˜‰</p>
<h2 id="installing-postgresql-12-1">Installing PostgreSQL 12</h2>
<p>First, update your Homebrew installation. You should do this before each thing that you install using Homebrew.</p>
<pre class="shell"><code>brew update</code></pre>
<p>Now, make sure that you have the correct Homebrew recipe. Type the following and make sure that the first line of the output contains some version of "12".</p>
<pre class="shell"><code>brew info postgresql</code></pre>
<p>You should see something like this in the output.</p>
<pre><code>postgresql: stable 12.2 (bottled), HEAD</code></pre>
<p>Now, launch the installation.</p>
<pre><code>brew install postgresql</code></pre>
<p>This may take a while. Have a tea.</p>
<h2 id="configuring-postgresql-12">Configuring PostgreSQL 12</h2>
<p>When that completes, you can read the <strong>Caveats</strong> section from the installation output. You should do this with <em>everything</em> that you install using Homebrew.</p>
<pre class="shell"><code>To migrate existing data from a previous major version of PostgreSQL run:
  brew postgresql-upgrade-database

To have launchd start postgresql now and restart at login:
  brew services start postgresql
Or, if you don&#39;t want/need a background service you can just run:
  pg_ctl -D /usr/local/var/postgres start</code></pre>
<p>You definitely want PostgreSQL to run now and every time you log in. Otherwise youâ€™d have to start it every time you reboot your computer which can be a hassle. Following the instructions, please type the following into the command line.</p>
<pre class="shell"><code>brew services start postgresql</code></pre>
<p>That should report that PostgreSQL is now started.</p>
<h2 id="connecting-to-postgresql">Connecting to PostgreSQL</h2>
<p>To make sure your client tools are configured properly, type the following in a Terminal. This tells the <code>psql</code> client that you want to connect to the "postgres" database, which is the default database created when PostgreSQL is installed.</p>
<pre class="shell"><code>psql postgres</code></pre>
<p>That will connect to the "postgres" database as your user that youâ€™re logged in as, which the installer configured for you during the installation. Itâ€™s the same as specifying your user name by using the "-U" command line parameter and typing.</p>
<pre><code>psql -U Â«your user nameÂ» postgres</code></pre>
<p>When you successfully log in, it should show you the following output.</p>
<pre><code>psql (12.2)
Type &quot;help&quot; for help.

postgres=#</code></pre>
<p>Type <code>\q</code> and hit Return to quit the PostgreSQL client.</p>
<h2 id="installing-postbird-1">Installing Postbird</h2>
<p>Make sure that your Homebrew can find Postbird. Search for it using the <code>brew search</code> command.</p>
<pre class="shell"><code>brew search postbird</code></pre>
<p>You should get something back that looks like this.</p>
<pre><code>==&gt; Casks
postbird</code></pre>
<p>That means it could find it. Since itâ€™s a <strong>Cask</strong>, that means itâ€™s an application that is meant to be used as a graphical user interface rather than on the command line. To install it, you need to include "cask" in the command.</p>
<pre class="shell"><code>brew cask install postbird</code></pre>
<p>Once it installs, try starting it. Itâ€™s in your Applications directory. You can use Spotlight to launch it by pressing Command+Space. In the Spotlight window, type "postbird". It should show you the recently-installed applicationâ€™s logo in the list as a white circle with a blue elephant. Select that and press Enter (or click it, if youâ€™re the touchpad/mouse kind of person).</p>
<p>The first time it starts, you may get this error.</p>
<figure>
<img src="images/postbird-installation-unidentified-developer.png" alt="Postbird unidentified developer" /><figcaption>Postbird unidentified developer</figcaption>
</figure>
<p>You should get used to seeing this because many open-source applications arenâ€™t signed with an Apple Developer Certificate yet. Click "Cancel". We will need to tell macOS we would like to run this application despite it not being signed.</p>
<p>Open up your Applications directory by clicking on the shortcut in the left bar of Finder.</p>
<figure>
<img src="images/finder-applications-shortcut.png" alt="Finder Applications shortcut" /><figcaption>Finder Applications shortcut</figcaption>
</figure>
<p>Find the Postbird application in there. Hold down the Option key and left-click the icon. (If youâ€™re using the touchpad, this probably means two-finger tap.) Once the context menu shows up, you can let go of the Option key. Then, click the "Open" menu item. You will now see a new version of the popup from before with an extra button.</p>
<figure>
<img src="images/postbird-installation-open-confirmation.png" alt="Postbird open confirmation" /><figcaption>Postbird open confirmation</figcaption>
</figure>
<p>Click the "Open" button. That will let Postbird run. Now that youâ€™ve done that once, you wonâ€™t have to do it again for Postbird. This is valuable knowledge about how to run open-source software on macOS that isnâ€™t signed by the developers. However, it is a good security practice to only run applications from developers that you trust. The Postbird application is used by tens of thousands of software developers and is something that you can trust.</p>
<p>In fact, the developer of Postbird has an <a href="https://github.com/Paxa/postbird/issues/16">â€˜issueâ€™ on github</a> about this very thing. So hopefully they will get the signing of the app fixed in a future version.</p>
<p>When Postbird starts, type "postgres" into the database field. Then, click the "Connect" button. It should open a new tab and show you basically a blank page. That means everything worked! Exit Postbird by pressing Command+Q or selecting Postbird &gt; "Quit Postbird" from the menu.</p>
<h2 id="what-you-did-1">What you did</h2>
<p>You installed and configured PosgreSQL 12, a relational database management system, and tools to use it! Well done!</p>
<hr />
<h1 id="user-management-walk-through">User Management Walk-Through</h1>
<p><strong>This is a walk-through</strong>: Please type along as you read whatâ€™s going on in this article.</p>
<p>In this walk-through, you will</p>
<ul>
<li>Create superusers with full access to the system,</li>
<li>Create normal users,</li>
<li>Delete users from the system, and,</li>
<li>See how SQL is not case sensitive</li>
</ul>
<p>Itâ€™s good practice to create a different database user for each application that you will have connect to an RDBMS. This prevents applications from reading and changing data in <em>other</em> databases that they should not have access to.</p>
<p>The "User" in PostgreSQL is a <strong>database entity</strong> that represents a person or system that will connect to the RDBMS and access data from one or more databases. This is the first entity that you will create, modify, and destroy.</p>
<p>All user management is beyond the scope of the ANSI SQL standard. That means each relational database management system has its own vendor-specific extensions about how to do this. When working with a new RDBMS, check out its documentation about how to create users, groups, and other security entities.</p>
<h2 id="naming-a-user">Naming a user</h2>
<p>Names of users should not create spaces or dashes. They should contain only lower case letters, numbers, and underscores.</p>
<ul>
<li>Good user names
<ul>
<li></li>
<li>patel_kush_112</li>
<li>bdorsey</li>
</ul></li>
<li>Bad (incorrect) user names
<ul>
<li>Ned Ruggeri</li>
<li>melvin-howard-tormÃ©</li>
<li>b.d.o.r.s.e.y</li>
</ul></li>
</ul>
<h2 id="creating-a-superuser">Creating a superuser</h2>
<p>On Windows, open your Ubuntu shell. On macOS, open your Terminal. Start the PostgreSQL command line client with the command <code>psql postgres</code>.</p>
<p>You should see some information about the version of the database and the command line tool, plus a helpful hint to type "help" if you need help. Then, you will see the <code>psql</code> prompt:</p>
<pre><code>postgres=#</code></pre>
<p>The value "postgres" means that youâ€™re currently connected to the "postgres" database. More on that in the next article.</p>
<p>To create a user in PostgreSQL you will use the following command. It creates a user with the name "test_superuser" and the password "test". <em>Type</em> that command (please donâ€™t copy and paste it) and run it by hitting Enter (or Return).</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb25-1" title="1"><span class="kw">CREATE</span> <span class="fu">USER</span> test_superuser</a>
<a class="sourceLine" id="cb25-2" title="2"><span class="kw">WITH</span></a>
<a class="sourceLine" id="cb25-3" title="3"><span class="kw">PASSWORD</span> <span class="st">&#39;test&#39;</span></a>
<a class="sourceLine" id="cb25-4" title="4">SUPERUSER;</a></code></pre></div>
<p>Note that this SQL statement ends with a semicolon. All SQL statements in PostgreSQL do. Donâ€™t forget it. If you do forget it, just type it on an empty line. The above statement, for example, can also be entered as the following where the semicolon is on a line all its own.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb26-1" title="1"><span class="kw">CREATE</span> <span class="fu">USER</span> test_superuser</a>
<a class="sourceLine" id="cb26-2" title="2"><span class="kw">WITH</span></a>
<a class="sourceLine" id="cb26-3" title="3"><span class="kw">PASSWORD</span> <span class="st">&#39;test&#39;</span></a>
<a class="sourceLine" id="cb26-4" title="4">SUPERUSER</a>
<a class="sourceLine" id="cb26-5" title="5">;</a></code></pre></div>
<p>If you typed it correctly, you will see the message <code>CREATE ROLE</code>. Because you created test_superuser as a super user, when a person or application uses that login, they can do whatever they want. You will test out that fact, now.</p>
<p>Quit your current session by typing <code>\q</code> and hitting Enter (or Return). Now type the following command to connect to PostgreSQL with the newly-created user. It instructs the client to connect as the user "test_superuser" (<code>-U test_superuser</code>) to the database named "postgres" (<code>postgres</code>) and prompt for the password (<code>-W</code>) for the user.</p>
<pre class="shell"><code>psql -W -U test_superuser postgres</code></pre>
<p>At the prompt, type the password <em>test</em> that you used when you created the user. If everything went well, then you will find yourself at the SQL prompt just like before. To prove to you that youâ€™re now the "test_superuser", type the following command.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb28-1" title="1"><span class="kw">SELECT</span> CURRENT_USER;</a></code></pre></div>
<p>It should respond with the following output:</p>
<pre><code>  current_user
----------------
 test_superuser
(1 row)</code></pre>
<h2 id="creating-a-limited-user">Creating a limited user</h2>
<p>Youâ€™re logged in as a super user that can do anything. Use that power! Create another user that does not have such amazing power. You will rarely create super users in real life. The following user creation is more appropriate. It creates just a normal user that can log in. Then, you can assign that user specific access to specific databases.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb30-1" title="1"><span class="kw">CREATE</span> <span class="fu">USER</span> test_normal_user</a>
<a class="sourceLine" id="cb30-2" title="2"><span class="kw">WITH</span></a>
<a class="sourceLine" id="cb30-3" title="3"><span class="kw">PASSWORD</span> <span class="st">&#39;test&#39;</span>;</a></code></pre></div>
<p>That should also give you the <code>CREATE ROLE</code> message that means everything went ok.</p>
<p>Quit the session by typing <code>\q</code> and pressing Enter (or Return). Start another as the new user.</p>
<pre class="psql"><code>psql -U test_normal_user -W postgres</code></pre>
<p>Type the password <em>test</em> for this user. Confirm that you are now that new user by using the <code>SELECT CURRENT_USER;</code> command. Once confirmed, try to create a user named <em>hacking_the_planet</em> with a password of <em>pwned!</em>. What happens?</p>
<p>Thatâ€™s right. This user doesnâ€™t have the security privileges to create users.</p>
<p>Create users to do the job you want them to do. Then, give the appropriate permissions to that user. This will make a safe and secure application development world for you and your team.</p>
<h2 id="removing-a-user">Removing a user</h2>
<p>Time to remove both of these users. The opposite of <code>CREATE USER</code> is <code>DROP USER</code>. To drop a user, you just type <code>DROP USER Â«user nameÂ»;</code>.</p>
<p>Connect again as just you, the OG super user. (Once again, thatâ€™s with the command <code>psql postgres</code>.)</p>
<p>Drop the normal user with the command</p>
<pre><code>DROP USER test_normal_user;</code></pre>
<p>Then, drop the user with the name "test_superuser". You should receive the message "DROP ROLE" for each of your commands.</p>
<h2 id="case-sensitivity">Case sensitivity</h2>
<p>Unlike JavaScript, the keywords in SQL are case insensitive. that means you can type any of the following and theyâ€™ll all work.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb33-1" title="1"><span class="kw">DROP</span> <span class="fu">USER</span> test_user;</a>
<a class="sourceLine" id="cb33-2" title="2"><span class="kw">Drop</span> <span class="fu">User</span> test_user;</a>
<a class="sourceLine" id="cb33-3" title="3"><span class="kw">drop</span> <span class="fu">user</span> test_user;</a></code></pre></div>
<p>Notice that entity names like user names <em>are</em> case sensitive.</p>
<p>SQL is conventionally written in all uppercase to distinguish the commands from the names that you will have for your entities and their properties.</p>
<h2 id="what-you-learned">What you learned</h2>
<ul>
<li>That a user is a <em>database entity</em> in PostgreSQL</li>
<li>That it is best practice to create a user for each application that you will create</li>
<li>How to create a super user with the <code>CREATE USER ... SUPERUSER</code> command</li>
<li>How to create a restricted (normal) user with the <code>CREATE USER</code> command</li>
<li>How to remove a user with the <code>DROP USER</code> command</li>
<li>SQL keywords are not sensitive to case, but are conventionally written in uppercase</li>
</ul>
<hr />
<h1 id="database-management-walk-through">Database Management Walk-Through</h1>
<p><strong>This is a walk-through</strong>: Please type along as you read whatâ€™s going on in this article.</p>
<p>In this walk-through, you will</p>
<ul>
<li>Create a database for your user,</li>
<li>Create databases for other users,</li>
<li>Apply security to the databases to prevent access,</li>
<li>See the first example of "relational data" in the RDBMS, and,</li>
<li>Create other databases and apply security to them.</li>
</ul>
<p>Now that you can create users for each of your applications, itâ€™s time for you to be able to create a <strong>database</strong>. The database is where you will store the data for your application.</p>
<p>Youâ€™ve been using the following command to log in as your superuser to the "postgres" database. This works because if you donâ€™t specify a user with the <code>-U</code> command line parameter, it just uses the name of the currently logged in user, your user name.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb34-1" title="1">psql postgres</a></code></pre></div>
<p>Thatâ€™s because if you donâ€™t specify a database, then PostgreSQL will try to connect you to a database that has the same name as your user. Try it, now.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb35-1" title="1">psql</a></code></pre></div>
<p>When you run this, if there is no database with your user name, then you will receive an error message that reads like the following. (The text has been wrapped in the example for readability.)</p>
<pre><code>psql: error: could not connect to server:
      FATAL:  database &quot;&quot; does not exist</code></pre>
<h2 id="naming-a-database">Naming a database</h2>
<p>Names of databases should not create spaces or dashes. They should contain only lower case letters, numbers, and underscores.</p>
<ul>
<li>Good database names
<ul>
<li>data</li>
<li>financials2020</li>
<li>chicago_office</li>
</ul></li>
<li>Bad (incorrect) database names
<ul>
<li>Data</li>
<li>financials-2020</li>
<li>chicago.office</li>
</ul></li>
</ul>
<h2 id="creating-a-database-for-your-user">Creating a database for your user</h2>
<p>So that you donâ€™t have to type "postgres" every time you want to connect on the command line, you can create a database with your user name so that one will exist. To determine your user name, type the following command at your shell, <em>not</em> in PostgreSQL.</p>
<pre class="shell"><code>whoami</code></pre>
<p>That will show you the name of your user. Remember that name. Now, start your PostgreSQL command line as your superuser.</p>
<pre class="shell"><code>psql postgres</code></pre>
<p>That should result in the <code>psql</code> command prompt of <code>postgres=#</code>. Again, that means that you are currently connected to the "postgres" database.</p>
<p>Once youâ€™re greeted by the <code>postgres=#</code> command prompt, you can create a database for your user by typing the following command. Donâ€™t copy and paste, here. Type it out.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb39-1" title="1"><span class="kw">CREATE</span> <span class="kw">DATABASE</span> Â«your <span class="fu">user</span> nameÂ» <span class="kw">WITH</span> OWNER Â«your <span class="fu">user</span> nameÂ»;</a></code></pre></div>
<p>By making yourself the owner of that database, then your user can do anything with it.</p>
<p>For the examples in these articles, the user name is "", so the authors typed</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb40-1" title="1"><span class="kw">CREATE</span> <span class="kw">DATABASE</span>  <span class="kw">WITH</span> OWNER ;</a></code></pre></div>
<p>If the command succeeds, you will see the message "CREATE DATABASE". Now, quit the client using <code>\q</code>. Now, connect, again, to PostgreSQL by just typing the following.</p>
<pre class="shell"><code>psql</code></pre>
<p>Now, when you log in, you will be greeted by a command prompt that reads</p>
<pre><code>Â«your user nameÂ»=#</code></pre>
<p>Youâ€™re connected to your very own database! And, now, you have less to type when you want to start <code>psql</code>! Yay for less typing!</p>
<h2 id="creating-other-users-and-databases">Creating other users and databases</h2>
<p>Create two normal users with the following user names and passwords using the <code>CREATE USER</code> command from the last article.</p>
<table>
<thead>
<tr class="header">
<th>User name</th>
<th>Password</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ada</td>
<td>ada1234</td>
</tr>
<tr class="even">
<td>odo</td>
<td>ODO!!!1</td>
</tr>
</tbody>
</table>
<p>Now, create two databases, each named for a user with that user as the owner. Again, type these rather than copying and pasting.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb43-1" title="1"><span class="kw">CREATE</span> <span class="kw">DATABASE</span> ada <span class="kw">WITH</span> OWNER ada;</a>
<a class="sourceLine" id="cb43-2" title="2"><span class="kw">CREATE</span> <span class="kw">DATABASE</span> odo <span class="kw">WITH</span> OWNER odo;</a></code></pre></div>
<p>Now that you have new users and databases for them, itâ€™s time to test out that you can connect to PostgreSQL with those users. Quit your current session by typing <code>\q</code> and pressing Enter (or Return). Then, start a new session for "ada" by using the following <code>psql</code> command that will prompt for the userâ€™s password (<code>-W</code>) and connect as the specified user (<code>-U ada</code>).</p>
<pre class="shell"><code>psql -W -U ada</code></pre>
<p><strong>Note</strong>: Those command line parameters can come in any order, usually. The above statement can also be written as <code>psql -U ada -W</code>, for example.</p>
<p>When you enter that and type the password for "ada" which is "ada1234" from the table above, you should see that you are now connected to the "ada" database in the prompt.</p>
<pre><code>ada=&gt;</code></pre>
<p>Notice that the character at the end is now a "&gt;" rather than the "#" that youâ€™re used to seeing. Thatâ€™s because "ada" is a normal user. Normal user prompts end with "&gt;". Your user, the one tied to your user name, is a super user. That results in a "#"</p>
<p>Quit this session and connect as the "odo" user, now. You will notice that because "odo" is a normal user, that you will see this prompt, too.</p>
<pre><code>odo=&gt;</code></pre>
<h2 id="applying-security-to-databases">Applying security to databases</h2>
<p>Youâ€™ve created a database for "odo". Type the following command which will try to connect as the user "ada" (<code>-U ada</code>) to the database "odo" (<code>odo</code>).</p>
<pre class="shell"><code>psql -W -U ada odo</code></pre>
<p>After you type the password, you may be surprised to find out that "ada" can connect to the database "odo" thatâ€™s owned by the user "odo"! Thatâ€™s because all databases, when theyâ€™re created, by default allow access to what is known as the "PUBLIC" schema, a kind of group that everyone belongs to. You sure donâ€™t want that if you want to prevent the user "ada" from messing up the data in the database "odo", and the user "odo" from messing up the data in the database "ada".</p>
<p>To do that, you have to revoke connection privileges to "PUBLIC". Thatâ€™s like putting a biometric lock on a bank safety deposit box so that only the owner of that deposit box (and bank officials) can get into it and do stuff with its contents.</p>
<p>To do that, quit the current <code>psql</code> session if youâ€™re in one. Connect to PostgreSQL as your user, a superuser. Again, now that you have your own database, you can just type <code>psql</code> at your macOS Terminal command line or Ubuntu shell command line. Once you have your prompt</p>
<pre><code>Â«your user nameÂ»=#</code></pre>
<p>you want to type a command that will revoke all privileges from the databases named "odo" and "ada" the connection privileges of the entire "PUBLIC" group. To do that, you write the command with the form:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb49-1" title="1"><span class="kw">REVOKE</span> <span class="kw">CONNECT</span> <span class="kw">ON</span> <span class="kw">DATABASE</span> Â«database nameÂ» <span class="kw">FROM</span> <span class="kw">PUBLIC</span>;</a></code></pre></div>
<p>Do that for both databases. Each time you run it, you should see the message "REVOKE" showing that it worked.</p>
<p>Now, quit your session (<code>\q</code>). With the connection privilege revoked, "ada" can no longer connect to database "odo" and vice versa. Try typing the following.</p>
<pre class="shell"><code>psql -W -U ada odo</code></pre>
<p>You should see an error message similar to the following.</p>
<pre><code>psql: error: could not connect to server:
      FATAL:  permission denied for database &quot;odo&quot;
DETAIL:  User does not have CONNECT privilege.</code></pre>
<p>Try connecting with the user "odo" to the database named "ada". You should see the same error message except with the database named "ada" in it.</p>
<p>But, your superuser status will not be thwarted! You can still connect to either of those because of your superuser privileges. Neither of the following commands should fail.</p>
<pre class="shell"><code># Connect to the database &quot;odo&quot; as your superuser
psql odo</code></pre>
<pre class="shell"><code># Connect to the database &quot;ada&quot; as your superuser
psql ada</code></pre>
<p>Superusers can connect to any and all databases. Because <em>superuser</em>!</p>
<p>Remember you created a database for your user? Now, revoke connection privileges from it for "PUBLIC", too.</p>
<h2 id="listing-databases-and-granting-privileges">Listing databases and granting privileges</h2>
<p>Now, say the user "ada" needs another database, one that will contain data that "ada" wants to keep separate from the data in the database "ada". Connect to PostgreSQL as your user. Create a new database without specifying the owner.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb54-1" title="1"><span class="kw">CREATE</span> <span class="kw">DATABASE</span> hr_data;</a></code></pre></div>
<p>Now, type the command to list databases on your installation of PostgreSQL.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb55-1" title="1">\<span class="kw">list</span></a></code></pre></div>
<p>You will see something akin to the following. The entries in the "Collate", "Cypte", and "Access privileges" columns may differ. Thatâ€™s fine and can be ignored. Also, where you see "", youâ€™ll probably see your user name.</p>
<table>
<thead>
<tr class="header">
<th>Name</th>
<th>Owner</th>
<th>Encoding</th>
<th>Collate</th>
<th>Ctype</th>
<th>Access privileges</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ada</td>
<td>ada</td>
<td>UTF8</td>
<td>C</td>
<td>C</td>
<td>=T/ada +</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>ada=CTc/ada</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>UTF8</td>
<td>C</td>
<td>C</td>
<td></td>
</tr>
<tr class="even">
<td>hr_data</td>
<td></td>
<td>UTF8</td>
<td>C</td>
<td>C</td>
<td></td>
</tr>
<tr class="odd">
<td>odo</td>
<td>odo</td>
<td>UTF8</td>
<td>C</td>
<td>C</td>
<td>=T/odo +</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>odo=CTc/odo</td>
</tr>
<tr class="odd">
<td>postgres</td>
<td></td>
<td>UTF8</td>
<td>C</td>
<td>C</td>
<td></td>
</tr>
<tr class="even">
<td>template0</td>
<td></td>
<td>UTF8</td>
<td>C</td>
<td>C</td>
<td>=c/ +</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>=CTc/</td>
</tr>
<tr class="even">
<td>template1</td>
<td></td>
<td>UTF8</td>
<td>C</td>
<td>C</td>
<td>=c/ +</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>=CTc/</td>
</tr>
</tbody>
</table>
<p>You will see that for the database that you just created, "hr_data", that the owner is you. Go ahead and revoke all access to it from "PUBLIC" like you did in the last section. Once youâ€™ve done that, no one but you (and other superusers) can connect to the "hr_data" database. (You may want to exit the <code>psql</code> shell and try connecting with the credentials for the "ada" user just to make sure. If you do that, reconnect as your user so you can continue with the security management.)</p>
<p>Now, you need to add "ada" back to it so that user can connect to the database. The opposite of <code>REVOKE ... FROM ...</code> is <code>GRANT ... TO ...</code>. So, you will type the following:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb56-1" title="1"><span class="kw">GRANT</span> <span class="kw">CONNECT</span> <span class="kw">ON</span> <span class="kw">DATABASE</span> hr_data <span class="kw">TO</span> ada;</a></code></pre></div>
<p>Now, if you exit the <code>psql</code> shell and connect as "ada", you will see that user can connect. Make sure thatâ€™s true.</p>
<pre class="shell"><code>psql -U ada hr_data</code></pre>
<p>Once you have confirmed that "ada" can connect, make sure that user "odo" cannot connect.</p>
<pre class="shell"><code>psql -U odo hr_data</code></pre>
<p>That command should return the error message that reads that the user "does not have CONNECT privilege."</p>
<h2 id="time-to-clean-up">Time to clean up</h2>
<p>Time to clean up the entities that youâ€™ve created in this walk-through. You already know how to delete a user by using the <code>DROP USER</code> statement. Log in as your superuser and try to drop the "ada" user. You should see an error message similar to the following.</p>
<pre><code>ERROR:  role &quot;ada&quot; cannot be dropped because some objects depend on it
DETAIL:  owner of database ada
privileges for database hr_data</code></pre>
<p>This tells you that you canâ€™t drop that user because database objects in the system rely on the existence of the user "ada". This is the first example that youâ€™ve seen of <em>relational data</em>. The database "ada" is related to the user "ada" because user "ada" owns the database "ada". The database "hr_data" is related to the user "ada" because the user "ada" has access privileges for the database "hr_data".</p>
<p>This is one of the primary reasons that relational databases provide such an important role in application design and development. If you or your application puts data into the database that relates to other data, you canâ€™t just remove it without removing <em>all of the related data, too</em>!</p>
<p>To remove the related data from user "ada", you need to revoke the connect privilege on "hr_data" for user "ada". Then, you need to delete the database "ada" that user "ada" owns. Youâ€™ve seen some <code>REVOKE</code> statements in this article that revoke the connect privilege from "PUBLIC". Itâ€™s the same for an individual user, too, just replace "PUBLIC" with the name of the user.</p>
<p>Then, the opposite of <code>CREATE DATABASE</code> is <code>DROP DATABASE</code> just like the opposite of <code>CREATE USER</code> is <code>DROP USER</code>.</p>
<p>Putting together those two hints, you can type commands like this to get the job done.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb60-1" title="1"><span class="kw">REVOKE</span> <span class="kw">CONNECT</span> <span class="kw">ON</span> <span class="kw">DATABASE</span> hr_data <span class="kw">FROM</span> ada;</a>
<a class="sourceLine" id="cb60-2" title="2"><span class="kw">DROP</span> <span class="kw">DATABASE</span> ada;</a>
<a class="sourceLine" id="cb60-3" title="3"><span class="kw">DROP</span> <span class="fu">USER</span> ada;</a></code></pre></div>
<p>Run in that order, the first two statements remove the data <em>related</em> to the user "ada". Once thatâ€™s gone, you can finally remove the user "ada" itself.</p>
<p>Do the same for the user "odo", deleting the related data, first. Remember, you can run the <code>DROP</code> statement for the user "odo" to see what data relates to that user.</p>
<p><strong>Note</strong>: When you run a statement in PostgreSQL that results in an error message, do not worry! You have not corrupted anything! These are helpful statements to let you know that the state of the database wonâ€™t allow you to perform the requested operation. These kinds of error statements are guideposts for you to follow to get to the place you want to be.</p>
<h2 id="what-youve-done">What youâ€™ve done</h2>
<p>You have successfully created databases for yourself and other users. You have created a database with you as the owner and given access to it to another user. You have locked down databases so only owners (and superusers) can access them. You know how to see the owner of a database. You know how to remove a user from a database after removing all data related to the user.</p>
<p>This is the start of a lovely secure set of databases.</p>
<hr />
<h1 id="table-management-walk-through---part-i">Table Management Walk-Through - Part I</h1>
<p><strong>This is a walk-through</strong>: Please type along as you read whatâ€™s going on in this article.</p>
<p>In this walk-through, you will</p>
<ul>
<li>Learn about what a table is,</li>
<li>How to create and delete tables,</li>
<li>Who owns a table, and,</li>
<li>Learn about different data types that you can use when defining a table.</li>
</ul>
<p>You can now create users that can connect to the relational database management system. You can now create databases and secure them so only certain users can connect to them. Now, itâ€™s time to get into the part where you define the entities that actually hold the data: <strong>tables</strong>!</p>
<h2 id="what-is-a-table">What is a table?</h2>
<p>A table is a "logical" structure that defines how data is stored and contains that data that meets the definition. Most people think about tables like spreadsheets that have a specific number of columns and rows that contain the data.</p>
<p>It is called a "logical" structure because we reason about it in terms of columns and rows; however, the RDMBS is in charge of how the data is actually stored on disk and, quite often, for performance reasons, it does <em>not</em> look like rows and columns. The way it is stored on disk is called the "physical" structure because thatâ€™s what is the actual physical representation of it. We do not cover physical structures because they vary by RDBMS. If you become a <strong>database administrator</strong> in the future, you may have to learn such things.</p>
<p>Here is a spreadsheet that contains some data about puppies.</p>
<figure>
<img src="images/tables-puppies-spreadsheet.png" alt="Puppies spreadsheet" /><figcaption>Puppies spreadsheet</figcaption>
</figure>
<p>You can see that the columns are</p>
<ul>
<li>name</li>
<li>age_yrs</li>
<li>breed</li>
<li>weight_lbs</li>
<li>microchipped</li>
</ul>
<p>Now, look at the data each column contains. You can guess at what kind of data type is in each of them by their values. If you were to write that out using the data types that you know from JavaScript, you might come up with the following table.</p>
<table>
<thead>
<tr class="header">
<th>Column</th>
<th>Data type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>name</td>
<td>string</td>
</tr>
<tr class="even">
<td>age_yrs</td>
<td>number</td>
</tr>
<tr class="odd">
<td>breed</td>
<td>string</td>
</tr>
<tr class="even">
<td>weight_lbs</td>
<td>number</td>
</tr>
<tr class="odd">
<td>microchipped</td>
<td>Boolean</td>
</tr>
</tbody>
</table>
<p>In table definitions, you have to be more specific, unfortunately. This is so the database can know things like "the maximum length of the string" or "will the number have decimal points"? This is important information so that database can know how to store it most efficiently. The following table shows you the corresponding ANSI SQL data types for the JavaScript types from before.</p>
<table>
<thead>
<tr class="header">
<th>Column</th>
<th>JavaScript data type</th>
<th>Max length</th>
<th>ANSI SQL data type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>name</td>
<td>string</td>
<td>50</td>
<td>VARCHAR(50)</td>
</tr>
<tr class="even">
<td>age_yrs</td>
<td>number</td>
<td></td>
<td>NUMERIC(3,1)</td>
</tr>
<tr class="odd">
<td>breed</td>
<td>string</td>
<td>100</td>
<td>VARCHAR(100)</td>
</tr>
<tr class="even">
<td>weight_lbs</td>
<td>number</td>
<td></td>
<td>INTEGER</td>
</tr>
<tr class="odd">
<td>microchipped</td>
<td>Boolean</td>
<td></td>
<td>BOOLEAN</td>
</tr>
</tbody>
</table>
<p>You can see that "string" values map to something called a "VARCHAR" with a maximum length.</p>
<p>You can see that "number" values map to something called a "NUMERIC" with some numbers, or an INTEGER which is just a whole number.</p>
<p>You can see that "Boolean" values map to something called a "BOOLEAN" which is nice because thatâ€™s convenient.</p>
<h2 id="defining-tables">Defining tables</h2>
<p>To define a table, you need to know what the different pieces of related data it will store. Then, you need to know what kind each of those pieces are. Once you have that, you can create a table with an ANSI SQL statement.</p>
<h3 id="string-types">String types</h3>
<p>There are three kinds of commonly used string types that databases support based on the ANSI SQL standard. This section talks about them.</p>
<p>The most commonly used type is known as the <strong>CHARACTER VARYING</strong> type. It means that it can contain text of varying lengths up to a specified maximum. That maximum is provided when you define the table. Instead of having to type <em>CHARACTER VARYING</em> all the time, you can use its weirdly named alias <strong>VARCHAR</strong>, (pronounced "var-car" or "var-char" where each part rhymes with "car"). So, to specify that a column can hold up to 50 characters, you would write <code>VARCHAR(50)</code> in the table definition. (Remember, SQL is case insensitive for its keywords. You can also write <code>varchar(50)</code> or <code>VarChar(50)</code> if you so desired. Just be consistent.)</p>
<p>Another commonly used type is known simply as <strong>TEXT</strong>. This is a column that can contain an "unlimited" number of characters. You may ask yourself, "Why donâ€™t I just always use TEXT, then?" Performance is the reason. Columns with the <em>TEXT</em> type are notoriously slower than those with other string types. Use them judiciously.</p>
<p>Purposefully left out from this discussion is a type named <strong>CHARACTER</strong> or <strong>CHAR</strong>. It is like the <strong>VARCHAR</strong>, except that it is a fixed-width character field. This author has <em>never</em> seen it used in a production system except for Oracle DB which did not, at one time, support a Boolean type. Other than that, it was only useful back in the 1970s - 1990s when computer disk space and speed were slow and expensive.</p>
<h3 id="numeric-types">Numeric types</h3>
<p>ANSI SQL (and PostgreSQL) supports <strong>INTEGER</strong>, <strong>NUMERIC</strong>, and floating-point numbers.</p>
<p>The <em>INTEGER</em> should be familiar. Itâ€™s just a number. In PostgreSQL, it can hold almost all values that your application can handle. Thatâ€™s from -2,147,483,648 to +2,147,483,647. If, for some reason, you were writing a database that would contain a record for every person in the world, you would need integers bigger than that. To solve that problem, ANSI SQL (and PostgreSQL) supports the <strong>BIGINT</strong> type that will hold values between -9,223,372,036,854,775,808 to 9,223,372,036,854,775,807. If your application needs bigger integers, there are extensions available.</p>
<p>The <strong>NUMERIC</strong> type is a fixed-point number. When you specify it, it takes up to two arguments. The first number is the total number of digits that a number can have in that column. The second number is the number of digits after the decimal point that you want to track. The specification <em>NUMERIC(4,2)</em> will hold the number <em>23.22</em>, but not the numbers <em>123.22</em> (too many total digits) or <em>23.222</em> (which it will just ignore the extra decimal places and store <em>23.22</em>). These exact numbers are important for things like storing values of money, where rounding errors could cause significant errors in calculations.</p>
<p>If you donâ€™t care about rounding errors, you can use the <strong>DOUBLE PRECISION</strong>. There is no short alias for it. You can just put decimal numbers in there and they will come out pretty much the same. Donâ€™t use this kind of data type for columns that contain values of money because they will round and someone will get in trouble, eventually.</p>
<h2 id="other-data-types">Other data types</h2>
<p>PostgreSQL supports a lot of other data types, as well. It has specialized data types for money, dates and times, geometric types, network addresses, and JSON! Ones that you will use a lot in this course are the ones for dates and times, as well as the one for JSON.</p>
<p>Hereâ€™s the link to the documentation on <a href="https://www.postgresql.org/docs/current/datatype.html">PostgreSQL data types</a>. Go review the documentation for the types that support dates and times as you will need to know the <strong>TIMESTAMP</strong> and <strong>DATE</strong> types.</p>
<h2 id="naming-a-table">Naming a table</h2>
<p>Names of tables should not create spaces or dashes. They should contain only lower case letters, numbers, and underscores.</p>
<p>Conventionally, many software developers name their database table names as the plural form of the data that it holds. More importantly, many software libraries known as ORMs (which you will cover, this week) use the plural naming convention. You should use the plural naming convention while here at App Academy.</p>
<ul>
<li>Good table names
<ul>
<li>student_grades</li>
<li>office_locations</li>
<li>people</li>
</ul></li>
<li>Bad (incorrect) table names
<ul>
<li>Student Grades</li>
<li>office-locations</li>
<li>person</li>
</ul></li>
</ul>
<p><strong>Note</strong>: The opinion that database table names should be plural is the subject of heated debate among many software developers. We donâ€™t argue about it at App Academy. We acknowledge that it <em>really doesnâ€™t matter</em> how theyâ€™re named. You should just be consistent in the way theyâ€™re named. Because our tools will use the plural forms, we use the plural forms.</p>
<h2 id="writing-the-sql">Writing the SQL</h2>
<p>Creating a table with SQL has this general syntax.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb61-1" title="1"><span class="kw">CREATE</span> <span class="kw">TABLE</span> Â«table nameÂ» (</a>
<a class="sourceLine" id="cb61-2" title="2">  Â«column nameÂ» Â«data typeÂ»,</a>
<a class="sourceLine" id="cb61-3" title="3">  Â«column nameÂ» Â«data typeÂ»,</a>
<a class="sourceLine" id="cb61-4" title="4">  <span class="op">..</span>.</a>
<a class="sourceLine" id="cb61-5" title="5">  Â«column nameÂ» Â«data typeÂ»</a>
<a class="sourceLine" id="cb61-6" title="6">);</a></code></pre></div>
<p>A couple of things to note. First, it uses parentheses, not curly braces. Many developers that use curly brace languages like JavaScript will eventually, out of habit, put curly braces instead of parentheses. If you were to do that, the RDBMS will tell you that you have a syntax error. Just grin and replace the curly braces with parentheses.</p>
<p>Another thing to note is that the last column specification <em>cannot</em> have a comma after it. In JavaScript, we can have commas after the last entry in an array or in a literal object definition. Not so in SQL. Again, the RDBMS will tell you that there is a syntax error. Just delete that last comma.</p>
<p>Hereâ€™s the table that contains the column definitions for the "puppies" spreadsheet from before.</p>
<table>
<thead>
<tr class="header">
<th>Column</th>
<th>JavaScript data type</th>
<th>Max length</th>
<th>ANSI SQL data type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>name</td>
<td>string</td>
<td>50</td>
<td>VARCHAR(50)</td>
</tr>
<tr class="even">
<td>age_yrs</td>
<td>number</td>
<td></td>
<td>NUMERIC(3,1)</td>
</tr>
<tr class="odd">
<td>breed</td>
<td>string</td>
<td>100</td>
<td>VARCHAR(100)</td>
</tr>
<tr class="even">
<td>weight_lbs</td>
<td>number</td>
<td></td>
<td>INTEGER</td>
</tr>
<tr class="odd">
<td>microchipped</td>
<td>Boolean</td>
<td></td>
<td>BOOLEAN</td>
</tr>
</tbody>
</table>
<p>To write that as SQL, you would just put in the table name, column names, and data types in the syntax from above. You would get the following.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb62-1" title="1"><span class="kw">CREATE</span> <span class="kw">TABLE</span> puppies (</a>
<a class="sourceLine" id="cb62-2" title="2">  name <span class="dt">VARCHAR</span>(<span class="dv">50</span>),</a>
<a class="sourceLine" id="cb62-3" title="3">  age_yrs <span class="dt">NUMERIC</span>(<span class="dv">3</span>,<span class="dv">1</span>),</a>
<a class="sourceLine" id="cb62-4" title="4">  breed <span class="dt">VARCHAR</span>(<span class="dv">100</span>),</a>
<a class="sourceLine" id="cb62-5" title="5">  weight_lbs <span class="dt">INTEGER</span>,</a>
<a class="sourceLine" id="cb62-6" title="6">  microchipped <span class="dt">BOOLEAN</span></a>
<a class="sourceLine" id="cb62-7" title="7">);</a></code></pre></div>
<p>Log into your database, if youâ€™re not already. (Make sure youâ€™re in <em>your</em> database by looking at the prompt. It should read <code>Â«your user nameÂ»=#</code>.) Type in the SQL statement from above. If you do it correctly, PostgreSQL will return the message "CREATE TABLE".</p>
<h2 id="listing-tables-and-table-definitions">Listing tables and table definitions</h2>
<p>You can see the tables in your database by typing <code>\dt</code> at the <code>psql</code> shell prompt. The <code>\dt</code> command means "describe tables". If you do that now, assuming that youâ€™ve only created the "puppies" table, you should see the following with your user name, of course.</p>
<pre><code>           List of relations
 Schema |  Name   | Type  |   Owner
--------+---------+-------+------------
 public | puppies | table | </code></pre>
<p>The user that runs the SQL statement that creates the table is the owner of that table. Table owners, like database owners, will always be able to access the table and its data. If you want a user other than the one that youâ€™re logged in as to own the table, you have two ways of doing that.</p>
<ul>
<li>Log out and log in as the user that you want to own the table and run the <code>CREATE TABLE</code> statement as that user.</li>
<li>As the superuser, run the <code>SET ROLE Â«user nameÂ»</code> command to switch the current user and run the <code>CREATE TABLE</code> statement as that user.</li>
</ul>
<p>To see the definition of a particular table table, type <code>\d Â«table nameÂ»</code>. For puppies, type <code>\d puppies</code>. You should see the following output.</p>
<pre><code>                         Table &quot;public.puppies&quot;
    Column    |          Type          | Collation | Nullable | Default
--------------+------------------------+-----------+----------+---------
 name         | character varying(50)  |           |          |
 age_yrs      | numeric(3,1)           |           |          |
 breed        | character varying(100) |           |          |
 weight_lbs   | integer                |           |          |
 microchipped | boolean                |           |          |</code></pre>
<p>For now, ignore the "Collation", "Nullable", and "Default" columns in that output. The next article will address "Nullable" and "Default".</p>
<p>You can see that the data types that you provided have been translated into their ANSI SQL full name equivalents.</p>
<p>Now, connect to the "postgres" database using the <code>\c postgres</code> command. It should give you a message that youâ€™re now connected to the "postgres" database as your user. The prompt should change from one that has your name to <code>postgres=#</code>. Now, type <code>\dt</code> to list the tables in the "postgres" database. If you havenâ€™t created any tables there, it will read "Did not find any relations." If you type <code>\d puppies</code>, it will report that it canâ€™t find a relation named "puppies".</p>
<p>This is because youâ€™re in a different database than the one in which you created the "puppies" table. You just donâ€™t see the "puppies" table, here, because it doesnâ€™t exit. That table is in another database, your user database. Thatâ€™s how databases work: they provide an area where you can create tables in which youâ€™ll store data. Different databases have different tables. You canâ€™t easily get at tables in another database from the one that youâ€™re currently in. And, really, you donâ€™t want to. Databases provide the storage and security boundaries for data.</p>
<p>Change back to your user database by executing the command <code>\c Â«your user nameÂ»</code>.</p>
<h2 id="deleting-a-table">Deleting a table</h2>
<p>In the same way that you can delete users and databases by using the <code>DROP</code> command, you can do the same for tables. To get rid of the "puppies" table, execute the following SQL command.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb65-1" title="1"><span class="kw">DROP</span> <span class="kw">TABLE</span> puppies;</a></code></pre></div>
<p>It should tell you that it dropped the table. You can confirm that it is no longer there by executing the <code>\dt</code> command.</p>
<h2 id="what-youve-done-1">What youâ€™ve done</h2>
<p>In this section, you learned the basics about creating database entities called "tables" and their ownership. You learned that tables are where you store data. You discovered that the data that you store is defined by the columns and their data types. You can now write SQL to create and drop tables.</p>
<p>Next up, you will learn about special kinds of columns, column constraints, and building relations between tables.</p>
<hr />
<h1 id="table-management-walk-through---part-ii">Table Management Walk-Through - Part II</h1>
<p><strong>This is a walk-through</strong>: Please type along as you read whatâ€™s going on in this article.</p>
<p>In this walk-through, you will</p>
<ul>
<li>Learn about nullable columns,</li>
<li>Learn about default values for columns,</li>
<li>Learn how to make columns have unique values,</li>
<li>Learn about primary keys, and,</li>
<li>Learn about relating tables through foreign keys to maintain data and referential integrity.</li>
</ul>
<p>Here is the "puppies" spreadsheet, table definition, and the SQL to create it from the last article.</p>
<figure>
<img src="images/tables-puppies-spreadsheet.png" alt="Puppies spreadsheet" /><figcaption>Puppies spreadsheet</figcaption>
</figure>
<table>
<thead>
<tr class="header">
<th>Column</th>
<th>JavaScript data type</th>
<th>Max length</th>
<th>ANSI SQL data type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>name</td>
<td>string</td>
<td>50</td>
<td>VARCHAR(50)</td>
</tr>
<tr class="even">
<td>age_yrs</td>
<td>number</td>
<td></td>
<td>NUMERIC(3,1)</td>
</tr>
<tr class="odd">
<td>breed</td>
<td>string</td>
<td>100</td>
<td>VARCHAR(100)</td>
</tr>
<tr class="even">
<td>weight_lbs</td>
<td>number</td>
<td></td>
<td>INTEGER</td>
</tr>
<tr class="odd">
<td>microchipped</td>
<td>Boolean</td>
<td></td>
<td>BOOLEAN</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb66"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb66-1" title="1"><span class="kw">CREATE</span> <span class="kw">TABLE</span> puppies (</a>
<a class="sourceLine" id="cb66-2" title="2">  name <span class="dt">VARCHAR</span>(<span class="dv">50</span>),</a>
<a class="sourceLine" id="cb66-3" title="3">  age_yrs <span class="dt">NUMERIC</span>(<span class="dv">3</span>,<span class="dv">1</span>),</a>
<a class="sourceLine" id="cb66-4" title="4">  breed <span class="dt">VARCHAR</span>(<span class="dv">100</span>),</a>
<a class="sourceLine" id="cb66-5" title="5">  weight_lbs <span class="dt">INTEGER</span>,</a>
<a class="sourceLine" id="cb66-6" title="6">  microchipped <span class="dt">BOOLEAN</span></a>
<a class="sourceLine" id="cb66-7" title="7">);</a></code></pre></div>
<p>In this article, you will add more specifications to this table so that you can properly use it. Then, you will refactor it into two tables that relate to one another.</p>
<h2 id="nullable-columns">Nullable columns</h2>
<p>By default, when you define a table, each column does not require a value when you create a record (row). Look at the spreadsheet. You can see all of the rows in it have data in every column. The SQL that you wrote does not enforce that.</p>
<p>The value <code>NULL</code> is a strange value because it means <em>the absence of a value</em>. When a value in a row is <code>NULL</code>, that means that it didnâ€™t get entered. Many database administrators, experts in databases and the models of data in them, detest the value <code>NULL</code> for one reason: it adds a weird state.</p>
<p>Think about a Boolean value in JavaScript. It can one of two values: <code>true</code> or <code>false</code>. In databases, a "nullable" <code>BOOLEAN</code> column, that is a <code>BOOLEAN</code> column that can hold <code>NULL</code> values, can have <em>three</em> values in it: <code>TRUE</code>, <code>FALSE</code>, and <code>NULL</code>. What does that mean to you as a software developer? It is this weird third state that leads to a strange offshoot of mathematics named <a href="https://en.wikipedia.org/wiki/Three-valued_logic">three-valued logic</a>. To prevent that, you should (nearly) always put the <code>NOT NULL</code> constraint on each of your column definitions. That will make your previous SQL statement look like this.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb67-1" title="1"><span class="kw">CREATE</span> <span class="kw">TABLE</span> puppies (</a>
<a class="sourceLine" id="cb67-2" title="2">  name <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb67-3" title="3">  age_yrs <span class="dt">NUMERIC</span>(<span class="dv">3</span>,<span class="dv">1</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb67-4" title="4">  breed <span class="dt">VARCHAR</span>(<span class="dv">100</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb67-5" title="5">  weight_lbs <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb67-6" title="6">  microchipped <span class="dt">BOOLEAN</span> <span class="kw">NOT</span> <span class="kw">NULL</span></a>
<a class="sourceLine" id="cb67-7" title="7">);</a></code></pre></div>
<p>Type that SQL into your <code>psql</code> shell and execute it. (If you already have a "puppies" table, drop the existing one first.) Then, run <code>\d puppies</code>. You will see, now, that the column "Nullable" reads "not null" for every single one.</p>
<pre><code>                         Table &quot;public.puppies&quot;
    Column    |          Type          | Collation | Nullable | Default
--------------+------------------------+-----------+----------+---------
 name         | character varying(50)  |           | not null |
 age_yrs      | numeric(3,1)           |           | not null |
 breed        | character varying(100) |           | not null |
 weight_lbs   | integer                |           | not null |
 microchipped | boolean                |           | not null |</code></pre>
<p>Now, when someone tries to add data to the table, they must provide a value for every single column.</p>
<p><strong>Note</strong>: An empty string is <em>not</em> a <code>NULL</code> value. It is still possible for someone to insert the string "" into the "name" column, for example. There are ways to prevent that, but you should check it in your JavaScript code before actually inserting the data.</p>
<h2 id="default-values">Default values</h2>
<p>Sometimes, you just want a column to have a default value. When there is a default value, the applications that insert data into the table can just rely on the default value and not have to specify it.</p>
<p>For the "puppies" table, a reasonable default value for the "microchipped" column would be <code>FALSE</code>. You can add that to your SQL using the <code>DEFAULT</code> keyword.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb69-1" title="1"><span class="kw">CREATE</span> <span class="kw">TABLE</span> puppies (</a>
<a class="sourceLine" id="cb69-2" title="2">  name <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb69-3" title="3">  age_yrs <span class="dt">NUMERIC</span>(<span class="dv">3</span>,<span class="dv">1</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb69-4" title="4">  breed <span class="dt">VARCHAR</span>(<span class="dv">100</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb69-5" title="5">  weight_lbs <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb69-6" title="6">  microchipped <span class="dt">BOOLEAN</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="kw">FALSE</span></a>
<a class="sourceLine" id="cb69-7" title="7">);</a></code></pre></div>
<p>Drop the existing "puppies" table and type in that SQL. Then, run <code>\d puppies</code> to see how it shows up in the table definition.</p>
<h2 id="primary-keys">Primary keys</h2>
<p>Being able to identify a single row in a table is <em>very</em> important. Hereâ€™s the screenshot of the spreadsheet, again.</p>
<figure>
<img src="images/tables-puppies-spreadsheet.png" alt="Puppies spreadsheet" /><figcaption>Puppies spreadsheet</figcaption>
</figure>
<p>Letâ€™s say that the puppy named "Max" gains a couple of pounds. You want to update the spreadsheet. You scan through the list of names and find it on row 11. Then, you update the weight to be 69 pounds.</p>
<p>Now, what happens when you are tracking 300 dogs in the spreadsheet? What happens when your spreadsheet has 17 dogs named "Max"? It is helpful to have some way to uniquely identify a row in the spreadsheet. This is the idea behind a <strong>primary key</strong>. You can specify a column to be the primary key with the keywords <code>PRIMARY KEY</code>. A column that acts as a primary key cannot be <code>NULL</code>, so that is implied.</p>
<p>Hereâ€™s the spreadsheet with a new column in it named "id" that just contains numbers to uniquely identify each row.</p>
<figure>
<img src="https://-open-assets.s3-us-west-1.amazonaws.com/Module-SQL/assets/spreadsheet-puppies-with-primary-key.png" alt="Puppies spreadsheet with primary key" /><figcaption>Puppies spreadsheet with primary key</figcaption>
</figure>
<p>You may ask yourself, "Why canâ€™t I just use the row number as each rowâ€™s identifier?" Thatâ€™s a very valid question! Here is the reason why. You can see that "Max" has an "id" of 10 on row 11. What happens if you wanted to look at the data differently, say sorted by name? Hereâ€™s what that spreadsheet looks like.</p>
<figure>
<img src="images/spreadsheet-puppies-with-primary-key-sorted-by-name.png" alt="Puppies spreadsheet with primary key sorted by name" /><figcaption>Puppies spreadsheet with primary key sorted by name</figcaption>
</figure>
<p>You can see that when you sort them by name, if you relied on row number, "Max" now lives on row 10 rather than row 11. That changes the unique identifer of "Max" based on the way that you view the data. You want the unique identifier to <em>be part of the row definition</em> so that the number always stays with the row no matter how youâ€™ve sorted the data. You will always know that the row with "id" value of 10 is "Max".</p>
<p>Keeping track of what the next number would be in that column could cause you a lot or headaches. What if two people (or applications) were entering data at the same time? Who would get the correct "next id" and still have it be unique? The answer to that is to let the database handle it. All databases have some way of specifying that you want to set the column to a special data type that will auto-assign and auto-increment an integer value for the column. In PostgreSQL, that special data type is called <code>SERIAL</code>.</p>
<p>Putting that all together, you would add a new column definition to your table with the name of "id" and the type <code>SERIAL</code>. Then, to specify that it is the primary key, you can do it one of two ways. The following example shows it as part of the column definition.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb70-1" title="1"><span class="kw">CREATE</span> <span class="kw">TABLE</span> puppies (</a>
<a class="sourceLine" id="cb70-2" title="2">  <span class="kw">id</span> SERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</a>
<a class="sourceLine" id="cb70-3" title="3">  name <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb70-4" title="4">  age_yrs <span class="dt">NUMERIC</span>(<span class="dv">3</span>,<span class="dv">1</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb70-5" title="5">  breed <span class="dt">VARCHAR</span>(<span class="dv">100</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb70-6" title="6">  weight_lbs <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb70-7" title="7">  microchipped <span class="dt">BOOLEAN</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="kw">FALSE</span></a>
<a class="sourceLine" id="cb70-8" title="8">);</a></code></pre></div>
<p>Or, you can put it in what is known as <strong>constraint syntax</strong> after the columns specifications but before the close parenthesis.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb71-1" title="1"><span class="kw">CREATE</span> <span class="kw">TABLE</span> puppies (</a>
<a class="sourceLine" id="cb71-2" title="2">  <span class="kw">id</span> SERIAL,</a>
<a class="sourceLine" id="cb71-3" title="3">  name <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb71-4" title="4">  age_yrs <span class="dt">NUMERIC</span>(<span class="dv">3</span>,<span class="dv">1</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb71-5" title="5">  breed <span class="dt">VARCHAR</span>(<span class="dv">100</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb71-6" title="6">  weight_lbs <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb71-7" title="7">  microchipped <span class="dt">BOOLEAN</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="kw">FALSE</span>,</a>
<a class="sourceLine" id="cb71-8" title="8">  <span class="kw">PRIMARY</span> <span class="kw">KEY</span>(<span class="kw">id</span>)</a>
<a class="sourceLine" id="cb71-9" title="9">);</a></code></pre></div>
<p>Either way you do it, when you view the output of <code>\d puppies</code>, you see some new things in the output.</p>
<pre><code>                                      Table &quot;public.puppies&quot;
    Column    |          Type          | Collation | Nullable |               Default
--------------+------------------------+-----------+----------+-------------------------------------
 id           | integer                |           | not null | nextval(&#39;puppies_id_seq&#39;::regclass)
 name         | character varying(50)  |           | not null |
 age_yrs      | numeric(3,1)           |           | not null |
 breed        | character varying(100) |           | not null |
 weight_lbs   | integer                |           | not null |
 microchipped | boolean                |           | not null | false
Indexes:
    &quot;puppies_pkey&quot; PRIMARY KEY, btree (id)</code></pre>
<p>First, youâ€™ll notice that there is a weird default value for the "id" column. Thatâ€™s the way that PostgreSQL populates it with a new integer value every time you add a new row.</p>
<p>You will also see that that there is a section named "Indexes" after the column specifications. This shows that there is a thing named "puppies_pkey" which is the primary key on the column "id".</p>
<h2 id="unique-values">Unique values</h2>
<p>Sometimes, you want all of the data in a column to be unique. For example, if you a table of people records. You want to collect their email address for them to sign up for your Web site. In general, people donâ€™t share email addresses (although it has been known to happen). You can put a constraint on a column by putting <code>UNIQUE</code> in the columnâ€™s definition. For example, hereâ€™s a sample "people" table with a unique constraint on the email column.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb73-1" title="1"><span class="kw">CREATE</span> <span class="kw">TABLE</span> people (</a>
<a class="sourceLine" id="cb73-2" title="2">  <span class="kw">id</span> SERIAL,</a>
<a class="sourceLine" id="cb73-3" title="3">  first_name <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb73-4" title="4">  last_name <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb73-5" title="5">  email <span class="dt">VARCHAR</span>(<span class="dv">250</span>) <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">UNIQUE</span>,</a>
<a class="sourceLine" id="cb73-6" title="6">  <span class="kw">PRIMARY</span> <span class="kw">KEY</span> (<span class="kw">id</span>)</a>
<a class="sourceLine" id="cb73-7" title="7">);</a></code></pre></div>
<p>When you use the <code>\d people</code> command to view the definition of the table, you will see this.</p>
<pre><code>                                      Table &quot;public.people&quot;
   Column   |          Type          | Collation | Nullable |              Default
------------+------------------------+-----------+----------+------------------------------------
 id         | integer                |           | not null | nextval(&#39;people_id_seq&#39;::regclass)
 first_name | character varying(50)  |           | not null |
 last_name  | character varying(50)  |           | not null |
 email      | character varying(250) |           | not null |
Indexes:
    &quot;people_pkey&quot; PRIMARY KEY, btree (id)
    &quot;people_email_key&quot; UNIQUE CONSTRAINT, btree (email)</code></pre>
<p>Down there at the bottom, you see that PostgreSQL has added a <code>UNIQUE CONSTRAINT</code> to the list of indexes for the "email" field. Now, if someone tried to put an email address into the table that someone had previously used, then the database would return an error.</p>
<pre><code>ERROR:  duplicate key value violates unique constraint &quot;people_email_key&quot;
DETAIL:  Key (email)=(a) already exists.</code></pre>
<h2 id="refactor-for-data-integrity">Refactor for data integrity</h2>
<p>Now is the time for thinking about the nature of the data. When you create database tables, you need to ask yourself about the data that youâ€™re going to store in them. One of the first questions that you should ask yourself is, "Do any of the columns have values that come from a list?" Or, another way to ask that is, "Do any of the columns come from a set of predefined values?" If you look at this data, does anything seem like it comes from a list, or that the data could repeat itself?</p>
<p>Take a look, again, at the spreadsheet. Does anything jump out at you?</p>
<figure>
<img src="images/spreadsheet-puppies-with-primary-key-sorted-by-name.png" alt="Puppies spreadsheet with primary key sorted by name" /><figcaption>Puppies spreadsheet with primary key sorted by name</figcaption>
</figure>
<p>If you looked at it and answered "the breed column", thatâ€™s the ticket! The values that go into the breed column is finite. You donâ€™t want one person typing "Corgi" and another person typing "CORGI" and another "corgi" because, as you know, those are <em>three different values</em>! You want them all to be the same value! Supporting this is the primary reason that relational databases exist.</p>
<p>Instead of having just one table, you could have two tables. One that contains the puppy information and another that contains the breed information. Then, using the magic of relational databases, you can create a relation between the two tables so that the "puppies" table will reference entries in the "breeds" table.</p>
<p>This process is called <strong>normalization</strong>. Itâ€™s a <em>really big deal</em> in database communities. And, itâ€™s a really big deal for application developers to maintain the integrity of the data. Bad data leads to bad applications.</p>
<p>To do this follows a fairly simple set of steps.</p>
<ol type="1">
<li>Figure out what related data repeats itself. In this case, it is only the single column that contains the <strong>breed</strong> names.</li>
<li>Create a new table to hold that data. Make sure it has a primary key. In this case, you can create a "breeds" table that contains an "id" the name of the breed.</li>
<li>Replace all of the columns in the original table that you extracted with a single value that will contain the corresponding "id" value from the new table. In this case, you will replace the "breed" column with a column named "breed_id" because it will have the id of the specific breed from the "breeds" table.</li>
</ol>
<p>Hereâ€™s what that would look like with two spreadsheets.</p>
<p>[Puppies and breed spreadsheets normalized]</p>
<p>You might think to yourself, "Thatâ€™s not simpler! Thatâ€™s â€¦ thatâ€™s harder!" From a human perspective looking at the two separate tables and associating the id in the "breed_id" column with the value in the "id" column of the "breeds" table to lookup the name of the breed <em>is</em> harder. But, SQL provides tools to make this <em>very easy</em>. You will learn about that in the homework, tonight, and in all of the database work that youâ€™ll be doing from here on out. Eventually, thinking this way about data will become second nature.</p>
<p>To represent this in SQL, you will need two SQL statements. The first one, the one for the "breeds" table, you should be able to construct that already with the knowledge that you have. It would look like this. Type this into your <code>plsql</code> shell.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb76-1" title="1"><span class="kw">CREATE</span> <span class="kw">TABLE</span> breeds (</a>
<a class="sourceLine" id="cb76-2" title="2">  <span class="kw">id</span> SERIAL,</a>
<a class="sourceLine" id="cb76-3" title="3">  name <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb76-4" title="4">  <span class="kw">PRIMARY</span> <span class="kw">KEY</span> (<span class="kw">id</span>)</a>
<a class="sourceLine" id="cb76-5" title="5">);</a></code></pre></div>
<p>Now, hereâ€™s the new thing. You want the database to make sure that the value in the "breed_id" column of the "puppies" table references the value in the "id" table of the "breeds" table. This reference is called a <strong>foreign key</strong>. That means that the value in the column <em>must exist</em> as the value of a primary key in the table that it references. This <strong>referential integrity</strong> is the backbone of relational databases. It prevents bad data from getting put into those foreign key columns.</p>
<p>Hereâ€™s what the new "puppies" SQL looks like. Drop the old "puppies" table and type this SQL in there.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb77-1" title="1"><span class="kw">CREATE</span> <span class="kw">TABLE</span> puppies (</a>
<a class="sourceLine" id="cb77-2" title="2">  <span class="kw">id</span> SERIAL,</a>
<a class="sourceLine" id="cb77-3" title="3">  name <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb77-4" title="4">  age_yrs <span class="dt">NUMERIC</span>(<span class="dv">3</span>,<span class="dv">1</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb77-5" title="5">  breed_id <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb77-6" title="6">  weight_lbs <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb77-7" title="7">  microchipped <span class="dt">BOOLEAN</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="kw">FALSE</span>,</a>
<a class="sourceLine" id="cb77-8" title="8">  <span class="kw">PRIMARY</span> <span class="kw">KEY</span>(<span class="kw">id</span>),</a>
<a class="sourceLine" id="cb77-9" title="9">  <span class="kw">FOREIGN</span> <span class="kw">KEY</span> (breed_id) <span class="kw">REFERENCES</span> breeds(<span class="kw">id</span>)</a>
<a class="sourceLine" id="cb77-10" title="10">);</a></code></pre></div>
<p>That new thing at the bottom of the definition, thatâ€™s how you relate one table to another. If follows the syntax</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb78-1" title="1"><span class="kw">FOREIGN</span> <span class="kw">KEY</span> (Â«column name <span class="kw">in</span> this tableÂ»)</a>
<a class="sourceLine" id="cb78-2" title="2">  <span class="kw">REFERENCES</span> Â«other <span class="kw">table</span> nameÂ»(Â«primary <span class="kw">key</span> <span class="kw">column</span> <span class="kw">in</span> other tableÂ»)</a></code></pre></div>
<p>Looking at the spreadsheets, again, the presence of the foreign key would make it <em>impossible</em> for someone to enter a value in the "breed_id" column that did not exist in the "id" column of the "breeds" table.</p>
<p>[Puppies and breed spreadsheets normalized]</p>
<p>You can see that the puppies with ids of 1 and 9, "Cooper" and "Leinni", both have the "breed_id" of 8. That means theyâ€™re both "Miniature Schnauzers". What if, originally, someone had misspelled "Schnauzers"? If it was still just a text column in the "puppies" sheet, youâ€™d have to go find and replace every single instance of the misspelling. Now, because itâ€™s only spelled once and then <em>referenced</em>, you would only need to update the misspelling in one place!</p>
<h2 id="order-of-table-declarations">Order of table declarations</h2>
<p>The order of running these table definitions is important. Because "puppies" now relies on "breeds" to exist for that foreign key relationship, you <em>must</em> create the "breeds" table first. If you had tried to create the "puppies" table first, you would see the following error message.</p>
<pre><code>ERROR: relation &quot;breeds&quot; does not exist</code></pre>
<p>Now that you have both of those tables in your database, what do you think would happen if you tried to drop the "breeds" table? Another table depends on it. When you tried to drop a user that owned a database, you got an error because that database object depended on that user existing, the same things happens now.</p>
<p>Type the SQL to drop the "breeds" table from the database. You should see the following error message.</p>
<pre><code>ERROR:  cannot drop table breeds because other objects depend on it
DETAIL:  constraint puppies_breed_id_fkey on table puppies depends on table breeds
HINT:  Use DROP ... CASCADE to drop the dependent objects too.</code></pre>
<p>You can see that PostgreSQL has told you that other things depend on the "breeds" table and, specifically, a thing called "puppies_breed_id_fkey" depends on it. That is the auto-generated name for the foreign key that you created in the "puppies" table. It took the name of the table, the name of the column, and the string "fkey" and joined them all together with underscores.</p>
<p>In the homework for tomorrow, you will see how to <em>join</em> together two tables into one virtual table so that the breed names are right there along with the puppies data.</p>
<h2 id="what-youve-done-2">What youâ€™ve done</h2>
<p>In this walk-through, you</p>
<ul>
<li>Learned about nullable columns and how to control that behavior by writing <code>NOT NULL</code> in your column specifications</li>
<li>Learned that <code>NULL</code> means an "absence of a value" which makes database administrators groan with displeasure</li>
<li>Learned about how to specify default values for a column</li>
<li>Learned the purpose of and how to declare integer-valued primary keys for a table using the <code>PRIMARY KEY</code> constraint and <code>SERIAL</code> data type</li>
<li>Learned about <em>normalization</em> and the steps to refactor a table to remove duplicated data</li>
<li>Learned the purpose of and how to declare foreign keys to relate the column of one table to the primary key of another table</li>
</ul>
<p>[Puppies and breed spreadsheets normalized]: images/spreadsheet-puppies-and-breeds-normalized.pngimages/spreadsheet-puppies-and-breeds-normalized.pngort "[TOC]" {cmd="toc" depthFrom=2 depthTo=6 orderedList=false} â€“&gt; ________________________________________________________________________________</p>
<p><strong>This is a walk-through</strong>: Please type along as you read whatâ€™s going on in this article.</p>
<p>In this walk-through, you will</p>
<ul>
<li>Learn about nullable columns,</li>
<li>Learn about default values for columns,</li>
<li>Learn how to make columns have unique values,</li>
<li>Learn about primary keys, and,</li>
<li>Learn about relating tables through foreign keys to maintain data and referential integrity.</li>
</ul>
<p>Here is the "puppies" spreadsheet, table definition, and the SQL to create it from the last article.</p>
<figure>
<img src="images/tables-puppies-spreadsheet.png" alt="Puppies spreadsheet" /><figcaption>Puppies spreadsheet</figcaption>
</figure>
<table>
<thead>
<tr class="header">
<th>Column</th>
<th>JavaScript data type</th>
<th>Max length</th>
<th>ANSI SQL data type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>name</td>
<td>string</td>
<td>50</td>
<td>VARCHAR(50)</td>
</tr>
<tr class="even">
<td>age_yrs</td>
<td>number</td>
<td></td>
<td>NUMERIC(3,1)</td>
</tr>
<tr class="odd">
<td>breed</td>
<td>string</td>
<td>100</td>
<td>VARCHAR(100)</td>
</tr>
<tr class="even">
<td>weight_lbs</td>
<td>number</td>
<td></td>
<td>INTEGER</td>
</tr>
<tr class="odd">
<td>microchipped</td>
<td>Boolean</td>
<td></td>
<td>BOOLEAN</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb81"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb81-1" title="1"><span class="kw">CREATE</span> <span class="kw">TABLE</span> puppies (</a>
<a class="sourceLine" id="cb81-2" title="2">  name <span class="dt">VARCHAR</span>(<span class="dv">50</span>),</a>
<a class="sourceLine" id="cb81-3" title="3">  age_yrs <span class="dt">NUMERIC</span>(<span class="dv">3</span>,<span class="dv">1</span>),</a>
<a class="sourceLine" id="cb81-4" title="4">  breed <span class="dt">VARCHAR</span>(<span class="dv">100</span>),</a>
<a class="sourceLine" id="cb81-5" title="5">  weight_lbs <span class="dt">INTEGER</span>,</a>
<a class="sourceLine" id="cb81-6" title="6">  microchipped <span class="dt">BOOLEAN</span></a>
<a class="sourceLine" id="cb81-7" title="7">);</a></code></pre></div>
<p>In this article, you will add more specifications to this table so that you can properly use it. Then, you will refactor it into two tables that relate to one another.</p>
<hr />
<h1 id="database-management-project">Database Management Project</h1>
<p>This project asks you to write some SQL to make some tests pass. You must do them in order of the file name.</p>
<p>Youâ€™ll be writing your SQL in *.sql files. This is just like writing it in the <code>psql</code> client. You put semicolons after each statement. But, you donâ€™t have to worry about silly mistakes because itâ€™s in a file and theyâ€™re easy to fix.</p>
<h2 id="instructions">Instructions</h2>
<ul>
<li>Clone the project from https://github.com/-starters/sql-database-management-starter.</li>
<li><code>cd</code> into the project folder</li>
<li><code>npm install</code> to install dependencies in the project root directory</li>
<li><code>npm test</code> to run the specs</li>
<li>You can view the test cases in <code>test</code>. Your job is to write code in
<ul>
<li><strong>01-create-users.sql</strong> to write statements that will create users</li>
<li><strong>01-create-databases.sql</strong> to write statements that will create databases</li>
<li><strong>01-create-aa-times-tables.sql</strong> will create related tables in a database</li>
</ul></li>
</ul>
<hr />
<h1 id="week-10-day-2-data-data-data" data-ignore="true">WEEK-10 DAY-2<br><em>Data! Data! Data!</em></h1>
<hr />
<h1 id="sql-learning-objectives">SQL Learning Objectives</h1>
<p>SQL is the language of relational data. It is one of the core languages that most software developers know because of its prevalence in the industry due to the common use of RDBMSes. The objectives for your SQL learning journey cover:</p>
<ul>
<li>How to use the <code>SELECT ... FROM ...</code> statement to select data from a single table</li>
<li>How to use the <code>WHERE</code> clause on <code>SELECT</code>, <code>UPDATE</code>, and <code>DELETE</code> statements to narrow the scope of the command</li>
<li>How to use the <code>JOIN</code> keyword to join two (or more) tables together into a single virtual table</li>
<li>How to use the <code>INSERT</code> statement to insert data into a table</li>
<li>How to use an <code>UPDATE</code> statement to update data in a table</li>
<li>How to use a <code>DELETE</code> statement to remove data from a table</li>
<li>How to use a seed file to populate data in a database</li>
<li>How to perform relational database design</li>
<li>How to use transactions to group multiple SQL commands into one succeed or fail operation</li>
<li>How to apply indexes to tables to improve performance</li>
<li>Explain what and why someone would use <code>EXPLAIN</code></li>
<li>Demonstrate how to install and use the <strong>node-postgres</strong> library and its <code>Pool</code> class to query a PostgreSQL-managed database</li>
<li>Explain how to write prepared statements with placeholders for parameters of the form "$1", "$2", and so on</li>
</ul>
<hr />
<h1 id="retrieving-rows-from-a-table-using-select">Retrieving Rows From A Table Using SELECT</h1>
<p>In the first reading, we covered SQL and PostgreSQL and how to set up PostgreSQL. In this reading, weâ€™re going to learn how to write a simple SQL query using SELECT.</p>
<h2 id="what-is-a-query">What is a query?</h2>
<p>SQL stands for <em>Structured Query Language</em>, and whenever we write SQL weâ€™re usually querying a database. A query is simply a question weâ€™re asking a database, and weâ€™re aiming to get a response back. The response comes back to us as a list of table rows.</p>
<h2 id="example-table">Example table</h2>
<p>Letâ€™s say we had the following database table called <code>puppies</code>. Weâ€™ll use this table to make our queries:</p>
<p><em><strong>puppies table</strong></em></p>
<table>
<thead>
<tr class="header">
<th>name</th>
<th>age_yrs</th>
<th>breed</th>
<th>weight_lbs</th>
<th>microchipped</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Cooper</td>
<td>1</td>
<td>Miniature Schnauzer</td>
<td>18</td>
<td>yes</td>
</tr>
<tr class="even">
<td>Indie</td>
<td>0.5</td>
<td>Yorkshire Terrier</td>
<td>13</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>Kota</td>
<td>0.7</td>
<td>Australian Shepherd</td>
<td>26</td>
<td>no</td>
</tr>
<tr class="even">
<td>Zoe</td>
<td>0.8</td>
<td>Korean Jindo</td>
<td>32</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>Charley</td>
<td>1.5</td>
<td>Basset Hound</td>
<td>25</td>
<td>no</td>
</tr>
<tr class="even">
<td>Ladybird</td>
<td>0.6</td>
<td>Labradoodle</td>
<td>20</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>Callie</td>
<td>0.9</td>
<td>Corgi</td>
<td>16</td>
<td>no</td>
</tr>
<tr class="even">
<td>Jaxson</td>
<td>0.4</td>
<td>Beagle</td>
<td>19</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>Leinni</td>
<td>1</td>
<td>Miniature Schnauzer</td>
<td>25</td>
<td>yes</td>
</tr>
<tr class="even">
<td>Max</td>
<td>1.6</td>
<td>German Shepherd</td>
<td>65</td>
<td>no</td>
</tr>
</tbody>
</table>
<h2 id="using-psql-in-the-terminal">Using psql in the terminal</h2>
<p>As we covered in the first reading, psql allows us to access the PostgreSQL server and make queries via the terminal. Open up the terminal on your machine, and connect to the PostgreSQL server by using the following psql command:</p>
<pre class="shell"><code>psql -U postgres</code></pre>
<p>The above command lets you access the PostgreSQL server as the user â€˜postgresâ€™ (<code>-U</code> stands for user). After you enter this command, youâ€™ll be prompted for the password that you set for the â€˜postgresâ€™ user during installation. Type it in, and hit Enter. Once youâ€™ve successfully logged in, you should see the following in the terminal:</p>
<pre class="shell"><code>Password for user postgres:
psql (11.5, server 11.6)
Type &quot;help&quot; for help.

postgres=#</code></pre>
<p>You can exit psql at anytime with the command <code>\q</code>, and you can log back in with <code>psql -U postgres</code>. (<em>See this <a href="https://www.postgresql.org/docs/9.1/sql-createindex.html">Postgres Cheatsheet</a> for a list of more PSQL commands.</em>)</p>
<p>Weâ€™ll use the following PostgreSQL to create the <code>puppies</code> table above. After youâ€™ve logged into the psql server, type the following code and hit Enter.</p>
<p><em><strong>puppies.sql</strong></em></p>
<div class="sourceCode" id="cb84"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb84-1" title="1"><span class="kw">create</span> <span class="kw">table</span> puppies (</a>
<a class="sourceLine" id="cb84-2" title="2">  name <span class="dt">VARCHAR</span>(<span class="dv">100</span>),</a>
<a class="sourceLine" id="cb84-3" title="3">  age_yrs <span class="dt">NUMERIC</span>(<span class="dv">2</span>,<span class="dv">1</span>),</a>
<a class="sourceLine" id="cb84-4" title="4">  breed <span class="dt">VARCHAR</span>(<span class="dv">100</span>),</a>
<a class="sourceLine" id="cb84-5" title="5">  weight_lbs <span class="dt">INT</span>,</a>
<a class="sourceLine" id="cb84-6" title="6">  microchipped <span class="dt">BOOLEAN</span></a>
<a class="sourceLine" id="cb84-7" title="7">);</a>
<a class="sourceLine" id="cb84-8" title="8"></a>
<a class="sourceLine" id="cb84-9" title="9"><span class="kw">insert</span> <span class="kw">into</span> puppies</a>
<a class="sourceLine" id="cb84-10" title="10"><span class="kw">values</span></a>
<a class="sourceLine" id="cb84-11" title="11">(<span class="st">&#39;Cooper&#39;</span>, <span class="dv">1</span>, <span class="st">&#39;Miniature Schnauzer&#39;</span>, <span class="dv">18</span>, <span class="st">&#39;yes&#39;</span>);</a>
<a class="sourceLine" id="cb84-12" title="12"></a>
<a class="sourceLine" id="cb84-13" title="13"><span class="kw">insert</span> <span class="kw">into</span> puppies</a>
<a class="sourceLine" id="cb84-14" title="14"><span class="kw">values</span></a>
<a class="sourceLine" id="cb84-15" title="15">(<span class="st">&#39;Indie&#39;</span>, <span class="fl">0.5</span>, <span class="st">&#39;Yorkshire Terrier&#39;</span>, <span class="dv">13</span>, <span class="st">&#39;yes&#39;</span>),</a>
<a class="sourceLine" id="cb84-16" title="16">(<span class="st">&#39;Kota&#39;</span>, <span class="fl">0.7</span>, <span class="st">&#39;Australian Shepherd&#39;</span>, <span class="dv">26</span>, <span class="st">&#39;no&#39;</span>),</a>
<a class="sourceLine" id="cb84-17" title="17">(<span class="st">&#39;Zoe&#39;</span>, <span class="fl">0.8</span>, <span class="st">&#39;Korean Jindo&#39;</span>, <span class="dv">32</span>, <span class="st">&#39;yes&#39;</span>),</a>
<a class="sourceLine" id="cb84-18" title="18">(<span class="st">&#39;Charley&#39;</span>, <span class="fl">1.5</span>, <span class="st">&#39;Basset Hound&#39;</span>, <span class="dv">25</span>, <span class="st">&#39;no&#39;</span>),</a>
<a class="sourceLine" id="cb84-19" title="19">(<span class="st">&#39;Ladybird&#39;</span>, <span class="fl">0.6</span>, <span class="st">&#39;Labradoodle&#39;</span>, <span class="dv">20</span>, <span class="st">&#39;yes&#39;</span>),</a>
<a class="sourceLine" id="cb84-20" title="20">(<span class="st">&#39;Callie&#39;</span>, <span class="fl">0.9</span>, <span class="st">&#39;Corgi&#39;</span>, <span class="dv">16</span>, <span class="st">&#39;no&#39;</span>),</a>
<a class="sourceLine" id="cb84-21" title="21">(<span class="st">&#39;Jaxson&#39;</span>, <span class="fl">0.4</span>, <span class="st">&#39;Beagle&#39;</span>, <span class="dv">19</span>, <span class="st">&#39;yes&#39;</span>),</a>
<a class="sourceLine" id="cb84-22" title="22">(<span class="st">&#39;Leinni&#39;</span>, <span class="dv">1</span>, <span class="st">&#39;Miniature Schnauzer&#39;</span>, <span class="dv">25</span>, <span class="st">&#39;yes&#39;</span> ),</a>
<a class="sourceLine" id="cb84-23" title="23">(<span class="st">&#39;Max&#39;</span>, <span class="fl">1.6</span>, <span class="st">&#39;German Shepherd&#39;</span>, <span class="dv">65</span>, <span class="st">&#39;no&#39;</span>);</a></code></pre></div>
<p>In the above SQL, we created a new table called <code>puppies</code>, and we gave it the following columns: <code>name</code>, <code>age_yrs</code>, <code>breed</code>, <code>weight_lbs</code>, and <code>microchipped</code>. We filled the table with ten rows containing data for each puppy, by using <code>insert into puppies values ()</code>.</p>
<p>We used the following <a href="https://www.postgresql.org/docs/9.1/using-explain.html">PostgreSQL data types</a>: <code>VARCHAR</code>, <code>NUMERIC</code>, <code>INT</code>, and <code>BOOLEAN</code>.</p>
<ul>
<li><code>VARCHAR(n)</code> is a variable-length character string that lets you store up to <em>n</em> characters. Here weâ€™ve set the character limit to 100 for the <code>name</code> and <code>breed</code> columns.</li>
<li><code>NUMERIC(p,s)</code> is a floating-point number with <em>p</em> digits and <em>s</em> number of places after the decimal point. Here weâ€™ve set the values for the <code>age_yrs</code> column to up to two digits before the decimal and one place after the decimal.</li>
<li><code>INT</code> is a 4-byte integer, which weâ€™ve set on the <code>weight_lbs</code> column.</li>
<li><code>BOOLEAN</code> is, of course, a Boolean value. Weâ€™ve set the <code>microchipped</code> column to accept Boolean values. SQL accepts the standard Boolean values <code>true</code>, <code>false</code>, or <code>null</code>. However, youâ€™ll note that weâ€™ve used <code>yes</code> and <code>no</code> in our <code>microchipped</code> column because <a href="https://www.postgresql.org/docs/9.1/indexes.html">PostgreSQL Booleans</a> can be any of the following values:</li>
</ul>
<table>
<thead>
<tr class="header">
<th>TRUE</th>
<th>FALSE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>true</td>
<td>false</td>
</tr>
<tr class="even">
<td>â€˜tâ€™</td>
<td>â€˜fâ€™</td>
</tr>
<tr class="odd">
<td>â€˜trueâ€™</td>
<td>â€˜falseâ€™</td>
</tr>
<tr class="even">
<td>â€˜yesâ€™</td>
<td>â€˜noâ€™</td>
</tr>
<tr class="odd">
<td>â€˜yâ€™</td>
<td>â€˜nâ€™</td>
</tr>
<tr class="even">
<td>â€˜1â€™</td>
<td>â€˜0â€™</td>
</tr>
</tbody>
</table>
<h2 id="simple-select-query">Simple SELECT Query</h2>
<p>We can write a simple <a href="https://www.postgresql.org/docs/8.1/performance-tips.html">SELECT query</a> to get results back from the table above. The syntax for the SELECT query is <code>SELECT [columns] FROM [table]</code>.</p>
<h3 id="select-all-rows">SELECT all rows</h3>
<p>Using <code>SELECT *</code> is a quick way to get back all the rows in a given table. It is discouraged in queries that you write for your applications. Use it only when playing around with data, not for production code.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb85-1" title="1"><span class="kw">SELECT</span> <span class="op">*</span></a>
<a class="sourceLine" id="cb85-2" title="2"><span class="kw">FROM</span>   puppies;</a></code></pre></div>
<p>Type the query above into your psql terminal, and make sure to add a semicolon at the end, which terminates the statement. <code>SELECT</code> and <code>FROM</code> should be capitalized. The above query should give us back the entire <code>puppies</code> table:</p>
<table>
<thead>
<tr class="header">
<th>name</th>
<th>age_yrs</th>
<th>breed</th>
<th>weight_lbs</th>
<th>microchipped</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Cooper</td>
<td>1</td>
<td>Miniature Schnauzer</td>
<td>18</td>
<td>yes</td>
</tr>
<tr class="even">
<td>Indie</td>
<td>0.5</td>
<td>Yorkshire Terrier</td>
<td>13</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>Kota</td>
<td>0.7</td>
<td>Australian Shepherd</td>
<td>26</td>
<td>no</td>
</tr>
<tr class="even">
<td>Zoe</td>
<td>0.8</td>
<td>Korean Jindo</td>
<td>32</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>Charley</td>
<td>1.5</td>
<td>Basset Hound</td>
<td>25</td>
<td>no</td>
</tr>
<tr class="even">
<td>Ladybird</td>
<td>0.6</td>
<td>Labradoodle</td>
<td>20</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>Callie</td>
<td>0.9</td>
<td>Corgi</td>
<td>16</td>
<td>no</td>
</tr>
<tr class="even">
<td>Jaxson</td>
<td>0.4</td>
<td>Beagle</td>
<td>19</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>Leinni</td>
<td>1</td>
<td>Miniature Schnauzer</td>
<td>25</td>
<td>yes</td>
</tr>
<tr class="even">
<td>Max</td>
<td>1.6</td>
<td>German Shepherd</td>
<td>65</td>
<td>no</td>
</tr>
</tbody>
</table>
<h3 id="select-by-column">SELECT by column</h3>
<p>We can see all the rows in a given column by using <code>SELECT [column name]</code>.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb86-1" title="1"><span class="kw">SELECT</span> name</a>
<a class="sourceLine" id="cb86-2" title="2"><span class="kw">FROM</span>   puppies;</a></code></pre></div>
<p>Type the query above into your psql terminal, and make sure to add a semicolon at the end, which terminates the statement. <code>SELECT</code> and <code>FROM</code> should be capitalized. The above query should give us back the following:</p>
<table>
<thead>
<tr class="header">
<th>name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Cooper</td>
</tr>
<tr class="even">
<td>Indie</td>
</tr>
<tr class="odd">
<td>Kota</td>
</tr>
<tr class="even">
<td>Zoe</td>
</tr>
<tr class="odd">
<td>Charley</td>
</tr>
<tr class="even">
<td>Ladybird</td>
</tr>
<tr class="odd">
<td>Callie</td>
</tr>
<tr class="even">
<td>Jaxson</td>
</tr>
<tr class="odd">
<td>Leinni</td>
</tr>
<tr class="even">
<td>Max</td>
</tr>
</tbody>
</table>
<h3 id="select-multiple-columns">SELECT multiple columns</h3>
<p>To see multiple columns, we can concatenate the column names by using commas between column names.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb87-1" title="1"><span class="kw">SELECT</span> name</a>
<a class="sourceLine" id="cb87-2" title="2">     , age_yrs</a>
<a class="sourceLine" id="cb87-3" title="3">     , weight_lbs</a>
<a class="sourceLine" id="cb87-4" title="4"><span class="kw">FROM</span>   puppies;</a></code></pre></div>
<p>Type the query above into your psql terminal, and make sure to add a semicolon at the end, which terminates the statement. <code>SELECT</code> and <code>FROM</code> should be capitalized. The above query should give us back the following:</p>
<table>
<thead>
<tr class="header">
<th>name</th>
<th>age_yrs</th>
<th>weight_lbs</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Cooper</td>
<td>1</td>
<td>18</td>
</tr>
<tr class="even">
<td>Indie</td>
<td>0.5</td>
<td>13</td>
</tr>
<tr class="odd">
<td>Kota</td>
<td>0.7</td>
<td>26</td>
</tr>
<tr class="even">
<td>Zoe</td>
<td>0.8</td>
<td>32</td>
</tr>
<tr class="odd">
<td>Charley</td>
<td>1.5</td>
<td>25</td>
</tr>
<tr class="even">
<td>Ladybird</td>
<td>0.6</td>
<td>20</td>
</tr>
<tr class="odd">
<td>Callie</td>
<td>0.9</td>
<td>16</td>
</tr>
<tr class="even">
<td>Jaxson</td>
<td>0.4</td>
<td>19</td>
</tr>
<tr class="odd">
<td>Leinni</td>
<td>1</td>
<td>25</td>
</tr>
<tr class="even">
<td>Max</td>
<td>1.6</td>
<td>65</td>
</tr>
</tbody>
</table>
<h2 id="formatting-select-statements">Formatting SELECT statements</h2>
<p>This is another of those hot-button topics with software developers. Some people like to put all the stuff on one line for each SQL keyword.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb88-1" title="1"><span class="kw">SELECT</span> name, age_yrs, weight_lbs</a>
<a class="sourceLine" id="cb88-2" title="2"><span class="kw">FROM</span>   puppies;</a></code></pre></div>
<p>That works for short lists. But some tables have hundreds of columns. That gets long.</p>
<p>Some developers like what you saw earlier, the "each column name on its own line with the comma at the front".</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb89-1" title="1"><span class="kw">SELECT</span> name</a>
<a class="sourceLine" id="cb89-2" title="2">     , age_yrs</a>
<a class="sourceLine" id="cb89-3" title="3">     , weight_lbs</a>
<a class="sourceLine" id="cb89-4" title="4"><span class="kw">FROM</span>   puppies;</a></code></pre></div>
<p>They like this because if they need to comment out a column name, they can just put a couple of dashes at the beginning of the line.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb90-1" title="1"><span class="kw">SELECT</span> name</a>
<a class="sourceLine" id="cb90-2" title="2"><span class="co">--     , age_yrs</span></a>
<a class="sourceLine" id="cb90-3" title="3">     , weight_lbs</a>
<a class="sourceLine" id="cb90-4" title="4"><span class="kw">FROM</span>   puppies;</a></code></pre></div>
<p>Some developers just do a word wrap when lines get too long.</p>
<p>All of these are fine. Just stay consistent within a project how you do them.</p>
<h2 id="what-we-learned-1">What we learned:</h2>
<ul>
<li>What a query is</li>
<li>How to connect to the PostgreSQL server with psql</li>
<li>How to construct an example SQL table</li>
<li>PostgreSQL data types</li>
<li>How to write a simple SELECT query</li>
<li>How to SELECT all rows, rows by column, and rows by multiple columns</li>
</ul>
<hr />
<h1 id="selecting-table-rows-using-where-and-common-operators">Selecting Table Rows Using WHERE And Common Operators</h1>
<p>In the last reading, we learned how to create a simple SQL query using SELECT. In this reading, weâ€™ll be adding a <a href="https://www.postgresql.org/docs/9.1/sql-createindex.html">WHERE clause</a> to our SELECT statement to further filter a database table and get specific rows back.</p>
<h2 id="using-select-and-where">Using SELECT and WHERE</h2>
<p>Previously, we covered how to use SELECT queries to fetch all of a tableâ€™s rows or specified table rows by column(s). We can filter information returned by our query by using a WHERE clause in our SELECT statement.</p>
<p>Letâ€™s look at some examples of adding a WHERE clause using our <code>puppies</code> table from before:</p>
<table>
<thead>
<tr class="header">
<th>name</th>
<th>age_yrs</th>
<th>breed</th>
<th>weight_lbs</th>
<th>microchipped</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Cooper</td>
<td>1</td>
<td>Miniature Schnauzer</td>
<td>18</td>
<td>yes</td>
</tr>
<tr class="even">
<td>Indie</td>
<td>0.5</td>
<td>Yorkshire Terrier</td>
<td>13</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>Kota</td>
<td>0.7</td>
<td>Australian Shepherd</td>
<td>26</td>
<td>no</td>
</tr>
<tr class="even">
<td>Zoe</td>
<td>0.8</td>
<td>Korean Jindo</td>
<td>32</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>Charley</td>
<td>1.5</td>
<td>Basset Hound</td>
<td>25</td>
<td>no</td>
</tr>
<tr class="even">
<td>Ladybird</td>
<td>0.6</td>
<td>Labradoodle</td>
<td>20</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>Callie</td>
<td>0.9</td>
<td>Corgi</td>
<td>16</td>
<td>no</td>
</tr>
<tr class="even">
<td>Jaxson</td>
<td>0.4</td>
<td>Beagle</td>
<td>19</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>Leinni</td>
<td>1</td>
<td>Miniature Schnauzer</td>
<td>25</td>
<td>yes</td>
</tr>
<tr class="even">
<td>Max</td>
<td>1.6</td>
<td>German Shepherd</td>
<td>65</td>
<td>no</td>
</tr>
</tbody>
</table>
<h3 id="where-clause-for-a-single-value">WHERE clause for a single value</h3>
<p>The simplest WHERE clause finds a row by a single column value. See the example below, which finds the rows where the breed equals â€˜Corgiâ€™:</p>
<pre class="shell"><code>SELECT name, breed FROM puppies
  WHERE breed = &#39;Corgi&#39;;</code></pre>
<p><code>SELECT</code>, <code>FROM</code>, and <code>WHERE</code> are capitalized. Notice that the string must use single quotation marks. <em>Note: PostgreSQL converts all names of tables, columns, functions, etc. to lowercase unless theyâ€™re double quoted.</em> For example: <code>create table Foo()</code> will create a table called <code>foo</code>, and <code>create table "Bar"()</code> will create a table called <code>Bar</code>. If you use double quotation marks in the query above, youâ€™ll get an error that says <code>column "Corgi" does not exist</code> because it thinks youâ€™re searching for the capitalized column name <code>Corgi</code>.</p>
<p>Use the command <code>psql -U postgres</code> in the terminal, and type in your â€˜postgresâ€™ user password to connect to the PostgreSQL server. You should have a puppies table in your postgres database from the last reading. Once youâ€™re in psql, enter the query above into the terminal and press Enter. You should get back one result for Callie the Corgi.</p>
<pre class="shell"><code>  name  | breed
--------+-------
 Callie | Corgi</code></pre>
<h3 id="where-clause-for-a-list-of-values">WHERE clause for a list of values</h3>
<p>We can also add a WHERE clause to check for a list of values. The syntax is <code>WHERE [column] IN ('value1', 'value2', 'value3')</code>. Letâ€™s say we wanted to find the name and breed of the puppies who are Corgis, Beagles, or Yorkshire Terriers. We could do so with the query below:</p>
<pre class="shell"><code>SELECT name, breed FROM puppies
  WHERE breed IN (&#39;Corgi&#39;, &#39;Beagle&#39;, &#39;Yorkshire Terrier&#39;);</code></pre>
<p>Entering this query into psql should yield the following results:</p>
<pre class="shell"><code>  name  |       breed
--------+-------------------
 Indie  | Yorkshire Terrier
 Callie | Corgi
 Jaxson | Beagle</code></pre>
<h3 id="where-clause-for-a-range-of-values">WHERE clause for a range of values</h3>
<p>In addition to checking for string values, we can use the WHERE clause to check for a range of numeric/integer values. This time, letâ€™s find the name, breed, and age of the puppies who are between 0 to 6 months old.</p>
<pre class="shell"><code>SELECT name, breed, age_yrs FROM puppies
  WHERE age_yrs BETWEEN 0 AND 0.6;</code></pre>
<p>Entering this query into psql should yield the following results:</p>
<pre class="shell"><code>   name   |       breed       | age_yrs
----------+-------------------+---------
 Indie    | Yorkshire Terrier |     0.5
 Ladybird | Labradoodle       |     0.6
 Jaxson   | Beagle            |     0.4</code></pre>
<h2 id="order-by">ORDER BY</h2>
<p>Getting the values back from a database in any order it wants to give them to you is ludicrous. Instead, you will often want to specify the order in which you get them back. Say you wanted them in alphabetical order by their name. Then, you would write</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb97-1" title="1"><span class="kw">SELECT</span> name, breed</a>
<a class="sourceLine" id="cb97-2" title="2"><span class="kw">FROM</span> puppies</a>
<a class="sourceLine" id="cb97-3" title="3"><span class="kw">ORDER</span> <span class="kw">BY</span> name;</a></code></pre></div>
<p>Say you wanted that returned from oldest dog to youngest dog. You would write</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb98-1" title="1"><span class="kw">SELECT</span> name, breed</a>
<a class="sourceLine" id="cb98-2" title="2"><span class="kw">FROM</span> puppies</a>
<a class="sourceLine" id="cb98-3" title="3"><span class="kw">ORDER</span> <span class="kw">BY</span> age_yrs <span class="kw">DESC</span>;</a></code></pre></div>
<p>where <code>DESC</code> means in descending order. Note that the column that you order on does not have to appear in the column list of the <code>SELECT</code> statement.</p>
<h2 id="limit-and-offset">LIMIT and OFFSET</h2>
<p>Say your query would return one million rows because youâ€™ve cataloged every puppy in the world. That would be a lot for any application to handle. Instead, you may want to limit the number of rows returned. You can do that with the <code>LIMIT</code> keyword.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb99-1" title="1"><span class="kw">SELECT</span> name, breed</a>
<a class="sourceLine" id="cb99-2" title="2"><span class="kw">FROM</span> puppies</a>
<a class="sourceLine" id="cb99-3" title="3"><span class="kw">ORDER</span> <span class="kw">BY</span> age_yrs</a>
<a class="sourceLine" id="cb99-4" title="4"><span class="kw">LIMIT</span> <span class="dv">100</span>;</a></code></pre></div>
<p>That would return the name and breed of the 100 youngest puppies. (Why?) That is, of the million rows that the statement would find, it <em>limits</em> the number to only 100.</p>
<p>Letâ€™s say you want to see the <em>next</em> 100 puppies after the first hundred. You can do that with the <code>OFFSET</code> keyword which comes after the <code>LIMIT</code> clause.</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb100-1" title="1"><span class="kw">SELECT</span> name, breed</a>
<a class="sourceLine" id="cb100-2" title="2"><span class="kw">FROM</span> puppies</a>
<a class="sourceLine" id="cb100-3" title="3"><span class="kw">ORDER</span> <span class="kw">BY</span> age_yrs</a>
<a class="sourceLine" id="cb100-4" title="4"><span class="kw">LIMIT</span> <span class="dv">100</span> OFFSET <span class="dv">100</span>;</a></code></pre></div>
<p>That will return only rows 101 - 200 of the result set. It <em>limits</em> the total number of records to return to 100. Then, it starts at the 100th row and counts 100 records. Those are the records returned.</p>
<h2 id="sql-operators">SQL operators</h2>
<p>A SQL operator is a word or character that is used inside a WHERE clause to perform comparisons or arithmetic operations. In the three examples above, we used SQL operators inside of WHERE clauses to filter table rows â€“ <code>=</code>, <code>IN</code>, <code>BETWEEN</code>, and <code>AND</code>.</p>
<p>The following is a listing of SQL operators. We can combine any of these operators in our query or use a single operator by itself.</p>
<h3 id="logical-operators">Logical operators</h3>
<table>
<thead>
<tr class="header">
<th>Operator</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ALL</td>
<td>TRUE if all of the subquery values meet the condition.</td>
</tr>
<tr class="even">
<td>AND</td>
<td>TRUE if all the conditions separated by AND are TRUE.</td>
</tr>
<tr class="odd">
<td>ANY</td>
<td>TRUE if any of the subquery values meet the condition.</td>
</tr>
<tr class="even">
<td>BETWEEN</td>
<td>TRUE if the operand is within the range of comparisons.</td>
</tr>
<tr class="odd">
<td>EXISTS</td>
<td>TRUE if the subquery returns one or more records.</td>
</tr>
<tr class="even">
<td>IN</td>
<td>TRUE if the operand is equal to one of a list of expressions.</td>
</tr>
<tr class="odd">
<td>LIKE</td>
<td>TRUE if the operand matches a pattern (accepts "wildcards").</td>
</tr>
<tr class="even">
<td>NOT</td>
<td>Displays a record if the condition(s) is NOT TRUE.</td>
</tr>
<tr class="odd">
<td>OR</td>
<td>TRUE if any of the conditions separated by OR is TRUE.</td>
</tr>
<tr class="even">
<td>SOME</td>
<td>TRUE if any of the subquery values meet the condition.</td>
</tr>
</tbody>
</table>
<p>Here is another example query with a WHERE clause using several logical operators: <code>NOT</code>, <code>IN</code>, <code>AND</code>, and <code>LIKE</code>.</p>
<pre class="shell"><code>SELECT name, breed FROM puppies
  WHERE breed NOT IN (&#39;Miniature Schnauzer&#39;, &#39;Basset Hound&#39;, &#39;Labradoodle&#39;)
    AND breed NOT LIKE &#39;%Shepherd&#39;;</code></pre>
<p><strong>Note</strong>: Pay attention to that <code>LIKE</code> operator. You will use it more than you want to. The wildcard it uses is the percent sign. Hereâ€™s a table to help you understand.</p>
<table>
<thead>
<tr class="header">
<th><code>LIKE</code></th>
<th>Matches "dog"</th>
<th>Matches "hotdog"</th>
<th>Matches "dog-tired"</th>
<th>Matches "ordogordo"</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>'dog'</code></td>
<td>yes</td>
<td>no</td>
<td>no</td>
<td>no</td>
</tr>
<tr class="even">
<td><code>'%dog'</code></td>
<td>yes</td>
<td>yes</td>
<td>no</td>
<td>no</td>
</tr>
<tr class="odd">
<td><code>'dog%'</code></td>
<td>yes</td>
<td>no</td>
<td>yes</td>
<td>no</td>
</tr>
<tr class="even">
<td><code>'%dog%'</code></td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
</tr>
</tbody>
</table>
<p>Entering this query into psql should yield the following results:</p>
<pre class="shell"><code>  name  |       breed
--------+-------------------
 Indie  | Yorkshire Terrier
 Zoe    | Korean Jindo
 Callie | Corgi
 Jaxson | Beagle</code></pre>
<p>With the query above, we filtered out six puppies: two Miniature Schnauzers, one Basset Hound, one Labradoodle, and two Shepherds. We started with ten puppies in the table, so weâ€™re left with four table rows. There are two puppies who are Shepherd breeds: an Australian Shepherd and a German Shepherd. We used the <code>LIKE</code> operator to filter these. In <code>'%Shepherd</code>, the <code>%</code> matches any substring value before the substring â€˜Shepherdâ€™.</p>
<h3 id="arithmetic-operators">Arithmetic operators</h3>
<table>
<thead>
<tr class="header">
<th>Operator</th>
<th>Meaning</th>
<th>Syntax</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>+</td>
<td>Addition</td>
<td>a + b</td>
</tr>
<tr class="even">
<td>-</td>
<td>Subtraction</td>
<td>a - b</td>
</tr>
<tr class="odd">
<td>*</td>
<td>Multiplication</td>
<td>a * b</td>
</tr>
<tr class="even">
<td>/</td>
<td>Division</td>
<td>a / b</td>
</tr>
<tr class="odd">
<td>%</td>
<td>Modulus (returns remainder)</td>
<td>a % b</td>
</tr>
</tbody>
</table>
<p>Here is an example query with a WHERE clause using the multiplication operator to find puppies that are 6 months old:</p>
<pre class="shell"><code>SELECT name, breed, age_yrs FROM puppies
  WHERE age_yrs * 10 = 6;</code></pre>
<p>Entering the above query into psql will yield one result:</p>
<pre class="shell"><code>   name   |    breed    | age_yrs
----------+-------------+---------
 Ladybird | Labradoodle |     0.6</code></pre>
<h3 id="comparison-operators">Comparison operators</h3>
<table>
<thead>
<tr class="header">
<th>Operator</th>
<th>Meaning</th>
<th>Syntax</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>=</td>
<td>Equals</td>
<td>a = b</td>
</tr>
<tr class="even">
<td>!=</td>
<td>Not equal to</td>
<td>a != b</td>
</tr>
<tr class="odd">
<td>&lt;&gt;</td>
<td>Not equal to</td>
<td>a &lt;&gt; b</td>
</tr>
<tr class="even">
<td>&gt;</td>
<td>Greater than</td>
<td>a &gt; b</td>
</tr>
<tr class="odd">
<td>&lt;</td>
<td>Less than</td>
<td>a &lt; b</td>
</tr>
<tr class="even">
<td>&gt;=</td>
<td>Greater than or equal to</td>
<td>a &gt;= b</td>
</tr>
<tr class="odd">
<td>&lt;=</td>
<td>Less than or equal to</td>
<td>a &lt;= b</td>
</tr>
<tr class="even">
<td>!&lt;</td>
<td>Not less than</td>
<td>a !&lt; b</td>
</tr>
<tr class="odd">
<td>!&gt;</td>
<td>Not greater than</td>
<td>a !&gt; b</td>
</tr>
</tbody>
</table>
<p>Here is an example query with a WHERE clause using the <code>&gt;</code> comparison operator:</p>
<pre class="shell"><code>SELECT name, breed, weight_lbs FROM puppies
  WHERE weight_lbs &gt; 50;</code></pre>
<p>Entering the above query into psql will yield one result:</p>
<pre class="shell"><code> name |      breed      | weight_lbs
------+-----------------+------------
 Max  | German Shepherd |         65</code></pre>
<h2 id="what-we-learned-2">What we learned:</h2>
<ul>
<li>How to use a WHERE clause in a SELECT query</li>
<li>How to construct WHERE clauses matching a single value, a list of values, and a range of values</li>
<li>What SQL operators are</li>
<li>How to use logical operators, arithmetic operators, and comparison operators</li>
</ul>
<hr />
<h1 id="inserting-data-into-a-table">Inserting Data Into A Table</h1>
<hr />
<p>If you have data, but itâ€™s not in tables, does the data even exist? Not to an app! We often need to create relational databases on the back end of the Web apps weâ€™re building so that we can ultimately display this data on the front end of our application. All relational database data is stored in tables, so itâ€™s important to learn how to create tables and successfully query them.</p>
<p>Of the four data manipulation statements, <code>INSERT</code> is the easiest.</p>
<p>Create a new database named "folks". Now, create a new table named "friends" with the following column specifications.</p>
<table>
<thead>
<tr class="header">
<th>Name</th>
<th>Data type</th>
<th>Constraints</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td><code>SERIAL</code></td>
<td><code>PRIMARY KEY</code></td>
</tr>
<tr class="even">
<td>first_name</td>
<td><code>VARCHAR(255)</code></td>
<td><code>NOT NULL</code></td>
</tr>
<tr class="odd">
<td>last_name</td>
<td><code>VARCHAR(255)</code></td>
<td><code>NOT NULL</code></td>
</tr>
</tbody>
</table>
<p>Now that we have a new table, we need to add table rows with some data. We can insert a new table row using the following syntax:</p>
<pre class="shell"><code>INSERT INTO table_name
VALUES
  (column1_value, colum2_value, column3_value);</code></pre>
<p>Letâ€™s fill out our "friends" table with information about five friends. In psql, enter the following to add new table rows. <em>Note the use of single quotation marks for string values. Also note that, since we used the <a href="https://www.postgresql.org/docs/9.1/sql-createindex.html"><code>SERIAL</code> pseudo-type</a> to auto-increment the ID values, we can simply write <code>DEFAULT</code> for the ID values when inserting new table rows.</em></p>
<pre class="shell"><code>INSERT INTO friends (id, first_name, last_name)
VALUES
  (DEFAULT, &#39;Amy&#39;, &#39;Pond&#39;);</code></pre>
<p>You can also completely omit the <code>DEFAULT</code> keyword if you specify the names of the columns that you want to insert into.</p>
<p>You can also use the "multiple values" insert. This prevents you from having to write <code>INSERT</code> with every statement. Even better, if one fails, they all fail. That can help protect your data integrity.</p>
<pre><code>INSERT INTO friends (first_name, last_name)
VALUES
(&#39;Rose&#39;, &#39;Tyler&#39;),
(&#39;Martha&#39;, &#39;Jones&#39;),
(&#39;Donna&#39;, &#39;Noble&#39;),
(&#39;River&#39;, &#39;Song&#39;);</code></pre>
<p>Use <code>SELECT * FROM friends;</code> to verify that there are rows in the "friends" table:</p>
<pre class="shell"><code>=# SELECT * FROM friends;
 id | first_name | last_name
----+------------+-----------
  1 | Amy        | Pond
  2 | Rose       | Tyler
  3 | Martha     | Jones
  4 | Donna      | Noble
  5 | River      | Song</code></pre>
<p>Now letâ€™s try to insert a new row using the ID of 5:</p>
<pre class="shell"><code>INSERT INTO friends (id, first_name, last_name)
VALUES (5, &#39;Jenny&#39;, &#39;Who&#39;);</code></pre>
<p>Because ID is a primary key and that ID is already taken, we should get a message in psql that it already exists:</p>
<pre class="shell"><code>=# insert into friends values (5, &#39;Jenny&#39;, &#39;Who&#39;);
ERROR:  duplicate key value violates unique constraint &quot;friends_pkey&quot;
DETAIL:  Key (id)=(5) already exists.</code></pre>
<h2 id="what-we-learned-3">What we learned:</h2>
<ul>
<li>How to connect to an existing PostgreSQL database</li>
<li>How to create a new PostgreSQL database</li>
<li>How to create a new database table</li>
<li>Accepted PostgreSQL data types</li>
<li>How to add new rows to a database table</li>
<li>What a primary key is/does</li>
</ul>
<hr />
<h1 id="foreign-keys-and-the-join-operation">Foreign Keys And The JOIN Operation</h1>
<p>In relational databases, <em>relationships</em> are key. We can create relationships, or <em>associations</em>, among tables so that they can access and share data. In a SQL database, we create table associations through <em>foreign keys</em> and <em>primary keys</em>.</p>
<p>Youâ€™ve learned about primary and foreign keys. Now, itâ€™s time to put them to use.</p>
<h2 id="setting-up-the-database">Setting up the database</h2>
<p>Create a new database called "learn_joins". Connect to that database. Run the following SQL statements to create tables and the data in them.</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb113-1" title="1"><span class="kw">CREATE</span> <span class="kw">TABLE</span> breeds (</a>
<a class="sourceLine" id="cb113-2" title="2">  <span class="kw">id</span> SERIAL,</a>
<a class="sourceLine" id="cb113-3" title="3">  name <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb113-4" title="4">  <span class="kw">PRIMARY</span> <span class="kw">KEY</span> (<span class="kw">id</span>)</a>
<a class="sourceLine" id="cb113-5" title="5">);</a></code></pre></div>
<div class="sourceCode" id="cb114"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb114-1" title="1"><span class="kw">INSERT</span> <span class="kw">INTO</span> breeds (name)</a>
<a class="sourceLine" id="cb114-2" title="2"><span class="kw">VALUES</span></a>
<a class="sourceLine" id="cb114-3" title="3">(<span class="st">&#39;Australian Shepherd&#39;</span>),</a>
<a class="sourceLine" id="cb114-4" title="4">(<span class="st">&#39;Basset Hound&#39;</span>),</a>
<a class="sourceLine" id="cb114-5" title="5">(<span class="st">&#39;Beagle&#39;</span>),</a>
<a class="sourceLine" id="cb114-6" title="6">(<span class="st">&#39;Corgi&#39;</span>),</a>
<a class="sourceLine" id="cb114-7" title="7">(<span class="st">&#39;German Shepherd&#39;</span>),</a>
<a class="sourceLine" id="cb114-8" title="8">(<span class="st">&#39;Korean Jindo&#39;</span>),</a>
<a class="sourceLine" id="cb114-9" title="9">(<span class="st">&#39;Labradoodle&#39;</span>),</a>
<a class="sourceLine" id="cb114-10" title="10">(<span class="st">&#39;Miniature Schnauzer&#39;</span>),</a>
<a class="sourceLine" id="cb114-11" title="11">(<span class="st">&#39;Yorkshire Terrier&#39;</span>);</a></code></pre></div>
<div class="sourceCode" id="cb115"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb115-1" title="1"><span class="kw">CREATE</span> <span class="kw">TABLE</span> puppies (</a>
<a class="sourceLine" id="cb115-2" title="2">  <span class="kw">id</span> SERIAL,</a>
<a class="sourceLine" id="cb115-3" title="3">  name <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb115-4" title="4">  age_yrs <span class="dt">NUMERIC</span>(<span class="dv">3</span>,<span class="dv">1</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb115-5" title="5">  breed_id <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb115-6" title="6">  weight_lbs <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb115-7" title="7">  microchipped <span class="dt">BOOLEAN</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="kw">FALSE</span>,</a>
<a class="sourceLine" id="cb115-8" title="8">  <span class="kw">PRIMARY</span> <span class="kw">KEY</span>(<span class="kw">id</span>),</a>
<a class="sourceLine" id="cb115-9" title="9">  <span class="kw">FOREIGN</span> <span class="kw">KEY</span> (breed_id) <span class="kw">REFERENCES</span> breeds(<span class="kw">id</span>)</a>
<a class="sourceLine" id="cb115-10" title="10">);</a></code></pre></div>
<div class="sourceCode" id="cb116"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb116-1" title="1"><span class="kw">INSERT</span> <span class="kw">INTO</span> puppies (name, age_yrs, breed_id, weight_lbs, microchipped)</a>
<a class="sourceLine" id="cb116-2" title="2"><span class="kw">VALUES</span></a>
<a class="sourceLine" id="cb116-3" title="3">(<span class="st">&#39;Cooper&#39;</span>, <span class="dv">1</span>, <span class="dv">8</span>, <span class="dv">18</span>, <span class="kw">true</span>),</a>
<a class="sourceLine" id="cb116-4" title="4">(<span class="st">&#39;Indie&#39;</span>, <span class="fl">0.5</span>, <span class="dv">9</span>, <span class="dv">13</span>, <span class="kw">true</span>),</a>
<a class="sourceLine" id="cb116-5" title="5">(<span class="st">&#39;Kota&#39;</span>, <span class="fl">0.7</span>, <span class="dv">1</span>, <span class="dv">26</span>, <span class="kw">false</span>),</a>
<a class="sourceLine" id="cb116-6" title="6">(<span class="st">&#39;Zoe&#39;</span>, <span class="fl">0.8</span>, <span class="dv">6</span>, <span class="dv">32</span>, <span class="kw">true</span>),</a>
<a class="sourceLine" id="cb116-7" title="7">(<span class="st">&#39;Charley&#39;</span>, <span class="fl">1.5</span>, <span class="dv">2</span>, <span class="dv">25</span>, <span class="kw">false</span>),</a>
<a class="sourceLine" id="cb116-8" title="8">(<span class="st">&#39;Ladybird&#39;</span>, <span class="fl">0.6</span>, <span class="dv">7</span>, <span class="dv">20</span>, <span class="kw">true</span>),</a>
<a class="sourceLine" id="cb116-9" title="9">(<span class="st">&#39;Callie&#39;</span>, <span class="fl">0.9</span>, <span class="dv">4</span>, <span class="dv">16</span>, <span class="kw">false</span>),</a>
<a class="sourceLine" id="cb116-10" title="10">(<span class="st">&#39;Jaxson&#39;</span>, <span class="fl">0.4</span>, <span class="dv">3</span>, <span class="dv">19</span>, <span class="kw">true</span>),</a>
<a class="sourceLine" id="cb116-11" title="11">(<span class="st">&#39;Leinni&#39;</span>, <span class="dv">1</span>, <span class="dv">8</span>, <span class="dv">25</span>, <span class="kw">true</span>),</a>
<a class="sourceLine" id="cb116-12" title="12">(<span class="st">&#39;Max&#39;</span>, <span class="fl">1.6</span>, <span class="dv">5</span>, <span class="dv">65</span>, <span class="kw">false</span>);</a></code></pre></div>
<h2 id="using-join-to-retrieve-rows-from-multiple-tables">Using JOIN to retrieve rows from multiple tables</h2>
<p>Now that weâ€™ve set up an association between the "puppies" table and the "friends" table, we can access data from both tables. We can do so by using a <a href="https://www.postgresql.org/docs/9.1/indexes.html">JOIN operation</a> in our SELECT query. Type the following into psql:</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb117-1" title="1"><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> puppies</a>
<a class="sourceLine" id="cb117-2" title="2"><span class="kw">INNER</span> <span class="kw">JOIN</span> breeds <span class="kw">ON</span> (puppies.breed_id <span class="op">=</span> breeds.<span class="kw">id</span>);</a></code></pre></div>
<p>The <code>JOIN</code> operation above is joining the "puppies" table with the "breeds" table together into a single table using the foreign key/primary key shared between the two tables: <code>breed_id</code>.</p>
<p>You should get all rows back containing all information for the puppies and breeds with matching <code>breed_id</code> values:</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb118-1" title="1">postgres<span class="op">=</span># <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> puppies</a>
<a class="sourceLine" id="cb118-2" title="2">postgres<span class="op">-</span># <span class="kw">INNER</span> <span class="kw">JOIN</span> breeds <span class="kw">ON</span> (puppies.breed_id <span class="op">=</span> breeds.<span class="kw">id</span>);</a>
<a class="sourceLine" id="cb118-3" title="3"> <span class="kw">id</span> |   name   | age_yrs | breed_id | weight_lbs | microchipped | <span class="kw">id</span> |        name</a>
<a class="sourceLine" id="cb118-4" title="4"><span class="co">----+----------+---------+----------+------------+--------------+----+---------------------</span></a>
<a class="sourceLine" id="cb118-5" title="5">  <span class="dv">1</span> | Cooper   |     <span class="fl">1.0</span> |        <span class="dv">8</span> |         <span class="dv">18</span> | t            |  <span class="dv">8</span> | Miniature Schnauzer</a>
<a class="sourceLine" id="cb118-6" title="6">  <span class="dv">2</span> | Indie    |     <span class="fl">0.5</span> |        <span class="dv">9</span> |         <span class="dv">13</span> | t            |  <span class="dv">9</span> | Yorkshire Terrier</a>
<a class="sourceLine" id="cb118-7" title="7">  <span class="dv">3</span> | Kota     |     <span class="fl">0.7</span> |        <span class="dv">1</span> |         <span class="dv">26</span> | f            |  <span class="dv">1</span> | Australian Shepherd</a>
<a class="sourceLine" id="cb118-8" title="8">  <span class="dv">4</span> | Zoe      |     <span class="fl">0.8</span> |        <span class="dv">6</span> |         <span class="dv">32</span> | t            |  <span class="dv">6</span> | Korean Jindo</a>
<a class="sourceLine" id="cb118-9" title="9">  <span class="dv">5</span> | Charley  |     <span class="fl">1.5</span> |        <span class="dv">2</span> |         <span class="dv">25</span> | f            |  <span class="dv">2</span> | Basset Hound</a>
<a class="sourceLine" id="cb118-10" title="10">  <span class="dv">6</span> | Ladybird |     <span class="fl">0.6</span> |        <span class="dv">7</span> |         <span class="dv">20</span> | t            |  <span class="dv">7</span> | Labradoodle</a>
<a class="sourceLine" id="cb118-11" title="11">  <span class="dv">7</span> | Callie   |     <span class="fl">0.9</span> |        <span class="dv">4</span> |         <span class="dv">16</span> | f            |  <span class="dv">4</span> | Corgi</a>
<a class="sourceLine" id="cb118-12" title="12">  <span class="dv">8</span> | Jaxson   |     <span class="fl">0.4</span> |        <span class="dv">3</span> |         <span class="dv">19</span> | t            |  <span class="dv">3</span> | Beagle</a>
<a class="sourceLine" id="cb118-13" title="13">  <span class="dv">9</span> | Leinni   |     <span class="fl">1.0</span> |        <span class="dv">8</span> |         <span class="dv">25</span> | t            |  <span class="dv">8</span> | Miniature Schnauzer</a>
<a class="sourceLine" id="cb118-14" title="14"> <span class="dv">10</span> | <span class="fu">Max</span>      |     <span class="fl">1.6</span> |        <span class="dv">5</span> |         <span class="dv">65</span> | f            |  <span class="dv">5</span> | German Shepherd</a>
<a class="sourceLine" id="cb118-15" title="15">(<span class="dv">10</span> <span class="kw">rows</span>)</a></code></pre></div>
<p>We could make our query more specific by selecting specific columns, adding a <code>WHERE</code> clause, or doing any number of operations that we could do in a normal <code>SELECT</code> query. Aside from an <code>INNER JOIN</code>, we could also do different types of <code>JOIN</code> operations. (Refer to this overview on <a href="https://www.postgresql.org/docs/8.1/performance-tips.html">PostgreSQL JOINS</a> for more information.)</p>
<h2 id="what-we-learned-4">What we learned:</h2>
<ul>
<li>What a foreign key is/does</li>
<li>How to create a foreign key</li>
<li>How to alter/update an existing table</li>
<li>How to use the JOIN operation to get rows from two tables</li>
</ul>
<h2 id="helpful-links">Helpful links:</h2>
<ul>
<li><a href="https://www.postgresql.org/docs/9.1/sql-createindex.html">PostgreSQL Docs: Constraints</a></li>
<li><a href="https://www.postgresql.org/docs/9.1/using-explain.html">PostgreSQL Docs: Data Types &gt; Numeric Types</a></li>
<li><a href="https://www.postgresql.org/docs/9.1/indexes.html">PostgreSQL Docs: Joins Between Tables</a></li>
<li><a href="https://www.postgresql.org/docs/8.1/performance-tips.html">PostgreSQL Tutorial: PostgreSQL Joins</a></li>
</ul>
<hr />
<h1 id="writing-and-running-a-seed-file-in-psql">Writing And Running A Seed File In PSQL</h1>
<p>After a database is created, we need to populate it, or <em>seed</em> it, with data. Until now, weâ€™ve used the command-line psql interface to create tables and insert rows into those tables. While thatâ€™s fine for small datasets, it would be cumbersome to add a large dataset using the command line.</p>
<p>In this reading, weâ€™ll learn how to create and run a seed file, which makes the process of populating a database with test data much easier.</p>
<h2 id="creating-a-seed-file">Creating a seed file</h2>
<p>You can create a seed file by opening up VSCode or any text editor and saving a file with the <code>.sql</code> extension.</p>
<p>Letâ€™s create a seed file called <code>seed-data.sql</code> thatâ€™s going to create a new table called <code>pies</code> and insert 50 pie rows into the table. Use the code below to create the seed file, and make sure to save your seed file on your machine.</p>
<p><em><strong>seed-data.sql</strong></em></p>
<div class="sourceCode" id="cb119"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb119-1" title="1"><span class="kw">CREATE</span> <span class="kw">TABLE</span> pies (</a>
<a class="sourceLine" id="cb119-2" title="2">  flavor <span class="dt">VARCHAR</span>(<span class="dv">255</span>) <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</a>
<a class="sourceLine" id="cb119-3" title="3">  price <span class="dt">FLOAT</span></a>
<a class="sourceLine" id="cb119-4" title="4">);</a>
<a class="sourceLine" id="cb119-5" title="5"></a>
<a class="sourceLine" id="cb119-6" title="6"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Apple&#39;</span>, <span class="fl">19.95</span>);</a>
<a class="sourceLine" id="cb119-7" title="7"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Caramel Apple Crumble&#39;</span>, <span class="fl">20.53</span>);</a>
<a class="sourceLine" id="cb119-8" title="8"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Blueberry&#39;</span>, <span class="fl">19.31</span>);</a>
<a class="sourceLine" id="cb119-9" title="9"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Blackberry&#39;</span>, <span class="fl">22.86</span>);</a>
<a class="sourceLine" id="cb119-10" title="10"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Cherry&#39;</span>, <span class="fl">22.32</span>);</a>
<a class="sourceLine" id="cb119-11" title="11"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Peach&#39;</span>, <span class="fl">20.45</span>);</a>
<a class="sourceLine" id="cb119-12" title="12"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Raspberry&#39;</span>, <span class="fl">20.99</span>);</a>
<a class="sourceLine" id="cb119-13" title="13"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Mixed Berry&#39;</span>, <span class="fl">21.45</span>);</a>
<a class="sourceLine" id="cb119-14" title="14"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Strawberry Rhubarb&#39;</span>, <span class="fl">24.81</span>);</a>
<a class="sourceLine" id="cb119-15" title="15"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Banana Cream&#39;</span>, <span class="fl">18.66</span>);</a>
<a class="sourceLine" id="cb119-16" title="16"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Boston Toffee&#39;</span>, <span class="fl">25.00</span>);</a>
<a class="sourceLine" id="cb119-17" title="17"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Banana Nutella&#39;</span>, <span class="fl">22.12</span>);</a>
<a class="sourceLine" id="cb119-18" title="18"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Bananas Foster&#39;</span>, <span class="fl">24.99</span>);</a>
<a class="sourceLine" id="cb119-19" title="19"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Boston Cream&#39;</span>, <span class="fl">23.75</span>);</a>
<a class="sourceLine" id="cb119-20" title="20"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Cookies and Cream&#39;</span>, <span class="fl">18.27</span>);</a>
<a class="sourceLine" id="cb119-21" title="21"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Coconut Cream&#39;</span>, <span class="fl">22.89</span>);</a>
<a class="sourceLine" id="cb119-22" title="22"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Chess&#39;</span>, <span class="fl">25.00</span>);</a>
<a class="sourceLine" id="cb119-23" title="23"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Lemon Chess&#39;</span>, <span class="fl">25.00</span>);</a>
<a class="sourceLine" id="cb119-24" title="24"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Key Lime&#39;</span>, <span class="fl">19.34</span>);</a>
<a class="sourceLine" id="cb119-25" title="25"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Lemon Meringue&#39;</span>, <span class="fl">19.58</span>);</a>
<a class="sourceLine" id="cb119-26" title="26"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Guava&#39;</span>, <span class="fl">18.92</span>);</a>
<a class="sourceLine" id="cb119-27" title="27"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Mango&#39;</span>, <span class="fl">19.55</span>);</a>
<a class="sourceLine" id="cb119-28" title="28"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Plum&#39;</span>, <span class="fl">20.21</span>);</a>
<a class="sourceLine" id="cb119-29" title="29"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Apricot&#39;</span>, <span class="fl">20.55</span>);</a>
<a class="sourceLine" id="cb119-30" title="30"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Gooseberry&#39;</span>, <span class="fl">23.54</span>);</a>
<a class="sourceLine" id="cb119-31" title="31"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Lingonberry&#39;</span>, <span class="fl">24.35</span>);</a>
<a class="sourceLine" id="cb119-32" title="32"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Pear Vanilla Butterscotch&#39;</span>, <span class="fl">25.13</span>);</a>
<a class="sourceLine" id="cb119-33" title="33"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Baked Alaska&#39;</span>, <span class="fl">25.71</span>);</a>
<a class="sourceLine" id="cb119-34" title="34"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Chocolate&#39;</span>, <span class="fl">19.00</span>);</a>
<a class="sourceLine" id="cb119-35" title="35"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Chocolate Mousse&#39;</span>, <span class="fl">21.46</span>);</a>
<a class="sourceLine" id="cb119-36" title="36"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Mexican Chocolate&#39;</span>, <span class="fl">28.33</span>);</a>
<a class="sourceLine" id="cb119-37" title="37"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Chocolate Caramel&#39;</span>, <span class="fl">26.67</span>);</a>
<a class="sourceLine" id="cb119-38" title="38"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Chocolate Chip Cookie Dough&#39;</span>, <span class="fl">18.65</span>);</a>
<a class="sourceLine" id="cb119-39" title="39"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Pecan&#39;</span>, <span class="fl">26.33</span>);</a>
<a class="sourceLine" id="cb119-40" title="40"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Bourbon Caramel Pecan&#39;</span>, <span class="fl">27.88</span>);</a>
<a class="sourceLine" id="cb119-41" title="41"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Chocolate Pecan&#39;</span>, <span class="fl">27.63</span>);</a>
<a class="sourceLine" id="cb119-42" title="42"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Pumpkin&#39;</span>, <span class="fl">20.91</span>);</a>
<a class="sourceLine" id="cb119-43" title="43"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Sweet Potato&#39;</span>, <span class="fl">20.75</span>);</a>
<a class="sourceLine" id="cb119-44" title="44"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Purple Sweet Potato&#39;</span>, <span class="fl">26.34</span>);</a>
<a class="sourceLine" id="cb119-45" title="45"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Cheesecake&#39;</span>, <span class="fl">28.99</span>);</a>
<a class="sourceLine" id="cb119-46" title="46"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Butterscotch Praline&#39;</span>, <span class="fl">29.78</span>);</a>
<a class="sourceLine" id="cb119-47" title="47"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Salted Caramel&#39;</span>, <span class="fl">30.32</span>);</a>
<a class="sourceLine" id="cb119-48" title="48"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Salted Honey&#39;</span>, <span class="fl">59.00</span>);</a>
<a class="sourceLine" id="cb119-49" title="49"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Sugar Cream&#39;</span>, <span class="fl">33.89</span>);</a>
<a class="sourceLine" id="cb119-50" title="50"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Mississippi Mud&#39;</span>, <span class="fl">28.67</span>);</a>
<a class="sourceLine" id="cb119-51" title="51"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Turtle Fudge&#39;</span>, <span class="fl">30.58</span>);</a>
<a class="sourceLine" id="cb119-52" title="52"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Fruit Loops&#39;</span>, <span class="fl">20.45</span>);</a>
<a class="sourceLine" id="cb119-53" title="53"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Black Forest&#39;</span>, <span class="fl">34.99</span>);</a>
<a class="sourceLine" id="cb119-54" title="54"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Maple Cream&#39;</span>, <span class="fl">35.88</span>);</a>
<a class="sourceLine" id="cb119-55" title="55"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Smores&#39;</span>, <span class="fl">26.43</span>);</a>
<a class="sourceLine" id="cb119-56" title="56"><span class="kw">INSERT</span> <span class="kw">INTO</span> pies <span class="kw">VALUES</span>(<span class="st">&#39;Milk Bar&#39;</span>, <span class="fl">46.00</span>);</a>
<a class="sourceLine" id="cb119-57" title="57"></a>
<a class="sourceLine" id="cb119-58" title="58"><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> pies;</a></code></pre></div>
<h2 id="populating-a-database-via-left-caret">Populating a database via &lt; ("left caret")</h2>
<p>Now that you have a seed file, you can insert it into a database with a simple command.</p>
<p>Create a database named "bakery".</p>
<p>The syntax is <code>psql -d [database] &lt; [path_to_file/file.sql]</code>. The left caret (<code>&lt;</code>) takes the standard input from the file on the right (your seed file) and inputs it into the program on the left (<code>psql</code>).</p>
<p>Open up your terminal, and enter the following command. Make sure to replace <code>path_to_my_file</code> with the actual file path.</p>
<pre class="shell"><code>psql -d bakery &lt; path_to_my_file/seed-data.sql</code></pre>
<p>In the terminal, you should see a bunch of <code>INSERT</code> statements and the entire "pies" table printed out (from the <code>SELECT *</code> query in the seed file).</p>
<p>You can log into psql and use <code>\dt</code> to verify that your new table has been added to the database:</p>
<pre class="shell"><code>postgres=# \dt
List of relations
 Schema |     Name     | Type  |  Owner
 public | breeds       | table | 
 public | pies         | table | 
 public | puppies      | table | </code></pre>
<h2 id="populating-the-database-via-pipe">Populating the database via | ("pipe")</h2>
<p>You could also use the "pipe" (<code>|</code>) to populate the database with your seed file.</p>
<p>The syntax is <code>cat [path_to_file/file.sql] | psql -d [database]</code>. â€˜catâ€™ is a standard Unix utility that reads files sequentially, writing them to standard output. The "pipe" (<code>|</code>) takes the standard output of the command on the left and pipes it as standard input to the command on the right.</p>
<p>Try out this method in your terminal. If you have an existing "pies" table, youâ€™ll need to drop this table before you can add it again:</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb122-1" title="1"><span class="kw">DROP</span> <span class="kw">TABLE</span> pies;</a></code></pre></div>
<p>Then, enter the following. Make sure to replace <code>path_to_my_file</code> with the actual file path.</p>
<pre class="shell"><code>cat path_to_my_file/seed-data.sql | psql -d postgres</code></pre>
<p>Again, you should see a bunch of <code>INSERT</code> statements and the entire "pies" table printed out (from the <code>SELECT *</code> query in the seed file).</p>
<p>You can log into psql and use <code>\dt</code> to verify that your new table has been added to the database:</p>
<pre class="shell"><code>postgres=# \dt
List of relations
 Schema |     Name     | Type  |  Owner
 public | friends      | table | postgres
 public | pies         | table | postgres
 public | puppies      | table | postgres</code></pre>
<h2 id="what-we-learned-5">What we learned:</h2>
<ul>
<li>What a seed file is</li>
<li>How to create a seed file</li>
<li>How to populate a database with a seed file using &lt;</li>
<li>How to populate a database with a seed file using |</li>
</ul>
<hr />
<h1 id="create-and-seed-a-database-project">Create And Seed A Database Project</h1>
<p>In our SQL readings, we installed PostgreSQL, and we learned how to create a new PostgreSQL database and how to create and run a seed file in our database.</p>
<p>In this project, youâ€™ll practice seeding your database with a seed file thatâ€™s full of, well, <em>seeds</em>! Hopefully when youâ€™re done, youâ€™ll have <em>grown</em> your SQL knowledge.</p>
<h2 id="project-overview">Project overview</h2>
<p>Practice creating a new database and piping a seed file into your database.</p>
<ul>
<li>In Phase 1, youâ€™ll create a new database.</li>
<li>In Phase 2, youâ€™ll create a new seed data file.</li>
<li>In Phase 3, youâ€™ll pipe your seed data in your database via <code>psql</code> on the command line.</li>
</ul>
<h2 id="phase-1-create-a-new-database">Phase 1: Create a new database</h2>
<p>First, log into <code>psql</code> on the command line as your user.</p>
<p>Second, create a new database in PostgreSQL called <code>farm</code> by using the following syntax:</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb125-1" title="1"><span class="kw">CREATE</span> <span class="kw">DATABASE</span> [databasename];</a></code></pre></div>
<p><em>Note:</em> You can check to make sure youâ€™ve created a new database by viewing the list of databases with <code>\l</code>.</p>
<h2 id="phase-2-create-a-seeds-seed-file">Phase 2: Create a seeds seed file</h2>
<p>Create a seed file full of seeds! Set up a SQL file with seed data that will produce two tables: an "edible_seeds" with 40 rows and a "flower_seeds" table with 20 rows.</p>
<p><strong>Edible Seeds</strong></p>
<table>
<thead>
<tr class="header">
<th>id</th>
<th>name</th>
<th>type</th>
<th>price_per_pound</th>
<th>in_stock</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Chia</td>
<td>Pseudocereal</td>
<td>6.95</td>
<td>yes</td>
</tr>
<tr class="even">
<td>2</td>
<td>Flax</td>
<td>Pseudocereal</td>
<td>6.90</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Amaranth</td>
<td>Pseudocereal</td>
<td>14.99</td>
<td>yes</td>
</tr>
<tr class="even">
<td>4</td>
<td>Quinoa</td>
<td>Pseudocereal</td>
<td>12.49</td>
<td>no</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Sesame</td>
<td>Pseudocereal</td>
<td>13.49</td>
<td>yes</td>
</tr>
<tr class="even">
<td>6</td>
<td>Hemp</td>
<td>Other</td>
<td>10.99</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>7</td>
<td>Chickpea</td>
<td>Legume</td>
<td>7.99</td>
<td>yes</td>
</tr>
<tr class="even">
<td>8</td>
<td>Pea</td>
<td>Legume</td>
<td>7.50</td>
<td>no</td>
</tr>
<tr class="odd">
<td>9</td>
<td>Soybean</td>
<td>Legume</td>
<td>12.99</td>
<td>yes</td>
</tr>
<tr class="even">
<td>10</td>
<td>Acorn</td>
<td>Nut</td>
<td>11.99</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>11</td>
<td>Almond</td>
<td>Nut</td>
<td>13.99</td>
<td>yes</td>
</tr>
<tr class="even">
<td>12</td>
<td>Beech</td>
<td>Nut</td>
<td>10.94</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>13</td>
<td>Chestnut</td>
<td>Nut</td>
<td>13.99</td>
<td>yes</td>
</tr>
<tr class="even">
<td>14</td>
<td>Water Chestnut</td>
<td>Nut</td>
<td>9.99</td>
<td>no</td>
</tr>
<tr class="odd">
<td>15</td>
<td>Macadamia</td>
<td>Nut</td>
<td>25.00</td>
<td>yes</td>
</tr>
<tr class="even">
<td>16</td>
<td>Pistachio</td>
<td>Nut</td>
<td>20.00</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>17</td>
<td>Pine nuts</td>
<td>Nut-like gymnosperm</td>
<td>23.00</td>
<td>yes</td>
</tr>
<tr class="even">
<td>18</td>
<td>Pecan</td>
<td>Nut</td>
<td>6.99</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>19</td>
<td>Juniper berries</td>
<td>Nut-like gymnosperm</td>
<td>11.99</td>
<td>yes</td>
</tr>
<tr class="even">
<td>20</td>
<td>Cashew</td>
<td>Nut</td>
<td>23.61</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>21</td>
<td>Hazelnut</td>
<td>Nut</td>
<td>25.49</td>
<td>yes</td>
</tr>
<tr class="even">
<td>22</td>
<td>Sunflower seed</td>
<td>Other</td>
<td>9.99</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>23</td>
<td>Poppy seed</td>
<td>Other</td>
<td>12.99</td>
<td>yes</td>
</tr>
<tr class="even">
<td>24</td>
<td>Barley</td>
<td>Cereal</td>
<td>9.99</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>25</td>
<td>Maize</td>
<td>Cereal</td>
<td>6.98</td>
<td>yes</td>
</tr>
<tr class="even">
<td>26</td>
<td>Oats</td>
<td>Cereal</td>
<td>9.99</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>27</td>
<td>Rice</td>
<td>Cereal</td>
<td>7.90</td>
<td>yes</td>
</tr>
<tr class="even">
<td>28</td>
<td>Rye</td>
<td>Cereal</td>
<td>9.87</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>29</td>
<td>Spelt</td>
<td>Cereal</td>
<td>7.50</td>
<td>yes</td>
</tr>
<tr class="even">
<td>30</td>
<td>Wheat berries</td>
<td>Cereal</td>
<td>2.50</td>
<td>no</td>
</tr>
<tr class="odd">
<td>31</td>
<td>Buckwheat</td>
<td>Pseudocereal</td>
<td>5.60</td>
<td>yes</td>
</tr>
<tr class="even">
<td>32</td>
<td>Jackfruit</td>
<td>Other</td>
<td>15.00</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>33</td>
<td>Durian</td>
<td>Other</td>
<td>8.26</td>
<td>no</td>
</tr>
<tr class="even">
<td>34</td>
<td>Lotus seed</td>
<td>Other</td>
<td>12.99</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>35</td>
<td>Ginko</td>
<td>Nut-like gymnosperm</td>
<td>12.80</td>
<td>yes</td>
</tr>
<tr class="even">
<td>36</td>
<td>Peanut</td>
<td>Legume</td>
<td>5.99</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>37</td>
<td>Pumpkin seed</td>
<td>Other</td>
<td>5.99</td>
<td>yes</td>
</tr>
<tr class="even">
<td>38</td>
<td>Watermelon seed</td>
<td>Other</td>
<td>6.99</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>39</td>
<td>Pomegranate seed</td>
<td>Other</td>
<td>27.63</td>
<td>yes</td>
</tr>
<tr class="even">
<td>40</td>
<td>Cacao bean</td>
<td>Other</td>
<td>12.99</td>
<td>yes</td>
</tr>
</tbody>
</table>
<p>Use the following data types for your "edible_seeds" columns:</p>
<ul>
<li>id - SERIAL</li>
<li>name - VARCHAR that accepts 255 characters</li>
<li>type - VARCHAR that accepts 255 characters</li>
<li>price_per_pound - FLOAT or REAL</li>
<li>in_stock - BOOLEAN</li>
</ul>
<p><strong>Flower Seeds</strong></p>
<table>
<thead>
<tr class="header">
<th>id</th>
<th>name</th>
<th>main_color</th>
<th>seeds_per_packet</th>
<th>price_per_packet</th>
<th>in_stock</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Begonia Fiona Red</td>
<td>Red</td>
<td>25</td>
<td>4.95</td>
<td>yes</td>
</tr>
<tr class="even">
<td>2</td>
<td>Moonflower Seeds</td>
<td>White</td>
<td>25</td>
<td>2.95</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Easy Wave F1 Lavender Sky Blue Petunia Seeds</td>
<td>Lavender</td>
<td>10</td>
<td>4.25</td>
<td>yes</td>
</tr>
<tr class="even">
<td>4</td>
<td>Super Hero Spry Marigold Seeds</td>
<td>Marigold</td>
<td>50</td>
<td>2.95</td>
<td>no</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Zinnia Zinderella Lilac</td>
<td>Pink</td>
<td>25</td>
<td>3.95</td>
<td>yes</td>
</tr>
<tr class="even">
<td>6</td>
<td>Mini Ornamental Mint Seeds</td>
<td>Green</td>
<td>10</td>
<td>3.95</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>7</td>
<td>Kabloom Light Pink Blast Calibrachoa</td>
<td>Green</td>
<td>10</td>
<td>4.95</td>
<td>yes</td>
</tr>
<tr class="even">
<td>8</td>
<td>Calibrachoa Kabloom Coral</td>
<td>Coral</td>
<td>10</td>
<td>4.95</td>
<td>no</td>
</tr>
<tr class="odd">
<td>9</td>
<td>Fiesta del Sol Mexican Sunflower Seeds</td>
<td>Red</td>
<td>30</td>
<td>3.95</td>
<td>no</td>
</tr>
<tr class="even">
<td>10</td>
<td>Cosmos Apricot Lemonade</td>
<td>Yellow</td>
<td>25</td>
<td>3.95</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>11</td>
<td>Zinderella Purple Zinnia Seeds</td>
<td>Purple</td>
<td>25</td>
<td>3.95</td>
<td>yes</td>
</tr>
<tr class="even">
<td>12</td>
<td>Fireball Marigold Seeds</td>
<td>Varies</td>
<td>25</td>
<td>3.95</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>13</td>
<td>Gerbera Revolution Bicolor Red Lemon</td>
<td>Red</td>
<td>10</td>
<td>8.95</td>
<td>no</td>
</tr>
<tr class="even">
<td>14</td>
<td>Paradise Island Calibrachoa Fuseables Seeds</td>
<td>Varies</td>
<td>5</td>
<td>6.95</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>15</td>
<td>Cheyenne Spirit Coneflower Seeds</td>
<td>Varies</td>
<td>15</td>
<td>7.95</td>
<td>no</td>
</tr>
<tr class="even">
<td>16</td>
<td>Leucanthemum Madonna</td>
<td>White</td>
<td>25</td>
<td>4.95</td>
<td>no</td>
</tr>
<tr class="odd">
<td>17</td>
<td>Zinnia Zinderella Peach</td>
<td>Peach</td>
<td>25</td>
<td>3.95</td>
<td>yes</td>
</tr>
<tr class="even">
<td>18</td>
<td>Kabloom Orange Calibrachoa</td>
<td>Orange</td>
<td>10</td>
<td>4.95</td>
<td>yes</td>
</tr>
<tr class="odd">
<td>19</td>
<td>Fountain Blue Lobelia Seeds</td>
<td>Blue</td>
<td>100</td>
<td>2.50</td>
<td>yes</td>
</tr>
<tr class="even">
<td>20</td>
<td>Envy Zinnia Seeds</td>
<td>Green</td>
<td>50</td>
<td>2.95</td>
<td>yes</td>
</tr>
</tbody>
</table>
<p>Use the following data types for your "flower_seeds" columns:</p>
<ul>
<li>id - SERIAL</li>
<li>name - VARCHAR that accepts 300 characters</li>
<li>main_color - VARCHAR that accepts 100 characters</li>
<li>seeds_per_packet - INT</li>
<li>price_per_packet - FLOAT</li>
<li>in_stock - BOOLEAN</li>
</ul>
<p><em>Note:</em> Make sure to save your seed file on your machine so that you can pipe it into your database in the next phase!</p>
<h2 id="phase-3-pipe-your-seed-file-into-your-new-database">Phase 3: Pipe your seed file into your new database</h2>
<p>After youâ€™ve saved your seed file, use the caret and pipe methods to seed your <code>farm</code> database with the data from the "edible_seeds" table. (<em>Note: Make sure youâ€™ve quit <code>psql</code> first with <code>\q</code>.</em>)</p>
<p>There are two ways to seed your database:</p>
<h3 id="method-1.-seed-your-database-via-caret-method">Method 1. Seed your database via caret method</h3>
<div class="sourceCode" id="cb126"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb126-1" title="1">psql <span class="op">-</span>d [<span class="kw">database</span>] <span class="op">-</span>U [username] <span class="op">&lt;</span> [path_to_file<span class="op">/</span><span class="kw">file</span>.sql]</a></code></pre></div>
<h3 id="method-2.-seed-your-database-via-pipe-method">Method 2. Seed your database via pipe method</h3>
<div class="sourceCode" id="cb127"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb127-1" title="1">cat [path_to_file<span class="op">/</span><span class="kw">file</span>.sql] | psql <span class="op">-</span>d [<span class="kw">database</span>] <span class="op">-</span>U [username]</a></code></pre></div>
<p>Try both of these methods.</p>
<h3 id="if-you-want-to-seed-using-the-file-again-you-need-to-first-drop-the-tables.">If you want to seed using the file again, you need to first drop the tables.</h3>
<p>Access the database by:</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb128-1" title="1">psql <span class="op">-</span>d [<span class="kw">database</span>] <span class="op">-</span>U [username]</a></code></pre></div>
<p>Then drop the tables:</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb129-1" title="1"><span class="kw">DROP</span> <span class="kw">TABLE</span> [<span class="kw">table</span>];</a></code></pre></div>
<p>Then you can run the seed file again using any of the two above methods.</p>
<h3 id="check-to-make-sure-your-seed-file-has-actually-updated-the-farm-database">Check to make sure your seed file has actually updated the <code>farm</code> database</h3>
<ul>
<li>Log into <code>psql</code> again.</li>
<li>Connect to the <code>farm</code> database (syntax: <code>\c [database]</code>).</li>
<li>Make sure your "edible_seeds" table is filled with seeds: <code>SELECT * FROM Â«table nameÂ»;</code></li>
<li>Make sure your "flower_seeds" table is filled with seeds: <code>SELECT * FROM Â«table nameÂ»;</code></li>
</ul>
<hr />
<h1 id="solving-the-sql-menagerie-project">Solving The SQL Menagerie Project</h1>
<p>In our SQL readings, we learned how to write basic SQL queries and incorporate <code>WHERE</code> clauses to filter for more specific results. We also learned how to use a <code>JOIN</code> operation to get information from multiple tables.</p>
<p>In this project, put your SQL knowledge to the test and show off your querying skills.</p>
<p>Weâ€™ve put together a collection (letâ€™s call it a <em>menagerie</em>) of SQL problems for you to solve below. Solve them all, and youâ€™ll be the master of the menagerie!</p>
<h2 id="getting-started">Getting started</h2>
<p>Clone the starter repository from https://github.com/-starters/sql-select-exercises-starter.</p>
<h2 id="project-overview-1">Project overview</h2>
<ol type="1">
<li>In Phase 1, pipe the seed file into a new database.</li>
<li>In Phase 2, query the seed tables with basic <code>SELECT</code> statements.</li>
<li>In Phase 3, query the seed tables using <code>WHERE</code> clauses to get more specific rows back.</li>
<li>In Phase 4, use a <code>JOIN</code> operation to get data from both seed tables.</li>
<li>Bonuses! Go beyond what we learned in the readings to deepen your SQL query knowledge.</li>
</ol>
<h2 id="phase-1-pipe-in-a-seed-file-to-create-new-database-tables">Phase 1: Pipe in a seed file to create new database tables</h2>
<p>Weâ€™ve set up a seed file for you to use in this project called _<strong>cities_and_airports.sql_</strong> that will create two tables: a "cities" table and an "airports" table. These tables show the top 25 most populous U.S. cities and their airports, respectively. Pipe this file into your database, and use these tables for the rest of the project phases.</p>
<p>Go through the following steps:</p>
<ol type="1">
<li>Log into <code>psql</code>.</li>
<li>Create a new database called "travel".</li>
<li>Pipe the <em>cities_and_airports.sql</em> seed file into the "travel" database.</li>
<li>Check that thereâ€™s data in both the "cities" and "airports" tables.</li>
</ol>
<h2 id="phase-2-write-basic-select-statements">Phase 2: Write basic SELECT statements</h2>
<p>Retrieve rows from a table using <code>SELECT</code> FROM SQL statements.</p>
<ol type="1">
<li><p>Write a SQL query that returns the city, state, and estimated population in 2018 from the "cities" table.</p></li>
<li><p>Write a SQL query that returns all of the airport names contained in the "airports" table.</p></li>
</ol>
<h2 id="phase-3-add-where-clauses">Phase 3: Add WHERE clauses</h2>
<p>Select specific rows from a table using WHERE and common operators.</p>
<ol type="1">
<li>Write a SQL query that uses a <code>WHERE</code> clause to get the estimated population in 2018 of the city of San Diego.</li>
<li>Write a SQL query that uses a <code>WHERE</code> clause to get the city, state, and estimated population in 2018 of cities in this list: Phoenix, Jacksonville, Charlotte, Nashville.</li>
<li>Write a SQL query that uses a <code>WHERE</code> clause to get the cities with an estimated 2018 population between 800,000 and 900,000 people. Show the city, state, and estimated population in 2018 columns.</li>
<li>Write a SQL query that uses a <code>WHERE</code> clause to get the names of the cities that had an estimated population in 2018 of at least 1 million people (or 1,000,000 people).</li>
<li>Write a SQL query to get the city and estimated population in 2018 in number of millions (<em>i.e.Â without zeroes at the end: 1 million</em>), and that uses a <code>WHERE</code> clause to return only the cities in Texas.</li>
<li>Write a SQL query that uses a <code>WHERE</code> clause to get the city, state, and estimated population in 2018 of cities that are NOT in the following states: New York, California, Texas.</li>
<li>Write a SQL query that uses a <code>WHERE</code> clause with the <code>LIKE</code> operator to get the city, state, and estimated population in 2018 of cities that start with the letter "S". (<em>Note: See the PostgreSQL doc on <a href="https://www.postgresql.org/docs/9.1/sql-createindex.html">Pattern Matching</a> for more information.</em>)</li>
<li>Write a SQL query that uses a <code>WHERE</code> clause to find the cities with either a land area of over 400 square miles OR a population over 2 million people (or 2,000,000 people). Show the city name, the land area, and the estimated population in 2018.</li>
<li>Write a SQL query that uses a <code>WHERE</code> clause to find the cities with either a land area of over 400 square miles OR a population over 2 million people (or 2,000,000 people) â€“ but not the cities that have both. Show the city name, the land area, and the estimated population in 2018.</li>
<li>Write a SQL query that uses a <code>WHERE</code> clause to find the cities where the population has increased by over 200,000 people from 2010 to 2018. Show the city name, the estimated population in 2018, and the census population in 2010.</li>
</ol>
<h2 id="phase-4-use-a-join-operation">Phase 4: Use a JOIN operation</h2>
<p>Retrieve rows from multiple tables joining on a foreign key.</p>
<p>The "airports" table has a foreign key called <code>city_id</code> that references the <code>id</code> column in the "cities" table.</p>
<ol type="1">
<li>Write a SQL query using an INNER JOIN to join data from the "cities" table with data from the "airports" table using the <code>city_id</code> foreign key. Show the airport names and city names only.</li>
<li>Write a SQL query using an INNER JOIN to join data from the "cities" table with data from the "airports" table to find out how many airports are in New York City using the city name. (<em>Note: Use the <a href="https://www.postgresql.org/docs/9.1/using-explain.html">aggregate function</a> COUNT() to count the number of matching rows.</em>)</li>
</ol>
<h2 id="bonuses">Bonuses</h2>
<ol type="1">
<li><strong>Apostrophe:</strong> Write a SQL query to get all three ID codes (<em>the Federal Aviation Administration (FAA) ID, the International Air Transport Association (IATA) ID, and the International Civil Aviation Organization (ICAO) ID</em>) from the "airports" table for Chicago Oâ€™Hare International Airport. (<em>Note: Youâ€™ll need to escape the quotation mark in Oâ€™Hare. See <a href="https://www.postgresql.org/docs/9.1/indexes.html">How to include a single quote in a SQL query</a>.</em>)</li>
<li><p><strong>Formatting Commas:</strong> Refactor Phase 2, Query #1 to turn the INT for estimated population in 2018 into a character string with commas. (<em>Note: See <a href="https://www.postgresql.org/docs/8.1/performance-tips.html">Data Type Formatting Functions</a></em>)</p>
<ul>
<li>Phase 2, Query #1: Write a SQL query that returns the city, state, and estimated population in 2018 from the "cities" table.</li>
</ul></li>
<li><p><strong>Decimals and Rounding:</strong> Refactor Phase 3, Query #5 to turn number of millions from an integer into a decimal rounded to a precision of two decimal places. (<em>Note: See <a href="https://devcenter.heroku.com/articles/postgresql-indexes">Numeric Types</a> and the <a href="https://crate.io/a/sql-subquery-vs-left-join/">ROUND function</a>.</em>)</p>
<ul>
<li>Phase 3, Query #5: Write a SQL query to get the city and estimated population in 2018 in number of millions (<em>i.e.Â without zeroes at the end: 1 million</em>), and that uses a <code>WHERE</code> clause to return only the cities in Texas.</li>
</ul></li>
<li><strong>ORDER BY and LIMIT Clauses:</strong> Refactor Phase 3, Query #10 to return only one city with the biggest population increase from 2010 to 2018. Show the city name, the estimated population in 2018, and the census population in 2010 for that city. (_Note: Youâ€™ll do the same calculation as before, but instead of comparing it to 200,000, use the <a href="http://www.postgresqltutorial.com/postgresql-subquery/">ORDER BY Clause</a> with the <a href="https://www.postgresql.org/docs/8.3/functions-subquery.html">LIMIT</a> Clause to sort the results and grab only the top result.)
<ul>
<li>Phase 3, Query #10: Write a SQL query that uses a <code>WHERE</code> clause to find the cities where the population has increased by over 200,000 people from 2010 to 2018. Show the city name, the estimated population in 2018, and the census population in 2010.</li>
</ul></li>
</ol>
<hr />
<h1 id="week-10-day-3-deeper-into-data" data-ignore="true">WEEK-10 DAY-3<br><em>Deeper Into Data</em></h1>
<hr />
<hr />
<h1 id="creating-a-schema-for-relational-database-design">Creating A Schema For Relational Database Design</h1>
<p>Schemas allow use to easily visualize database tables and their relationships to one another, so that we can identify areas that need clarity, refinement, or redesign.</p>
<p>In this reading, weâ€™re going to cover the stages of relational database design and how to create schema that depicts database table relationships.</p>
<h2 id="what-is-relational-database-design">What is Relational Database Design?</h2>
<p>According to Technopedia, <a href="https://www.postgresql.org/docs/9.1/sql-createindex.html">Relational Database Design</a> (or RDD) differs from other databases in terms of data organization and transactions: "In an RDD, the data are organized into tables and all types of data access are carried out via controlled transactions."</p>
<p>In previous readings, we created relational database tables and accessed data from these tables through PostgreSQL queries. These tables (a.k.a. <em>entities</em>) contain rows (a.k.a. <em>records</em>) and columns (a.k.a. <em>fields</em>). We also learned how to uniquely identify table records by adding a <code>PRIMARY KEY</code> and how to create a table association by adding a <code>FOREIGN KEY</code>.</p>
<p>A relational database usually contains multiple tables. Itâ€™s useful to create schema to help us visualize these tables, keep track of primary keys and foreign keys, and create relationships among tables. This is a key part of the RDD process defined below.</p>
<h2 id="stages-of-relational-database-design">Stages of Relational Database Design</h2>
<p>There are four generally-agreed-upon stages of Relational Database Design:</p>
<ol type="1">
<li>Define the purpose/entities of the relational DB.</li>
<li>Identify primary keys.</li>
<li>Establish table relationships.</li>
<li>Apply normalization rules.</li>
</ol>
<h3 id="define-database-purpose-and-entities">1. Define database purpose and entities</h3>
<p>The first stage is identifying the purpose of the database (<em>Why is the database being created? What problem is it solving? What is the data used for?</em>), as well as identifying the main entities, or <em>tables</em>, that need to be created. It also typically involves identifying the tableâ€™s attributes (i.e.Â <em>columns</em> and <em>rows</em>).</p>
<p>For example, if we were creating a database for order processing on an e-commerce application, we would need a database with at least three tables: a <code>products</code> table, an <code>orders</code> tables, and a <code>users</code> (i.e.Â customers) table. We know that a product will probably have an ID, name, and price, and an order will contain one or more product IDs. We also know that users can create multiple orders.</p>
<figure>
<img src="images/orders-erd-entities.svg" alt="Orders ERD entities" /><figcaption>Orders ERD entities</figcaption>
</figure>
<h3 id="identify-primary-keys">2. Identify primary keys</h3>
<p>The second stage is to identify the primary key (<em>PK</em>) of each table. As we previously learned, a tableâ€™s primary key contains a unique value, or values, that identify each distinct record. For our above example of online orders, we would probably create IDs to serve as the primary key for each table: a product ID, an order ID, and a user ID.</p>
<figure>
<img src="images/orders-erd-primary-keys.svg" alt="orders-erd-primary-keys.svg" /><figcaption>orders-erd-primary-keys.svg</figcaption>
</figure>
<h3 id="establish-table-relationships">3. Establish table relationships</h3>
<p>The third stage is to establish the relationships among the tables in the database. There are three types of relational database table relationships:</p>
<ul>
<li>One-to-one</li>
<li>One-to-many</li>
<li>Many-to-many</li>
</ul>
<p><strong>One-to-one relationship</strong></p>
<p>In a one-to-one relationship, one record in a table is associated with only one record in another table. We could say that only one record in Table B belongs to only one record in Table A.</p>
<p>A one-to-one relationship is the least common type of table relationship. While the two tables above could be combined into a single table, we may want to keep some less-used data separate from the main <code>products</code> table.</p>
<figure>
<img src="images/products-erd-one-to-one.svg" alt="products-erd-one-to-one.svg" /><figcaption>products-erd-one-to-one.svg</figcaption>
</figure>
<p>The above schema depicts two tables: a "products" table and a "product_details" table. A <code>product_details</code> record belongs to only one product record. Weâ€™ve used an arrow to indicate the one-to-one relationship between the tables. Both tables have the same primary key â€“ <code>product_id</code> â€“ which we can use in a <a href="https://www.postgresql.org/docs/9.1/using-explain.html"><code>JOIN</code></a> operation to get data from both tables.</p>
<p>This table relationship would produce the following example data (note that not all columns are shown below):</p>
<p><strong>Products</strong></p>
<table>
<thead>
<tr class="header">
<th>id</th>
<th>name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1597</td>
<td>Glass Coffee Mug</td>
</tr>
<tr class="even">
<td>1598</td>
<td>Metallic Coffee Mug</td>
</tr>
<tr class="odd">
<td>1599</td>
<td>Smart Coffee Mug</td>
</tr>
</tbody>
</table>
<p><strong>Product Details</strong></p>
<table>
<colgroup>
<col style="width: 1%" />
<col style="width: 4%" />
<col style="width: 93%" />
</colgroup>
<thead>
<tr class="header">
<th>id</th>
<th>product_id</th>
<th>full_description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>1597</td>
<td>Sturdy tempered glass coffee mug with natural cork band and silicone lid. Barista standard - fits under commercial coffee machine heads and most cup-holders.</td>
</tr>
<tr class="even">
<td>2</td>
<td>1598</td>
<td>Fun coffee mug that comes in various metallic colors. Sleek, stylish, and easy to wash. Makes a great addition to your kitchen. Take it on the go by attaching the secure lid.</td>
</tr>
<tr class="odd">
<td>3</td>
<td>1599</td>
<td>This smart mug goes beyond being a simple coffee receptacle. Its smart features let you set and maintain an exact drinking temperature for up to 1.5 hours, so your coffee is never too hot or too cold.</td>
</tr>
</tbody>
</table>
<p>Take a moment to analyze the data above. Using the foreign keys, you should be able to reason out that the "Metallic Coffee Mug" is a "Fun coffee mug that comes in various metallic colors."</p>
<p><strong>One-to-many relationship</strong></p>
<p>In a one-to-many relationship, each record in Table A is associated with multiple records in Table B. Each record in Table B is associated with only one record in Table A.</p>
<figure>
<img src="images/orders-erd-one-to-many.svg" alt="orders-erd-one-to-many.svg" /><figcaption>orders-erd-one-to-many.svg</figcaption>
</figure>
<p>The above schema depicts a one-to-many relationship between the "users" table and the <code>orders</code> table: One user can create multiple orders. The primary key of the "orders" table (<code>id</code>) is a foreign key in the "users" table (<code>order_id</code>). We can use this foreign key in a <code>JOIN</code> operation to get data from both tables.</p>
<p>This table relationship would produce the following example data (note that not all columns are shown below):</p>
<p><strong>Users</strong></p>
<table>
<thead>
<tr class="header">
<th>id</th>
<th>name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Alice</td>
</tr>
<tr class="even">
<td>2</td>
<td>Bob</td>
</tr>
</tbody>
</table>
<p><strong>Orders</strong></p>
<table>
<thead>
<tr class="header">
<th>id</th>
<th>purchaser_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>10</td>
<td>1</td>
</tr>
<tr class="even">
<td>11</td>
<td>1</td>
</tr>
<tr class="odd">
<td>12</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>Take a moment to analyze the data above. Using the foreign keys, you should be able to reason out that "Alice" has made two orders and "Bob" has made one order.</p>
<p><strong>Many-to-many relationship</strong></p>
<p>In a many-to-many relationship, multiple records in Table A are associated with multiple records in Table B. You would normally create a third table for this relationship called a <em><strong>join table</strong></em>, which contains the primary keys from both tables.</p>
<figure>
<img src="images/orders-erd-many-to-many.svg" alt="orders-erd-many-to-many.svg" /><figcaption>orders-erd-many-to-many.svg</figcaption>
</figure>
<p>The above schema depicts a many-to-many relationship between the <code>products</code> table and the <code>orders</code> table. A single order can have multiple products, and a single product can belong to multiple orders. We created a third join table called <code>order_details</code>, which contains both the<code>order_id</code> and <code>product_id</code> fields as foreign keys.</p>
<p>This table relationship would produce the following example data(note that not all columns are shown below):</p>
<p><strong>Products</strong></p>
<table>
<thead>
<tr class="header">
<th>id</th>
<th>name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1597</td>
<td>Glass Coffee Mug</td>
</tr>
<tr class="even">
<td>1598</td>
<td>Metallic Coffee Mug</td>
</tr>
<tr class="odd">
<td>1599</td>
<td>Smart Coffee Mug</td>
</tr>
</tbody>
</table>
<p><strong>Users</strong></p>
<table>
<thead>
<tr class="header">
<th>id</th>
<th>name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Alice</td>
</tr>
<tr class="even">
<td>2</td>
<td>Bob</td>
</tr>
</tbody>
</table>
<p><strong>Orders</strong></p>
<table>
<thead>
<tr class="header">
<th>id</th>
<th>purchaser_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>10</td>
<td>1</td>
</tr>
<tr class="even">
<td>11</td>
<td>1</td>
</tr>
<tr class="odd">
<td>12</td>
<td>2</td>
</tr>
</tbody>
</table>
<p><strong>Order Details</strong></p>
<table>
<thead>
<tr class="header">
<th>id</th>
<th>order_id</th>
<th>product_id</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>10</td>
<td>1599</td>
</tr>
<tr class="even">
<td>2</td>
<td>11</td>
<td>1597</td>
</tr>
<tr class="odd">
<td>3</td>
<td>11</td>
<td>1598</td>
</tr>
<tr class="even">
<td>4</td>
<td>12</td>
<td>1597</td>
</tr>
<tr class="odd">
<td>5</td>
<td>12</td>
<td>1598</td>
</tr>
<tr class="even">
<td>6</td>
<td>12</td>
<td>1599</td>
</tr>
</tbody>
</table>
<p>Take a moment to analyze the data above. Using the foreign keys, you should be able to reason out that "Alice" has two orders. One order containing a "Smart Coffee Mug" and another order containing both a "Glass Coffee Mug" and "Metallic Coffee Mug".</p>
<h3 id="apply-normalization-rules">4. Apply normalization rules</h3>
<p>The fourth stage in RDD is <em><strong>normalization</strong></em>. Normalization is the process of optimizing the database structure so that redundancy and confusion are eliminated.</p>
<p>The rules of normalization are called "normal forms" and are as follows:</p>
<ol type="1">
<li>First normal form</li>
<li>Second normal form</li>
<li>Third normal form</li>
<li>Boyce-Codd normal form</li>
<li>Fifth normal form</li>
</ol>
<p>The first three forms are widely used in practice, while the fourth and fifth are less often used.</p>
<p><strong>First normal form rules:</strong></p>
<ul>
<li>Eliminate repeating groups in individual tables.</li>
<li>Create a separate table for each set of related data.</li>
<li>Identify each set of related data with a primary key.</li>
</ul>
<p><strong>Second normal form rules:</strong></p>
<ul>
<li>Create separate tables for sets of values that apply to multiple records.</li>
<li>Relate these tables with a foreign key.</li>
</ul>
<p><strong>Third normal form rules:</strong></p>
<ul>
<li>Eliminate fields that do not depend on the tableâ€™s key.</li>
</ul>
<p><em>Note: For examples of how to apply these forms, read <a href="https://www.postgresql.org/docs/9.1/indexes.html">"Description of the database normalization basics"</a> from Microsoft.</em></p>
<h2 id="schema-design-tools">Schema design tools</h2>
<p>Many people draw their relational database design schema with good olâ€™ pen and paper, or on a whiteboard. However, there are also lots of online tools created for this purpose if youâ€™d like to use something easily exportable/shareable. Feel free to check out the ERD (short for "Entity Relationship Diagram") tools below.</p>
<p>Free Database Diagram (ERD) Design Tools:</p>
<ul>
<li><a href="https://www.postgresql.org/docs/8.1/performance-tips.html">Lucidchart</a></li>
<li><a href="https://devcenter.heroku.com/articles/postgresql-indexes">draw.io</a></li>
<li><a href="https://crate.io/a/sql-subquery-vs-left-join/">dbdiagram.io</a></li>
<li><a href="http://www.postgresqltutorial.com/postgresql-subquery/">QuickDBD</a></li>
</ul>
<h2 id="what-we-learned-6">What we learned:</h2>
<ul>
<li>Stages of Relational Database Design (RDD)</li>
<li>Examples of schema depicting table relationships</li>
<li>Normalization rules</li>
<li>Schema drawing tools</li>
</ul>
<hr />
<h1 id="using-sql-transactions">Using SQL Transactions</h1>
<p>Transactions allow us to make changes to a SQL database in a consistent and durable way, and itâ€™s a best practice to use them regularly.</p>
<p>In this reading, weâ€™ll cover what a transaction is and why we want to use it, as well as how to write explicit transactions.</p>
<h2 id="what-is-a-transaction">What is a transaction?</h2>
<p>A transaction is a single unit of work, which can contain multiple operations, performed on a database. According to the <a href="https://www.postgresql.org/docs/9.1/sql-createindex.html">PostgreSQL docs</a>, the important thing to note about a transaction is that "it bundles multiple steps into a single, all-or-nothing operation". If any operation within the transaction fails, then the entire transaction fails. If all the operations succeed, then the entire transaction succeeds.</p>
<h2 id="implicit-vs.-explicit-transactions">Implicit vs.Â explicit transactions</h2>
<p>Every SQL statement is effectively a transaction. When you insert a new table row into a database table, for example, you are creating a transaction. The following <code>INSERT</code> statement is a transaction:</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb130-1" title="1"><span class="kw">INSERT</span> <span class="kw">INTO</span> hobbits(name,purpose)</a>
<a class="sourceLine" id="cb130-2" title="2">  <span class="kw">VALUES</span>(<span class="st">&#39;Frodo&#39;</span>,<span class="st">&#39;Destroy the One Ring of power.&#39;</span>);</a></code></pre></div>
<p>The above code is known as an <em>implicit</em> transaction. With an implicit transaction, changes to the database happen immediately, and we have no way to undo or roll back these changes. We can only make subsequent changes/ transactions.</p>
<p>An <em>explicit</em> transaction, however, allows us to create save points and roll back to whatever point in time we choose. An explicit transaction begins with the command <code>BEGIN</code>, followed by the SQL statement, and then ends with either a <code>COMMIT</code> or <code>ROLLBACK</code>.</p>
<h3 id="postgresql-transactional-commands">PostgreSQL transactional commands</h3>
<p><strong><a href="https://www.postgresql.org/docs/9.1/indexes.html">BEGIN</a></strong> â€“ Initiates a transaction block. All statements after a BEGIN command will be executed in a single transaction until an explicit COMMIT or ROLLBACK is given.</p>
<p>Starting a transaction:</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb131-1" title="1"><span class="cf">BEGIN</span>;</a>
<a class="sourceLine" id="cb131-2" title="2">  <span class="kw">INSERT</span> <span class="kw">INTO</span> hobbits(name,purpose)</a>
<a class="sourceLine" id="cb131-3" title="3">    <span class="kw">VALUES</span>(<span class="st">&#39;Frodo&#39;</span>,<span class="st">&#39;Destroy the One Ring of power.&#39;</span>);</a></code></pre></div>
<p><strong><a href="https://www.postgresql.org/docs/8.1/performance-tips.html">COMMIT</a></strong> â€“ Commits the current transaction. All changes made by the transaction become visible to others and are guaranteed to be durable if a crash occurs.</p>
<p>Committing a transaction:</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb132-1" title="1"><span class="cf">BEGIN</span>;</a>
<a class="sourceLine" id="cb132-2" title="2">  <span class="kw">INSERT</span> <span class="kw">INTO</span> hobbits(name,purpose)</a>
<a class="sourceLine" id="cb132-3" title="3">    <span class="kw">VALUES</span>(<span class="st">&#39;Frodo&#39;</span>,<span class="st">&#39;Destroy the One Ring of power.&#39;</span>);</a>
<a class="sourceLine" id="cb132-4" title="4"><span class="kw">COMMIT</span>;</a></code></pre></div>
<p><strong><a href="https://devcenter.heroku.com/articles/postgresql-indexes">ROLLBACK</a></strong> â€“ Rolls back the current transaction and causes all the updates made by the transaction to be discarded. Can only undo transactions since the last COMMIT or ROLLBACK command was issued.</p>
<p>Rolling back a transaction (i.e.Â abort all changes):</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb133-1" title="1"><span class="cf">BEGIN</span>;</a>
<a class="sourceLine" id="cb133-2" title="2">  <span class="kw">INSERT</span> <span class="kw">INTO</span> hobbits(name,purpose)</a>
<a class="sourceLine" id="cb133-3" title="3">    <span class="kw">VALUES</span>(<span class="st">&#39;Frodo&#39;</span>,<span class="st">&#39;Destroy the One Ring of power.&#39;</span>);</a>
<a class="sourceLine" id="cb133-4" title="4"><span class="kw">ROLLBACK</span>;</a></code></pre></div>
<p><strong><a href="https://crate.io/a/sql-subquery-vs-left-join/">SAVEPOINT</a></strong> â€“ Establishes a new save point within the current transaction. Allows all commands executed after the save point to be rolled back, restoring the transaction state to what it was at the time of the save point.</p>
<p>Syntax to create save point: <code>SAVEPOINT savepoint_name;</code> Syntax to delete a save point: <code>RELEASE SAVEPOINT savepoint_name;</code></p>
<p>Letâ€™s say we had the following table called <code>fellowship</code>:</p>
<table>
<thead>
<tr class="header">
<th>name</th>
<th>age</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Frodo</td>
<td>50</td>
</tr>
<tr class="even">
<td>Samwise</td>
<td>38</td>
</tr>
<tr class="odd">
<td>Merry</td>
<td>36</td>
</tr>
<tr class="even">
<td>Pippin</td>
<td>28</td>
</tr>
<tr class="odd">
<td>Aragorn</td>
<td>87</td>
</tr>
<tr class="even">
<td>Boromir</td>
<td>40</td>
</tr>
<tr class="odd">
<td>Legolas</td>
<td>2000</td>
</tr>
<tr class="even">
<td>Gandalf</td>
<td>2000</td>
</tr>
</tbody>
</table>
<p>Weâ€™ll create a transaction on this table containing a few operations. Inside the transaction, weâ€™ll establish a save point that weâ€™ll roll back to before committing.</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb134-1" title="1"><span class="cf">BEGIN</span>;</a>
<a class="sourceLine" id="cb134-2" title="2">  <span class="kw">DELETE</span> <span class="kw">FROM</span> fellowship</a>
<a class="sourceLine" id="cb134-3" title="3">    <span class="kw">WHERE</span> age <span class="op">&gt;</span> <span class="dv">100</span>;</a>
<a class="sourceLine" id="cb134-4" title="4">  <span class="kw">SAVEPOINT</span> first_savepoint;</a>
<a class="sourceLine" id="cb134-5" title="5">  <span class="kw">DELETE</span> <span class="kw">FROM</span> fellowship</a>
<a class="sourceLine" id="cb134-6" title="6">    <span class="kw">WHERE</span> age <span class="op">&gt;</span> <span class="dv">80</span>;</a>
<a class="sourceLine" id="cb134-7" title="7">  <span class="kw">DELETE</span> <span class="kw">FROM</span> fellowship</a>
<a class="sourceLine" id="cb134-8" title="8">    <span class="kw">WHERE</span> age <span class="op">&gt;=</span> <span class="dv">40</span>;</a>
<a class="sourceLine" id="cb134-9" title="9">  <span class="kw">ROLLBACK</span> <span class="kw">TO</span> first_savepoint;</a>
<a class="sourceLine" id="cb134-10" title="10"><span class="kw">COMMIT</span>;</a></code></pre></div>
<p>Once our transaction is committed, our table would look like this:</p>
<table>
<thead>
<tr class="header">
<th>name</th>
<th>age</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Frodo</td>
<td>50</td>
</tr>
<tr class="even">
<td>Samwise</td>
<td>38</td>
</tr>
<tr class="odd">
<td>Merry</td>
<td>36</td>
</tr>
<tr class="even">
<td>Pippin</td>
<td>28</td>
</tr>
<tr class="odd">
<td>Aragorn</td>
<td>87</td>
</tr>
<tr class="even">
<td>Boromir</td>
<td>40</td>
</tr>
</tbody>
</table>
<p>We can see that the deletion that happened just prior to the savepoint creation was preserved.</p>
<p><strong><a href="http://www.postgresqltutorial.com/postgresql-subquery/">SET TRANSACTION</a></strong> â€“ Sets the characteristics of the current transaction. (_Note: To set characteristics for subsequent transactions in a session, use <code>SET SESSION   CHARACTERISTICS</code>.) The available transaction characteristics are the transaction isolation level, the transaction access mode (read/write or read-only), and the deferrable mode. (<em>Read more about these characteristics in the <a href="http://www.postgresqltutorial.com/postgresql-subquery/">PostgreSQL docs</a>.</em>)</p>
<p>Example of setting transaction characteristics:</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb135-1" title="1"><span class="cf">BEGIN</span>;</a>
<a class="sourceLine" id="cb135-2" title="2">  <span class="kw">SET</span> <span class="kw">TRANSACTION</span> <span class="kw">READ</span> <span class="kw">ONLY</span>;</a>
<a class="sourceLine" id="cb135-3" title="3">  <span class="op">..</span>.</a>
<a class="sourceLine" id="cb135-4" title="4"><span class="kw">COMMIT</span>;</a></code></pre></div>
<h2 id="when-to-use-transactions-and-why">When to use transactions and why</h2>
<p>It is generally a good idea to use explicit SQL transactions when making any updates, insertions, or deletions, to a database. However, you generally wouldnâ€™t write an explicit transaction for a simple <code>SELECT</code> query.</p>
<p>Transactions help you deal with crashes, failures, data consistency, and error handling. The ability to create savepoints and roll back to earlier points is tremendously helpful when doing multiple updates and helps maintain data integrity.</p>
<p>Another benefit of transactions is the <em><strong>atomic</strong></em>, or "all-or-nothing", nature of their operations. Because all of the operations in a transaction must succeed or else be aborted, partial or incomplete updates to the database will not be made. End-users will see only the final result of the transaction.</p>
<h2 id="transaction-properties-acid">Transaction properties: ACID</h2>
<p>A SQL transaction has four properties known collectively as "ACID" â€“ which is an acronym for <em>Atomic, Consistent, Isolated, and Durable</em>. The following descriptions come from the IBM doc "<a href="https://www.postgresql.org/docs/9.1/using-explain.html">ACID properties of transactions</a>":</p>
<p><strong>Atomicity</strong> â€“ All changes to data are performed as if they are a single operation. That is, all the changes are performed, or none of them are.</p>
<p>For example, in an application that transfers funds from one account to another, the atomicity property ensures that, if a debit is made successfully from one account, the corresponding credit is made to the other account.</p>
<p><strong>Consistency</strong> â€“ Data is in a consistent state when a transaction starts and when it ends.</p>
<p>For example, in an application that transfers funds from one account to another, the consistency property ensures that the total value of funds in both the accounts is the same at the start and end of each transaction.</p>
<p><strong>Isolation</strong> â€“ The intermediate state of a transaction is invisible to other transactions. As a result, transactions that run concurrently appear to be serialized.</p>
<p>For example, in an application that transfers funds from one account to another, the isolation property ensures that another transaction sees the transferred funds in one account or the other, but not in both, nor in neither.</p>
<p><strong>Durability</strong> â€“ After a transaction successfully completes, changes to data persist and are not undone, even in the event of a system failure.</p>
<p>For example, in an application that transfers funds from one account to another, the durability property ensures that the changes made to each account will not be reversed.</p>
<h3 id="banking-transaction-example">Banking transaction example</h3>
<p>Letâ€™s look at an example from the <a href="https://www.postgresql.org/docs/9.1/sql-createindex.html">PostgreSQL Transactions doc</a> that demonstrates the ACID properties of a transaction. We have a bank database that contains customer account balances, as well as total deposit balances for branches. We want to record a payment of $100.00 from Aliceâ€™s account to Bobâ€™s account, as well as update the total branch balances. The transaction would look like the code below.</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb136-1" title="1"><span class="cf">BEGIN</span>;</a>
<a class="sourceLine" id="cb136-2" title="2">  <span class="kw">UPDATE</span> accounts <span class="kw">SET</span> balance <span class="op">=</span> balance <span class="op">-</span> <span class="fl">100.00</span></a>
<a class="sourceLine" id="cb136-3" title="3">      <span class="kw">WHERE</span> name <span class="op">=</span> <span class="st">&#39;Alice&#39;</span>;</a>
<a class="sourceLine" id="cb136-4" title="4">  <span class="kw">UPDATE</span> branches <span class="kw">SET</span> balance <span class="op">=</span> balance <span class="op">-</span> <span class="fl">100.00</span></a>
<a class="sourceLine" id="cb136-5" title="5">      <span class="kw">WHERE</span> name <span class="op">=</span> (<span class="kw">SELECT</span> branch_name <span class="kw">FROM</span> accounts <span class="kw">WHERE</span> name <span class="op">=</span> <span class="st">&#39;Alice&#39;</span>);</a>
<a class="sourceLine" id="cb136-6" title="6">  <span class="kw">UPDATE</span> accounts <span class="kw">SET</span> balance <span class="op">=</span> balance <span class="op">+</span> <span class="fl">100.00</span></a>
<a class="sourceLine" id="cb136-7" title="7">      <span class="kw">WHERE</span> name <span class="op">=</span> <span class="st">&#39;Bob&#39;</span>;</a>
<a class="sourceLine" id="cb136-8" title="8">  <span class="kw">UPDATE</span> branches <span class="kw">SET</span> balance <span class="op">=</span> balance <span class="op">+</span> <span class="fl">100.00</span></a>
<a class="sourceLine" id="cb136-9" title="9">      <span class="kw">WHERE</span> name <span class="op">=</span> (<span class="kw">SELECT</span> branch_name <span class="kw">FROM</span> accounts <span class="kw">WHERE</span> name <span class="op">=</span> <span class="st">&#39;Bob&#39;</span>);</a>
<a class="sourceLine" id="cb136-10" title="10"><span class="kw">COMMIT</span>;</a></code></pre></div>
<p>There are several updates happening above. The bank wants to make sure that all of the updates happen or none happen, in order to ensure that funds are transferred from the proper account (i.e.Â Aliceâ€™s account) to the proper recipientâ€™s account (i.e.Â Bobâ€™s account). If any of the updates fails, none of them will take effect. That is, if something goes wrong either with withdrawing funds from Aliceâ€™s account or transferring the funds into Bobâ€™s account, then the entire transaction will be aborted and no changes will occur. This prevents Alice or Bob from seeing a transaction in their account summaries that isnâ€™t supposed to be there.</p>
<p>There are many other scenarios where we would want to use an atomic operation to ensure a successful end result. Transactions are ideal for such scenarios, and we should use them whenever theyâ€™re applicable.</p>
<h2 id="helpful-links-1">Helpful links:</h2>
<ul>
<li><a href="https://www.postgresql.org/docs/9.1/sql-createindex.html">PostgreSQL: Transactions</a></li>
<li><a href="https://www.postgresql.org/docs/8.3/functions-subquery.html">PostgreSQL Tutorial: PostgreSQL Transaction</a></li>
<li><a href="https://www.postgresql.org/docs/9.1/indexes.html">PostgreSQL: BEGIN</a></li>
<li><a href="https://www.postgresql.org/docs/8.1/performance-tips.html">PostgreSQL: COMMIT</a></li>
<li><a href="https://devcenter.heroku.com/articles/postgresql-indexes">PostgreSQL: ROLLBACK</a></li>
<li><a href="https://crate.io/a/sql-subquery-vs-left-join/">PostgreSQL: SAVEPOINT</a></li>
<li><a href="https://crate.io/a/sql-subquery-vs-left-join/">PostgreSQL: SET TRANSACTION</a></li>
</ul>
<hr />
<h1 id="joins-vs.-subqueries">Joins vs.Â Subqueries</h1>
<p>To select, or not to select? That is the query. Weâ€™ve barely scratched the surface of SQL queries. Previously, we went over how to write simple SQL queries using the <code>SELECT</code> statement, and we learned how to incorporate a <code>WHERE</code> clause into our queries.</p>
<p>Thereâ€™s a lot more we could add to our queries to get more refined results. In this reading, weâ€™ll go over joins and subqueries and talk about when we would use one over the other.</p>
<h2 id="what-is-a-join">What is a JOIN?</h2>
<p>We briefly looked at the <code>JOIN</code> operation after we created foreign keys in a previous reading. The <a href="https://www.postgresql.org/docs/9.1/sql-createindex.html">JOIN operation</a> allows us to retrieve rows from multiple tables.</p>
<p>To review, we had two tables: a "breeds" table and a "puppies" table. The two tables shared information through a foreign key. The foreign key <code>breed_id</code> lives on the "puppies" table and is related to the primary key <code>id</code> of the "breeds" table.</p>
<p>We wrote the following <code>INNER JOIN</code> operation to get only the rows from the "puppies" table with a matching <code>breed_id</code> in the "friends" table:</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb137-1" title="1"><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> puppies</a>
<a class="sourceLine" id="cb137-2" title="2"><span class="kw">INNER</span> <span class="kw">JOIN</span> breeds <span class="kw">ON</span> (puppies.breed_id <span class="op">=</span> breeds.<span class="kw">id</span>);</a></code></pre></div>
<p><a href="https://www.postgresql.org/docs/9.1/using-explain.html">INNER JOIN</a> can be represented as a Venn Diagram, which produces rows from Table A that match some information in Table B.</p>
<figure>
<img src="images/inner-join-venn-diagram.png" alt="inner-join-venn-diagram" /><figcaption>inner-join-venn-diagram</figcaption>
</figure>
<p>We got the following table rows back from our <code>INNER JOIN</code> on the "puppies" table. These rows represent the center overlapping area of the two circles. We can see that the data from "puppies" appears first, followed by the joined data from the "friends" table.</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb138-1" title="1"> <span class="kw">id</span> |   name   | age_yrs | breed_id | weight_lbs | microchipped | <span class="kw">id</span> |        name</a>
<a class="sourceLine" id="cb138-2" title="2"><span class="co">----+----------+---------+----------+------------+--------------+----+---------------------</span></a>
<a class="sourceLine" id="cb138-3" title="3">  <span class="dv">1</span> | Cooper   |     <span class="fl">1.0</span> |        <span class="dv">8</span> |         <span class="dv">18</span> | t            |  <span class="dv">8</span> | Miniature Schnauzer</a>
<a class="sourceLine" id="cb138-4" title="4">  <span class="dv">2</span> | Indie    |     <span class="fl">0.5</span> |        <span class="dv">9</span> |         <span class="dv">13</span> | t            |  <span class="dv">9</span> | Yorkshire Terrier</a>
<a class="sourceLine" id="cb138-5" title="5">  <span class="dv">3</span> | Kota     |     <span class="fl">0.7</span> |        <span class="dv">1</span> |         <span class="dv">26</span> | f            |  <span class="dv">1</span> | Australian Shepherd</a>
<a class="sourceLine" id="cb138-6" title="6">  <span class="dv">4</span> | Zoe      |     <span class="fl">0.8</span> |        <span class="dv">6</span> |         <span class="dv">32</span> | t            |  <span class="dv">6</span> | Korean Jindo</a>
<a class="sourceLine" id="cb138-7" title="7">  <span class="dv">5</span> | Charley  |     <span class="fl">1.5</span> |        <span class="dv">2</span> |         <span class="dv">25</span> | f            |  <span class="dv">2</span> | Basset Hound</a>
<a class="sourceLine" id="cb138-8" title="8">  <span class="dv">6</span> | Ladybird |     <span class="fl">0.6</span> |        <span class="dv">7</span> |         <span class="dv">20</span> | t            |  <span class="dv">7</span> | Labradoodle</a>
<a class="sourceLine" id="cb138-9" title="9">  <span class="dv">7</span> | Callie   |     <span class="fl">0.9</span> |        <span class="dv">4</span> |         <span class="dv">16</span> | f            |  <span class="dv">4</span> | Corgi</a>
<a class="sourceLine" id="cb138-10" title="10">  <span class="dv">8</span> | Jaxson   |     <span class="fl">0.4</span> |        <span class="dv">3</span> |         <span class="dv">19</span> | t            |  <span class="dv">3</span> | Beagle</a>
<a class="sourceLine" id="cb138-11" title="11">  <span class="dv">9</span> | Leinni   |     <span class="fl">1.0</span> |        <span class="dv">8</span> |         <span class="dv">25</span> | t            |  <span class="dv">8</span> | Miniature Schnauzer</a>
<a class="sourceLine" id="cb138-12" title="12"> <span class="dv">10</span> | <span class="fu">Max</span>      |     <span class="fl">1.6</span> |        <span class="dv">5</span> |         <span class="dv">65</span> | f            |  <span class="dv">5</span> | German Shepherd</a></code></pre></div>
<p>There are different types of <code>JOIN</code> operations. The ones youâ€™ll use most often are:</p>
<ol type="1">
<li><strong>Inner Join</strong> â€“ Returns a result set containing rows in the left table that match rows in the right table.</li>
<li><strong>Left Join</strong> â€“ Returns a result set containing all rows from the left table with the matching rows from the right table. If there is no match, the right side will have null values.</li>
<li><strong>Right Join</strong> â€“ Returns a result set containing all rows from the right table with matching rows from the left table. If there is no match, the left side will have null values.</li>
<li><strong>Full Outer Join</strong> â€“ Returns a result set containing all rows from both the left and right tables, with the matching rows from both sides where available. If there is no match, the missing side contains null values.</li>
<li><strong>Self-Join</strong> â€“ A self-join is a query in which a table is joined to itself. Self-joins are useful for comparing values in a column of rows within the same table.</li>
</ol>
<p>(<em>See this tutorial doc on <a href="https://www.postgresql.org/docs/9.1/indexes.html">PostgreSQL Joins</a> for more information on the different <code>JOIN</code> operations.</em>)</p>
<h2 id="what-is-a-subquery">What is a subquery?</h2>
<p>A subquery is essentially a <code>SELECT</code> statement nested inside another <code>SELECT</code> statement. A subquery can return a single ("scalar") value or multiple rows.</p>
<h3 id="single-value-subquery">Single-value subquery</h3>
<p>Letâ€™s see an example of how to use a subquery to return a single value. Take the "puppies" table from before. We had a column called <code>age_yrs</code> in that table (see below).</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb139-1" title="1">postgres<span class="op">=</span># <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> puppies;</a>
<a class="sourceLine" id="cb139-2" title="2"> <span class="kw">id</span> |   name   | age_yrs | breed_id | weight_lbs | microchipped</a>
<a class="sourceLine" id="cb139-3" title="3"><span class="co">----+----------+---------+----------+------------+--------------</span></a>
<a class="sourceLine" id="cb139-4" title="4">  <span class="dv">1</span> | Cooper   |     <span class="fl">1.0</span> |        <span class="dv">8</span> |         <span class="dv">18</span> | t</a>
<a class="sourceLine" id="cb139-5" title="5">  <span class="dv">2</span> | Indie    |     <span class="fl">0.5</span> |        <span class="dv">9</span> |         <span class="dv">13</span> | t</a>
<a class="sourceLine" id="cb139-6" title="6">  <span class="dv">3</span> | Kota     |     <span class="fl">0.7</span> |        <span class="dv">1</span> |         <span class="dv">26</span> | f</a>
<a class="sourceLine" id="cb139-7" title="7">  <span class="dv">4</span> | Zoe      |     <span class="fl">0.8</span> |        <span class="dv">6</span> |         <span class="dv">32</span> | t</a>
<a class="sourceLine" id="cb139-8" title="8">  <span class="dv">5</span> | Charley  |     <span class="fl">1.5</span> |        <span class="dv">2</span> |         <span class="dv">25</span> | f</a>
<a class="sourceLine" id="cb139-9" title="9">  <span class="dv">6</span> | Ladybird |     <span class="fl">0.6</span> |        <span class="dv">7</span> |         <span class="dv">20</span> | t</a>
<a class="sourceLine" id="cb139-10" title="10">  <span class="dv">7</span> | Callie   |     <span class="fl">0.9</span> |        <span class="dv">4</span> |         <span class="dv">16</span> | f</a>
<a class="sourceLine" id="cb139-11" title="11">  <span class="dv">8</span> | Jaxson   |     <span class="fl">0.4</span> |        <span class="dv">3</span> |         <span class="dv">19</span> | t</a>
<a class="sourceLine" id="cb139-12" title="12">  <span class="dv">9</span> | Leinni   |     <span class="fl">1.0</span> |        <span class="dv">8</span> |         <span class="dv">25</span> | t</a>
<a class="sourceLine" id="cb139-13" title="13"> <span class="dv">10</span> | <span class="fu">Max</span>      |     <span class="fl">1.6</span> |        <span class="dv">5</span> |         <span class="dv">65</span> | f</a>
<a class="sourceLine" id="cb139-14" title="14">(<span class="dv">10</span> <span class="kw">rows</span>)</a></code></pre></div>
<p>Weâ€™ll use the <a href="https://www.postgresql.org/docs/8.1/performance-tips.html">PostgreSQL aggregate function</a> <code>AVG</code> to get an average puppy age.</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb140-1" title="1"><span class="kw">SELECT</span></a>
<a class="sourceLine" id="cb140-2" title="2">  <span class="fu">AVG</span> (age_yrs)</a>
<a class="sourceLine" id="cb140-3" title="3"><span class="kw">FROM</span></a>
<a class="sourceLine" id="cb140-4" title="4">  puppies;</a></code></pre></div>
<p>Assuming our previous "puppies" table still exists in our database, if we entered the above statement into psql weâ€™d get an <em><strong>average age of 0.9</strong></em>. (<em>Note: Try it out yourself in psql! Refer to the reading "Retrieving Rows From A Table Using SELECT" if you need help remembering how we set up the "puppies" table.</em>)</p>
<p>Letâ€™s say that we wanted to find all of the puppies that are older than the average age of 0.9. We could write the following query:</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb141-1" title="1"><span class="kw">SELECT</span></a>
<a class="sourceLine" id="cb141-2" title="2">  name,</a>
<a class="sourceLine" id="cb141-3" title="3">  age_yrs,</a>
<a class="sourceLine" id="cb141-4" title="4">  breed</a>
<a class="sourceLine" id="cb141-5" title="5"><span class="kw">FROM</span></a>
<a class="sourceLine" id="cb141-6" title="6">  puppies</a>
<a class="sourceLine" id="cb141-7" title="7"><span class="kw">WHERE</span></a>
<a class="sourceLine" id="cb141-8" title="8">  age_yrs <span class="op">&gt;</span> <span class="fl">0.9</span>;</a></code></pre></div>
<p>In the above query, we compared <code>age_yrs</code> to an actual number (0.9). However, as more puppies get added to our table, the average age could change at any time. To make our statement more dynamic, we can plug in the query we wrote to find the average age into another statement as a <em>subquery</em> (surrounded by parentheses).</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb142-1" title="1"><span class="kw">SELECT</span></a>
<a class="sourceLine" id="cb142-2" title="2">  puppies.name,</a>
<a class="sourceLine" id="cb142-3" title="3">  age_yrs,</a>
<a class="sourceLine" id="cb142-4" title="4">  breeds.name</a>
<a class="sourceLine" id="cb142-5" title="5"><span class="kw">FROM</span></a>
<a class="sourceLine" id="cb142-6" title="6">  puppies</a>
<a class="sourceLine" id="cb142-7" title="7"><span class="kw">INNER</span> <span class="kw">JOIN</span></a>
<a class="sourceLine" id="cb142-8" title="8">  breeds <span class="kw">ON</span> (breeds.<span class="kw">id</span> <span class="op">=</span> puppies.breed_id)</a>
<a class="sourceLine" id="cb142-9" title="9"><span class="kw">WHERE</span></a>
<a class="sourceLine" id="cb142-10" title="10">  age_yrs <span class="op">&gt;</span> (</a>
<a class="sourceLine" id="cb142-11" title="11">    <span class="kw">SELECT</span></a>
<a class="sourceLine" id="cb142-12" title="12">      <span class="fu">AVG</span> (age_yrs)</a>
<a class="sourceLine" id="cb142-13" title="13">    <span class="kw">FROM</span></a>
<a class="sourceLine" id="cb142-14" title="14">      puppies</a>
<a class="sourceLine" id="cb142-15" title="15">  );</a></code></pre></div>
<p>We should get the following table rows, which include only the puppies older than 9 months:</p>
<pre class="shell"><code>  name   | age_yrs |        breed
---------+---------+---------------------
 Cooper  |     1.0 | Miniature Schnauzer
 Charley |     1.5 | Basset Hound
 Leinni  |     1.0 | Miniature Schnauzer
 Max     |     1.6 | German Shepherd</code></pre>
<h3 id="multiple-row-subquery">Multiple-row subquery</h3>
<p>We could also write a subquery that returns multiple rows.</p>
<p>In the reading "Creating A Table In An Existing PostgreSQL Database", we created a "friends" table. In "Foreign Keys And The JOIN Operation", we set up a primary key in the "puppies" table that is a foreign key in the "friends" table â€“ <code>puppy_id</code>. Weâ€™ll use this ID in our subquery and outer query.</p>
<p><strong>"friends" table</strong></p>
<pre class="shell"><code>id | first_name | last_name | puppy_id
----+------------+-----------+----------
  1 | Amy        | Pond      |        4
  2 | Rose       | Tyler     |        5
  3 | Martha     | Jones     |        6
  4 | Donna      | Noble     |        7
  5 | River      | Song      |        8</code></pre>
<p>Letâ€™s say we wanted to find all the puppies that are younger than 6 months old.</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb145-1" title="1"><span class="kw">SELECT</span> puppy_id</a>
<a class="sourceLine" id="cb145-2" title="2"><span class="kw">FROM</span> puppies</a>
<a class="sourceLine" id="cb145-3" title="3"><span class="kw">WHERE</span></a>
<a class="sourceLine" id="cb145-4" title="4">  age_yrs <span class="op">&lt;</span> <span class="fl">0.6</span>;</a></code></pre></div>
<p>This would return two rows:</p>
<pre class="shell"><code>puppy_id
----------
        2
        8
(2 rows)</code></pre>
<p>Now we want to use the above statement as a subquery (inside parentheses) in another query. Youâ€™ll notice weâ€™re using a <code>WHERE</code> clause with the <a href="https://devcenter.heroku.com/articles/postgresql-indexes">IN</a> operator to check if the <code>puppy_id</code> from the "friends" table meets the conditions in the subquery.</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb147-1" title="1"><span class="kw">SELECT</span> <span class="op">*</span></a>
<a class="sourceLine" id="cb147-2" title="2"><span class="kw">FROM</span> friends</a>
<a class="sourceLine" id="cb147-3" title="3"><span class="kw">WHERE</span></a>
<a class="sourceLine" id="cb147-4" title="4">  puppy_id <span class="kw">IN</span> (</a>
<a class="sourceLine" id="cb147-5" title="5">    <span class="kw">SELECT</span> puppy_id</a>
<a class="sourceLine" id="cb147-6" title="6">    <span class="kw">FROM</span> puppies</a>
<a class="sourceLine" id="cb147-7" title="7">    <span class="kw">WHERE</span></a>
<a class="sourceLine" id="cb147-8" title="8">      age_yrs <span class="op">&lt;</span> <span class="fl">0.6</span></a>
<a class="sourceLine" id="cb147-9" title="9">  );</a></code></pre></div>
<p>We should get just one row back. River Song has a puppy younger than 6 months old.</p>
<pre class="shell"><code> id | first_name | last_name | puppy_id
----+------------+-----------+----------
  5 | River      | Song      |        8
(1 row)</code></pre>
<h2 id="using-joins-vs.-subqueries">Using joins vs.Â subqueries</h2>
<p>We can use either a <code>JOIN</code> operation or a subquery to filter for the same information. Both methods can be used to get info from multiple tables. Take the query/subquery from above:</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb149-1" title="1"><span class="kw">SELECT</span> <span class="op">*</span></a>
<a class="sourceLine" id="cb149-2" title="2"><span class="kw">FROM</span> friends</a>
<a class="sourceLine" id="cb149-3" title="3"><span class="kw">WHERE</span></a>
<a class="sourceLine" id="cb149-4" title="4">  puppy_id <span class="kw">IN</span>  (</a>
<a class="sourceLine" id="cb149-5" title="5">    <span class="kw">SELECT</span> puppy_id</a>
<a class="sourceLine" id="cb149-6" title="6">    <span class="kw">FROM</span> puppies</a>
<a class="sourceLine" id="cb149-7" title="7">    <span class="kw">WHERE</span></a>
<a class="sourceLine" id="cb149-8" title="8">      age_yrs <span class="op">&lt;</span> <span class="fl">0.6</span></a>
<a class="sourceLine" id="cb149-9" title="9">  );</a></code></pre></div>
<p>Which produced the following result:</p>
<pre class="shell"><code> id | first_name | last_name | puppy_id
----+------------+-----------+----------
  5 | River      | Song      |        8
(1 row)</code></pre>
<p>Instead of using a <code>WHERE</code> clause with a subquery, we could use a <code>JOIN</code> operation:</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb151-1" title="1"><span class="kw">SELECT</span> <span class="op">*</span></a>
<a class="sourceLine" id="cb151-2" title="2"><span class="kw">FROM</span> friends</a>
<a class="sourceLine" id="cb151-3" title="3"><span class="kw">INNER</span> <span class="kw">JOIN</span> puppies <span class="kw">ON</span> (puppies.puppy_id <span class="op">=</span> friends.puppy_id)</a>
<a class="sourceLine" id="cb151-4" title="4"><span class="kw">WHERE</span></a>
<a class="sourceLine" id="cb151-5" title="5">  puppies.age_yrs <span class="op">&lt;</span> <span class="fl">0.6</span>;</a></code></pre></div>
<p>Again, weâ€™d get back one result, but because we used an <code>INNER JOIN</code> we have information from both the "puppies" and "friends" tables.</p>
<pre class="shell"><code>id | first_name | last_name | puppy_id |  name  | age_yrs | breed  | weight_lbs | microchipped | puppy_id
----+------------+-----------+----------+--------+---------+--------+------------+--------------+----------
  5 | River      | Song      |        8 | Jaxson |     0.4 | Beagle |         19 | t            |        8
(1 row)</code></pre>
<h3 id="should-i-use-a-join-or-a-subquery">Should I use a JOIN or a subquery?</h3>
<p>As stated earlier, we could use either a JOIN operation or a subquery to filter for table rows. However, you might want to think about whether using a JOIN or a subquery is more appropriate for retrieving data.</p>
<p>A JOIN operation is ideal when you want to combine rows from one or more tables based on a match condition. Subqueries work great when youâ€™re returning a single value. When youâ€™re returning multiple rows, you could opt for a subquery or a JOIN.</p>
<p>Executing a query using a JOIN could potentially be faster than executing a subquery that would return the same data. (A subquery will execute once for each row returned in the outer query, whereas the <code>INNER JOIN</code> only has to make one pass through the data.) However, this isnâ€™t always the case. Performance depends on the size of your data, what youâ€™re filtering for, and how the server optimizes the query. With smaller datasets, the difference in performance of a JOIN and subquery is imperceptible. However, there are use cases where a subquery would improve performance.</p>
<p>(<em>See this article for more info: <a href="https://crate.io/a/sql-subquery-vs-left-join/">When is a SQL Subquery 260x Faster than a Left Join?</a></em>)</p>
<p>We can use the the <a href="http://www.postgresqltutorial.com/postgresql-explain/">EXPLAIN</a> statement to see runtime statistics of our queries that help with debugging slow queries. (Weâ€™ll get into this more later!)</p>
<h2 id="helpful-links-2">Helpful links:</h2>
<ul>
<li>PostgreSQL Tutorial: <a href="https://www.postgresql.org/docs/9.1/indexes.html">PostgreSQL Joins</a></li>
<li>PostgreSQL Tutorial: <a href="http://www.postgresqltutorial.com/postgresql-subquery/">PostgreSQL Subquery</a></li>
<li>PostgreSQL Docs: <a href="https://www.postgresql.org/docs/8.3/functions-subquery.html">Subquery Expressions</a></li>
<li>Essential SQL: <a href="https://www.essentialsql.com/what-is-the-difference-between-a-join-and-subquery/">Subqueries versus Joins</a></li>
<li>Essential SQL: <a href="https://www.essentialsql.com/get-ready-to-learn-sql-server-20-using-subqueries-in-the-select-statement/">Using Subqueries with the Select Statement</a></li>
</ul>
<hr />
<h1 id="postgresql-indexes">PostgreSQL Indexes</h1>
<p>PostgreSQL indexes can help us optimize our queries for faster performance. In this reading, weâ€™ll learn how to create an index, when to use an index, and when to avoid using them.</p>
<h2 id="what-is-a-postgresql-index">What is a PostgreSQL index?</h2>
<p>A PostgreSQL index works like an index in the back of a book. It points to information contained elsewhere and can be a faster method of looking up the information we want.</p>
<p>A book index contains a list of references with page numbers. Instead of having to scan all the pages of the book to find the places where specific information appears, a reader can simply check the index. In similar fashion, PostgreSQL indexes, which are special lookup tables, let us make faster database queries.</p>
<p>Letâ€™s say we had the following table:</p>
<table>
<thead>
<tr class="header">
<th>addresses</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>address_id</td>
</tr>
<tr class="even">
<td>address</td>
</tr>
<tr class="odd">
<td>address2</td>
</tr>
<tr class="even">
<td>city_id</td>
</tr>
<tr class="odd">
<td>postal_code</td>
</tr>
<tr class="even">
<td>phone_number</td>
</tr>
</tbody>
</table>
<p>And we made a query to the database like the following:</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb153-1" title="1"><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> addresses <span class="kw">WHERE</span> phone_number <span class="op">=</span> <span class="st">&#39;5556667777&#39;</span>;</a></code></pre></div>
<p>The above query would scan every row of the "addresses" table to find matching rows based on the given phone number. If "addresses" is a large table (letâ€™s say with millions of entries), and we only expect to get a small number of results back (one row, or a few rows), then such a query would be an inefficient way to retrieve data. Instead of scanning every row, we could create an index for the phone column for faster data retrieval.</p>
<h2 id="how-to-create-an-index">How to create an index</h2>
<p>To create a <a href="https://www.postgresql.org/docs/9.1/sql-createindex.html">PostgreSQL index</a>, use the following syntax:</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb154-1" title="1"><span class="kw">CREATE</span> <span class="kw">INDEX</span> index_name <span class="kw">ON</span> table_name (column_name);</a></code></pre></div>
<p>We can create a phone number index for the above "addresses" table with the following:</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb155-1" title="1"><span class="kw">CREATE</span> <span class="kw">INDEX</span> addresses_phone_index <span class="kw">ON</span> addresses (phone_number);</a></code></pre></div>
<p>You can delete an index using the <code>DROP INDEX</code> command:</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb156-1" title="1"><span class="kw">DROP</span> <span class="kw">INDEX</span> addresses_phone_index;</a></code></pre></div>
<p>After an index has been created, the system will take care of the rest â€“ it will update an index when the table is modified and use the index in queries when it improves performance over a full table scan.</p>
<h3 id="types-of-indexes">Types of indexes</h3>
<p>PostgreSQL provides several index types: B-tree, Hash, GiST and GIN. The CREATE INDEX command creates B-tree indexes by default, which fit the most common situations. While itâ€™s good to know other index types exist, youâ€™ll probably find yourself using the default B-tree most often.</p>
<p><strong>Single-Column Indexes</strong> Uses only one table column.</p>
<p>Syntax:</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb157-1" title="1"><span class="kw">CREATE</span> <span class="kw">INDEX</span> index_name <span class="kw">ON</span> table_name (column_name);</a></code></pre></div>
<p>Addresses Example:</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb158-1" title="1"><span class="kw">CREATE</span> <span class="kw">INDEX</span> addresses_phone_index <span class="kw">ON</span> addresses (phone_number);</a></code></pre></div>
<p><strong>Multiple-Column Indexes</strong> Uses more than one table column.</p>
<p>Syntax:</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb159-1" title="1"><span class="kw">CREATE</span> <span class="kw">INDEX</span> index_name <span class="kw">ON</span> table_name (col1_name, col2_name);</a></code></pre></div>
<p>Addresses Example:</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb160-1" title="1"><span class="kw">CREATE</span> <span class="kw">INDEX</span> idx_addresses_city_post_code <span class="kw">ON</span> table_name (city_id, postal_code);</a></code></pre></div>
<p><strong>Partial Indexes</strong> Uses subset of a table defined by a conditional expression.</p>
<p>Syntax:</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb161-1" title="1"><span class="kw">CREATE</span> <span class="kw">INDEX</span> index_name <span class="kw">ON</span> table_name <span class="kw">WHERE</span> (conditional_expression);</a></code></pre></div>
<p>Addresses Example:</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb162-1" title="1"><span class="kw">CREATE</span> <span class="kw">INDEX</span> addresses_phone_index <span class="kw">ON</span> addresses (phone_number) <span class="kw">WHERE</span> (city_id <span class="op">=</span> <span class="dv">2</span>);</a></code></pre></div>
<p><strong>Note</strong>: Check out <a href="https://www.postgresql.org/docs/9.1/indexes.html">Chapter 11 on Indexes</a> in the PostgreSQL docs for more about types of indexes.</p>
<h2 id="when-to-use-an-index">When to use an index</h2>
<p>Indexes are intended to enhance database performance and are generally thought to be a faster data retrieval method than a sequential (or row-by-row) table scan. However, there are instances where using an index would not improve efficiency, such as the following:</p>
<ul>
<li>When working with a relatively small table (i.e.Â not a lot of rows)</li>
<li>When a table has frequent, large-batch update or insert operations</li>
<li>When working with columns that contain many NULL values</li>
<li>When working with columns that are frequently manipulated</li>
</ul>
<p>An important thing to note about indexes is that, while they can optimize READ (i.e.Â table query) speed, they can also hamper WRITE (i.e.Â table updates/insertions) speed. The latterâ€™s performance is affected due to the system having to spend time updating indexes whenever a change or insertion is made to the table.</p>
<p>The system optimizes database performance and decides whether to use an index in a query or to perform a sequential table scan, but we can analyze query performance ourselves to debug slow queries using <code>EXPLAIN</code> and <code>EXPLAIN ANALYZE</code>.</p>
<p>Here is an example of using <code>EXPLAIN</code> from the <a href="https://www.postgresql.org/docs/9.1/using-explain.html">PostgreSQL docs</a>:</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb163-1" title="1"><span class="kw">EXPLAIN</span> <span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">FROM</span> tenk1;</a>
<a class="sourceLine" id="cb163-2" title="2"></a>
<a class="sourceLine" id="cb163-3" title="3">                         <span class="kw">QUERY</span> <span class="kw">PLAN</span></a>
<a class="sourceLine" id="cb163-4" title="4"><span class="co">-------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb163-5" title="5"> Seq <span class="kw">Scan</span> <span class="kw">on</span> tenk1  (<span class="kw">cost</span><span class="op">=</span><span class="dv">0</span>.<span class="dv">00</span><span class="op">..</span><span class="fl">458.00</span> <span class="kw">rows</span><span class="op">=</span><span class="dv">10000</span> width<span class="op">=</span><span class="dv">244</span>)</a></code></pre></div>
<p>In the QUERY PLAN above, we can see that a sequential table scan (<code>Seq Scan</code>) was performed on the table called "tenk1". In parentheses, we see performance information:</p>
<ul>
<li>Estimated start-up cost (or time expended before the scan can start): 0.00</li>
<li>Estimated total cost: 458.00</li>
<li>Estimated number of rows output: 10000</li>
<li>Estimated average width (in bytes) of rows: 244</li>
</ul>
<p>Itâ€™s important to note that, although we might mistake the number next to <code>cost</code> for milliseconds, <code>cost</code> is not measured in any particular unit and is an arbitrary measurement relatively based on other query costs.</p>
<p>If we use the <code>ANALYZE</code> keyword after <code>EXPLAIN</code> on a <code>SELECT</code> statement, we can get more information about query performance:</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb164-1" title="1"><span class="kw">EXPLAIN</span> <span class="kw">ANALYZE</span> <span class="kw">SELECT</span> <span class="op">*</span></a>
<a class="sourceLine" id="cb164-2" title="2"><span class="kw">FROM</span> tenk1 t1, tenk2 t2</a>
<a class="sourceLine" id="cb164-3" title="3"><span class="kw">WHERE</span> t1.unique1 <span class="op">&lt;</span> <span class="dv">100</span> <span class="kw">AND</span> t1.unique2 <span class="op">=</span> t2.unique2;</a>
<a class="sourceLine" id="cb164-4" title="4"></a>
<a class="sourceLine" id="cb164-5" title="5">                                                            <span class="kw">QUERY</span> <span class="kw">PLAN</span></a>
<a class="sourceLine" id="cb164-6" title="6"><span class="co">----------------------------------------------------------------------------------------------------------------------------------</span></a>
<a class="sourceLine" id="cb164-7" title="7"><span class="kw">Nested</span> <span class="cf">Loop</span>  (<span class="kw">cost</span><span class="op">=</span><span class="dv">2</span>.<span class="dv">37</span><span class="op">..</span><span class="fl">553.11</span> <span class="kw">rows</span><span class="op">=</span><span class="dv">106</span> width<span class="op">=</span><span class="dv">488</span>) (actual <span class="dt">time</span><span class="op">=</span><span class="dv">1</span>.<span class="dv">392</span><span class="op">..</span><span class="fl">12.700</span> <span class="kw">rows</span><span class="op">=</span><span class="dv">100</span> loops<span class="op">=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb164-8" title="8">  <span class="op">-&gt;</span>  <span class="kw">Bitmap</span> <span class="kw">Heap</span> <span class="kw">Scan</span> <span class="kw">on</span> tenk1 t1  (<span class="kw">cost</span><span class="op">=</span><span class="dv">2</span>.<span class="dv">37</span><span class="op">..</span><span class="fl">232.35</span> <span class="kw">rows</span><span class="op">=</span><span class="dv">106</span> width<span class="op">=</span><span class="dv">244</span>) (actual <span class="dt">time</span><span class="op">=</span><span class="dv">0</span>.<span class="dv">878</span><span class="op">..</span><span class="fl">2.367</span> <span class="kw">rows</span><span class="op">=</span><span class="dv">100</span> loops<span class="op">=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb164-9" title="9">        Recheck Cond: (unique1 <span class="op">&lt;</span> <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb164-10" title="10">        <span class="op">-&gt;</span>  <span class="kw">Bitmap</span> <span class="kw">Index</span> <span class="kw">Scan</span> <span class="kw">on</span> tenk1_unique1  (<span class="kw">cost</span><span class="op">=</span><span class="dv">0</span>.<span class="dv">00</span><span class="op">..</span><span class="fl">2.37</span> <span class="kw">rows</span><span class="op">=</span><span class="dv">106</span> width<span class="op">=</span><span class="dv">0</span>) (actual <span class="dt">time</span><span class="op">=</span><span class="dv">0</span>.<span class="dv">546</span><span class="op">..</span><span class="fl">0.546</span> <span class="kw">rows</span><span class="op">=</span><span class="dv">100</span> loops<span class="op">=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb164-11" title="11">              <span class="kw">Index</span> Cond: (unique1 <span class="op">&lt;</span> <span class="dv">100</span>)</a>
<a class="sourceLine" id="cb164-12" title="12">  <span class="op">-&gt;</span>  <span class="kw">Index</span> <span class="kw">Scan</span> <span class="kw">using</span> tenk2_unique2 <span class="kw">on</span> tenk2 t2  (<span class="kw">cost</span><span class="op">=</span><span class="dv">0</span>.<span class="dv">00</span><span class="op">..</span><span class="fl">3.01</span> <span class="kw">rows</span><span class="op">=</span><span class="dv">1</span> width<span class="op">=</span><span class="dv">244</span>) (actual <span class="dt">time</span><span class="op">=</span><span class="dv">0</span>.<span class="dv">067</span><span class="op">..</span><span class="fl">0.078</span> <span class="kw">rows</span><span class="op">=</span><span class="dv">1</span> loops<span class="op">=</span><span class="dv">100</span>)</a>
<a class="sourceLine" id="cb164-13" title="13">        <span class="kw">Index</span> Cond: (unique2 <span class="op">=</span> t1.unique2)</a>
<a class="sourceLine" id="cb164-14" title="14">Total runtime: <span class="fl">14.452</span> ms</a></code></pre></div>
<p>We can see in the QUERY PLAN above that there are other types of scans happening: Bitmap Heap Scan, Bitmap Index Scan, and Index Scan. We know that an index has been created, and the system is using it to scan for results instead of performing a sequential scan. At the bottom, we also have a total runtime of 14.42 ms, which is pretty fast.</p>
<h2 id="helpful-links-3">Helpful links:</h2>
<ul>
<li><a href="https://www.postgresql.org/docs/9.1/indexes.html">PostgreSQL docs: Indexes</a></li>
<li><a href="https://www.postgresql.org/docs/8.1/performance-tips.html">PostgreSQL docs: Performance Tips</a></li>
<li><a href="https://devcenter.heroku.com/articles/postgresql-indexes">Heroku DevCenter: Efficient Use of PostgreSQL Indexes</a></li>
</ul>
<h2 id="what-we-learned-7">What we learned:</h2>
<ul>
<li>How to create a PostgreSQL index</li>
<li>Types of indexes</li>
<li>Use cases for indexes and when to avoid them</li>
<li>How to use <code>EXPLAIN</code> to analyze query performance</li>
</ul>
<hr />
<h1 id="node-postgres-and-prepared-statements">Node-Postgres And Prepared Statements</h1>
<p>The library <a href="https://node-postgres.com">node-postgres</a> is, not too surprisingly, the library that Node.js applications use to connect to a database managed by a PostgreSQL RDBMS. The applications that you deal with will use this library to make connections to the database and get rows returned from your SQL <code>SELECT</code> statements.</p>
<h2 id="connecting">Connecting</h2>
<p>The <strong>node-postgres</strong> library provides two ways to connect to it. You can use a single <code>Client</code> object, or you can use a <code>Pool</code> of <code>Client</code> objects. Normally, you want to use a <code>Pool</code> because creating and opening single connections to any database server is a "costly" operation in terms of CPU and network resources. A <code>Pool</code> creates a group of those <code>Client</code> connections and lets your code use them whenever it needs to.</p>
<p>To use a <code>Pool</code>, you specify any specific portions of the following connection parameters that you need. The default values for each parameter is listed with each parameter.</p>
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 41%" />
<col style="width: 37%" />
</colgroup>
<thead>
<tr class="header">
<th>Connection parameter</th>
<th>What it indicates</th>
<th>Default value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>user</td>
<td>The name of the user you want to connect as</td>
<td>The user name that runs the application</td>
</tr>
<tr class="even">
<td>password</td>
<td>The password to use</td>
<td>The password set in your configuration</td>
</tr>
<tr class="odd">
<td>database</td>
<td>The name of the database to connect to</td>
<td>The userâ€™s database</td>
</tr>
<tr class="even">
<td>port</td>
<td>The port over which to connect</td>
<td>5432</td>
</tr>
<tr class="odd">
<td>host</td>
<td>The name of the server to connect to</td>
<td>localhost</td>
</tr>
</tbody>
</table>
<p>Normally, you will only override the user and password fields, and sometimes the database if it doesnâ€™t match the userâ€™s name. You do that by instantiating a new <code>Pool</code> object and passing in an object with those key/value pairs.</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb165-1" title="1"><span class="kw">const</span> <span class="op">{</span> Pool <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;pg&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb165-2" title="2"></a>
<a class="sourceLine" id="cb165-3" title="3"><span class="kw">const</span> pool <span class="op">=</span> <span class="kw">new</span> <span class="at">Pool</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb165-4" title="4">  <span class="dt">user</span><span class="op">:</span> <span class="st">&#39;application_user&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb165-5" title="5">  <span class="dt">password</span><span class="op">:</span> <span class="st">&#39;iy7qTEcZ&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb165-6" title="6"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Once you have an instance of the <code>Pool</code> class, you can use the <code>query</code> method on it to run queries. (The <code>query</code> method returns a Promise, so itâ€™s nice to just use <code>await</code> for it to finish.)</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb166-1" title="1"><span class="kw">const</span> results <span class="op">=</span> <span class="cf">await</span> <span class="va">pool</span>.<span class="at">query</span>(<span class="vs">`</span></a>
<a class="sourceLine" id="cb166-2" title="2"><span class="vs">  SELECT id, name, age_yrs</span></a>
<a class="sourceLine" id="cb166-3" title="3"><span class="vs">  FROM puppies;</span></a>
<a class="sourceLine" id="cb166-4" title="4"><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb166-5" title="5"></a>
<a class="sourceLine" id="cb166-6" title="6"><span class="va">console</span>.<span class="at">log</span>(results)<span class="op">;</span></a></code></pre></div>
<p>When this runs, you will get an object that contains a property named "rows". The value of "rows" will be an array of the rows that match the statement. Hereâ€™s an example output from the code above.</p>
<pre><code>{
  rows:
    [ { id: 1, name: &#39;Cooper&#39;, age_yrs: &#39;1.0&#39; },
      { id: 2, name: &#39;Indie&#39;, age_yrs: &#39;0.5&#39; },
      { id: 3, name: &#39;Kota&#39;, age_yrs: &#39;0.7&#39; },
      { id: 4, name: &#39;Zoe&#39;, age_yrs: &#39;0.8&#39; },
      { id: 5, name: &#39;Charley&#39;, age_yrs: &#39;1.5&#39; },
      { id: 6, name: &#39;Ladybird&#39;, age_yrs: &#39;0.6&#39; },
      { id: 7, name: &#39;Callie&#39;, age_yrs: &#39;0.9&#39; },
      { id: 8, name: &#39;Jaxson&#39;, age_yrs: &#39;0.4&#39; },
      { id: 9, name: &#39;Leinni&#39;, age_yrs: &#39;1.0&#39; },
      { id: 10, name: &#39;Max&#39;, age_yrs: &#39;1.6&#39; } ],
}</code></pre>
<p>You can see that the "rows" property contains an array of objects. Each object represents a row in the "puppies" table that matches the query. Each object has a property named after the column selected in the <code>SELECT</code> statement. The query read <code>SELECT id, name, age_yrs</code> and each object has an "id", "name", and an "age_yrs" property.</p>
<p>You can then use that array to loop over and do things with it. For example, you could print them to the console like this:</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb168-1" title="1"><span class="cf">for</span> (<span class="kw">let</span> row <span class="kw">of</span> <span class="va">results</span>.<span class="at">rows</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb168-2" title="2">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`</span><span class="sc">${</span><span class="va">row</span>.<span class="at">id</span><span class="sc">}</span><span class="vs">: </span><span class="sc">${</span><span class="va">row</span>.<span class="at">name</span><span class="sc">}</span><span class="vs"> is </span><span class="sc">${</span><span class="va">row</span>.<span class="at">age_yrs</span><span class="sc">}</span><span class="vs"> old&lt;/li&gt;`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb168-3" title="3"><span class="op">}</span></a></code></pre></div>
<p>Which would show</p>
<pre><code>1. Cooper is 1.0 years old
2. Indie is 0.5 years old
3. Kots is 0.7 years old
...</code></pre>
<h2 id="prepared-statement">Prepared Statement</h2>
<p>Prepared statements are SQL statements that have parameters in them that you can use to substitute values. The parameters are normally part of the <code>WHERE</code> clause in all statements. You will also use then in the <code>SET</code> portion of <code>UPDATE</code> statements and the <code>VALUES</code> portion of <code>INSERT</code> statements.</p>
<p>For example, say your application collected the information to create a new row in the puppy table by asking for the puppyâ€™s name, age, breed, weight, and if it was microchipped. Youâ€™d have those values stored in variables somewhere. Youâ€™d want to create an <code>INSERT</code> statement that inserts the data from those variables into a SQL statement that the RDBMS could then execute to insert a new row.</p>
<p>Think about what a generic <code>INSERT</code> statement would look like. It would have to have the</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb170-1" title="1"><span class="kw">INSERT</span> <span class="kw">INTO</span> puppies (name, age_yrs, breed, weight_lbs, microchipped)</a></code></pre></div>
<p>portion of the statement. The part that would change with each time you inserted would be the specific values that would go into the <code>VALUES</code> section of the <code>INSERT</code> statement. With prepared statements, you use <em>positional parameters</em> to act as placeholders for the actual values that you will provide the query.</p>
<p>For example, the generic <code>INSERT</code> statement from above would look like this.</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb171-1" title="1"><span class="kw">INSERT</span> <span class="kw">INTO</span> puppies (name, age_yrs, breed, weight_lbs, microchipped)</a>
<a class="sourceLine" id="cb171-2" title="2"><span class="kw">VALUES</span> ($<span class="dv">1</span>, $<span class="dv">2</span>, $<span class="dv">3</span>, $<span class="dv">4</span>, $<span class="dv">5</span>);</a></code></pre></div>
<p>Each of the "$" placeholders is a positional argument for the parameters that you pass in. That means, the value that pass in for the first parameter will be put where the "$1" placeholder is, which is the value for the "name" of the puppy. The "$2" corresponds to the "age_yrs" column, so it should contain the age of the puppy. This continues for the third, fourth, and fifth parameters, as well.</p>
<p>Assume that in your code, you have the variables <code>name</code>, <code>age</code>, <code>breedName</code>, <code>weight</code>, and <code>isMicrochipped</code> containing the values that the user provided for the new puppy. Then, your use of the <code>query</code> method will now include another argument, the values that you want to pass in inside an array.</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb172-1" title="1"><span class="cf">await</span> <span class="va">pool</span>.<span class="at">query</span>(<span class="vs">`</span></a>
<a class="sourceLine" id="cb172-2" title="2"><span class="vs">  INSERT INTO puppies (name, age_yrs, breed, weight_lbs, microchipped)</span></a>
<a class="sourceLine" id="cb172-3" title="3"><span class="vs">  VALUES ($1, $2, $3, $4, $5);</span></a>
<a class="sourceLine" id="cb172-4" title="4"><span class="vs">`</span><span class="op">,</span> [name<span class="op">,</span> age<span class="op">,</span> breedName<span class="op">,</span> weight<span class="op">,</span> isMicrochipped])<span class="op">;</span></a></code></pre></div>
<p>You can see that the variable <code>name</code> is in the first position of the array, so it will be substituted into the placeholder "$1". The <code>age</code> variable is in the second position of the array, so it will be substituted into the "$2" placeholder.</p>
<p>The full documentation for how to use queries with <strong>node-postgres</strong> can be found on the <a href="https://node-postgres.com/features/queries">Queries</a> documentation page on their Web site.</p>
<h2 id="try-it-out-for-yourself">Try it out for yourself</h2>
<p>Make sure you have a database with a table that has data in it. If you donâ€™t, create a new database and run the following SQL.</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb173-1" title="1"><span class="kw">CREATE</span> <span class="kw">TABLE</span> puppies (</a>
<a class="sourceLine" id="cb173-2" title="2">  <span class="kw">id</span> SERIAL <span class="kw">PRIMARY</span> <span class="kw">KEY</span>,</a>
<a class="sourceLine" id="cb173-3" title="3">  name <span class="dt">VARCHAR</span>(<span class="dv">50</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb173-4" title="4">  age_yrs <span class="dt">NUMERIC</span>(<span class="dv">3</span>,<span class="dv">1</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb173-5" title="5">  breed <span class="dt">VARCHAR</span>(<span class="dv">100</span>) <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb173-6" title="6">  weight_lbs <span class="dt">INTEGER</span> <span class="kw">NOT</span> <span class="kw">NULL</span>,</a>
<a class="sourceLine" id="cb173-7" title="7">  microchipped <span class="dt">BOOLEAN</span> <span class="kw">NOT</span> <span class="kw">NULL</span> <span class="kw">DEFAULT</span> <span class="kw">FALSE</span></a>
<a class="sourceLine" id="cb173-8" title="8">);</a>
<a class="sourceLine" id="cb173-9" title="9"></a>
<a class="sourceLine" id="cb173-10" title="10"><span class="kw">insert</span> <span class="kw">into</span> puppies(name, age_yrs, breed, weight_lbs, microchipped)</a>
<a class="sourceLine" id="cb173-11" title="11"><span class="kw">values</span></a>
<a class="sourceLine" id="cb173-12" title="12">(<span class="st">&#39;Cooper&#39;</span>, <span class="dv">1</span>, <span class="st">&#39;Miniature Schnauzer&#39;</span>, <span class="dv">18</span>, <span class="st">&#39;yes&#39;</span>),</a>
<a class="sourceLine" id="cb173-13" title="13">(<span class="st">&#39;Indie&#39;</span>, <span class="fl">0.5</span>, <span class="st">&#39;Yorkshire Terrier&#39;</span>, <span class="dv">13</span>, <span class="st">&#39;yes&#39;</span>),</a>
<a class="sourceLine" id="cb173-14" title="14">(<span class="st">&#39;Kota&#39;</span>, <span class="fl">0.7</span>, <span class="st">&#39;Australian Shepherd&#39;</span>, <span class="dv">26</span>, <span class="st">&#39;no&#39;</span>),</a>
<a class="sourceLine" id="cb173-15" title="15">(<span class="st">&#39;Zoe&#39;</span>, <span class="fl">0.8</span>, <span class="st">&#39;Korean Jindo&#39;</span>, <span class="dv">32</span>, <span class="st">&#39;yes&#39;</span>),</a>
<a class="sourceLine" id="cb173-16" title="16">(<span class="st">&#39;Charley&#39;</span>, <span class="fl">1.5</span>, <span class="st">&#39;Basset Hound&#39;</span>, <span class="dv">25</span>, <span class="st">&#39;no&#39;</span>),</a>
<a class="sourceLine" id="cb173-17" title="17">(<span class="st">&#39;Ladybird&#39;</span>, <span class="fl">0.6</span>, <span class="st">&#39;Labradoodle&#39;</span>, <span class="dv">20</span>, <span class="st">&#39;yes&#39;</span>),</a>
<a class="sourceLine" id="cb173-18" title="18">(<span class="st">&#39;Callie&#39;</span>, <span class="fl">0.9</span>, <span class="st">&#39;Corgi&#39;</span>, <span class="dv">16</span>, <span class="st">&#39;no&#39;</span>),</a>
<a class="sourceLine" id="cb173-19" title="19">(<span class="st">&#39;Jaxson&#39;</span>, <span class="fl">0.4</span>, <span class="st">&#39;Beagle&#39;</span>, <span class="dv">19</span>, <span class="st">&#39;yes&#39;</span>),</a>
<a class="sourceLine" id="cb173-20" title="20">(<span class="st">&#39;Leinni&#39;</span>, <span class="dv">1</span>, <span class="st">&#39;Miniature Schnauzer&#39;</span>, <span class="dv">25</span>, <span class="st">&#39;yes&#39;</span> ),</a>
<a class="sourceLine" id="cb173-21" title="21">(<span class="st">&#39;Max&#39;</span>, <span class="fl">1.6</span>, <span class="st">&#39;German Shepherd&#39;</span>, <span class="dv">65</span>, <span class="st">&#39;no&#39;</span>);</a></code></pre></div>
<p>Now that you have ten rows in the "puppies" table of a database, you can create a simple Node.js project to access it.</p>
<p>Create a new directory somewhere thatâ€™s not part of an existing project. Run <code>npm init -y</code> to initialize the <strong>package.json</strong> file. Then, run <code>npm install pg</code> to install the library from this section. (Why is the name of the library "node-postgres" but you install "pg"? Dunno.) Finally, open Visual Studio Code for the current directory with <code>code .</code>.</p>
<p>Create a new file named <strong>sql-test.js</strong>.</p>
<p>The first thing you need to do is import the <code>Pool</code> class from the <strong>node-postgres</strong> library. The name of the library in the <strong>node_modules</strong> directory is "pg". That line of code looks like this and can be found all over the <a href="https://node-postgres.com">node-postgres</a> documentation.</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb174-1" title="1"><span class="kw">const</span> <span class="op">{</span> Pool <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;pg&#39;</span>)<span class="op">;</span></a></code></pre></div>
<p>Now, write some SQL that will select all of the records from the "puppies" table. (This is assuming you want to select puppies. If youâ€™re using a different table with different data, write the appropriate SQL here.)</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb175-1" title="1"><span class="kw">const</span> <span class="op">{</span> Pool <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;pg&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb175-2" title="2"></a>
<a class="sourceLine" id="cb175-3" title="3"><span class="kw">const</span> allPuppies <span class="op">=</span> <span class="vs">`</span></a>
<a class="sourceLine" id="cb175-4" title="4"><span class="vs">  SELECT id, name, age_yrs, breed, weight_lbs, microchipped</span></a>
<a class="sourceLine" id="cb175-5" title="5"><span class="vs">  FROM puppies;</span></a>
<a class="sourceLine" id="cb175-6" title="6"><span class="vs">`</span><span class="op">;</span></a></code></pre></div>
<p>You will now use that with a new <code>Pool</code> object. You will need to know the name of the database that the "puppies" table is in (or whatever database you want to connect to).</p>
<div class="sourceCode" id="cb176"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb176-1" title="1"><span class="kw">const</span> <span class="op">{</span> Pool <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;pg&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb176-2" title="2"></a>
<a class="sourceLine" id="cb176-3" title="3"><span class="kw">const</span> allPuppies <span class="op">=</span> <span class="vs">`</span></a>
<a class="sourceLine" id="cb176-4" title="4"><span class="vs">  SELECT id, name, age_yrs, breed, weight_lbs, microchipped</span></a>
<a class="sourceLine" id="cb176-5" title="5"><span class="vs">  FROM puppies;</span></a>
<a class="sourceLine" id="cb176-6" title="6"><span class="vs">`</span><span class="op">;</span></a>
<a class="sourceLine" id="cb176-7" title="7"></a>
<a class="sourceLine" id="cb176-8" title="8"><span class="kw">const</span> pool <span class="op">=</span> <span class="kw">new</span> <span class="at">Pool</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb176-9" title="9">  <span class="dt">database</span><span class="op">:</span> <span class="st">&#39;Â«database nameÂ»&#39;</span></a>
<a class="sourceLine" id="cb176-10" title="10"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Of course, replace "Â«database nameÂ»" with the name of your database. Otherwise, when you run it, you will see this error message.</p>
<pre><code>UnhandledPromiseRejectionWarning: error: database &quot;Â«database nameÂ»&quot; does not exist</code></pre>
<p>This will, by default, connect to "localhost" on port "5432" with your user credentials because you did not specify any other parameters.</p>
<p>Once you have the pool, you can execute the query that you have in <code>allPuppies</code>. Remember that the <code>query</code> method returns a Promise. This code wraps the call to <code>query</code> in an <code>async function</code> so that it can use the <code>await</code> keyword for simplicityâ€™s sake. Then, it prints out the rows that it fetched to the console. Finally, it calls <code>end</code> on the connection pool object to tell <strong>node-postgres</strong> to close all the connections and quit. Otherwise, your application will just hang and youâ€™ll have to close it with Control+C.</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb178-1" title="1"><span class="kw">const</span> <span class="op">{</span> Pool <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;pg&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb178-2" title="2"></a>
<a class="sourceLine" id="cb178-3" title="3"><span class="kw">const</span> allPuppiesSql <span class="op">=</span> <span class="vs">`</span></a>
<a class="sourceLine" id="cb178-4" title="4"><span class="vs">  SELECT id, name, age_yrs, breed, weight_lbs, microchipped</span></a>
<a class="sourceLine" id="cb178-5" title="5"><span class="vs">  FROM puppies;</span></a>
<a class="sourceLine" id="cb178-6" title="6"><span class="vs">`</span><span class="op">;</span></a>
<a class="sourceLine" id="cb178-7" title="7"></a>
<a class="sourceLine" id="cb178-8" title="8"><span class="kw">const</span> pool <span class="op">=</span> <span class="kw">new</span> <span class="at">Pool</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb178-9" title="9">  <span class="dt">database</span><span class="op">:</span> <span class="st">&#39;Â«database nameÂ»&#39;</span></a>
<a class="sourceLine" id="cb178-10" title="10"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb178-11" title="11"></a>
<a class="sourceLine" id="cb178-12" title="12"><span class="kw">async</span> <span class="kw">function</span> <span class="at">selectAllPuppies</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb178-13" title="13">  <span class="kw">const</span> results <span class="op">=</span> <span class="cf">await</span> <span class="va">pool</span>.<span class="at">query</span>(allPuppiesSql)<span class="op">;</span></a>
<a class="sourceLine" id="cb178-14" title="14">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">results</span>.<span class="at">rows</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb178-15" title="15">  <span class="va">pool</span>.<span class="at">end</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb178-16" title="16"><span class="op">}</span></a>
<a class="sourceLine" id="cb178-17" title="17"></a>
<a class="sourceLine" id="cb178-18" title="18"><span class="at">selectAllPuppies</span>()<span class="op">;</span></a></code></pre></div>
<p>When you run this with <code>node sql-test.js</code>, you should see some output like this although likely in a nicer format.</p>
<pre><code>[ { id: 1, name: &#39;Cooper&#39;, age_yrs: &#39;1.0&#39;, breed: &#39;Miniature Schnauzer&#39;, weight_lbs: 18, microchipped: true },
  { id: 2, name: &#39;Indie&#39;, age_yrs: &#39;0.5&#39;, breed: &#39;Yorkshire Terrier&#39;, weight_lbs: 13, microchipped: true },
  { id: 3, name: &#39;Kota&#39;, age_yrs: &#39;0.7&#39;, breed: &#39;Australian Shepherd&#39;, weight_lbs: 26, microchipped: false },
  { id: 4, name: &#39;Zoe&#39;, age_yrs: &#39;0.8&#39;, breed: &#39;Korean Jindo&#39;, weight_lbs: 32, microchipped: true },
  { id: 5, name: &#39;Charley&#39;, age_yrs: &#39;1.5&#39;, breed: &#39;Basset Hound&#39;, weight_lbs: 25, microchipped: false },
  { id: 6, name: &#39;Ladybird&#39;, age_yrs: &#39;0.6&#39;, breed: &#39;Labradoodle&#39;, weight_lbs: 20, microchipped: true },
  { id: 7, name: &#39;Callie&#39;, age_yrs: &#39;0.9&#39;, breed: &#39;Corgi&#39;, weight_lbs: 16, microchipped: false },
  { id: 8, name: &#39;Jaxson&#39;, age_yrs: &#39;0.4&#39;, breed: &#39;Beagle&#39;, weight_lbs: 19, microchipped: true },
  { id: 9, name: &#39;Leinni&#39;, age_yrs: &#39;1.0&#39;, breed: &#39;Miniature Schnauzer&#39;, weight_lbs: 25, microchipped: true },
  { id: 10, name: &#39;Max&#39;, age_yrs: &#39;1.6&#39;, breed: &#39;German Shepherd&#39;, weight_lbs: 65, microchipped: false } ]</code></pre>
<p>Now, try one of those parameterized queries. Comment out the <code>selectAllPuppies</code> function and invocation.</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb180-1" title="1"><span class="co">// async function selectAllPuppies() {</span></a>
<a class="sourceLine" id="cb180-2" title="2"><span class="co">//   const results = await pool.query(allPuppiesSql);</span></a>
<a class="sourceLine" id="cb180-3" title="3"><span class="co">//   console.log(results.rows);</span></a>
<a class="sourceLine" id="cb180-4" title="4"><span class="co">//   pool.end();</span></a>
<a class="sourceLine" id="cb180-5" title="5"><span class="co">// }</span></a>
<a class="sourceLine" id="cb180-6" title="6"></a>
<a class="sourceLine" id="cb180-7" title="7"><span class="co">// selectAllPuppies();</span></a></code></pre></div>
<p>Add the following content to the bottom of the file.</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb181-1" title="1"><span class="co">// Define the parameterized query where it will select a puppy</span></a>
<a class="sourceLine" id="cb181-2" title="2"><span class="co">// based on an id</span></a>
<a class="sourceLine" id="cb181-3" title="3"><span class="kw">const</span> singlePuppySql <span class="op">=</span> <span class="vs">`</span></a>
<a class="sourceLine" id="cb181-4" title="4"><span class="vs">  SELECT id, name, age_yrs, breed, weight_lbs, microchipped</span></a>
<a class="sourceLine" id="cb181-5" title="5"><span class="vs">  FROM puppies</span></a>
<a class="sourceLine" id="cb181-6" title="6"><span class="vs">  WHERE ID = $1;</span></a>
<a class="sourceLine" id="cb181-7" title="7"><span class="vs">`</span><span class="op">;</span></a>
<a class="sourceLine" id="cb181-8" title="8"></a>
<a class="sourceLine" id="cb181-9" title="9"><span class="co">// Run the parameterized SQL by passing in an array that contains</span></a>
<a class="sourceLine" id="cb181-10" title="10"><span class="co">// the puppyId to the query method. Then, print the results and</span></a>
<a class="sourceLine" id="cb181-11" title="11"><span class="co">// end the pool.</span></a>
<a class="sourceLine" id="cb181-12" title="12"><span class="kw">async</span> <span class="kw">function</span> <span class="at">selectOnePuppy</span>(puppyId) <span class="op">{</span></a>
<a class="sourceLine" id="cb181-13" title="13">  <span class="kw">const</span> results <span class="op">=</span> <span class="cf">await</span> <span class="va">pool</span>.<span class="at">query</span>(singlePuppySql<span class="op">,</span> [puppyId])<span class="op">;</span></a>
<a class="sourceLine" id="cb181-14" title="14">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">results</span>.<span class="at">rows</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb181-15" title="15">  <span class="va">pool</span>.<span class="at">end</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb181-16" title="16"><span class="op">}</span></a>
<a class="sourceLine" id="cb181-17" title="17"></a>
<a class="sourceLine" id="cb181-18" title="18"><span class="co">// Get the id from the command line and store it</span></a>
<a class="sourceLine" id="cb181-19" title="19"><span class="co">// in the variable &quot;id&quot;. Pass that value to the</span></a>
<a class="sourceLine" id="cb181-20" title="20"><span class="co">// selectOnePuppy function.</span></a>
<a class="sourceLine" id="cb181-21" title="21"><span class="kw">const</span> id <span class="op">=</span> <span class="va">Number</span>.<span class="at">parseInt</span>(<span class="va">process</span>.<span class="at">argv</span>[<span class="dv">2</span>])<span class="op">;</span></a>
<a class="sourceLine" id="cb181-22" title="22"><span class="at">selectOnePuppy</span>(id)<span class="op">;</span></a></code></pre></div>
<p>Now, when you run the program, include a number after the command. For example, if you run <code>node sql-test.js 1</code>, it will print out</p>
<pre><code>[ { id: 1,
    name: &#39;Cooper&#39;,
    age_yrs: &#39;1.0&#39;,
    breed: &#39;Miniature Schnauzer&#39;,
    weight_lbs: 18,
    microchipped: true } ]</code></pre>
<p>If you run <code>node sql-test.js 4</code>, it will print out</p>
<pre><code>[ { id: 4,
    name: &#39;Zoe&#39;,
    age_yrs: &#39;0.8&#39;,
    breed: &#39;Korean Jindo&#39;,
    weight_lbs: 32,
    microchipped: true } ]</code></pre>
<p>Thatâ€™s because the number that you type on the command line is being substituted in for the "$1" in the parameterized query. That means, when you pass in "4", Itâ€™s like the RDMBS takes the parameterized query</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb184-1" title="1"><span class="kw">SELECT</span> <span class="kw">id</span>, name, age_yrs, breed, weight_lbs, microchipped</a>
<a class="sourceLine" id="cb184-2" title="2"><span class="kw">FROM</span> puppies</a>
<a class="sourceLine" id="cb184-3" title="3"><span class="kw">WHERE</span> <span class="kw">ID</span> <span class="op">=</span> $<span class="dv">1</span>;</a></code></pre></div>
<p>and your value "4"</p>
<p>and mushes them together to make</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb185-1" title="1"><span class="kw">SELECT</span> <span class="kw">id</span>, name, age_yrs, breed, weight_lbs, microchipped</a>
<a class="sourceLine" id="cb185-2" title="2"><span class="kw">FROM</span> puppies</a>
<a class="sourceLine" id="cb185-3" title="3"><span class="kw">WHERE</span> <span class="kw">ID</span> <span class="op">=</span> <span class="dv">4</span>; <span class="co">-- Value substituted here by PostgreSQL.</span></a></code></pre></div>
<p>That happens because when you run the query, you call the <code>query</code> method like this.</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb186-1" title="1"><span class="cf">await</span> <span class="va">pool</span>.<span class="at">query</span>(singlePuppySql<span class="op">,</span> [puppyId])<span class="op">;</span></a></code></pre></div>
<p>which passes along the sql stored in <code>singlePuppySql</code> and the value stored in <code>puppyId</code> (as the first parameter) to PostgreSQL.</p>
<p>What do you think will happen if you change <code>singlePuppySql</code> to have <em>two</em> parameters instead of one, but only pass in one parameter through the <code>query</code> method?</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb187-1" title="1"><span class="kw">const</span> singlePuppySql <span class="op">=</span> <span class="vs">`</span></a>
<a class="sourceLine" id="cb187-2" title="2"><span class="vs">  SELECT id, name, age_yrs, breed, weight_lbs, microchipped</span></a>
<a class="sourceLine" id="cb187-3" title="3"><span class="vs">  FROM puppies</span></a>
<a class="sourceLine" id="cb187-4" title="4"><span class="vs">  WHERE ID = $1</span></a>
<a class="sourceLine" id="cb187-5" title="5"><span class="vs">  AND age_yrs &gt; $2;</span></a>
<a class="sourceLine" id="cb187-6" title="6"><span class="vs">`</span><span class="op">;</span></a></code></pre></div>
<p>PostgreSQL is smart enough to see that youâ€™ve only provided one parameter value but it needs <em>two</em> positional parameters. It gives you the error message</p>
<pre><code>error: bind message supplies 1 parameters, but prepared statement &quot;&quot; requires 2</code></pre>
<p>In this error message, the term "bind message" is the kind of message that the <code>query</code> method sends to PostgreSQL when you provide parameters to it.</p>
<p>Change the query back to how it was. Now, add an extra parameter to the invocation of the <code>query</code> method. What do you think will</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb189-1" title="1"><span class="cf">await</span> <span class="va">pool</span>.<span class="at">query</span>(singlePuppySql<span class="op">,</span> [puppyId<span class="op">,</span> <span class="st">&#39;extra parameter&#39;</span>])<span class="op">;</span></a></code></pre></div>
<p>Again, PostgreSQL gives you an error message about a mismatch in the number of placeholders in the SQL and the number of values you passed to it.</p>
<pre><code>error: bind message supplies 2 parameters, but prepared statement &quot;&quot; requires 1</code></pre>
<h2 id="what-youve-learned">What youâ€™ve learned</h2>
<p>Here, youâ€™ve seen how to connect to a PostgreSQL database using the <strong>node-postgres</strong> library named "pg". You saw how to run simple SQL statements against it and handle the results. You also saw how to create parameterized queries so that you can pass in values to be substituted.</p>
<p>If you are using the <strong>node-postgres</strong> library and running your own handcrafted SQL, you will most often use parameterized queries. Itâ€™s good to get familiar with them.</p>
<hr />
<h1 id="recipe-box-project">Recipe Box Project</h1>
<p>In this project, you will build the Data Access Layer to power a Web application. This means that you will provide all of the SQL that it takes to get data into and from the database. You will do this in SQL files that the application will load and read.</p>
<p><strong>Note</strong>: This is not a good way to create a database-backed application. This project is structured this way so that it isolates the activity of SQL writing. Do not use this project as a template for your future projects.</p>
<h2 id="the-data-model-analysis">The data model analysis</h2>
<p>What goes into a recipe box? Why, recipes, of course! Hereâ€™s an example recipe card.</p>
<figure>
<img src="images/sql-recipe-card.jpeg" alt="Recipe card" /><figcaption>Recipe card</figcaption>
</figure>
<p>You can see that a recipe is made up of three basic parts:</p>
<ul>
<li>A title,</li>
<li>A list of ingredients, and</li>
<li>A list of instructions.</li>
</ul>
<p>Youâ€™re going to add a little more to that, too. It will also have</p>
<ul>
<li>The date/time that it was entered into the recipe box, and</li>
<li>The date/time it was last updated in the recipe box.</li>
</ul>
<p>These are good pieces of data to have so that you can show them "most recent" for example.</p>
<p>Ingredients themselves are complex data types and need their own structure. They "belong" to a recipe. That means theyâ€™ll need to reference that recipe. That means an ingredient is made up of:</p>
<ul>
<li>An amount (optional),</li>
<li>A unit of measure (optional),</li>
<li>The actual food stuff, and</li>
<li>The id of the recipe that it belongs to.</li>
</ul>
<p>That unit of measure is a good candidate for normalization, donâ€™t you think? Itâ€™s a predefined list of options that should not change and that you donâ€™t want people just typing whatever they want in there, not if you want to maintain data integrity. Otherwise, youâ€™ll end up with "C", "c", "cup", "CUP", "Cup", and all the other permutations, each of which is a distinct value but means the same thing.</p>
<p>Instructions are also complex objects, but not by looking at them. Initially, one might only see text that comprises an instruction. But, very importantly, instructions have <em>order</em>. They also <em>belong</em> to the recipe. With that in mind, an instruction is made up of:</p>
<ul>
<li>The text of the instruction,</li>
<li>The order that it appears in the recipe, and</li>
<li>The id of the recipe that it belongs to.</li>
</ul>
<p>That is enough to make a good model for the recipe box.</p>
<figure>
<img src="images/sql-recipe-box-data-model.png" alt="recipe box data model" /><figcaption>recipe box data model</figcaption>
</figure>
<h2 id="getting-started-1">Getting started</h2>
<ul>
<li>Download the starter project from https://github.com/-starters/sql-recipe-box</li>
<li>Run <code>npm install</code> to install the packages</li>
<li>Run <code>npm start</code> to start the server on port 3000</li>
</ul>
<p>Youâ€™ll do all of your work in the <strong>data-access-layer</strong> directory. In there, you will find a series of SQL files. In each, you will find instructions of what to do to make the user interface to work. They are numbered in an implied order for you to complete them. The only real requirement is that you finish the SQL for the <strong>00a-schema.sql</strong> and <strong>00b-seed.sql</strong> files first. That way, as you make your way through the rest of the SQL files, the tables and some of the data will already exist for you. You can run the command <code>npm run seed</code> to run both of those files or pipe each it into <code>psql</code> as youâ€™ve been doing.</p>
<p>Either way that you decide to seed the database, youâ€™ll need to stop your server. The seed wonâ€™t correctly run while the application maintains a connection to the application database. You may also need to exit all of the active <code>psql</code> instances that you have running to close out all of the active connections. When you run the seed, if it reports that it canâ€™t do something because of active connections, look for a running instance of the server, Postbird, or <code>psql</code> with that connection.</p>
<p><strong>Warning</strong>: running the seed files will destroy all data that you have in the database.</p>
<h2 id="your-sql">Your SQL</h2>
<p>When you write the SQL, they will mostly be parameterized queries. The first couple of files will show you how it needs to be done, where you will place the parameter placeholders "$1", "$2", and so on. If you need to, refer to the <a href="https://node-postgres.com/features/queries#Parameterized%20query">Parameterized query</a> section of the documentation for <strong>node-postgres</strong>.</p>
<p>In each of the following files in the <strong>data-access-layer</strong>, you will find one or more lines with the content <code>-- YOUR CODE HERE</code>. It is your job to write the SQL statement described in the block above that code. Each file is named with the intent of the SQL that it should contain.</p>
<h2 id="the-application">The application</h2>
<p>The application is a standard <a href="https://www.expressjs.com">express.js</a> application using the <a href="https://pugjs.org">pug</a> library to generate the HTML and the <a href="https://node-postgres.com">node-postgres</a> library to connect to the database.</p>
<p>It reads your SQL files whenever it wants to make a database call. If your file throws an error, then the UI handles it by telling you what needs to be fixed so that the UI will work. The application will also output error messages for missing functionality.</p>
<p>The SQL files contain a description of what the content is and where itâ€™s used in the application. Tying those together, youâ€™ll know youâ€™re done when you have all of the SQL files containing queries and there are no errors in the UI or console.</p>
<h2 id="directions">Directions</h2>
<p>Fill out the <strong>00a-schema.sql</strong> and <strong>00b-seed.sql</strong> files first. Then seed the database with command, <code>npm run seed</code>.</p>
<h3 id="home-page">Home Page</h3>
<p>Start the server by running <code>npm run dev</code>. Then go to <code>localhost:3000</code> you should see the home page with "Latest Recipes". To show the latest recipes properly, complete the <code>01-get-ten-most-recent-recipes.sql</code> file.</p>
<p>After completing the file, make sure you correctly defined the sql query so that the first recipe listed is the most recently updated recipe.</p>
<h3 id="recipesid"><code>/recipes/:id</code></h3>
<p>If you click on one of the recipes in the list of recipes on the home page, it will direct you to that recipeâ€™s Detail Page. Complete the following files that correspond to this page and make sure to test a file right after you fill out the file by refreshing the page: - <code>02a-get-recipe-by-id.sql</code> - <code>02b-get-ingredients-by-recipe-id.sql</code> - <code>02c-get-instructions-by-recipe-id.sql</code></p>
<p>Make sure to read the instructions well! In all the above sql queries, the <code>$1</code> parameter will be the recipe id.</p>
<h3 id="recipesnew"><code>/recipes/new</code></h3>
<p>Click on <code>ADD A RECIPE</code> button on the Navigation Bar to direct you to the New Recipe Form page. Fill out the <code>03a-insert-new-recipe.sql</code> file so you can create a new recipe.</p>
<h3 id="recipesidedit"><code>/recipes/:id/edit</code></h3>
<p>After creating a new recipe, you will be directed to the Recipe Edit page where you can add instructions and ingredients to a recipe. Complete the following files that correspond to this page and make sure to test a file right after you fill out the file: - <code>03b-get-units-of-measure.sql</code> - <code>04-insert-new-ingredient.sql</code> - <code>05-insert-new-instruction.sql</code> - <code>06-delete-recipe.sql</code></p>
<h3 id="recipestermsearchterm"><code>/recipes?term={searchTerm}</code></h3>
<p>Allow users to find recipes by a part of their name using the Search Bar in the Navigation Bar. Complete <code>07-search-recipes.sql</code> for this feature.</p>
<hr />
<h1 id="week-10-day-4-sequelize-orm" data-ignore="true">WEEK-10 DAY-4<br><em>Sequelize ORM</em></h1>
<h1 id="orm-learning-objectives">ORM Learning Objectives</h1>
<p>To ease the use of SQL, the object-relational mapping tool was invented. This allows developers to focus on their application code and let a library generate all of the SQL for them. Depending on which developer you ask, this is a miracle or a travesty. Either way, those developers use them because writing all of the SQL by hand is a chore that most software developers just donâ€™t want to do.</p>
<p>In this section, you will learn:</p>
<ul>
<li>How to install, configure, and use Sequelize, an ORM for JavaScript</li>
<li>How to use database migrations to make your database grow with your application in a source-control enabled way</li>
<li>How to perform CRUD operations with Sequelize</li>
<li>How to query using Sequelize</li>
<li>How to perform data validations with Sequelize</li>
<li>How to use transactions with Sequelize</li>
</ul>
<hr />
<h1 id="installing-and-using-sequelize">Installing And Using Sequelize</h1>
<p>Now that you have gained experience with SQL, it is time to learn how to access data stored in a SQL database using a JavaScript program. You will use a JavaScript library called Sequelize to do this. Sequelize is an example of an <em>Object Relational Mapping</em> (commonly abbreviated <em>ORM</em>). An ORM allows a JavaScript programmer to fetch and store data in a SQL database using JavaScript functions instead of writing SQL code.</p>
<p>When you finish this reading you will be able to:</p>
<ul>
<li>Describe what an Object Relational Mapping is and what it is used for.</li>
<li>Install and configure the packages needed to use Sequelize.</li>
<li>Use Sequelize to generate JavaScript code that fetches and stores data in a SQL database.</li>
<li>Use those auto-generated methods to fetch and store data in a SQL database.</li>
</ul>
<h2 id="what-is-an-orm">What Is An ORM?</h2>
<p>An <em>Object Relational Mapping</em> is a library that allows you to access data stored in a SQL database through object-oriented, non-SQL code (such as JavaScript). You will write <em>object-oriented</em> code that accesses data stored in a <em>relational</em> SQL database like Postgres. The ORM is the <em>mapping</em> that will "translate" your object-oriented code into SQL code that the database can run. The ORM will automatically generate SQL code for common tasks like fetching and storing data.</p>
<p>You will learn how to use the <a href="https://sequelize.org/v5/">Sequelize ORM</a>. Sequelize is the most widely used JavaScript ORM library.</p>
<h2 id="how-to-install-sequelize">How To Install Sequelize</h2>
<p>After creating a new node project with <code>npm init</code> we are ready to install the Sequelize library.</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode sh"><code class="sourceCode bash"><a class="sourceLine" id="cb191-1" title="1"><span class="ex">npm</span> install sequelize@^5.0.0</a>
<a class="sourceLine" id="cb191-2" title="2"><span class="ex">npm</span> install sequelize-cli@^5.0.0</a>
<a class="sourceLine" id="cb191-3" title="3"><span class="ex">npm</span> install pg@^8.0.0</a></code></pre></div>
<p>We have installed not only the Sequelize library, but also a command line tool called <code>sequelize-cli</code> that will help us auto-generate and manage JavaScript files which will hold our Sequelize ORM code.</p>
<p>Last, we have also installed the pg library. This library allows Sequelize to access a Postgres database. If you were using a different database software (such as MySQL), you would need to install a different library.</p>
<h2 id="how-to-initialize-sequelize">How To Initialize Sequelize</h2>
<p>We can run the command <code>npx sequelize init</code> to automatically setup the following directory structure for our project:</p>
<pre><code>.
â”œâ”€â”€ config
â”‚Â Â  â””â”€â”€ config.json
â”œâ”€â”€ migrations
â”œâ”€â”€ models
â”‚Â Â  â””â”€â”€ index.js
â”œâ”€â”€ node_modules
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â””â”€â”€ seeders</code></pre>
<blockquote>
<p>Aside: the <code>npx</code> tool allows you to easily run scripts provided by packages like <code>sequelize-cli</code>. If you donâ€™t already have <code>npx</code>, you can install it with <code>npm install npx --global</code>. Without <code>npx</code> you would have to run the bash command: <code>./node_modules/.bin/sequelize init</code>. This directly runs the <code>sequelize</code> script provided by the installed <code>sequelize-cli</code> package.</p>
</blockquote>
<p>Having run <code>npx sequelize init</code>, we must write our database login information into <code>config/config.json</code>.</p>
<p>By default this file contains different sections we call "environments". In a typical company you will have different database servers and configuration depending on where you app is running. Development is usually where you do your development work. In our case this is our local computer. But test might be and environment where you run tests, and production is the environment where real users are interacting with your application.</p>
<p>Since we are doing development, we can just modify the "development" section to look like this:</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb193-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb193-2" title="2">  <span class="dt">&quot;development&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb193-3" title="3">    <span class="dt">&quot;username&quot;</span><span class="fu">:</span> <span class="st">&quot;catsdbuser&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb193-4" title="4">    <span class="dt">&quot;password&quot;</span><span class="fu">:</span> <span class="st">&quot;catsdbpassword&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb193-5" title="5">    <span class="dt">&quot;database&quot;</span><span class="fu">:</span> <span class="st">&quot;catsdb&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb193-6" title="6">    <span class="dt">&quot;host&quot;</span><span class="fu">:</span> <span class="st">&quot;127.0.0.1&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb193-7" title="7">    <span class="dt">&quot;dialect&quot;</span><span class="fu">:</span> <span class="st">&quot;postgres&quot;</span></a>
<a class="sourceLine" id="cb193-8" title="8">  <span class="fu">}</span></a>
<a class="sourceLine" id="cb193-9" title="9"><span class="fu">}</span><span class="er">...</span></a></code></pre></div>
<p>Here we are supposing that we have already created a <code>catsdb</code> database owned by the user <code>catsdbuser</code>, with password <code>catsdbpassword</code>. By setting <code>host</code> to <code>127.0.0.1</code>, we are saying that the database will run on the same machine as my JavaScript application. Last, we specify that we are using a <code>postgres</code> database.</p>
<h2 id="verifying-that-sequelize-can-connect-to-the-database">Verifying That Sequelize Can Connect To The Database</h2>
<p>At the top level of our project, we should create an <code>index.js</code> file. From this file we will verify that Sequelize can connect to the SQL database. To do this, we use the <code>authenticate</code> method of the sequelize object.</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb194-1" title="1"><span class="co">// ./index.js</span></a>
<a class="sourceLine" id="cb194-2" title="2"></a>
<a class="sourceLine" id="cb194-3" title="3"><span class="kw">const</span> <span class="op">{</span> sequelize <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb194-4" title="4"></a>
<a class="sourceLine" id="cb194-5" title="5"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb194-6" title="6">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb194-7" title="7">    <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">authenticate</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb194-8" title="8">  <span class="op">}</span> <span class="cf">catch</span> (e) <span class="op">{</span></a>
<a class="sourceLine" id="cb194-9" title="9">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Database connection failure.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb194-10" title="10">    <span class="va">console</span>.<span class="at">log</span>(e)<span class="op">;</span></a>
<a class="sourceLine" id="cb194-11" title="11">    <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb194-12" title="12">  <span class="op">}</span></a>
<a class="sourceLine" id="cb194-13" title="13"></a>
<a class="sourceLine" id="cb194-14" title="14">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Database connection success!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb194-15" title="15">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Sequelize is ready to use!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb194-16" title="16"></a>
<a class="sourceLine" id="cb194-17" title="17">  <span class="co">// Close database connection when done with it.</span></a>
<a class="sourceLine" id="cb194-18" title="18">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb194-19" title="19"><span class="op">}</span></a>
<a class="sourceLine" id="cb194-20" title="20"></a>
<a class="sourceLine" id="cb194-21" title="21"><span class="at">main</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb194-22" title="22"></a>
<a class="sourceLine" id="cb194-23" title="23"><span class="co">// Prints:</span></a>
<a class="sourceLine" id="cb194-24" title="24"><span class="co">//</span></a>
<a class="sourceLine" id="cb194-25" title="25"><span class="co">// Executing (default): SELECT 1+1 AS result</span></a>
<a class="sourceLine" id="cb194-26" title="26"><span class="co">// Database connection success!</span></a>
<a class="sourceLine" id="cb194-27" title="27"><span class="co">// Sequelize is ready to use!</span></a></code></pre></div>
<p>You may observe that the <code>authenticate</code> method returns a JavaScript <code>Promise</code> object. We use <code>await</code> to wait for the database connection to be established. If <code>authenticate</code> fails to connect, the <code>Promise</code> will be rejected. Since we use <code>await</code>, an exception will be thrown.</p>
<p>Many Sequelize methods return <code>Promise</code>s. Using <code>async</code> and <code>await</code> lets us use Sequelize methods as if they were synchronous. This helps reduce code complexity significantly.</p>
<p>Note that I call <code>sequelize.close()</code>. This closes the connection to the database. A Node.js JavaScript program will not terminate until all open files and database connections are closed. Thus, to make sure the Node.js program doesnâ€™t "hang" at the end, we close the database connection. Otherwise we will be forced to kill the Node.js program with <code>CTRL-C</code>, which is somewhat annoying.</p>
<h2 id="our-preexisting-database-schema">Our Preexisting Database Schema</h2>
<p>We are assuming that we are working with a preexisting SQL database. Our <code>catsdb</code> has a single table: <code>Cats</code>. Using the <code>psql</code> command-line program, we can describe the pre-existing <code>Cats</code> table below.</p>
<pre><code>catsdb=&gt; \d &quot;Cats&quot;
                                         Table &quot;public.Cats&quot;
    Column    |           Type           | Collation | Nullable |              Default
--------------+--------------------------+-----------+----------+------------------------------------
 id           | integer                  |           | not null | nextval(&#39;&quot;Cats_id_seq&quot;&#39;::regclass)
 firstName    | character varying(255)   |           |          |
 specialSkill | character varying(255)   |           |          |
 age          | integer                  |           |          |
 createdAt    | timestamp with time zone |           | not null |
 updatedAt    | timestamp with time zone |           | not null |
Indexes:
    &quot;Cats_pkey&quot; PRIMARY KEY, btree (id)</code></pre>
<p>Besides a primary key <code>id</code>, each <code>Cats</code> record has a <code>firstName</code>, a <code>specialSkill</code>, and an <code>age</code>. Each record also keeps track of two timestamps: the time when the cat was created (<code>createdAt</code>), and the most recent time when a column of the cat has been updated (<code>updatedAt</code>).</p>
<h2 id="using-sequelize-to-generate-the-model-file">Using Sequelize To Generate The Model File</h2>
<p>We will configure Sequelize to access the <code>Cats</code> table via a JavaScript class called <code>Cat</code>. To do this, we first use our trusty Sequelize CLI:</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb196-1" title="1"><span class="co"># Oops, forgot age:integer! (Don&#39;t worry we&#39;ll fix it later)</span></a>
<a class="sourceLine" id="cb196-2" title="2"><span class="ex">npx</span> sequelize model:generate --name Cat --attributes <span class="st">&quot;firstName:string,specialSkill:string&quot;</span></a></code></pre></div>
<p>This command generates two files: a <em>model</em> file (<code>./models/cat.js</code>) and a <em>migration</em> file (<code>./migrations/20200203211508-Cat.js</code>). We will ignore the migration file for now, and focus on the model file.</p>
<p>When using Sequelizeâ€™s <code>model:generate</code> command, we specify two things. First: we specify the <em>singular</em> form of the <code>Cats</code> table name (<code>Cat</code>). Second: we list the columns of the <code>Cats</code> table after the <code>--attributes</code> flag: <code>firstName</code> and <code>specialSkill</code>. We tell Sequelize that these are both <code>string</code> columns (Sequelize calls SQL <code>character varying(255)</code> columns <code>string</code>s).</p>
<p>We do not need to list <code>id</code>, <code>createdAt</code>, or <code>updatedAt</code>. Sequelize will always presume those exist. Notice that we have <strong>forgotten</strong> to list <code>age:integer</code> â€“ we will fix that soon!</p>
<h2 id="examining-and-modifying-a-sequelize-model-file">Examining (And Modifying) A Sequelize Model File</h2>
<p>Let us examine the generated <code>./models/cat.js</code> file:</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb197-1" title="1"><span class="co">// ./models/cat.js</span></a>
<a class="sourceLine" id="cb197-2" title="2"></a>
<a class="sourceLine" id="cb197-3" title="3"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb197-4" title="4"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb197-5" title="5">  <span class="kw">const</span> Cat <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Cat&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb197-6" title="6">    <span class="dt">firstName</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb197-7" title="7">    <span class="dt">specialSkill</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb197-8" title="8">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb197-9" title="9">  <span class="va">Cat</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb197-10" title="10">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb197-11" title="11">  <span class="op">};</span></a>
<a class="sourceLine" id="cb197-12" title="12">  <span class="cf">return</span> Cat<span class="op">;</span></a>
<a class="sourceLine" id="cb197-13" title="13"><span class="op">};</span></a></code></pre></div>
<p>This file exports a function that defines a <code>Cat</code> class. When you use <code>Sequelize</code> to query the <code>Cats</code> table, each row retrieved will be transformed by Sequelize into an instance of the <code>Cat</code> class. A JavaScript class like <code>Cat</code> that corresponds to a SQL table is called a <em>model</em> class.</p>
<p>The <code>./models/cat.js</code> will not be loaded by us directly. Sequelize will load this file and call the exported function to define the <code>Cat</code> class. The exported function uses Sequelizeâ€™s <code>define</code> method to auto-generate a new class (called <code>Cat</code>).</p>
<blockquote>
<p>Note: You may notice we arenâ€™t using the JavaScriptâ€™s <code>class</code> keyword to define the Cat class. With Sequelize, it is going to do all that for us with the <code>define</code> method. This is because Sequelize was around way before the <code>class</code> keyword was added to JavaScript. It is possible to use the class keyword with Sequelize, but itâ€™s <a href="https://codewithhugo.com/using-es6-classes-for-sequelize-4-models/">undocumented</a>.</p>
</blockquote>
<p>The first argument of <code>define</code> is the name of the class to define: <code>Cat</code>. Notice how the second argument is an <code>Object</code> of <code>Cats</code> table columns:</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb198-1" title="1"><span class="op">{</span></a>
<a class="sourceLine" id="cb198-2" title="2">    <span class="dt">firstName</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb198-3" title="3">    <span class="dt">specialSkill</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb198-4" title="4"><span class="op">}</span></a></code></pre></div>
<p>This object tells Sequelize about each of the columns of <code>Cats</code>. It maps each column name (<code>firstName</code>, <code>specialSkill</code>) to the type of data stored in the corresponding column of the <code>Cats</code> table. It is unnecessary to list <code>id</code>, <code>createdAt</code>, <code>updatedAt</code>, since Sequelize will already assume those exist.</p>
<p>We can correct our earlier mistake of forgetting <code>age</code>. We update the definition as so:</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb199-1" title="1"><span class="kw">const</span> Cat <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Cat&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb199-2" title="2">  <span class="dt">firstName</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb199-3" title="3">  <span class="dt">specialSkill</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb199-4" title="4">  <span class="dt">age</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb199-5" title="5"><span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a></code></pre></div>
<p>A complete list of Sequelize datatypes can be found in the <a href="https://sequelize.org/v5/manual/data-types.html">documentation</a>.</p>
<h2 id="using-the-cat-model-to-fetch-and-update-sql-data">Using The <code>Cat</code> Model To Fetch And Update SQL Data</h2>
<p>We are now ready to use our <code>Cat</code> model class. When Sequelize defines the <code>Cat</code> class, it will generate instance and class methods needed to interact with the <code>Cats</code> SQL table.</p>
<p>As we mentioned before we donâ€™t require our <code>cats.js</code> file directly. Instead we require <code>./models</code> which loads the file <code>./models/index.js</code>.</p>
<p>Inside this file it reads through all our models and attaches them to an object that it exports. So we can use destructuring to get a reference to our model class <code>Cat</code> like so:</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb200-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a></code></pre></div>
<p>Now letâ€™s update <em>our</em> <code>index.js</code> file to fetch a <code>Cat</code> from the <code>Cats</code> table:</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb201-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize <span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb201-2" title="2"></a>
<a class="sourceLine" id="cb201-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb201-4" title="4">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb201-5" title="5">    <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">authenticate</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb201-6" title="6">  <span class="op">}</span> <span class="cf">catch</span> (e) <span class="op">{</span></a>
<a class="sourceLine" id="cb201-7" title="7">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Database connection failure.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb201-8" title="8">    <span class="va">console</span>.<span class="at">log</span>(e)<span class="op">;</span></a>
<a class="sourceLine" id="cb201-9" title="9">    <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb201-10" title="10">  <span class="op">}</span></a>
<a class="sourceLine" id="cb201-11" title="11"></a>
<a class="sourceLine" id="cb201-12" title="12">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Database connection success!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb201-13" title="13">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Sequelize is ready to use!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb201-14" title="14"></a>
<a class="sourceLine" id="cb201-15" title="15">  <span class="kw">const</span> cat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findByPk</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb201-16" title="16">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">cat</span>.<span class="at">toJSON</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb201-17" title="17"></a>
<a class="sourceLine" id="cb201-18" title="18">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb201-19" title="19"><span class="op">}</span></a>
<a class="sourceLine" id="cb201-20" title="20"></a>
<a class="sourceLine" id="cb201-21" title="21"><span class="at">main</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb201-22" title="22"></a>
<a class="sourceLine" id="cb201-23" title="23"><span class="co">// This code prints:</span></a>
<a class="sourceLine" id="cb201-24" title="24"><span class="co">//</span></a>
<a class="sourceLine" id="cb201-25" title="25"><span class="co">// Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;id&quot; = 1;</span></a>
<a class="sourceLine" id="cb201-26" title="26"><span class="co">// {</span></a>
<a class="sourceLine" id="cb201-27" title="27"><span class="co">//   id: 1,</span></a>
<a class="sourceLine" id="cb201-28" title="28"><span class="co">//   firstName: &#39;Markov&#39;,</span></a>
<a class="sourceLine" id="cb201-29" title="29"><span class="co">//   specialSkill: &#39;sleeping&#39;,</span></a>
<a class="sourceLine" id="cb201-30" title="30"><span class="co">//   age: 5,</span></a>
<a class="sourceLine" id="cb201-31" title="31"><span class="co">//   createdAt: 2020-02-03T21:32:28.960Z,</span></a>
<a class="sourceLine" id="cb201-32" title="32"><span class="co">//   updatedAt: 2020-02-03T21:32:28.960Z</span></a>
<a class="sourceLine" id="cb201-33" title="33"><span class="co">// }</span></a></code></pre></div>
<p>We use the <code>Cat.findByPk</code> static class method to fetch a single cat: the one with <code>id</code> equal to 1. This static method exists because our <code>Cat</code> model class <em>extends</em> <code>Sequelize.Model</code>.</p>
<p>"Pk" stands for <em>primary key</em>; the <code>id</code> field is the primary key for the <code>Cats</code> table. <code>findByPk</code> returns a <code>Promise</code>, so we must <code>await</code> the result. The result is an instance of the <code>Cat</code> model class.</p>
<p>The cleanest way to log a fetched database record is to first call the <code>toJSON</code> method. <code>toJSON</code> converts a <code>Cat</code> object to a <em>Plain Old JavaScript Object</em> (POJO). <code>Cat</code> instances have many private variables and methods that can be distracting when printed. When you call <code>toJSON</code>, only the public data fields are copied into a JavaScript <code>Object</code>. Printing this raw JavaScript <code>Object</code> is thus much cleaner.</p>
<blockquote>
<p>The author has a pet-peeve about the <code>.toJSON()</code> method of Sequelize, it does not return JSON. It instead returns a POJO. If you needed it to be JSON you would still need to call <code>JSON.stringify(cat.toJSON())</code>. Perhaps they should have called it <code>.toObject</code> or <code>.toPOJO</code> instead.</p>
</blockquote>
<p>Note that Sequelize has logged the SQL query it ran to fetch Markovâ€™s information. This logging information is often helpful when trying to figure out what Sequelize is doing.</p>
<p>Youâ€™ll also notice that Sequelize puts double quotes around the table and field names. So if you are trying to look at your "Cats" table from the <code>psql</code> command you will need to quote them there as well. This is because PostgreSQL lowercases all identifiers like table and fields names before the query is run if they arenâ€™t quoted.</p>
<h2 id="reading-and-changing-record-attributes">Reading And Changing Record Attributes</h2>
<p>While <code>toJSON</code> is useful for logging a <code>Cat</code> object, it is not the simplest way to access individual column values. To read the <code>id</code>, <code>firstName</code>, etc of a <code>Cat</code>, you can directly access those attributes on the <code>Cat</code> instance itself:</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb202-1" title="1"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb202-2" title="2">  <span class="co">// Sequelize authentication code from above...</span></a>
<a class="sourceLine" id="cb202-3" title="3"></a>
<a class="sourceLine" id="cb202-4" title="4">  <span class="kw">const</span> cat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findByPk</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb202-5" title="5">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`</span><span class="sc">${</span><span class="va">cat</span>.<span class="at">firstName</span><span class="sc">}</span><span class="vs"> has been assigned id #</span><span class="sc">${</span><span class="va">cat</span>.<span class="at">id</span><span class="sc">}</span><span class="vs">.`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb202-6" title="6">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`They are </span><span class="sc">${</span><span class="va">cat</span>.<span class="at">age</span><span class="sc">}</span><span class="vs"> years old.`</span>)</a>
<a class="sourceLine" id="cb202-7" title="7">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Their special skill is </span><span class="sc">${</span><span class="va">cat</span>.<span class="at">specialSkill</span><span class="sc">}</span><span class="vs">.`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb202-8" title="8"></a>
<a class="sourceLine" id="cb202-9" title="9">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb202-10" title="10"><span class="op">}</span></a>
<a class="sourceLine" id="cb202-11" title="11"></a>
<a class="sourceLine" id="cb202-12" title="12"><span class="at">main</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb202-13" title="13"></a>
<a class="sourceLine" id="cb202-14" title="14"><span class="co">// This code prints:</span></a>
<a class="sourceLine" id="cb202-15" title="15"><span class="co">//</span></a>
<a class="sourceLine" id="cb202-16" title="16"><span class="co">// Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;id&quot; = 1;</span></a>
<a class="sourceLine" id="cb202-17" title="17"><span class="co">// Markov has been assigned id #1.</span></a>
<a class="sourceLine" id="cb202-18" title="18"><span class="co">// They are 5 years old.</span></a>
<a class="sourceLine" id="cb202-19" title="19"><span class="co">// Their special skill is sleeping.</span></a></code></pre></div>
<p>Accessing data directly through the <code>Cat</code> object is just like reading an attribute on any other JavaScript class. You may likewise <em>change</em> values in the database:</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb203-1" title="1"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb203-2" title="2">  <span class="co">// Sequelize authentication code from above...</span></a>
<a class="sourceLine" id="cb203-3" title="3"></a>
<a class="sourceLine" id="cb203-4" title="4">  <span class="co">// Fetch existing cat from database.</span></a>
<a class="sourceLine" id="cb203-5" title="5">  <span class="kw">const</span> cat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findByPk</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb203-6" title="6">  <span class="co">// Change cat&#39;s attributes.</span></a>
<a class="sourceLine" id="cb203-7" title="7">  <span class="va">cat</span>.<span class="at">firstName</span> <span class="op">=</span> <span class="st">&quot;Curie&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb203-8" title="8">  <span class="va">cat</span>.<span class="at">specialSkill</span> <span class="op">=</span> <span class="st">&quot;jumping&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb203-9" title="9">  <span class="va">cat</span>.<span class="at">age</span> <span class="op">=</span> <span class="dv">123</span><span class="op">;</span></a>
<a class="sourceLine" id="cb203-10" title="10"></a>
<a class="sourceLine" id="cb203-11" title="11">  <span class="co">// Save the new name to the database.</span></a>
<a class="sourceLine" id="cb203-12" title="12">  <span class="cf">await</span> <span class="va">cat</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb203-13" title="13"></a>
<a class="sourceLine" id="cb203-14" title="14">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb203-15" title="15"><span class="op">}</span></a>
<a class="sourceLine" id="cb203-16" title="16"></a>
<a class="sourceLine" id="cb203-17" title="17"><span class="co">// Prints:</span></a>
<a class="sourceLine" id="cb203-18" title="18"><span class="co">//</span></a>
<a class="sourceLine" id="cb203-19" title="19"><span class="co">// Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;id&quot; = 1;</span></a>
<a class="sourceLine" id="cb203-20" title="20"><span class="co">// Executing (default): UPDATE &quot;Cats&quot; SET &quot;firstName&quot;=$1,&quot;specialSkill&quot;=$2,&quot;age&quot;=$3,&quot;updatedAt&quot;=$4 WHERE &quot;id&quot; = $5</span></a>
<a class="sourceLine" id="cb203-21" title="21"></a>
<a class="sourceLine" id="cb203-22" title="22"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>Note that changing the <code>firstName</code> attribute value does not immediately change the stored value in the SQL database. Changing the <code>firstName</code> without calling <code>save</code> <strong>has no effect</strong> on the database. Only when we call <code>cat.save()</code> (and <code>await</code> the promise to resolve) will the changes to <code>firstName</code>, <code>specialSkill</code>, and <code>age</code> be saved to the SQL database. All these values are updated simultaneously.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Having completed this reading, you should be able to:</p>
<ul>
<li>Describe what an Object Relational Mapping is and what it is used for.</li>
<li>Install the <code>sequelize</code>, <code>sequelize-cli</code>, <code>pg</code> packages.</li>
<li>Configure Sequelize via the <code>config/config.json</code> file.</li>
<li>Use Sequelizeâ€™s <code>authenticate</code> method to verify that Sequelize can connect to the database.</li>
<li>Use the Sequelize CLI <code>model:generate</code> command to generate a model file.</li>
<li>Configure a model file to tell Sequelize about each database column.</li>
<li>Use the <code>findByPk</code> class method to fetch data from a SQL table.</li>
<li>Read data attributes from a model instance.</li>
<li>Modify a model instanceâ€™s attributes and save the changes back to the SQL database using the <code>save</code> method.</li>
</ul>
<hr />
<h1 id="using-database-migrations">Using Database Migrations</h1>
<p>Weâ€™ve seen how to use an ORM like Sequelize to fetch and store data in a SQL database using JavaScript classes and methods. Sequelize also lets you write JavaScript code that creates, modifies, or drops SQL tables. The JavaScript code that does this is called a <em>migration</em>. A migration "moves" the database from an old schema to a new schema.</p>
<p>When you finish this reading you will be able to:</p>
<ul>
<li>Describe advantages to using migrations over raw SQL commands to create and drop tables.</li>
<li>Write migrations that create and drop tables.</li>
<li>Undo incorrect migrations, fix them, and rerun them.</li>
</ul>
<h2 id="sequelize-migration-files">Sequelize Migration Files</h2>
<p>In the prior reading we assumed that a <code>Cats</code> table already existed in our <code>catsdb</code> database. In this reading, we will presume that the <code>Cats</code> table does not exist, and that we have to create the table ourselves. This is the typical case when you arenâ€™t merely interacting with a preexisting database. When you develop your own application, the database will start out empty and with a blank schema.</p>
<p>We previously used the Sequelize CLI tool to autogenerate a <code>Cat</code> model file like so:</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb204-1" title="1"><span class="co"># Oops, forgot age:integer!</span></a>
<a class="sourceLine" id="cb204-2" title="2"><span class="ex">npx</span> sequelize model:generate --name Cat --attributes <span class="st">&quot;firstName:string,specialSkill:string&quot;</span></a></code></pre></div>
<p>We noted that this creates <em>two</em> files. Weâ€™ve already examined the model file <code>./models/cat.js</code>. We will now look at the auto-generated <em>migration</em> file <code>./migrations/20200203211508-create-cat.js</code>.</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb205-1" title="1"><span class="co">// ./migrations/20200203211508-create-cat.js</span></a>
<a class="sourceLine" id="cb205-2" title="2"></a>
<a class="sourceLine" id="cb205-3" title="3"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb205-4" title="4"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb205-5" title="5">  <span class="dt">up</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb205-6" title="6">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">createTable</span>(<span class="st">&#39;Cats&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb205-7" title="7">      <span class="dt">id</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb205-8" title="8">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb205-9" title="9">        <span class="dt">autoIncrement</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb205-10" title="10">        <span class="dt">primaryKey</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb205-11" title="11">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">INTEGER</span></a>
<a class="sourceLine" id="cb205-12" title="12">      <span class="op">},</span></a>
<a class="sourceLine" id="cb205-13" title="13">      <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb205-14" title="14">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb205-15" title="15">      <span class="op">},</span></a>
<a class="sourceLine" id="cb205-16" title="16">      <span class="dt">specialSkill</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb205-17" title="17">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb205-18" title="18">      <span class="op">},</span></a>
<a class="sourceLine" id="cb205-19" title="19">      <span class="dt">createdAt</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb205-20" title="20">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb205-21" title="21">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">DATE</span></a>
<a class="sourceLine" id="cb205-22" title="22">      <span class="op">},</span></a>
<a class="sourceLine" id="cb205-23" title="23">      <span class="dt">updatedAt</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb205-24" title="24">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb205-25" title="25">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">DATE</span></a>
<a class="sourceLine" id="cb205-26" title="26">      <span class="op">}</span></a>
<a class="sourceLine" id="cb205-27" title="27">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb205-28" title="28">  <span class="op">},</span></a>
<a class="sourceLine" id="cb205-29" title="29">  <span class="dt">down</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb205-30" title="30">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">dropTable</span>(<span class="st">&#39;Cats&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb205-31" title="31">  <span class="op">}</span></a>
<a class="sourceLine" id="cb205-32" title="32"><span class="op">};</span></a></code></pre></div>
<p>The migration file exports two functions: <code>up</code> and <code>down</code>. The <code>up</code> function tells Sequelize how to create a <code>Cats</code> table. The <code>down</code> function tells Sequelize how to "undo" the <code>up</code> function. The <code>down</code> function drops the <code>Cats</code> table.</p>
<p>We will examine these functions more closely, but letâ€™s first see how to use a migration.</p>
<blockquote>
<p>Note: The timestamp <code>20200203211508</code> preceding <code>-create-cat.js</code> represents February 2, 2020. It gives the time and day that the migration was generated. (Your date should be when you generated your migration) By using the date and time as part of the filename, all migration files will have unique names. Also, alphabetical sorting will order the files from oldest to most recent migration.</p>
</blockquote>
<h2 id="running-a-migration">Running A Migration</h2>
<p>To create the <code>Cats</code> table, we must run our migration code. Having generated the <code>20200203211508-create-cat.js</code> migration file, we will use the Sequelize CLI tool to run the migration. We may do this like so:</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb206-1" title="1"><span class="co"># Run the migration&#39;s `up` method.</span></a>
<a class="sourceLine" id="cb206-2" title="2"><span class="ex">npx</span> sequelize db:migrate</a></code></pre></div>
<p>By giving Sequelize the <code>db:migrate</code> subcommand, it will know that we are asking it to run any new migrations. To run a migration, Sequelize will call the <code>up</code> method defined in the migration file. The <code>up</code> method will run the necessary <code>CREATE TABLE ...</code> SQL command for us. Sequelize will record (in a special <code>catsdb</code> table called <code>SequelizeMeta</code>) that the migration has been run. The next time we call <code>npx sequelize db:migrate</code>, Sequelize will not try to "redo" this already performed migration. It will do nothing the second time.</p>
<p>Having run the migration, we can verify that the <code>Cats</code> table looks like it should (with the exception of the <code>age</code> column):</p>
<p>Note that we we are using the table name in quotes here in <code>psql</code>.</p>
<pre><code>catsdb=&gt; \d &quot;Cats&quot;;
                                         Table &quot;public.Cats&quot;
    Column    |           Type           | Collation | Nullable
--------------+--------------------------+-----------+----------
 id           | integer                  |           | not null
 firstName    | character varying(255)   |           |
 specialSkill | character varying(255)   |           |
 createdAt    | timestamp with time zone |           | not null
 updatedAt    | timestamp with time zone |           | not null
Indexes:
    &quot;Cats_pkey&quot; PRIMARY KEY, btree (id)</code></pre>
<h2 id="rolling-back-a-migration">Rolling Back A Migration</h2>
<p>We made a mistake when generating our <code>Cat</code> migration. We forgot to include the <code>age</code> column.</p>
<p>One way to fix this is to generate a <em>second</em> migration that adds the forgotten <code>age</code> column. If we have already pushed our migration code to a remote git server, we should opt for this option.</p>
<p>If the migration has not yet been pushed, we can fix the migration directly. We will "undo" (AKA <em>rollback</em>) the migration that created the <code>Cats</code> table (dropping the table), fix the <code>up</code> method so that the <code>age</code> column is included, and finally rerun the migration.</p>
<blockquote>
<p>Note: this is not the same as the SQL command ROLLBACK.</p>
</blockquote>
<p>To undo the migration, we run:</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb208-1" title="1"><span class="ex">npx</span> sequelize db:migrate:undo</a></code></pre></div>
<p>Sequelize will call the <code>down</code> method for us, and the <code>Cats</code> table is dropped.</p>
<p>Why should you not use the <code>db:migrate:undo</code> way when the migration file has already been pushed to a remote git server? The reason is this: you can easily tell other developers to fix a broken migration by writing a second fixup migration (for instance, that adds the <code>age</code> column). All you need to do is check this new migration file into source control and push it. When another developer pulls your new migration code, the next time they run <code>npx sequelize db:migrate</code>, your fixup migration will be run on their local machine.</p>
<p>When rolling back already-checked-in migrations, there is no way to easily communicate to other developers that they should (1) rollback your migration and (2) rerun the newly corrected version of this migration. To avoid this communication problem, you should only rollback commits if you havenâ€™t already pushed them to a remote git server.</p>
<h2 id="editing-a-migration-file">Editing A Migration File</h2>
<p>Letâ€™s examine the <code>up</code> and <code>down</code> methods more closely. Letâ€™s start with the <code>up</code> method:</p>
<div class="sourceCode" id="cb209"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb209-1" title="1"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb209-2" title="2">  <span class="dt">up</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb209-3" title="3">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">createTable</span>(<span class="st">&#39;Cats&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb209-4" title="4">      <span class="dt">id</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb209-5" title="5">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb209-6" title="6">        <span class="dt">autoIncrement</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb209-7" title="7">        <span class="dt">primaryKey</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb209-8" title="8">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">INTEGER</span></a>
<a class="sourceLine" id="cb209-9" title="9">      <span class="op">},</span></a>
<a class="sourceLine" id="cb209-10" title="10">      <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb209-11" title="11">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb209-12" title="12">      <span class="op">},</span></a>
<a class="sourceLine" id="cb209-13" title="13">      <span class="dt">specialSkill</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb209-14" title="14">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb209-15" title="15">      <span class="op">},</span></a>
<a class="sourceLine" id="cb209-16" title="16">      <span class="dt">createdAt</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb209-17" title="17">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb209-18" title="18">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">DATE</span></a>
<a class="sourceLine" id="cb209-19" title="19">      <span class="op">},</span></a>
<a class="sourceLine" id="cb209-20" title="20">      <span class="dt">updatedAt</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb209-21" title="21">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb209-22" title="22">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">DATE</span></a>
<a class="sourceLine" id="cb209-23" title="23">      <span class="op">}</span></a>
<a class="sourceLine" id="cb209-24" title="24">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb209-25" title="25">  <span class="op">},</span></a>
<a class="sourceLine" id="cb209-26" title="26">  <span class="co">// ...</span></a>
<a class="sourceLine" id="cb209-27" title="27"><span class="op">};</span></a></code></pre></div>
<p>The <code>up</code> method will be passed a QueryInterface (<a href="https://sequelize.org/master/class/lib/query-interface.js~QueryInterface.html">documentation</a>) object. This object provides a number of commands for modifying the SQL database schema. The <code>createTable</code> method is amongst the most important.</p>
<p>We pass the table name (<code>'Cats'</code>) along with an object mapping column names to column attributes. Every column must have a specified <code>type</code>. This is similar to what we saw when we generated a model file. Note that we <strong>do not</strong> take <code>id</code>, <code>createdAt</code>, or <code>updatedAt</code> for granted. We need to include those columns. Luckily, everything has been auto-generated for us!</p>
<p>We will talk about <code>allowNull</code> and <code>primaryKey</code> in a later reading. These attributes ask Sequelize to add database constraints to a column. Likewise we will ignore <code>autoIncrement</code> for the moment (this allows a unique <code>id</code> to be auto-generated by the database for each saved row in the <code>Cats</code> table).</p>
<p>We fix the <code>up</code> method like so:</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb210-1" title="1"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb210-2" title="2">  <span class="dt">up</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb210-3" title="3">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">createTable</span>(<span class="st">&#39;Cats&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb210-4" title="4">      <span class="co">// ...</span></a>
<a class="sourceLine" id="cb210-5" title="5">      <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb210-6" title="6">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb210-7" title="7">      <span class="op">},</span></a>
<a class="sourceLine" id="cb210-8" title="8">      <span class="dt">specialSkill</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb210-9" title="9">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb210-10" title="10">      <span class="op">},</span></a>
<a class="sourceLine" id="cb210-11" title="11">      <span class="co">// Here we add the `age` column.</span></a>
<a class="sourceLine" id="cb210-12" title="12">      <span class="dt">age</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb210-13" title="13">        <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb210-14" title="14">      <span class="op">},</span></a>
<a class="sourceLine" id="cb210-15" title="15">      <span class="co">// ...</span></a>
<a class="sourceLine" id="cb210-16" title="16">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb210-17" title="17">  <span class="op">},</span></a>
<a class="sourceLine" id="cb210-18" title="18">  <span class="co">// ...</span></a>
<a class="sourceLine" id="cb210-19" title="19"><span class="op">};</span></a></code></pre></div>
<p>Adding the <code>age</code> column to the migration is a lot like how we added <code>age</code> to our model file.</p>
<p>Having fixed our migration, we may now "rerun" it the same way we ran it the first time:</p>
<div class="sourceCode" id="cb211"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb211-1" title="1"><span class="ex">npx</span> sequelize db:migrate</a></code></pre></div>
<p>We may now behold the fixed table:</p>
<pre><code>catsdb=&gt; \d &quot;Cats&quot;
                                         Table &quot;public.Cats&quot;
    Column    |           Type           | Collation | Nullable
--------------+--------------------------+-----------+----------
 id           | integer                  |           | not null
 firstName    | character varying(255)   |           |
 specialSkill | character varying(255)   |           |
 age          | integer                  |           |
 createdAt    | timestamp with time zone |           | not null
 updatedAt    | timestamp with time zone |           | not null
Indexes:
    &quot;Cats_pkey&quot; PRIMARY KEY, btree (id)</code></pre>
<h2 id="up-and-down-are-asynchronous"><code>up</code> And <code>down</code> are Asynchronous</h2>
<p>A final note about <code>up</code> (and also <code>down</code>). Sequelize expects <code>up</code> to be <em>asynchronous</em>. That is, Sequelize expects <code>up</code> to return a <code>Promise</code> object. Sequelize will wait for the <code>Promise</code> to be resolved. When the <code>Promise</code> is resolved, Sequelize will know the work of the <code>up</code> method is complete.</p>
<p>The <code>createTable</code> method is also asynchronous (returns a <code>Promise</code>). The promise resolves when <code>createTable</code> is done creating the table. This is why <code>up</code> is written as:</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb213-1" title="1"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb213-2" title="2">  <span class="dt">up</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb213-3" title="3">    <span class="co">// up returns Promise returned by `createTable`.</span></a>
<a class="sourceLine" id="cb213-4" title="4">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">createTable</span>(<span class="st">&#39;Cats&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb213-5" title="5">      <span class="co">// ...</span></a>
<a class="sourceLine" id="cb213-6" title="6">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb213-7" title="7">  <span class="op">},</span></a>
<a class="sourceLine" id="cb213-8" title="8">  <span class="co">// ...</span></a>
<a class="sourceLine" id="cb213-9" title="9"><span class="op">};</span></a></code></pre></div>
<p>Sequelize is able to autogenerate a migration to create a <code>Cats</code> table, but many other migrations (for instance, to add an <code>age</code> column to our <code>Cats</code> table) must be written by hand. When writing your own migrations, you may prefer using <code>async</code>/<code>await</code>, which is clearer:</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb214-1" title="1"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb214-2" title="2">  <span class="co">// Note the addition of the `async` keyword</span></a>
<a class="sourceLine" id="cb214-3" title="3">  <span class="dt">up</span><span class="op">:</span> <span class="kw">async</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb214-4" title="4">    <span class="co">// await `createTable` to finish its work.</span></a>
<a class="sourceLine" id="cb214-5" title="5">    <span class="cf">await</span> <span class="va">queryInterface</span>.<span class="at">createTable</span>(<span class="st">&#39;Cats&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb214-6" title="6">      <span class="co">// ...</span></a>
<a class="sourceLine" id="cb214-7" title="7">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb214-8" title="8"></a>
<a class="sourceLine" id="cb214-9" title="9">    <span class="co">// No need to return anything. An `async` method always returns a</span></a>
<a class="sourceLine" id="cb214-10" title="10">    <span class="co">// Promise that waits for all `await`ed work to be performed.</span></a>
<a class="sourceLine" id="cb214-11" title="11">  <span class="op">},</span></a>
<a class="sourceLine" id="cb214-12" title="12">  <span class="co">// ...</span></a>
<a class="sourceLine" id="cb214-13" title="13"><span class="op">};</span></a></code></pre></div>
<h2 id="writing-a-down-method">Writing A <code>down</code> Method</h2>
<p>A <code>down</code> method is written just like an <code>up</code> method. In the <code>down</code> method we "undo" what has been performed by the <code>up</code> method. We call <code>QueryInterface</code>â€™s <code>dropTable</code> method to drop the <code>Cats</code> table we created in <code>up</code>:</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb215-1" title="1"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb215-2" title="2">  <span class="co">// ...</span></a>
<a class="sourceLine" id="cb215-3" title="3">  <span class="dt">down</span><span class="op">:</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb215-4" title="4">    <span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">dropTable</span>(<span class="st">&#39;Cats&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb215-5" title="5">  <span class="op">}</span></a>
<a class="sourceLine" id="cb215-6" title="6"><span class="op">};</span></a>
<a class="sourceLine" id="cb215-7" title="7"></a>
<a class="sourceLine" id="cb215-8" title="8"><span class="co">// OR, async/await way:</span></a>
<a class="sourceLine" id="cb215-9" title="9"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb215-10" title="10">  <span class="co">// ...</span></a>
<a class="sourceLine" id="cb215-11" title="11">  <span class="dt">down</span><span class="op">:</span> <span class="kw">async</span> (queryInterface<span class="op">,</span> Sequelize) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb215-12" title="12">    <span class="cf">await</span> <span class="va">queryInterface</span>.<span class="at">dropTable</span>(<span class="st">&#39;Cats&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb215-13" title="13">  <span class="op">}</span></a>
<a class="sourceLine" id="cb215-14" title="14"><span class="op">};</span></a></code></pre></div>
<p><strong>Imagine we had forgotten to drop the <code>Cats</code> table in the <code>down</code> method.</strong> That is: imagine the <code>down</code> method was somehow left empty. If we rollback the migration nothing will be done by the empty <code>down</code> method. Thus the incorrect <code>Cats</code> table we created will not have been dropped. The wrong <code>Cats</code> table would still exist.</p>
<p>Imagine we next fix the migrationâ€™s <code>up</code> method. We want to rerun the migration now and create the corrected <code>Cats</code> table. But when try to do this, Sequelize will hit an error! Rerunning the migration will try to <code>CREATE TABLE "Cats"</code> again, but SQL will complain because a <code>Cats</code> table already exists. It was created the first time we ran the migration, but never dropped when we tried to rollback the migration!</p>
<p>Inevitably all programmers will sometimes make mistakes like this. In these circumstances, you will probably have to open <code>psql</code> and write a SQL <code>DROP TABLE</code> command to fix things. Having manually corrected things, you can finally rerun the corrected migration.</p>
<p>You should <strong>never</strong> manually drop a table on a production database. That is incredibly dangerous, and typically cannot be undone. Even if database backups do not exist, recently inserted data will be lost forever. This is yet another reason why you ought not rollback migrations that have been pushed from your local development environment!</p>
<h2 id="advantages-of-migrations">Advantages Of Migrations</h2>
<p>Having seen how to <em>use</em> Sequelize migrations, we can discuss their benefits versus writing SQL commands like <code>CREATE TABLE ...</code> yourself.</p>
<p>The first advantage is that Sequelize migration code is written in JavaScript, which you may find simpler to write/read than the corresponding SQL code. Most programmers write more JavaScript than SQL, so they are typically better at remembering how to do things in JavaScript than in SQL.</p>
<p>A second advantage is that migration files store SQL schema change code permanently. The migration files can be checked into git, so that you donâ€™t ever forget how your database was configured.</p>
<p>A third (related) advantage comes when another developer wants to collaborate on your JavaScript program. By cloning your git repository, they get all the migration files, too. To setup their own copy of your database, a collaborator can run the migration files on their own computer, playing back the schema changes one-by-one. Because they apply the same migrations as you, they end up with the same schema as you.</p>
<p>Last, by using migrations you are able to rollback database changes to fix bugs. This can be helpful in a local development environment where it is typical to make mistakes. Remember though: you should <strong>never</strong> rollback migrations that have been run on a production server.</p>
<h2 id="conclusion-1">Conclusion</h2>
<p>Having completed this reading, you now are able to:</p>
<ul>
<li>Describe advantages to using migrations over raw SQL commands to create, modify, and drop tables.</li>
<li>Generate (and modify as needed)) migrations that create and drop tables.</li>
<li>Run migrations to change the database schema.</li>
<li>Undo incorrect migrations, fix them, and rerun them.</li>
</ul>
<hr />
<h1 id="crud-operations-using-sequelize">CRUD Operations Using Sequelize</h1>
<p>There are four general ways to interact with a database. To illustrate these, recall our <code>Cats</code> table. We can:</p>
<ol type="1">
<li>Save a new cat to the database by <em>creating</em> a new row in the <code>Cats</code> table,</li>
<li>We can <em>read</em> previously stored cat data by fetching a row (or multiple rows) out of the <code>Cats</code> table,</li>
<li>We can <em>update</em> some of the column values for a pre-existing cat by modifying a row in the <code>Cats</code> table,</li>
<li>We can delete (<em>destroy</em>) the data for a cat by removing a row in the <code>Cats</code> table.</li>
</ol>
<p>These four actions are sometimes abbreviated as <em>CRUD</em>. After this reading, you will be able to:</p>
<ul>
<li>Use Sequelize to create new records in a table,</li>
<li>Use Sequelize to read/fetch existing records by primary key,</li>
<li>Use Sequelize to update existing records with new attribute values,</li>
<li>Use Sequelize to delete records from a table.</li>
</ul>
<h2 id="creating-a-new-record">Creating A New Record</h2>
<p>To save a new catâ€™s data as a row in the <code>Cats</code> table, we do a two step process:</p>
<ol type="1">
<li>We call the static <code>build</code> method on the <code>Cat</code> class with the desired values.</li>
<li>We call the <code>save</code> method on the <code>cat</code> instance.</li>
</ol>
<p>Letâ€™s see an example:</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb216-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb216-2" title="2"></a>
<a class="sourceLine" id="cb216-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb216-4" title="4">  <span class="co">// Constructs an instance of the JavaScript `Cat` class. **Does not</span></a>
<a class="sourceLine" id="cb216-5" title="5">  <span class="co">// save anything to the database yet**. Attributes are passed in as a</span></a>
<a class="sourceLine" id="cb216-6" title="6">  <span class="co">// POJO.</span></a>
<a class="sourceLine" id="cb216-7" title="7">  <span class="kw">const</span> cat <span class="op">=</span> <span class="va">Cat</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb216-8" title="8">    <span class="dt">firstName</span><span class="op">:</span> <span class="st">&quot;Markov&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb216-9" title="9">    <span class="dt">specialSkill</span><span class="op">:</span> <span class="st">&quot;sleeping&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb216-10" title="10">    <span class="dt">age</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span></a>
<a class="sourceLine" id="cb216-11" title="11">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb216-12" title="12"></a>
<a class="sourceLine" id="cb216-13" title="13">  <span class="co">// This actually creates a new `Cats` record in the database. We must</span></a>
<a class="sourceLine" id="cb216-14" title="14">  <span class="co">// wait for this asynchronous operation to succeed.</span></a>
<a class="sourceLine" id="cb216-15" title="15">  <span class="cf">await</span> <span class="va">cat</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb216-16" title="16"></a>
<a class="sourceLine" id="cb216-17" title="17">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">cat</span>.<span class="at">toJSON</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb216-18" title="18"></a>
<a class="sourceLine" id="cb216-19" title="19">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb216-20" title="20"><span class="op">}</span></a>
<a class="sourceLine" id="cb216-21" title="21"></a>
<a class="sourceLine" id="cb216-22" title="22"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>Running the code:</p>
<pre><code>Executing (default): INSERT INTO &quot;Cats&quot; (&quot;id&quot;,&quot;firstName&quot;,&quot;specialSkill&quot;,&quot;age&quot;,&quot;createdAt&quot;,&quot;updatedAt&quot;) VALUES (DEFAULT,$1,$2,$3,$4,$5) RETURNING *;
{
  id: 1,
  firstName: &#39;Markov&#39;,
  specialSkill: &#39;sleeping&#39;,
  age: 5,
  updatedAt: 2020-02-11T19:04:23.116Z,
  createdAt: 2020-02-11T19:04:23.116Z
}</code></pre>
<p>A new row has been inserted into the <code>Cats</code> table. We see that <code>id</code>, <code>updatedAt</code>, and <code>createdAt</code> were each autogenerated for us.</p>
<h2 id="reading-a-record-by-primary-key">Reading A Record By Primary Key</h2>
<p>Letâ€™s read an existing record from the database:</p>
<div class="sourceCode" id="cb218"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb218-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb218-2" title="2"></a>
<a class="sourceLine" id="cb218-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb218-4" title="4">  <span class="co">// Fetch the cat with id #1.</span></a>
<a class="sourceLine" id="cb218-5" title="5">  <span class="kw">const</span> cat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findByPk</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb218-6" title="6">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">cat</span>.<span class="at">toJSON</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb218-7" title="7"></a>
<a class="sourceLine" id="cb218-8" title="8">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb218-9" title="9"><span class="op">}</span></a>
<a class="sourceLine" id="cb218-10" title="10"></a>
<a class="sourceLine" id="cb218-11" title="11"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>Running this code prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;id&quot; = 1;
{
  id: 1,
  firstName: &#39;Markov&#39;,
  specialSkill: &#39;sleeping&#39;,
  age: 5,
  createdAt: 2020-02-11T19:04:23.116Z,
  updatedAt: 2020-02-11T19:04:23.116Z
}</code></pre>
<p>Fetching a record by primary key is the most common form of read operation from a database. In another reading we will learn other ways to fetch data. For instance: we will learn how to fetch all cats named "Markov" (there may be many).</p>
<h2 id="updating-a-record">Updating A Record</h2>
<p>Letâ€™s tweak our reading code to change (<em>update</em>) an attribute of Markov:</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb220-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span>  <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb220-2" title="2"></a>
<a class="sourceLine" id="cb220-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb220-4" title="4">  <span class="kw">const</span> cat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findByPk</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb220-5" title="5"></a>
<a class="sourceLine" id="cb220-6" title="6">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Old Markov: &quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb220-7" title="7">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">cat</span>.<span class="at">toJSON</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb220-8" title="8"></a>
<a class="sourceLine" id="cb220-9" title="9">  <span class="co">// The Cat object is modified, but the corresponding record in the</span></a>
<a class="sourceLine" id="cb220-10" title="10">  <span class="co">// database is *not* yet changed at all.</span></a>
<a class="sourceLine" id="cb220-11" title="11">  <span class="va">cat</span>.<span class="at">specialSkill</span> <span class="op">=</span> <span class="st">&quot;super deep sleeping&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb220-12" title="12">  <span class="co">// Only by calling `save` will the data be saved.</span></a>
<a class="sourceLine" id="cb220-13" title="13">  <span class="cf">await</span> <span class="va">cat</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb220-14" title="14"></a>
<a class="sourceLine" id="cb220-15" title="15">  <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;New Markov: &quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb220-16" title="16">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">cat</span>.<span class="at">toJSON</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb220-17" title="17"></a>
<a class="sourceLine" id="cb220-18" title="18">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb220-19" title="19"><span class="op">}</span></a>
<a class="sourceLine" id="cb220-20" title="20"></a>
<a class="sourceLine" id="cb220-21" title="21"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>Running this code prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;id&quot; = 1;
Old Markov:
{
  id: 1,
  firstName: &#39;Markov&#39;,
  specialSkill: &#39;sleeping&#39;,
  age: 5,
  createdAt: 2020-02-11T19:04:23.116Z,
  updatedAt: 2020-02-11T19:04:23.116Z
}
Executing (default): UPDATE &quot;Cats&quot; SET &quot;specialSkill&quot;=$1,&quot;updatedAt&quot;=$2 WHERE &quot;id&quot; = $3
New Markov:
{
  id: 1,
  firstName: &#39;Markov&#39;,
  specialSkill: &#39;super deep sleeping&#39;,
  age: 5,
  createdAt: 2020-02-11T19:04:23.116Z,
  updatedAt: 2020-02-11T19:15:08.668Z
}</code></pre>
<p><strong>Important note</strong>: changing an attribute of a <code>Cat</code> object does not immediately change any data in the <code>Cats</code> table. To change data in the <code>Cats</code> table, you must also call <code>save</code>. If you forget to call <code>save</code>, no data will be changed. <code>save</code> is asynchronous, so you must also <code>await</code> for it to complete.</p>
<p>If you look carefully, you can see that the <code>updatedAt</code> attribute was changed for us when we updated Markov!</p>
<h2 id="destroying-a-record">Destroying A Record</h2>
<p>We can also destroy records and remove them from the database:</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb222-1" title="1"><span class="kw">const</span> process <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;process&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb222-2" title="2"></a>
<a class="sourceLine" id="cb222-3" title="3"><span class="kw">const</span> <span class="op">{</span> sequelize <span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb222-4" title="4"></a>
<a class="sourceLine" id="cb222-5" title="5"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb222-6" title="6">  <span class="kw">const</span> cat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findByPk</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb222-7" title="7">  <span class="co">// Remove the Markov record.</span></a>
<a class="sourceLine" id="cb222-8" title="8">  <span class="cf">await</span> <span class="va">cat</span>.<span class="at">destroy</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb222-9" title="9"></a>
<a class="sourceLine" id="cb222-10" title="10">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb222-11" title="11"><span class="op">}</span></a>
<a class="sourceLine" id="cb222-12" title="12"></a>
<a class="sourceLine" id="cb222-13" title="13"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>This code prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;id&quot; = 1;
Executing (default): DELETE FROM &quot;Cats&quot; WHERE &quot;id&quot; = 1</code></pre>
<h2 id="class-methods-for-crud">Class Methods For CRUD</h2>
<p>When creating a record, you can avoid the two step process of (1) creating a <code>Cat</code> instance and (2) calling the <code>save</code> instance method. You can do a one step process of calling the <code>create</code> <strong>class method</strong>:</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb224-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb224-2" title="2"></a>
<a class="sourceLine" id="cb224-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb224-4" title="4">  <span class="kw">const</span> cat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">create</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb224-5" title="5">    <span class="dt">firstName</span><span class="op">:</span> <span class="st">&quot;Curie&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb224-6" title="6">    <span class="dt">specialSkill</span><span class="op">:</span> <span class="st">&quot;jumping&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb224-7" title="7">    <span class="dt">age</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></a>
<a class="sourceLine" id="cb224-8" title="8">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb224-9" title="9"></a>
<a class="sourceLine" id="cb224-10" title="10">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">cat</span>.<span class="at">toJSON</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb224-11" title="11"></a>
<a class="sourceLine" id="cb224-12" title="12">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb224-13" title="13"><span class="op">}</span></a>
<a class="sourceLine" id="cb224-14" title="14"></a>
<a class="sourceLine" id="cb224-15" title="15"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>The <code>create</code> class method does both steps in one. It is just a convenience. Similar to before, this code prints:</p>
<pre><code>Executing (default): INSERT INTO &quot;Cats&quot; (&quot;id&quot;,&quot;firstName&quot;,&quot;specialSkill&quot;,&quot;age&quot;,&quot;createdAt&quot;,&quot;updatedAt&quot;) VALUES (DEFAULT,$1,$2,$3,$4,$5) RETURNING *;
{
  id: 3,
  firstName: &#39;Curie&#39;,
  specialSkill: &#39;jumping&#39;,
  age: 4,
  updatedAt: 2020-02-11T19:36:03.858Z,
  createdAt: 2020-02-11T19:36:03.858Z
}</code></pre>
<p>When destroying, we also did a two step process: (1) fetch the record, (2) call the <code>destroy</code> instance method. Instead, we could just call the <code>destroy</code> <strong>class method</strong> directly:</p>
<div class="sourceCode" id="cb226"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb226-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb226-2" title="2"></a>
<a class="sourceLine" id="cb226-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb226-4" title="4">  <span class="co">// Destroy the Cat record with id #3.</span></a>
<a class="sourceLine" id="cb226-5" title="5">  <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">destroy</span>(<span class="op">{</span> <span class="dt">where</span><span class="op">:</span> <span class="op">{</span> <span class="dt">id</span><span class="op">:</span> <span class="dv">3</span> <span class="op">}</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb226-6" title="6"></a>
<a class="sourceLine" id="cb226-7" title="7">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb226-8" title="8"><span class="op">}</span></a>
<a class="sourceLine" id="cb226-9" title="9"></a>
<a class="sourceLine" id="cb226-10" title="10"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>This prints:</p>
<pre><code>Executing (default): DELETE FROM &quot;Cats&quot; WHERE &quot;id&quot; = 3</code></pre>
<p>An advantage to the class method form of destroying is that we avoid an unnecessary fetch of <code>Cat.findByPk(3)</code>. Database queries can sometimes be slow, though typically a few extra queries wonâ€™t make a big difference. Choosing between the instance and class methods of destroying usually comes down to which you consider easier to read/understand.</p>
<h2 id="conclusion-2">Conclusion</h2>
<p>As ever, the best resource for learning about Sequelize model methods is the <a href="https://sequelize.org/master/class/lib/model.js~Model.html">documentation</a>. The documentation explains the <code>create</code>, <code>destroy</code>, <code>findByPk</code>, and <code>save</code> methods in depth.</p>
<p>Having completed this reading, you now know how to:</p>
<ul>
<li>Use Sequelize to create new records in a table (using both instance and class methods),</li>
<li>Use Sequelize to read/fetch existing records by primary key,</li>
<li>Use Sequelize to update existing records with new attribute values,</li>
<li>Use Sequelize to delete records from a table (using both instance and class methods).</li>
</ul>
<hr />
<h1 id="querying-using-sequelize">Querying Using Sequelize</h1>
<p>We have already seen how to find a single record by primary key: <code>findByPk</code>. In this reading we will learn about more advanced ways to query a table. We will learn how to:</p>
<ul>
<li>Fetch all <code>Cats</code> whose name is <code>"Markov"</code>,</li>
<li>Fetch all <code>Cats</code> whose name is <code>"Markov"</code> <strong>OR</strong> <code>"Curie"</code>,</li>
<li>Fetch all <code>Cats</code> whose age is <strong>not</strong> 5,</li>
<li>Fetch all <code>Cats</code> whose name is <code>"Markov"</code> <strong>AND</strong> whose age is 5,</li>
<li>Fetch all <code>Cats</code> whose age is <strong>less than</strong> 5,</li>
</ul>
<p>We will also learn how to:</p>
<ul>
<li>Order <code>Cats</code> results by age (descending or ascending),</li>
<li>Limit <code>Cats</code> results to a finite number.</li>
</ul>
<h2 id="basic-usage-of-findall-to-retrieve-multiple-records">Basic Usage Of <code>findAll</code> To Retrieve Multiple Records</h2>
<p>Letâ€™s consider a simple example where we want to retrieve all the <code>Cats</code> in the database:</p>
<div class="sourceCode" id="cb228"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb228-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb228-2" title="2"></a>
<a class="sourceLine" id="cb228-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb228-4" title="4">  <span class="co">// `findAll` asks to retrieve _ALL_ THE CATS!!  An array of `Cat`</span></a>
<a class="sourceLine" id="cb228-5" title="5">  <span class="co">// objects will be returned.</span></a>
<a class="sourceLine" id="cb228-6" title="6">  <span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb228-7" title="7"></a>
<a class="sourceLine" id="cb228-8" title="8">  <span class="co">// Log the fetched cats.</span></a>
<a class="sourceLine" id="cb228-9" title="9">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb228-10" title="10"></a>
<a class="sourceLine" id="cb228-11" title="11">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb228-12" title="12"><span class="op">}</span></a>
<a class="sourceLine" id="cb228-13" title="13"></a>
<a class="sourceLine" id="cb228-14" title="14"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>Since this is an array we canâ€™t use that <code>.toJSON()</code> method we learned earlier, so we can instead use <code>JSON.stringify</code> on the Array.</p>
<p>Pro tip: giving a 3rd argument to <code>JSON.stringify</code> will pretty-print the result with the specified spacing. (We pass <code>null</code> as the 2nd argument to skip it.) You can read more at the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify"><code>JSON.stringify</code> docs</a>.</p>
<p>Running this code prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot;;
[
  {
    &quot;id&quot;: 4,
    &quot;firstName&quot;: &quot;Markov&quot;,
    &quot;specialSkill&quot;: &quot;sleeping&quot;,
    &quot;age&quot;: 5,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;
  },
  {
    &quot;id&quot;: 5,
    &quot;firstName&quot;: &quot;Curie&quot;,
    &quot;specialSkill&quot;: &quot;jumping&quot;,
    &quot;age&quot;: 4,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;
  }
]</code></pre>
<p>It isnâ€™t typical to want to fetch <em>every</em> record. We typically want to get only those records that match some criterion. In SQL, we use a <code>WHERE</code> clause to do this. With Sequelize, we issue a <code>WHERE</code> query like so:</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb230-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb230-2" title="2"></a>
<a class="sourceLine" id="cb230-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb230-4" title="4">  <span class="co">// Fetch all cats named Markov.</span></a>
<a class="sourceLine" id="cb230-5" title="5">  <span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb230-6" title="6">    <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb230-7" title="7">      <span class="dt">firstName</span><span class="op">:</span> <span class="st">&quot;Markov&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb230-8" title="8">    <span class="op">},</span></a>
<a class="sourceLine" id="cb230-9" title="9">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb230-10" title="10">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb230-11" title="11"></a>
<a class="sourceLine" id="cb230-12" title="12">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb230-13" title="13"><span class="op">}</span></a>
<a class="sourceLine" id="cb230-14" title="14"></a>
<a class="sourceLine" id="cb230-15" title="15"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>Which prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;firstName&quot; = &#39;Markov&#39;;
[
  {
    &quot;id&quot;: 4,
    &quot;firstName&quot;: &quot;Markov&quot;,
    &quot;specialSkill&quot;: &quot;sleeping&quot;,
    &quot;age&quot;: 5,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;
  }
]</code></pre>
<p>Weâ€™ve passed the <code>findAll</code> class method the <code>where</code> option. The <code>where</code> option tells Sequelize to use a <code>WHERE</code> clause. The option value passed is <code>{ firstName: "Markov" }</code>. This tells Sequelize to only return those <code>Cats</code> where <code>firstName</code> is equal to <code>"Markov"</code>.</p>
<p>If we wanted to select those <code>Cats</code> named Markov <strong>OR</strong> Curie, we can map <code>firstName</code> to an array of <code>["Markov", "Curie"]</code>. For example:</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb232-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb232-2" title="2"></a>
<a class="sourceLine" id="cb232-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb232-4" title="4">  <span class="co">// Fetch all cats named either Markov or Curie.</span></a>
<a class="sourceLine" id="cb232-5" title="5">  <span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb232-6" title="6">    <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb232-7" title="7">      <span class="dt">firstName</span><span class="op">:</span> [<span class="st">&quot;Markov&quot;</span><span class="op">,</span> <span class="st">&quot;Curie&quot;</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb232-8" title="8">    <span class="op">},</span></a>
<a class="sourceLine" id="cb232-9" title="9">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb232-10" title="10">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb232-11" title="11"></a>
<a class="sourceLine" id="cb232-12" title="12">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb232-13" title="13"><span class="op">}</span></a>
<a class="sourceLine" id="cb232-14" title="14"></a>
<a class="sourceLine" id="cb232-15" title="15"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>This prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;firstName&quot; IN (&#39;Markov&#39;, &#39;Curie&#39;);
[
  {
    &quot;id&quot;: 4,
    &quot;firstName&quot;: &quot;Markov&quot;,
    &quot;specialSkill&quot;: &quot;sleeping&quot;,
    &quot;age&quot;: 5,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;
  },
  {
    &quot;id&quot;: 5,
    &quot;firstName&quot;: &quot;Curie&quot;,
    &quot;specialSkill&quot;: &quot;jumping&quot;,
    &quot;age&quot;: 4,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;
  }
]</code></pre>
<p>The difference is that weâ€™ve passed <code>{ firstName: ["Markov", "Curie" ]}</code>. Sequelize will return all <code>Cats</code> whose <code>firstName</code> matches either <code>"Markov"</code> or <code>"Curie"</code>.</p>
<h2 id="using-findall-to-find-objects-not-matching-a-criterion">Using <code>findAll</code> To Find Objects Not Matching A Criterion</h2>
<p>We can also find all the <code>Cats</code> whose names are <strong>NOT</strong> Markov, but we will need to require in the <code>Op</code> object from Sequelize so we can use the "not equal" operator from it:</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb234-1" title="1"><span class="kw">const</span> <span class="op">{</span> Op <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;sequelize&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb234-2" title="2"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./db/models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb234-3" title="3"></a>
<a class="sourceLine" id="cb234-4" title="4"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb234-5" title="5">  <span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb234-6" title="6">    <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb234-7" title="7">      <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb234-8" title="8">        <span class="co">// Op.ne means the &quot;not equal&quot; operator.</span></a>
<a class="sourceLine" id="cb234-9" title="9">        [<span class="va">Op</span>.<span class="at">ne</span>]<span class="op">:</span> <span class="st">&quot;Markov&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb234-10" title="10">      <span class="op">},</span></a>
<a class="sourceLine" id="cb234-11" title="11">    <span class="op">},</span></a>
<a class="sourceLine" id="cb234-12" title="12">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb234-13" title="13">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb234-14" title="14"></a>
<a class="sourceLine" id="cb234-15" title="15">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb234-16" title="16"><span class="op">}</span></a>
<a class="sourceLine" id="cb234-17" title="17"></a>
<a class="sourceLine" id="cb234-18" title="18"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>Prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;firstName&quot; != &#39;Markov&#39;;
[
  {
    &quot;id&quot;: 5,
    &quot;firstName&quot;: &quot;Curie&quot;,
    &quot;specialSkill&quot;: &quot;jumping&quot;,
    &quot;age&quot;: 4,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;
  }
]</code></pre>
<p>This is our first example of a Sequelize <a href="https://sequelize.org/v5/manual/querying.html#operators"><em>operator</em></a>: <code>Op.ne</code>. <code>ne</code> stands for "not equal." Instead of mapping <code>firstName</code> to a single value like <code>"Markov"</code> or an array of values like <code>["Markov", "Curie"]</code>, we have mapped it to:</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb236-1" title="1"><span class="op">{</span> [<span class="va">Op</span>.<span class="at">ne</span>]<span class="op">:</span> <span class="st">&quot;Markov&quot;</span> <span class="op">}</span></a></code></pre></div>
<p>How does this work? <code>Op.ne</code> is a JavaScript <em>symbol</em>: <code>Op.ne === Symbol.for('ne')</code>. To simplify, letâ€™s just imagine that <code>Op.ne === "ne"</code>.</p>
<p>When we write <code>{ [Op.ne]: "Markov" }</code>, the <code>[]</code> brackets perform key interpolation. So this is equal to <code>{ "ne": "Markov" }</code>. So overall, we are effectively writing:</p>
<div class="sourceCode" id="cb237"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb237-1" title="1"><span class="va">db</span>.<span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb237-2" title="2">  <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb237-3" title="3">    <span class="co">// Won&#39;t exactly work (you need to use `[Op.ne]` after all). Does</span></a>
<a class="sourceLine" id="cb237-4" title="4">    <span class="co">// illustrate the concept though.</span></a>
<a class="sourceLine" id="cb237-5" title="5">    <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span> <span class="st">&quot;ne&quot;</span><span class="op">:</span> <span class="st">&quot;Markov&quot;</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb237-6" title="6">  <span class="op">},</span></a>
<a class="sourceLine" id="cb237-7" title="7"><span class="op">}</span>)</a></code></pre></div>
<p>This perhaps makes it clearer how Sequelize understands what we want. Sequelize is being passed an <em>object</em> as the <code>firstName</code> value. The object is specifying that we want to do a <code>!=</code> SQL operation by using the <code>"ne"</code> ("not equal") key. The value to "not equal" is specified as <code>"Markov"</code>.</p>
<h2 id="combining-criteria-with-op.and">Combining Criteria with <code>Op.and</code></h2>
<p>Weâ€™ve seen one way to do an <code>OR</code> operation above (by mapping a column name to an array of values). Letâ€™s see how to do an <code>AND</code> operation:</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb238-1" title="1"><span class="kw">const</span> <span class="op">{</span> Op <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;sequelize&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb238-2" title="2"><span class="kw">const</span> <span class="op">{</span> sequelize <span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb238-3" title="3"></a>
<a class="sourceLine" id="cb238-4" title="4"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb238-5" title="5">  <span class="co">// fetch cats with name != Markov AND age = 4.</span></a>
<a class="sourceLine" id="cb238-6" title="6">  <span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb238-7" title="7">    <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb238-8" title="8">      <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb238-9" title="9">        [<span class="va">Op</span>.<span class="at">ne</span>]<span class="op">:</span> <span class="st">&quot;Markov&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb238-10" title="10">      <span class="op">},</span></a>
<a class="sourceLine" id="cb238-11" title="11">      <span class="dt">age</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></a>
<a class="sourceLine" id="cb238-12" title="12">    <span class="op">},</span></a>
<a class="sourceLine" id="cb238-13" title="13">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb238-14" title="14">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb238-15" title="15"></a>
<a class="sourceLine" id="cb238-16" title="16">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb238-17" title="17"><span class="op">}</span></a>
<a class="sourceLine" id="cb238-18" title="18"></a>
<a class="sourceLine" id="cb238-19" title="19"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>This prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;firstName&quot; != &#39;Markov&#39; AND &quot;Cat&quot;.&quot;age&quot; = 4;
[
  {
    &quot;id&quot;: 5,
    &quot;firstName&quot;: &quot;Curie&quot;,
    &quot;specialSkill&quot;: &quot;jumping&quot;,
    &quot;age&quot;: 4,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;
  }
]</code></pre>
<p>Simply by listing more key/value pairs in the <code>where</code> object, we ask Sequelize to "AND" together multiple criteria.</p>
<p>Another way to do the same thing is like so:</p>
<div class="sourceCode" id="cb240"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb240-1" title="1"><span class="kw">const</span> <span class="op">{</span> Op <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;sequelize&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb240-2" title="2"><span class="kw">const</span> <span class="op">{</span> sequelize <span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb240-3" title="3"></a>
<a class="sourceLine" id="cb240-4" title="4"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb240-5" title="5">  <span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb240-6" title="6">    <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb240-7" title="7">      [<span class="va">Op</span>.<span class="at">and</span>]<span class="op">:</span> [</a>
<a class="sourceLine" id="cb240-8" title="8">        <span class="op">{</span> <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span> [<span class="va">Op</span>.<span class="at">ne</span>]<span class="op">:</span> <span class="st">&quot;Markov&quot;</span> <span class="op">}</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb240-9" title="9">        <span class="op">{</span> <span class="dt">age</span><span class="op">:</span> <span class="dv">4</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb240-10" title="10">      ]<span class="op">,</span></a>
<a class="sourceLine" id="cb240-11" title="11">    <span class="op">},</span></a>
<a class="sourceLine" id="cb240-12" title="12">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb240-13" title="13">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb240-14" title="14"></a>
<a class="sourceLine" id="cb240-15" title="15">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb240-16" title="16"><span class="op">}</span></a>
<a class="sourceLine" id="cb240-17" title="17"></a>
<a class="sourceLine" id="cb240-18" title="18"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>The use of the <code>Op.and</code> operator is somewhat similar to <code>Op.ne</code>. This time we map <code>Op.and</code> to an <em>array</em> of criteria. Returned records must match all the criteria.</p>
<h2 id="combining-criteria-with-op.or">Combining Criteria with <code>Op.or</code></h2>
<p>Weâ€™ve already seen how to do an <code>OR</code> to match a <em>single column</em> against <em>multiple values</em>. You can use <code>Op.or</code> for even greater flexibility:</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb241-1" title="1"><span class="kw">const</span> <span class="op">{</span> Op <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;sequelize&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb241-2" title="2"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb241-3" title="3"></a>
<a class="sourceLine" id="cb241-4" title="4"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb241-5" title="5">  <span class="co">// fetch cats with name == Markov OR age = 4.</span></a>
<a class="sourceLine" id="cb241-6" title="6">  <span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb241-7" title="7">    <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb241-8" title="8">      [<span class="va">Op</span>.<span class="at">or</span>]<span class="op">:</span> [</a>
<a class="sourceLine" id="cb241-9" title="9">        <span class="op">{</span> <span class="dt">firstName</span><span class="op">:</span> <span class="st">&quot;Markov&quot;</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb241-10" title="10">        <span class="op">{</span> <span class="dt">age</span><span class="op">:</span> <span class="dv">4</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb241-11" title="11">      ]<span class="op">,</span></a>
<a class="sourceLine" id="cb241-12" title="12">    <span class="op">},</span></a>
<a class="sourceLine" id="cb241-13" title="13">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb241-14" title="14">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb241-15" title="15"></a>
<a class="sourceLine" id="cb241-16" title="16">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb241-17" title="17"><span class="op">}</span></a>
<a class="sourceLine" id="cb241-18" title="18"></a>
<a class="sourceLine" id="cb241-19" title="19"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>This prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE (&quot;Cat&quot;.&quot;firstName&quot; = &#39;Markov&#39; OR &quot;Cat&quot;.&quot;age&quot; = 4);
[
  {
    &quot;id&quot;: 4,
    &quot;firstName&quot;: &quot;Markov&quot;,
    &quot;specialSkill&quot;: &quot;sleeping&quot;,
    &quot;age&quot;: 5,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;
  },
  {
    &quot;id&quot;: 5,
    &quot;firstName&quot;: &quot;Curie&quot;,
    &quot;specialSkill&quot;: &quot;jumping&quot;,
    &quot;age&quot;: 4,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;
  }
]</code></pre>
<p>Our query is to find all cats whose names are "Markov" and whose age is 4. Therefore both cats are returned: Markov and Curie (whose age is 4).</p>
<h2 id="querying-with-comparisons">Querying With Comparisons</h2>
<p>We can use operators like <code>Op.gt</code> (greater than) and <code>Op.lt</code> (less than) to select by comparing values. We use these just like <code>Op.ne</code>:</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb243-1" title="1"><span class="kw">const</span> <span class="op">{</span> Op <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;sequelize&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb243-2" title="2"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb243-3" title="3"></a>
<a class="sourceLine" id="cb243-4" title="4"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb243-5" title="5">  <span class="co">// Fetch all cats whose age is &gt; 4.</span></a>
<a class="sourceLine" id="cb243-6" title="6">  <span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb243-7" title="7">    <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb243-8" title="8">      <span class="dt">age</span><span class="op">:</span> <span class="op">{</span> [<span class="va">Op</span>.<span class="at">gt</span>]<span class="op">:</span> <span class="dv">4</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb243-9" title="9">    <span class="op">},</span></a>
<a class="sourceLine" id="cb243-10" title="10">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb243-11" title="11">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb243-12" title="12"></a>
<a class="sourceLine" id="cb243-13" title="13">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb243-14" title="14"><span class="op">}</span></a>
<a class="sourceLine" id="cb243-15" title="15"></a>
<a class="sourceLine" id="cb243-16" title="16"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>This prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;age&quot; &gt; 4;
[
  {
    &quot;id&quot;: 4,
    &quot;firstName&quot;: &quot;Markov&quot;,
    &quot;specialSkill&quot;: &quot;sleeping&quot;,
    &quot;age&quot;: 5,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;
  }
]</code></pre>
<h2 id="ordering-results">Ordering Results</h2>
<p>Weâ€™ve seen how to use a <code>where</code> query option to filter results with a SQL <code>WHERE</code> clause. We can use the <code>order</code> query option to perform a SQL <code>ORDER BY</code>:</p>
<div class="sourceCode" id="cb245"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb245-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb245-2" title="2"></a>
<a class="sourceLine" id="cb245-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb245-4" title="4">  <span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb245-5" title="5">    <span class="dt">order</span><span class="op">:</span> [[<span class="st">&quot;age&quot;</span><span class="op">,</span> <span class="st">&quot;DESC&quot;</span>]]<span class="op">,</span></a>
<a class="sourceLine" id="cb245-6" title="6">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb245-7" title="7">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb245-8" title="8"></a>
<a class="sourceLine" id="cb245-9" title="9">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb245-10" title="10"><span class="op">}</span></a>
<a class="sourceLine" id="cb245-11" title="11"></a>
<a class="sourceLine" id="cb245-12" title="12"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>This prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; ORDER BY &quot;Cat&quot;.&quot;age&quot; DESC;
[
  {
    &quot;id&quot;: 4,
    &quot;firstName&quot;: &quot;Markov&quot;,
    &quot;specialSkill&quot;: &quot;sleeping&quot;,
    &quot;age&quot;: 5,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;
  },
  {
    &quot;id&quot;: 5,
    &quot;firstName&quot;: &quot;Curie&quot;,
    &quot;specialSkill&quot;: &quot;jumping&quot;,
    &quot;age&quot;: 4,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.398Z&quot;
  }
]</code></pre>
<p>Weâ€™ve specified <code>{ order: [["age", "DESC"]] }</code>. Notice how we specify the sort order with a doubly-nested array. If we wanted to sort ascending we could more simply write: <code>{ order: ["age"] }</code>.</p>
<p>What if we wanted to sort by <em>two</em> columns? For instance, say we wanted to <code>SORT BY age DESC, firstName</code>. We would write: <code>{ order: [["age", "DESC"], "firstName"] }</code>. That would sort descending by <code>age</code>, and then ascending by <code>firstName</code> for cats with the same age.</p>
<h2 id="limiting-results-and-findone">Limiting Results and <code>findOne</code></h2>
<p>If we want only the oldest cat we can use the <code>limit</code> query option:</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb247-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb247-2" title="2"></a>
<a class="sourceLine" id="cb247-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb247-4" title="4">  <span class="kw">const</span> cats <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findAll</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb247-5" title="5">    <span class="dt">order</span><span class="op">:</span> [[<span class="st">&quot;age&quot;</span><span class="op">,</span> <span class="st">&quot;DESC&quot;</span>]]<span class="op">,</span></a>
<a class="sourceLine" id="cb247-6" title="6">    <span class="dt">limit</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></a>
<a class="sourceLine" id="cb247-7" title="7">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb247-8" title="8">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cats<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb247-9" title="9"></a>
<a class="sourceLine" id="cb247-10" title="10">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb247-11" title="11"><span class="op">}</span></a>
<a class="sourceLine" id="cb247-12" title="12"></a>
<a class="sourceLine" id="cb247-13" title="13"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>This selects only one (the oldest) cat:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; ORDER BY &quot;Cat&quot;.&quot;age&quot; DESC LIMIT 1;
[
  {
    &quot;id&quot;: 4,
    &quot;firstName&quot;: &quot;Markov&quot;,
    &quot;specialSkill&quot;: &quot;sleeping&quot;,
    &quot;age&quot;: 5,
    &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;,
    &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;
  }
]</code></pre>
<p>Since we know that there will be only one result, it is pointless to return an array. In cases when we want a maximum of one result, we can use <code>findOne</code>:</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb249-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb249-2" title="2"></a>
<a class="sourceLine" id="cb249-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb249-4" title="4">  <span class="kw">const</span> cat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findOne</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb249-5" title="5">    <span class="dt">order</span><span class="op">:</span> [[<span class="st">&quot;age&quot;</span><span class="op">,</span> <span class="st">&quot;DESC&quot;</span>]]<span class="op">,</span></a>
<a class="sourceLine" id="cb249-6" title="6">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb249-7" title="7">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cat<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb249-8" title="8"></a>
<a class="sourceLine" id="cb249-9" title="9">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb249-10" title="10"><span class="op">}</span></a>
<a class="sourceLine" id="cb249-11" title="11"></a>
<a class="sourceLine" id="cb249-12" title="12"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>Which prints:</p>
<pre><code>&gt;&gt; node index.js
Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; ORDER BY &quot;Cat&quot;.&quot;age&quot; DESC LIMIT 1;
{
  &quot;id&quot;: 4,
  &quot;firstName&quot;: &quot;Markov&quot;,
  &quot;specialSkill&quot;: &quot;sleeping&quot;,
  &quot;age&quot;: 5,
  &quot;createdAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;,
  &quot;updatedAt&quot;: &quot;2020-02-11T23:03:25.388Z&quot;
}</code></pre>
<p>This returned the <code>Cat</code> object directly, not wrapped in an array.</p>
<p>If there is no record matching the criteria passed to <code>findOne</code>, it will return <code>null</code> (rather than an empty array):</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb251-1" title="1"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb251-2" title="2"></a>
<a class="sourceLine" id="cb251-3" title="3"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb251-4" title="4">  <span class="co">// Try to find a non-existant cat.</span></a>
<a class="sourceLine" id="cb251-5" title="5">  <span class="kw">const</span> cat <span class="op">=</span> <span class="cf">await</span> <span class="va">Cat</span>.<span class="at">findOne</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb251-6" title="6">    <span class="dt">where</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb251-7" title="7">      <span class="dt">firstName</span><span class="op">:</span> <span class="st">&quot;Franklin Delano Catsevelt&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb251-8" title="8">    <span class="op">},</span></a>
<a class="sourceLine" id="cb251-9" title="9">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb251-10" title="10">  <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cat<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb251-11" title="11"></a>
<a class="sourceLine" id="cb251-12" title="12">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb251-13" title="13"><span class="op">}</span></a>
<a class="sourceLine" id="cb251-14" title="14"></a>
<a class="sourceLine" id="cb251-15" title="15"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>No such cat exists:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;firstName&quot;, &quot;specialSkill&quot;, &quot;age&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;Cats&quot; AS &quot;Cat&quot; WHERE &quot;Cat&quot;.&quot;firstName&quot; = &#39;Franklin Delano Catsevelt&#39; LIMIT 1;
null</code></pre>
<h2 id="conclusion-3">Conclusion</h2>
<p>Weâ€™ve scratched the surface of the many query options supported by Sequelize. You may find more information as necessary by reading the <a href="https://sequelize.org/v5/manual/querying.html">Sequelize querying documentation</a>. You can in particular review the <a href="https://sequelize.org/v5/manual/querying.html#operators">list of Sequelize query operators</a>.</p>
<p>Now that youâ€™ve completed this reading you should know how to:</p>
<ul>
<li>Use the <code>where</code> query option,</li>
<li>Use the <code>Op.and</code> operator to match <strong>all</strong> of multiple criteria,</li>
<li>Use the <code>Op.or</code> operator to match <strong>any</strong> of multiple criteria,</li>
<li>Use the <code>Op.ne</code> to match rows where the value <strong>does not equal</strong> the specified value,</li>
<li>Use the <code>Op.gt</code>, <code>Op.lt</code> operators to <strong>compare</strong> values,</li>
<li>Use the <code>order</code> query option to <strong>order</strong> results,</li>
<li>Use the <code>limit</code> query option to <strong>limit</strong> the number of returned results,</li>
<li>Use <code>findOne</code> when only one result is expected or desired.</li>
</ul>
<hr />
<h1 id="model-validations-with-sequelize">Model Validations With Sequelize</h1>
<p>Itâ€™s important to make sure that data stored to a database is not erroneous or incomplete. Imagine the following forms of "garbage data:"</p>
<ul>
<li>A <code>Cats</code> record with <code>firstName</code> set to <code>NULL</code>. All <code>Cats</code> ought to have a name.</li>
<li>A <code>Cats</code> record with <code>firstName</code> set to the empty string: <code>""</code>.</li>
<li>A <code>Cats</code> record with an <code>age</code> less than <code>0</code>. <code>age</code> must always be non-negative.</li>
<li>Perhaps the <code>specialSkill</code> should come from a pre-defined limited list of <code>["jumping", "sleeping", "purring"]</code>. A <code>Cats</code> record with a <code>specialSkill</code> of <code>"pearl diving"</code> would thus be invalid.</li>
</ul>
<p>Sequelize lets us write JavaScript code that will check that these data requirements are satisfied before saving a record to the database. The JavaScript code that does this is called a <em>validation</em>. A validation is code that makes sure that data is valid.</p>
<p>In this reading you will learn how to:</p>
<ol type="1">
<li>Validate that an attribute is not set to <code>NULL</code>.</li>
<li>Validate that a string attribute is not set to the empty string <code>""</code>.</li>
<li>Validate that a string attribute is not too long (has too many characters).</li>
<li>Validate that a numeric attribute meets minimum or maximum thresholds.</li>
<li>Validate that an attribute is within a limited set of options.</li>
</ol>
<h2 id="validating-that-an-attribute-is-not-null">Validating That An Attribute Is Not <code>NULL</code></h2>
<p>We should not allow a <code>Cat</code> to be saved to the database if it lacks</p>
<ol type="1">
<li>a <code>firstName</code>,</li>
<li>an <code>age</code>, or</li>
<li>a <code>specialSkill</code>.</li>
</ol>
<p>None of these should be set to <code>NULL</code>.</p>
<p>Before adding validations to check these requirements, letâ€™s review what our <code>Cat</code> model code currently looks like:</p>
<div class="sourceCode" id="cb253"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb253-1" title="1"><span class="co">// ./models/cat.js</span></a>
<a class="sourceLine" id="cb253-2" title="2"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb253-3" title="3"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb253-4" title="4">  <span class="kw">const</span> Cat <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Cat&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb253-5" title="5">    <span class="dt">firstName</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb253-6" title="6">    <span class="dt">specialSkill</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb253-7" title="7">    <span class="dt">age</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb253-8" title="8">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb253-9" title="9">  <span class="va">Cat</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb253-10" title="10">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb253-11" title="11">  <span class="op">};</span></a>
<a class="sourceLine" id="cb253-12" title="12">  <span class="cf">return</span> Cat<span class="op">;</span></a>
<a class="sourceLine" id="cb253-13" title="13"><span class="op">};</span></a></code></pre></div>
<p>We will modify our model definition to give more specific instructions to Sequelize about the <code>firstName</code>, <code>specialSkill</code>, and <code>age</code> attributes:</p>
<div class="sourceCode" id="cb254"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb254-1" title="1"><span class="co">// ./models/cat.js</span></a>
<a class="sourceLine" id="cb254-2" title="2"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb254-3" title="3"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb254-4" title="4">  <span class="kw">const</span> Cat <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Cat&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb254-5" title="5">    <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb254-6" title="6">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb254-7" title="7">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb254-8" title="8">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb254-9" title="9">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb254-10" title="10">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;firstName must not be null&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb254-11" title="11">        <span class="op">},</span></a>
<a class="sourceLine" id="cb254-12" title="12">      <span class="op">},</span></a>
<a class="sourceLine" id="cb254-13" title="13">    <span class="op">},</span></a>
<a class="sourceLine" id="cb254-14" title="14">    <span class="dt">specialSkill</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb254-15" title="15">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb254-16" title="16">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb254-17" title="17">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb254-18" title="18">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb254-19" title="19">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;specialSkill must not be null&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb254-20" title="20">        <span class="op">},</span></a>
<a class="sourceLine" id="cb254-21" title="21">      <span class="op">},</span></a>
<a class="sourceLine" id="cb254-22" title="22">    <span class="op">},</span></a>
<a class="sourceLine" id="cb254-23" title="23">    <span class="dt">age</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb254-24" title="24">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb254-25" title="25">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb254-26" title="26">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb254-27" title="27">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb254-28" title="28">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;age must not be null&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb254-29" title="29">        <span class="op">},</span></a>
<a class="sourceLine" id="cb254-30" title="30">      <span class="op">},</span></a>
<a class="sourceLine" id="cb254-31" title="31">    <span class="op">},</span></a>
<a class="sourceLine" id="cb254-32" title="32">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb254-33" title="33">  <span class="va">Cat</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb254-34" title="34">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb254-35" title="35">  <span class="op">};</span></a>
<a class="sourceLine" id="cb254-36" title="36">  <span class="cf">return</span> Cat<span class="op">;</span></a>
<a class="sourceLine" id="cb254-37" title="37"><span class="op">};</span></a></code></pre></div>
<p>What has changed? We now map each attribute name (<code>firstName</code>, <code>specialSkill</code>, <code>age</code>) to a POJO that tells Sequelize how to configure that attribute. Here is the POJO for <code>firstName</code>:</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb255-1" title="1"><span class="op">{</span></a>
<a class="sourceLine" id="cb255-2" title="2">  <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb255-3" title="3">  <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb255-4" title="4">  <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb255-5" title="5">    <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb255-6" title="6">      <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;firstName must not be null&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb255-7" title="7">    <span class="op">},</span></a>
<a class="sourceLine" id="cb255-8" title="8">  <span class="op">},</span></a>
<a class="sourceLine" id="cb255-9" title="9"><span class="op">}</span></a></code></pre></div>
<p>The <code>type</code> attribute is of course vital: this used to be the only thing we specified. Weâ€™ve added two new attributes. The first is <code>allowNull: false</code>. This tells Sequelize not to let us set the <code>firstName</code> attribute to <code>NULL</code>.</p>
<p>The second attribute is <code>validate</code>. We will spend a lot of time examining this attribute in this reading. Validation logic for <code>firstName</code> is configured inside the <code>validate</code> attribute. Our <code>validate</code> configuration is:</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb256-1" title="1"><span class="op">{</span></a>
<a class="sourceLine" id="cb256-2" title="2">  <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb256-3" title="3">    <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;firstName must not be null&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb256-4" title="4">  <span class="op">},</span></a>
<a class="sourceLine" id="cb256-5" title="5"><span class="op">}</span></a></code></pre></div>
<p>This configuration tells Sequelize what error message to give if we try to set the <code>firstName</code> attribute to <code>NULL</code>. Itâ€™s odd that we have to set both <code>allowNull: false</code> and <code>notNull: { msg:  ... }</code>. This feels like unnecessary duplication. Regardless, thatâ€™s what Sequelize wants us to do. On the other hand, we do get a chance to specify the error message to print if the validation fails (<code>"firstName must not be null"</code>).</p>
<p>Letâ€™s see how the validation logic helps us avoid saving junk data to our database:</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb257-1" title="1"><span class="co">// index.js</span></a>
<a class="sourceLine" id="cb257-2" title="2"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb257-3" title="3"></a>
<a class="sourceLine" id="cb257-4" title="4"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb257-5" title="5">  <span class="kw">const</span> cat <span class="op">=</span> <span class="va">Cat</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb257-6" title="6">    <span class="co">// Empty cat. All fields set to `null`.</span></a>
<a class="sourceLine" id="cb257-7" title="7">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb257-8" title="8"></a>
<a class="sourceLine" id="cb257-9" title="9">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb257-10" title="10">    <span class="co">// Try to save cat to the database.</span></a>
<a class="sourceLine" id="cb257-11" title="11">    <span class="cf">await</span> <span class="va">cat</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb257-12" title="12"></a>
<a class="sourceLine" id="cb257-13" title="13">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Save success!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb257-14" title="14">    <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cat<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb257-15" title="15">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb257-16" title="16">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Save failed!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb257-17" title="17"></a>
<a class="sourceLine" id="cb257-18" title="18">    <span class="co">// Print list of errors.</span></a>
<a class="sourceLine" id="cb257-19" title="19">    <span class="cf">for</span> (<span class="kw">const</span> validationError <span class="kw">of</span> <span class="va">err</span>.<span class="at">errors</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb257-20" title="20">      <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;*&quot;</span><span class="op">,</span> <span class="va">validationError</span>.<span class="at">message</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb257-21" title="21">    <span class="op">}</span></a>
<a class="sourceLine" id="cb257-22" title="22">  <span class="op">}</span></a>
<a class="sourceLine" id="cb257-23" title="23"></a>
<a class="sourceLine" id="cb257-24" title="24">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb257-25" title="25"><span class="op">}</span></a>
<a class="sourceLine" id="cb257-26" title="26"></a>
<a class="sourceLine" id="cb257-27" title="27"><span class="at">main</span>()</a></code></pre></div>
<p>Running this code prints:</p>
<pre><code>Save failed!
* firstName must not be null
* specialSkill must not be null
* age must not be null</code></pre>
<p>What happened? When we call the <code>save</code> method on a <code>Cat</code>, Sequelize will check that all the specified validations are satisfied. In this case none of them are! The <code>save</code> method will throw an exception, which we handle using <code>try { ... } catch (err) { ... }</code>.</p>
<p>What kind of exception? The thrown error is a <a href="https://sequelize.org/v5/class/lib/errors/validation-error.js~ValidationError.html"><code>ValidationError</code></a>. This has an <code>errors</code> attribute, which stores an array of <a href="https://sequelize.org/v5/class/lib/errors/validation-error.js~ValidationErrorItem.html"><code>ValidationErrorItem</code>s</a>. We print out the message for each item error.</p>
<p>Because there were validation failures, Sequelize <strong>will not save</strong> the invalid <code>Cats</code> record to the database. Sequelize thus keeps us from inserting junk data into the database.</p>
<p>If we want to save our <code>Cat</code> object, we would have to change its attributes to meet the validations (i.e., set them to something other than <code>NULL</code>) and call <code>save</code> a second time. For example:</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb259-1" title="1"><span class="co">// index.js</span></a>
<a class="sourceLine" id="cb259-2" title="2"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb259-3" title="3"></a>
<a class="sourceLine" id="cb259-4" title="4"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb259-5" title="5">  <span class="kw">const</span> cat <span class="op">=</span> <span class="va">Cat</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb259-6" title="6">    <span class="co">// Empty cat. All fields set to `null`.</span></a>
<a class="sourceLine" id="cb259-7" title="7">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb259-8" title="8"></a>
<a class="sourceLine" id="cb259-9" title="9">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb259-10" title="10">    <span class="cf">await</span> <span class="va">cat</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb259-11" title="11">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb259-12" title="12">    <span class="co">// The save will not succeed!</span></a>
<a class="sourceLine" id="cb259-13" title="13">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;We will fix and try again!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb259-14" title="14">  <span class="op">}</span></a>
<a class="sourceLine" id="cb259-15" title="15"></a>
<a class="sourceLine" id="cb259-16" title="16">  <span class="co">// Fix the various validation problems.</span></a>
<a class="sourceLine" id="cb259-17" title="17">  <span class="va">cat</span>.<span class="at">firstName</span> <span class="op">=</span> <span class="st">&quot;Markov&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb259-18" title="18">  <span class="va">cat</span>.<span class="at">specialSkill</span> <span class="op">=</span> <span class="st">&quot;sleeping&quot;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb259-19" title="19">  <span class="va">cat</span>.<span class="at">age</span> <span class="op">=</span> <span class="dv">4</span><span class="op">;</span></a>
<a class="sourceLine" id="cb259-20" title="20"></a>
<a class="sourceLine" id="cb259-21" title="21">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb259-22" title="22">    <span class="co">// Trying to save a second time!</span></a>
<a class="sourceLine" id="cb259-23" title="23">    <span class="cf">await</span> <span class="va">cat</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb259-24" title="24"></a>
<a class="sourceLine" id="cb259-25" title="25">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Success!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb259-26" title="26">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb259-27" title="27">    <span class="co">// The save *should* succeed!</span></a>
<a class="sourceLine" id="cb259-28" title="28">    <span class="va">console</span>.<span class="at">log</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb259-29" title="29">  <span class="op">}</span></a>
<a class="sourceLine" id="cb259-30" title="30"></a>
<a class="sourceLine" id="cb259-31" title="31">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb259-32" title="32"><span class="op">}</span></a>
<a class="sourceLine" id="cb259-33" title="33"></a>
<a class="sourceLine" id="cb259-34" title="34"><span class="at">main</span>()</a></code></pre></div>
<h2 id="the-notempty-validation">The <code>notEmpty</code> Validation</h2>
<p>Even though we are not allowed to set <code>firstName</code> and <code>specialSkill</code> to <code>NULL</code>, we could still set them to the empty string <code>""</code>:</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb260-1" title="1"><span class="co">// index.js</span></a>
<a class="sourceLine" id="cb260-2" title="2"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb260-3" title="3"></a>
<a class="sourceLine" id="cb260-4" title="4"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb260-5" title="5">  <span class="kw">const</span> cat <span class="op">=</span> <span class="va">Cat</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb260-6" title="6">    <span class="dt">firstName</span><span class="op">:</span> <span class="st">&quot;&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb260-7" title="7">    <span class="dt">specialSkill</span><span class="op">:</span> <span class="st">&quot;&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb260-8" title="8">    <span class="dt">age</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span></a>
<a class="sourceLine" id="cb260-9" title="9">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb260-10" title="10"></a>
<a class="sourceLine" id="cb260-11" title="11">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb260-12" title="12">    <span class="co">// Try to save cat to the database.</span></a>
<a class="sourceLine" id="cb260-13" title="13">    <span class="cf">await</span> <span class="va">cat</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb260-14" title="14"></a>
<a class="sourceLine" id="cb260-15" title="15">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Save success!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb260-16" title="16">    <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cat<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb260-17" title="17">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb260-18" title="18">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Save failed!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb260-19" title="19"></a>
<a class="sourceLine" id="cb260-20" title="20">    <span class="co">// Print list of errors.</span></a>
<a class="sourceLine" id="cb260-21" title="21">    <span class="cf">for</span> (<span class="kw">const</span> validationError <span class="kw">of</span> <span class="va">err</span>.<span class="at">errors</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb260-22" title="22">      <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;*&quot;</span><span class="op">,</span> <span class="va">validationError</span>.<span class="at">message</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb260-23" title="23">    <span class="op">}</span></a>
<a class="sourceLine" id="cb260-24" title="24">  <span class="op">}</span></a>
<a class="sourceLine" id="cb260-25" title="25"></a>
<a class="sourceLine" id="cb260-26" title="26">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb260-27" title="27"><span class="op">}</span></a>
<a class="sourceLine" id="cb260-28" title="28"></a>
<a class="sourceLine" id="cb260-29" title="29"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<pre><code>Executing (default): INSERT INTO &quot;Cats&quot; (&quot;id&quot;,&quot;firstName&quot;,&quot;specialSkill&quot;,&quot;age&quot;,&quot;createdAt&quot;,&quot;updatedAt&quot;) VALUES (DEFAULT,$1,$2,$3,$4,$5) RETURNING *;
Save success!
{
  &quot;id&quot;: 8,
  &quot;firstName&quot;: &quot;&quot;,
  &quot;specialSkill&quot;: &quot;&quot;,
  &quot;age&quot;: 5,
  &quot;updatedAt&quot;: &quot;2020-02-12T21:34:49.250Z&quot;,
  &quot;createdAt&quot;: &quot;2020-02-12T21:34:49.250Z&quot;
}</code></pre>
<p>This is bogus: <code>Cats</code> records should have a non-empty <code>firstName</code> and <code>specialSkill</code>. We will therefore add a second validation for both <code>firstName</code> and <code>specialSkill</code>:</p>
<div class="sourceCode" id="cb262"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb262-1" title="1"><span class="co">// ./models/cat.js</span></a>
<a class="sourceLine" id="cb262-2" title="2"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb262-3" title="3"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb262-4" title="4">  <span class="kw">const</span> Cat <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Cat&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb262-5" title="5">    <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb262-6" title="6">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb262-7" title="7">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb262-8" title="8">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb262-9" title="9">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb262-10" title="10">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;firstName must not be null&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb262-11" title="11">        <span class="op">},</span></a>
<a class="sourceLine" id="cb262-12" title="12">        <span class="dt">notEmpty</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb262-13" title="13">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;firstName must not be empty&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb262-14" title="14">        <span class="op">},</span></a>
<a class="sourceLine" id="cb262-15" title="15">      <span class="op">},</span></a>
<a class="sourceLine" id="cb262-16" title="16">    <span class="op">},</span></a>
<a class="sourceLine" id="cb262-17" title="17">    <span class="dt">specialSkill</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb262-18" title="18">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb262-19" title="19">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb262-20" title="20">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb262-21" title="21">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb262-22" title="22">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;specialSkill must not be null&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb262-23" title="23">        <span class="op">},</span></a>
<a class="sourceLine" id="cb262-24" title="24">        <span class="dt">notEmpty</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb262-25" title="25">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;specialSkill must not be empty&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb262-26" title="26">        <span class="op">},</span></a>
<a class="sourceLine" id="cb262-27" title="27">      <span class="op">},</span></a>
<a class="sourceLine" id="cb262-28" title="28">    <span class="op">},</span></a>
<a class="sourceLine" id="cb262-29" title="29">    <span class="co">// ...</span></a>
<a class="sourceLine" id="cb262-30" title="30">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb262-31" title="31">  <span class="va">Cat</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb262-32" title="32">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb262-33" title="33">  <span class="op">};</span></a>
<a class="sourceLine" id="cb262-34" title="34">  <span class="cf">return</span> Cat<span class="op">;</span></a>
<a class="sourceLine" id="cb262-35" title="35"><span class="op">};</span></a></code></pre></div>
<p>When we run the same <code>index.js</code> that tries to save the <code>Cats</code> record with the empty <code>firstName</code> and <code>specialSkill</code>, we now print:</p>
<pre><code>Save failed!
* firstName must not be empty
* specialSkill must not be empty</code></pre>
<p>Excellent! Weâ€™ve added the new validation by adding a <code>notEmpty</code> key to the <code>validate</code> POJO. Just like with <code>notNull</code>, we specify a message to print.</p>
<p>This is the typical story: we add new validations by adding new key/value pairs to the <code>validate</code> POJO. Sequelize provides many different kinds of validations for us, but we configure all of them in the same general manner.</p>
<h2 id="forbidding-long-string-values">Forbidding Long String Values</h2>
<p>We donâ€™t want our cats to have names that are too long. We add a <code>len</code> validation like so:</p>
<div class="sourceCode" id="cb264"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb264-1" title="1"><span class="co">// ./models/cat.js</span></a>
<a class="sourceLine" id="cb264-2" title="2"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb264-3" title="3"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb264-4" title="4">  <span class="kw">const</span> Cat <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Cat&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb264-5" title="5">    <span class="dt">firstName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb264-6" title="6">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb264-7" title="7">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb264-8" title="8">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb264-9" title="9">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb264-10" title="10">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;firstName must not be null&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb264-11" title="11">        <span class="op">},</span></a>
<a class="sourceLine" id="cb264-12" title="12">        <span class="dt">notEmpty</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb264-13" title="13">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;firstName must not be empty&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb264-14" title="14">        <span class="op">},</span></a>
<a class="sourceLine" id="cb264-15" title="15">        <span class="dt">len</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb264-16" title="16">          <span class="dt">args</span><span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">8</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb264-17" title="17">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;firstName must not be more than eight letters long&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb264-18" title="18">        <span class="op">},</span></a>
<a class="sourceLine" id="cb264-19" title="19">      <span class="op">},</span></a>
<a class="sourceLine" id="cb264-20" title="20">    <span class="op">},</span></a>
<a class="sourceLine" id="cb264-21" title="21">    <span class="co">// ...</span></a>
<a class="sourceLine" id="cb264-22" title="22">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb264-23" title="23">  <span class="va">Cat</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb264-24" title="24">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb264-25" title="25">  <span class="op">};</span></a>
<a class="sourceLine" id="cb264-26" title="26">  <span class="cf">return</span> Cat<span class="op">;</span></a>
<a class="sourceLine" id="cb264-27" title="27"><span class="op">};</span></a></code></pre></div>
<p>If we try to run:</p>
<div class="sourceCode" id="cb265"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb265-1" title="1"><span class="co">// index.js</span></a>
<a class="sourceLine" id="cb265-2" title="2"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> Cat <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb265-3" title="3"></a>
<a class="sourceLine" id="cb265-4" title="4"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb265-5" title="5">  <span class="kw">const</span> cat <span class="op">=</span> <span class="va">Cat</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb265-6" title="6">    <span class="dt">firstName</span><span class="op">:</span> <span class="st">&quot;Markov The Magnificent&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb265-7" title="7">    <span class="dt">specialSkill</span><span class="op">:</span> <span class="st">&quot;sleeping&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb265-8" title="8">    <span class="dt">age</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span></a>
<a class="sourceLine" id="cb265-9" title="9">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb265-10" title="10"></a>
<a class="sourceLine" id="cb265-11" title="11">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb265-12" title="12">    <span class="co">// Try to save cat to the database.</span></a>
<a class="sourceLine" id="cb265-13" title="13">    <span class="cf">await</span> <span class="va">cat</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb265-14" title="14"></a>
<a class="sourceLine" id="cb265-15" title="15">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Save success!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb265-16" title="16">    <span class="va">console</span>.<span class="at">log</span>(<span class="va">JSON</span>.<span class="at">stringify</span>(cat<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb265-17" title="17">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb265-18" title="18">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Save failed!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb265-19" title="19"></a>
<a class="sourceLine" id="cb265-20" title="20">    <span class="co">// Print list of errors.</span></a>
<a class="sourceLine" id="cb265-21" title="21">    <span class="cf">for</span> (<span class="kw">const</span> validationError <span class="kw">of</span> <span class="va">err</span>.<span class="at">errors</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb265-22" title="22">      <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;*&quot;</span><span class="op">,</span> <span class="va">validationError</span>.<span class="at">message</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb265-23" title="23">    <span class="op">}</span></a>
<a class="sourceLine" id="cb265-24" title="24">  <span class="op">}</span></a>
<a class="sourceLine" id="cb265-25" title="25"></a>
<a class="sourceLine" id="cb265-26" title="26">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb265-27" title="27"><span class="op">}</span></a>
<a class="sourceLine" id="cb265-28" title="28"></a>
<a class="sourceLine" id="cb265-29" title="29"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>We will be told:</p>
<pre><code>Save failed!
* firstName must not be more than eight letters long</code></pre>
<p>The <code>len</code> validation gets a <code>msg</code> attribute as usual. We also configure <code>args: [0, 8]</code>. These are the "arguments" to the <code>len</code> validation. We are telling Sequelize to trigger a validation error if the <code>firstName</code> property has a length less than zero (impossible) or greater than eight.</p>
<p>Note that even though the <code>len</code> validation is not triggered for a length of zero, the <code>notEmpty</code> validation still will be.</p>
<p>If desired, we could use the <code>len</code> validation to set a true minimum length for a string. If we wanted a minimum length of two letters, we would just change <code>args: [2, 8]</code>. (We ought also update the <code>msg</code> appropriately.)</p>
<h2 id="validating-that-a-numeric-value-is-within-a-specified-range">Validating That A Numeric Value Is Within A Specified Range</h2>
<p>A <code>Cat</code> should never have a negative age. Perhaps, also, a <code>Cat</code> should have a theoretical maximum age of 99 years. We can add validations to enforce these requirements:</p>
<div class="sourceCode" id="cb267"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb267-1" title="1"><span class="co">// ./models/cat.js</span></a>
<a class="sourceLine" id="cb267-2" title="2"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb267-3" title="3"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb267-4" title="4">  <span class="kw">const</span> Cat <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Cat&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb267-5" title="5">    <span class="co">// ...</span></a>
<a class="sourceLine" id="cb267-6" title="6">    <span class="dt">age</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb267-7" title="7">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb267-8" title="8">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb267-9" title="9">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb267-10" title="10">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb267-11" title="11">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;age must not be null&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb267-12" title="12">        <span class="op">},</span></a>
<a class="sourceLine" id="cb267-13" title="13">        <span class="dt">min</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb267-14" title="14">          <span class="dt">args</span><span class="op">:</span> [<span class="dv">0</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb267-15" title="15">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;age must not be less than zero&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb267-16" title="16">        <span class="op">},</span></a>
<a class="sourceLine" id="cb267-17" title="17">        <span class="dt">max</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb267-18" title="18">          <span class="dt">args</span><span class="op">:</span> [<span class="dv">99</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb267-19" title="19">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;age must not be greater than 99&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb267-20" title="20">        <span class="op">},</span></a>
<a class="sourceLine" id="cb267-21" title="21">      <span class="op">},</span></a>
<a class="sourceLine" id="cb267-22" title="22">    <span class="op">},</span></a>
<a class="sourceLine" id="cb267-23" title="23">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb267-24" title="24">  <span class="va">Cat</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb267-25" title="25">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb267-26" title="26">  <span class="op">};</span></a>
<a class="sourceLine" id="cb267-27" title="27">  <span class="cf">return</span> Cat<span class="op">;</span></a>
<a class="sourceLine" id="cb267-28" title="28"><span class="op">};</span></a></code></pre></div>
<p>You can see that the <code>min</code> and <code>max</code> validations are configured in the same sort of way that the <code>len</code> validation is.</p>
<p>If we try to save a <code>Cat</code> with an <code>age</code> of <code>-1</code>, we are printed:</p>
<pre><code>Save failed!
* age must not be less than zero</code></pre>
<p>Likewise, if we try to save a <code>Cat</code> with an <code>age</code> of <code>123</code> we are printed:</p>
<pre><code>Save failed!
* age must not be greater than 99</code></pre>
<p><em>(Note: Iâ€™ve stopped repeating our <code>index.js</code> file, since there are only trivial modifications to a <code>Cat</code>â€™s attributes each time.)</em></p>
<h2 id="validating-that-an-attribute-is-among-a-finite-set-of-values">Validating That An Attribute Is Among A Finite Set Of Values</h2>
<p>Letâ€™s say that a <code>Cat</code>â€™s <code>specialSkill</code> should be restricted to a pre-defined list of <code>["jumping", "sleeping", "purring"]</code>. That is: a <code>Cat</code> should not be allowed to have just any <code>specialSkill</code>. The <code>specialSkill</code> must be on the list.</p>
<p>We can enforce this requirement like so:</p>
<div class="sourceCode" id="cb270"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb270-1" title="1"><span class="co">// ./models/cat.js</span></a>
<a class="sourceLine" id="cb270-2" title="2"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb270-3" title="3"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb270-4" title="4">  <span class="kw">const</span> Cat <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Cat&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb270-5" title="5">    <span class="co">// ...</span></a>
<a class="sourceLine" id="cb270-6" title="6">    <span class="dt">specialSkill</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb270-7" title="7">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb270-8" title="8">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb270-9" title="9">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb270-10" title="10">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb270-11" title="11">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;specialSkill must not be null&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb270-12" title="12">        <span class="op">},</span></a>
<a class="sourceLine" id="cb270-13" title="13">        <span class="dt">notEmpty</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb270-14" title="14">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;specialSkill must not be empty&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb270-15" title="15">        <span class="op">},</span></a>
<a class="sourceLine" id="cb270-16" title="16">        <span class="dt">isIn</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb270-17" title="17">          <span class="dt">args</span><span class="op">:</span> [[<span class="st">&quot;jumping&quot;</span><span class="op">,</span> <span class="st">&quot;sleeping&quot;</span><span class="op">,</span> <span class="st">&quot;purring&quot;</span>]]<span class="op">,</span></a>
<a class="sourceLine" id="cb270-18" title="18">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;specialSkill must be either jumping, sleeping, or purring&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb270-19" title="19">        <span class="op">},</span></a>
<a class="sourceLine" id="cb270-20" title="20">      <span class="op">},</span></a>
<a class="sourceLine" id="cb270-21" title="21">    <span class="op">},</span></a>
<a class="sourceLine" id="cb270-22" title="22">    <span class="co">// ...</span></a>
<a class="sourceLine" id="cb270-23" title="23">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb270-24" title="24">  <span class="va">Cat</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb270-25" title="25">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb270-26" title="26">  <span class="op">};</span></a>
<a class="sourceLine" id="cb270-27" title="27">  <span class="cf">return</span> Cat<span class="op">;</span></a>
<a class="sourceLine" id="cb270-28" title="28"><span class="op">};</span></a></code></pre></div>
<p>Notice how we <strong>doubly-nest</strong> the list of special skills (<code>["jumping, "sleeping", "purring"]</code>) when specifying the <code>args</code> for the <code>isIn</code> validation. This is because we want to pass <strong>one</strong> argument: an array of three possible special skills.</p>
<p>Now when we try to save a <code>Cat</code> with <code>specialSkill</code> set to <code>"pearl diving"</code>, our code will print:</p>
<pre><code>Save failed!
* specialSkill must be either jumping, sleeping, or purring</code></pre>
<h2 id="conclusion-4">Conclusion</h2>
<p>There is a very large variety of validations that are provided by Sequelize. You can find many more in the Sequelize <a href="https://sequelize.org/v5/manual/models-definition.html#validations">documentation for validations</a>.</p>
<p>Having completed this reading, you now know how to:</p>
<ol type="1">
<li>Validate that an attribute is not set to <code>NULL</code>.</li>
<li>Validate that a string attribute is not set to the empty string <code>""</code>.</li>
<li>Validate that a string attribute is not too long (has too many characters).</li>
<li>Validate that a numeric attribute meets minimum or maximum thresholds.</li>
<li>Validate that an attribute is within a limited set of options.</li>
</ol>
<hr />
<h1 id="transactions-with-sequelize">Transactions With Sequelize</h1>
<p>In this reading, we will learn about database <em>transactions</em> and how we use them via Sequelize. We will learn how to group multiple update operations into a single atomic, indivisible unit.</p>
<p>At the end of the reading, you should know:</p>
<ol type="1">
<li>How to write code that is resilient to SQL operation failures,</li>
<li>How to group multiple operations into a database transaction using Sequelize (the <code>sequelize.transaction</code> method),</li>
<li>How to prevent "race conditions" using transactions.</li>
</ol>
<h2 id="the-problem-database-updates-can-fail">The Problem: Database Updates Can Fail</h2>
<p>Imagine a scenario with a banking database. Markov wants to transfer $7,500 to Curie. To perform the transfer, we will perform two database update operations:</p>
<ol type="1">
<li>Reduce Markovâ€™s account balance by $7,500,</li>
<li>Increase Curieâ€™s account balance by $7,500.</li>
</ol>
<p>When transferring money, itâ€™s very important that <em>both</em> operations be performed. If we reduce Markovâ€™s balance but fail to increase Curieâ€™s balance, the bank effectively steals money from Markov. If we increase Curieâ€™s balance without reducing Markovâ€™s balance, the bank effectively gives away free money to Curie. Neither is acceptable.</p>
<p>We must keep in mind that any attempt to perform a database update can sometimes <em>fail</em>. It can fail for a number of reasons:</p>
<ol type="1">
<li>The command is sent, but the database has previously been shut down by the database administrator. Because the database is not running, the database is not listening for our update, wonâ€™t receive it, and thus wonâ€™t process it.</li>
<li>A bug in the database or operating system software has caused the database or operating system to crash. Again, the database is not running, so it can neither receive nor process our update.</li>
<li>Power has been lost to the machine running the database. The database is not running.</li>
<li>The internet connection that connects us to the database machine is disrupted. The database may be running and listening for SQL requests to process. However, our update request cannot get through to the database machine. Because the database cannot receive our request, the database cannot process it.</li>
<li>The update asks the database to violate a pre-defined constraint. For example: the database may have a constraint that an account balance must never be less than zero. Any update that asks the database to reduce an account balance to less than zero will be rejected and therefore fail.</li>
</ol>
<p>Only this last scenario is "our fault." The fact is that database updates can fail <strong>through no fault of our own</strong>. With regard to our example: our first SQL request to reduce Markovâ€™s account balance may succeed, but the database may then crash before we have sent the request to increase Curieâ€™s balance. Through no fault of our own, the bank has stolen money from Markov without giving it to Curie.</p>
<p>How can we write code that avoids this fundamental problem?</p>
<h2 id="the-solution-database-transactions">The Solution: Database Transactions</h2>
<p>One way to solve the problem is to "group" or "pair" the two update operations somehow. We want to tell the database "Reduce Markovâ€™s balance AND increment Curieâ€™s balance." We want to tell the database: "If for any reason you cannot perform <strong>both</strong> operations, make sure not to perform <strong>either</strong>." We want to tell the database: "If you crash after reducing Markovâ€™s balance, make sure to either (a) increase Curieâ€™s balance when you restart, or (b) undo the increase to Markovâ€™s balance when you restart."</p>
<p>We want to ask the database to treat the pair of updates as one <em>atomic</em> (meaning <strong>indivisible</strong>) unit. SQL lets you do this using a feature called <em>transactions</em>.</p>
<p>Youâ€™ve previously seen how to use SQL transactions:</p>
<div class="sourceCode" id="cb272"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb272-1" title="1"><span class="kw">START</span> <span class="kw">TRANSACTION</span>;</a>
<a class="sourceLine" id="cb272-2" title="2"><span class="co">-- Reduce Markov&#39;s balance by $7500</span></a>
<a class="sourceLine" id="cb272-3" title="3"><span class="kw">UPDATE</span> <span class="ot">&quot;BankAccounts&quot;</span> <span class="kw">SET</span> balance <span class="op">=</span> balance <span class="op">-</span> <span class="dv">7500</span> <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb272-4" title="4"><span class="co">-- Increment Curie&#39;s balance by $7500</span></a>
<a class="sourceLine" id="cb272-5" title="5"><span class="kw">UPDATE</span> <span class="ot">&quot;BankAccounts&quot;</span> <span class="kw">SET</span> balance <span class="op">=</span> balance <span class="op">+</span> <span class="dv">7500</span> <span class="kw">WHERE</span> <span class="kw">id</span> <span class="op">=</span> <span class="dv">2</span>;</a>
<a class="sourceLine" id="cb272-6" title="6"><span class="kw">COMMIT</span> <span class="kw">TRANSACTION</span>;</a></code></pre></div>
<p>SQL guarantees to you that everything between <code>START TRANSACTION</code> and <code>COMMIT TRANSACTION</code> will be processed <em>atomically</em>. If any update operation fails, none of the updates will be performed. The transaction is "all-or-nothing."</p>
<p>In this reading you will learn how to use SQL transactions with the Sequelize ORM.</p>
<h2 id="the-bankaccounts-schema">The <code>BankAccounts</code> Schema</h2>
<p>For our example in this reading, I will use a single table with two accounts.</p>
<pre><code>catsdb=&gt; SELECT * FROM &quot;BankAccounts&quot;;
 id | clientName | balance | ...
----+------------+---------+-----
  1 | Markov     |    5000 | ...
  2 | Curie      |   10000 | ...
(2 rows)</code></pre>
<p>I have generated a Sequelize model corresponding to the <code>BankAccounts</code> table:</p>
<div class="sourceCode" id="cb274"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb274-1" title="1"><span class="co">// ./models/bank_account.js</span></a>
<a class="sourceLine" id="cb274-2" title="2"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb274-3" title="3"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb274-4" title="4">  <span class="co">// Define BankAccount model.</span></a>
<a class="sourceLine" id="cb274-5" title="5">  <span class="kw">const</span> BankAccount <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;BankAccount&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb274-6" title="6">    <span class="co">// Define clientName attribute.</span></a>
<a class="sourceLine" id="cb274-7" title="7">    <span class="dt">clientName</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb274-8" title="8">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb274-9" title="9">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb274-10" title="10">      <span class="co">// Define validations on clientName.</span></a>
<a class="sourceLine" id="cb274-11" title="11">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb274-12" title="12">        <span class="co">// clientName must not be null.</span></a>
<a class="sourceLine" id="cb274-13" title="13">        <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb274-14" title="14">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;clientName must not be NULL&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb274-15" title="15">        <span class="op">},</span></a>
<a class="sourceLine" id="cb274-16" title="16">        <span class="co">// clientName must not be empty.</span></a>
<a class="sourceLine" id="cb274-17" title="17">        <span class="dt">notEmpty</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb274-18" title="18">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;clientName must not be empty&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb274-19" title="19">        <span class="op">},</span></a>
<a class="sourceLine" id="cb274-20" title="20">      <span class="op">},</span></a>
<a class="sourceLine" id="cb274-21" title="21">    <span class="op">},</span></a>
<a class="sourceLine" id="cb274-22" title="22"></a>
<a class="sourceLine" id="cb274-23" title="23">    <span class="co">// Define balance attribute.</span></a>
<a class="sourceLine" id="cb274-24" title="24">    <span class="dt">balance</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb274-25" title="25">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb274-26" title="26">      <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb274-27" title="27">      <span class="co">// Define validations on balance.</span></a>
<a class="sourceLine" id="cb274-28" title="28">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb274-29" title="29">        <span class="co">// balance must not be less than zero.</span></a>
<a class="sourceLine" id="cb274-30" title="30">        <span class="dt">min</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb274-31" title="31">          <span class="dt">args</span><span class="op">:</span> [<span class="dv">0</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb274-32" title="32">          <span class="dt">msg</span><span class="op">:</span> <span class="st">&quot;balance must not be less than zero&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb274-33" title="33">        <span class="op">},</span></a>
<a class="sourceLine" id="cb274-34" title="34">      <span class="op">},</span></a>
<a class="sourceLine" id="cb274-35" title="35">    <span class="op">},</span></a>
<a class="sourceLine" id="cb274-36" title="36">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb274-37" title="37"></a>
<a class="sourceLine" id="cb274-38" title="38">  <span class="cf">return</span> BankAccount<span class="op">;</span></a>
<a class="sourceLine" id="cb274-39" title="39"><span class="op">};</span></a></code></pre></div>
<p>Notice that the <code>min</code> validation on <code>balance</code> will not allow us to save an account balance that is below zero.</p>
<h2 id="example-an-update-fails-because-of-validation-failure">Example: An Update Fails Because Of Validation Failure</h2>
<p>Letâ€™s imagine that Markov wants to transfer $7,500 to Curie. Unfortunately, Markov has only $5,000 in his account! Decrementing Markovâ€™s account balance by $7,500 would put it in the negative, which our validation will not allow. Thus the transfer must fail.</p>
<p>Imagine that Markov is unaware that his account balance cannot cover the transfer. He tries to perform the transfer anyway:</p>
<div class="sourceCode" id="cb275"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb275-1" title="1"><span class="co">// ./index.js</span></a>
<a class="sourceLine" id="cb275-2" title="2"><span class="kw">const</span> <span class="op">{</span> sequelize <span class="op">,</span> BankAccount <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb275-3" title="3"></a>
<a class="sourceLine" id="cb275-4" title="4"><span class="co">// This code will try to transfer $7,500 from Markov to Curie.</span></a>
<a class="sourceLine" id="cb275-5" title="5"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb275-6" title="6">  <span class="co">// Fetch Markov and Curie&#39;s accounts.</span></a>
<a class="sourceLine" id="cb275-7" title="7">  <span class="kw">const</span> markovAccount <span class="op">=</span> <span class="cf">await</span> <span class="va">BankAccount</span>.<span class="at">findByPk</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb275-8" title="8">  <span class="kw">const</span> curieAccount <span class="op">=</span> <span class="cf">await</span> <span class="va">BankAccount</span>.<span class="at">findByPk</span>(<span class="dv">2</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb275-9" title="9"></a>
<a class="sourceLine" id="cb275-10" title="10">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb275-11" title="11">    <span class="co">// Increment Curie&#39;s balance by $7,500.</span></a>
<a class="sourceLine" id="cb275-12" title="12">    <span class="va">curieAccount</span>.<span class="at">balance</span> <span class="op">+=</span> <span class="dv">7500</span><span class="op">;</span></a>
<a class="sourceLine" id="cb275-13" title="13">    <span class="cf">await</span> <span class="va">curieAccount</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb275-14" title="14"></a>
<a class="sourceLine" id="cb275-15" title="15">    <span class="co">// Decrement Markov&#39;s balance by $7,500.</span></a>
<a class="sourceLine" id="cb275-16" title="16">    <span class="va">markovAccount</span>.<span class="at">balance</span> <span class="op">-=</span> <span class="dv">7500</span><span class="op">;</span></a>
<a class="sourceLine" id="cb275-17" title="17">    <span class="cf">await</span> <span class="va">markovAccount</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb275-18" title="18">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb275-19" title="19">    <span class="co">// Report if anything goes wrong.</span></a>
<a class="sourceLine" id="cb275-20" title="20">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Error!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb275-21" title="21"></a>
<a class="sourceLine" id="cb275-22" title="22">    <span class="cf">for</span> (<span class="kw">const</span> e <span class="kw">of</span> <span class="va">err</span>.<span class="at">errors</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb275-23" title="23">      <span class="va">console</span>.<span class="at">log</span>(</a>
<a class="sourceLine" id="cb275-24" title="24">        <span class="vs">`</span><span class="sc">${</span><span class="va">e</span>.<span class="va">instance</span>.<span class="at">clientName</span><span class="sc">}</span><span class="vs">: </span><span class="sc">${</span><span class="va">e</span>.<span class="at">message</span><span class="sc">}</span><span class="vs">`</span></a>
<a class="sourceLine" id="cb275-25" title="25">      )<span class="op">;</span></a>
<a class="sourceLine" id="cb275-26" title="26">    <span class="op">}</span></a>
<a class="sourceLine" id="cb275-27" title="27">  <span class="op">}</span></a>
<a class="sourceLine" id="cb275-28" title="28"></a>
<a class="sourceLine" id="cb275-29" title="29">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb275-30" title="30"><span class="op">}</span></a>
<a class="sourceLine" id="cb275-31" title="31"></a>
<a class="sourceLine" id="cb275-32" title="32"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>Running this code prints the following:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;clientName&quot;, &quot;balance&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;BankAccounts&quot; AS &quot;BankAccount&quot; WHERE &quot;BankAccount&quot;.&quot;id&quot; = 1;
Executing (default): SELECT &quot;id&quot;, &quot;clientName&quot;, &quot;balance&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;BankAccounts&quot; AS &quot;BankAccount&quot; WHERE &quot;BankAccount&quot;.&quot;id&quot; = 2;
Executing (default): UPDATE &quot;BankAccounts&quot; SET &quot;balance&quot;=$1,&quot;updatedAt&quot;=$2 WHERE &quot;id&quot; = $3
Error!
Markov: balance must not be less than zero</code></pre>
<p>Everything starts out fine. We fetch Markov and Curieâ€™s accounts. We increase Curieâ€™s balance. But then we hit a snag: when we call <code>markovAccount.save()</code>, Sequelize detects that we are trying to set Markovâ€™s balance below zero. Sequelize therefore <strong>does not</strong> send a SQL request to update Markovâ€™s account balance. Instead, <code>markovAccount.save()</code> throws an exception. We print the error: Markovâ€™s balance must not be less than zero.</p>
<p>We thus avoid saving a negative balance for Markov. But other damage has already been done. If we now check account balances, we will see:</p>
<pre><code>catsdb=&gt; SELECT * FROM &quot;BankAccounts&quot;;
 id | clientName | balance | ...
----+------------+---------+-----
  1 | Markov     |    5000 | ...
  2 | Curie      |   17500 | ...
(2 rows)</code></pre>
<p>The bank has given free money to Curie! We should have "rolledback" the increase of Curieâ€™s balance. We will learn how to do that!</p>
<h2 id="incorrect-solutions">Incorrect Solutions</h2>
<p>One may suggest a fix: make sure to decrement Markovâ€™s account balance before incrementing Curieâ€™s balance! If Markovâ€™s balance is insufficient, we can stop the transfer before giving Curie any money.</p>
<p>We <em>could</em> swap the order of the updates, and it would indeed fix this specific problem. But imagine if Markov tries to transfer $2,500 (an amount he can afford). We first decrement Markovâ€™s account balance and then â€“ the operating system crashes before the second update can be submitted. Curieâ€™s balance is not incremented. The bank has stolen Markovâ€™s money!</p>
<p>The problem is fundamental: no matter what order we perform the two updates in, the database can always fail <em>after</em> processing the first, but <em>before</em> processing the second. For our code to be resilient to unavoidable failures, there is no other choice but to use a database transaction.</p>
<h2 id="using-a-database-transaction-with-sequelize">Using A Database Transaction With Sequelize</h2>
<p>Letâ€™s return to our previous example of trying to transfer $7,500 from Markov to Curie. Specifically, we will rewrite this key part:</p>
<div class="sourceCode" id="cb278"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb278-1" title="1"><span class="co">// Increment Curie&#39;s balance by $7,500.</span></a>
<a class="sourceLine" id="cb278-2" title="2"><span class="va">curieAccount</span>.<span class="at">balance</span> <span class="op">+=</span> <span class="dv">7500</span><span class="op">;</span></a>
<a class="sourceLine" id="cb278-3" title="3"><span class="cf">await</span> <span class="va">curieAccount</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb278-4" title="4"></a>
<a class="sourceLine" id="cb278-5" title="5"><span class="co">// Decrement Markov&#39;s balance by $7,500.</span></a>
<a class="sourceLine" id="cb278-6" title="6"><span class="va">markovAccount</span>.<span class="at">balance</span> <span class="op">-=</span> <span class="dv">7500</span><span class="op">;</span></a>
<a class="sourceLine" id="cb278-7" title="7"><span class="cf">await</span> <span class="va">markovAccount</span>.<span class="at">save</span>()<span class="op">;</span></a></code></pre></div>
<p>To ask Sequelize to perform the two updates in a SQL database transaction, we use the <code>sequelize.transaction</code> method. We will write this like so, instead:</p>
<div class="sourceCode" id="cb279"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb279-1" title="1"><span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">transaction</span>(<span class="kw">async</span> (tx) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb279-2" title="2">  <span class="co">// Increment Curie&#39;s balance by $7,500.</span></a>
<a class="sourceLine" id="cb279-3" title="3">  <span class="va">curieAccount</span>.<span class="at">balance</span> <span class="op">+=</span> <span class="dv">7500</span><span class="op">;</span></a>
<a class="sourceLine" id="cb279-4" title="4">  <span class="cf">await</span> <span class="va">curieAccount</span>.<span class="at">save</span>(<span class="op">{</span> <span class="dt">transaction</span><span class="op">:</span> tx <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb279-5" title="5"></a>
<a class="sourceLine" id="cb279-6" title="6">  <span class="co">// Decrement Markov&#39;s balance by $7,500.</span></a>
<a class="sourceLine" id="cb279-7" title="7">  <span class="va">markovAccount</span>.<span class="at">balance</span> <span class="op">-=</span> <span class="dv">7500</span><span class="op">;</span></a>
<a class="sourceLine" id="cb279-8" title="8">  <span class="cf">await</span> <span class="va">markovAccount</span>.<span class="at">save</span>(<span class="op">{</span> <span class="dt">transaction</span><span class="op">:</span> tx <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb279-9" title="9"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Letâ€™s go through the transaction code and explain each part:</p>
<div class="sourceCode" id="cb280"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb280-1" title="1"><span class="co">// Start a transaction. Queries run inside the callback can be part of</span></a>
<a class="sourceLine" id="cb280-2" title="2"><span class="co">// the transaction.</span></a>
<a class="sourceLine" id="cb280-3" title="3"><span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">transaction</span>(<span class="kw">async</span> (tx) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb280-4" title="4">  <span class="co">// Increment Curie&#39;s balance by $7,500.</span></a>
<a class="sourceLine" id="cb280-5" title="5">  <span class="va">curieAccount</span>.<span class="at">balance</span> <span class="op">+=</span> <span class="dv">7500</span><span class="op">;</span></a>
<a class="sourceLine" id="cb280-6" title="6">  <span class="co">// Pass the `tx` transaction object so that Sequelize knows to</span></a>
<a class="sourceLine" id="cb280-7" title="7">  <span class="co">// update Curie&#39;s account as part of this transaction (rather than</span></a>
<a class="sourceLine" id="cb280-8" title="8">  <span class="co">// &quot;on its own&quot; per usual).</span></a>
<a class="sourceLine" id="cb280-9" title="9">  <span class="cf">await</span> <span class="va">curieAccount</span>.<span class="at">save</span>(<span class="op">{</span> <span class="dt">transaction</span><span class="op">:</span> tx <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb280-10" title="10"></a>
<a class="sourceLine" id="cb280-11" title="11">  <span class="co">// Decrement Markov&#39;s balance by $7,500.</span></a>
<a class="sourceLine" id="cb280-12" title="12">  <span class="va">markovAccount</span>.<span class="at">balance</span> <span class="op">-=</span> <span class="dv">7500</span><span class="op">;</span></a>
<a class="sourceLine" id="cb280-13" title="13">  <span class="co">// Again, pass the `tx` transaction object. Thus both updates are part</span></a>
<a class="sourceLine" id="cb280-14" title="14">  <span class="co">// of the same transaction.</span></a>
<a class="sourceLine" id="cb280-15" title="15">  <span class="cf">await</span> <span class="va">markovAccount</span>.<span class="at">save</span>(<span class="op">{</span> <span class="dt">transaction</span><span class="op">:</span> tx <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb280-16" title="16"></a>
<a class="sourceLine" id="cb280-17" title="17">  <span class="co">// If no exceptions have been thrown, `sequelize.transaction` will</span></a>
<a class="sourceLine" id="cb280-18" title="18">  <span class="co">// `COMMIT` the transaction after the end of the callback.</span></a>
<a class="sourceLine" id="cb280-19" title="19">  <span class="co">//</span></a>
<a class="sourceLine" id="cb280-20" title="20">  <span class="co">// If any error gets thrown, `sequelize.transaction` will abort</span></a>
<a class="sourceLine" id="cb280-21" title="21">  <span class="co">// the transaction by issuing a `ROLLBACK`. This will cancel all</span></a>
<a class="sourceLine" id="cb280-22" title="22">  <span class="co">// updates.</span></a>
<a class="sourceLine" id="cb280-23" title="23"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>Letâ€™s put the transaction code back into our original program:</p>
<div class="sourceCode" id="cb281"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb281-1" title="1"><span class="co">// ./index.js</span></a>
<a class="sourceLine" id="cb281-2" title="2"><span class="kw">const</span> <span class="op">{</span> sequelize<span class="op">,</span> BankAccount <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;./models&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb281-3" title="3"></a>
<a class="sourceLine" id="cb281-4" title="4"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb281-5" title="5">  <span class="co">// Fetch Markov and Curie&#39;s accounts.</span></a>
<a class="sourceLine" id="cb281-6" title="6">  <span class="kw">const</span> markovAccount <span class="op">=</span> <span class="cf">await</span> <span class="va">BankAccount</span>.<span class="at">findByPk</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb281-7" title="7">  <span class="kw">const</span> curieAccount <span class="op">=</span> <span class="cf">await</span> <span class="va">BankAccount</span>.<span class="at">findByPk</span>(<span class="dv">2</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb281-8" title="8"></a>
<a class="sourceLine" id="cb281-9" title="9">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb281-10" title="10">    <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">transaction</span>(<span class="kw">async</span> (tx) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb281-11" title="11">      <span class="co">// Increment Curie&#39;s balance by $7,500.</span></a>
<a class="sourceLine" id="cb281-12" title="12">      <span class="va">curieAccount</span>.<span class="at">balance</span> <span class="op">+=</span> <span class="dv">7500</span><span class="op">;</span></a>
<a class="sourceLine" id="cb281-13" title="13">      <span class="cf">await</span> <span class="va">curieAccount</span>.<span class="at">save</span>(<span class="op">{</span> <span class="dt">transaction</span><span class="op">:</span> tx <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb281-14" title="14"></a>
<a class="sourceLine" id="cb281-15" title="15">      <span class="co">// Decrement Markov&#39;s balance by $7,500.</span></a>
<a class="sourceLine" id="cb281-16" title="16">      <span class="va">markovAccount</span>.<span class="at">balance</span> <span class="op">-=</span> <span class="dv">7500</span><span class="op">;</span></a>
<a class="sourceLine" id="cb281-17" title="17">      <span class="cf">await</span> <span class="va">markovAccount</span>.<span class="at">save</span>(<span class="op">{</span> <span class="dt">transaction</span><span class="op">:</span> tx <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb281-18" title="18">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb281-19" title="19">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb281-20" title="20">    <span class="co">// Report if anything goes wrong.</span></a>
<a class="sourceLine" id="cb281-21" title="21">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Error!&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb281-22" title="22"></a>
<a class="sourceLine" id="cb281-23" title="23">    <span class="cf">for</span> (<span class="kw">const</span> e <span class="kw">of</span> <span class="va">err</span>.<span class="at">errors</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb281-24" title="24">      <span class="va">console</span>.<span class="at">log</span>(</a>
<a class="sourceLine" id="cb281-25" title="25">        <span class="vs">`</span><span class="sc">${</span><span class="va">e</span>.<span class="va">instance</span>.<span class="at">clientName</span><span class="sc">}</span><span class="vs">: </span><span class="sc">${</span><span class="va">e</span>.<span class="at">message</span><span class="sc">}</span><span class="vs">`</span></a>
<a class="sourceLine" id="cb281-26" title="26">      )<span class="op">;</span></a>
<a class="sourceLine" id="cb281-27" title="27">    <span class="op">}</span></a>
<a class="sourceLine" id="cb281-28" title="28">  <span class="op">}</span></a>
<a class="sourceLine" id="cb281-29" title="29"></a>
<a class="sourceLine" id="cb281-30" title="30">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb281-31" title="31"><span class="op">}</span></a>
<a class="sourceLine" id="cb281-32" title="32"></a>
<a class="sourceLine" id="cb281-33" title="33"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>Running this code prints:</p>
<pre><code>Executing (default): SELECT &quot;id&quot;, &quot;clientName&quot;, &quot;balance&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;BankAccounts&quot; AS &quot;BankAccount&quot; WHERE &quot;BankAccount&quot;.&quot;id&quot; = 1;
Executing (default): SELECT &quot;id&quot;, &quot;clientName&quot;, &quot;balance&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;BankAccounts&quot; AS &quot;BankAccount&quot; WHERE &quot;BankAccount&quot;.&quot;id&quot; = 2;
Executing (208b3951-9ab9-489b-97f0-afb49aaff807): START TRANSACTION;
Executing (208b3951-9ab9-489b-97f0-afb49aaff807): UPDATE &quot;BankAccounts&quot; SET &quot;balance&quot;=$1,&quot;updatedAt&quot;=$2 WHERE &quot;id&quot; = $3
Executing (208b3951-9ab9-489b-97f0-afb49aaff807): ROLLBACK;
Error!
Markov: balance must not be less than zero</code></pre>
<p>Letâ€™s review what happened. We again start by fetching both <code>BankAccount</code>s. We next <code>START TRANSACTION</code>. We issue the update to Curieâ€™s account.</p>
<p>Then Sequelize detects the validation failure when trying to run <code>markovAccount.save({ transaction: tx })</code>. Markov doesnâ€™t have enough money in his account! Sequelize throws an exception. The <code>sequelize.transaction</code> method <em>catches the exception</em> and issues a <code>ROLLBACK</code> for the transaction. This tells the database to undo the prior increment of Curieâ€™s account balance.</p>
<p>Having rolled back the transaction, the <code>sequelize.transaction</code> method <em>rethrows</em> the error, so that our logging code gets a chance to learn about the error and print its details.</p>
<h2 id="aside-what-is-the-transaction-object">Aside: What Is The <code>Transaction</code> Object?</h2>
<p><em>This is bonus information in case you are troubled by what the <code>tx</code> parameter to <code>sequelize.transaction</code> is for. You can use transactions correctly without knowing this bonus information.</em></p>
<p>What is the mysterious <code>tx</code> that is passed by <code>sequelize.transaction</code> to our callback? It is basically just a unique ID. In this case, the ID is: <code>208b3951-9ab9-489b-97f0-afb49aaff807</code>. You can see this ID in the logs above.</p>
<p>When we say <code>curieAccount.save({ transaction: tx })</code>, we are telling Sequelize: "update Curieâ€™s account as part of transaction number <code>208b3951-9ab9-489b-97f0-afb49aaff807</code>."</p>
<p>Sequelize needs transaction IDs because it can be running many SQL transactions <em>concurrently</em> (loosely speaking: "in parallel"). One part of the application could be transferring money from Markov to Curie at the same time another part of the application is transferring money from Kate to Ned.</p>
<p>If Sequelize did not keep track of transaction IDs, it would not know that <code>curieAccount.save()</code> should be a part of the Markov/Curie transaction rather than the Kate/Ned transaction.</p>
<h2 id="transactions-prevent-race-conditions">Transactions Prevent <em>Race Conditions</em></h2>
<p>There is still a subtle mistake in my bank transfer code. There is a potential problem if someone modifies Markovâ€™s or Curieâ€™s account in between (1) the initial fetch of their accounts, and (2) the transaction to update the accounts.</p>
<div class="sourceCode" id="cb283"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb283-1" title="1"><span class="co">// ./index.js</span></a>
<a class="sourceLine" id="cb283-2" title="2"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb283-3" title="3">  <span class="co">// I will transfer only $5,000 so that Markov&#39;s balance can cover the</span></a>
<a class="sourceLine" id="cb283-4" title="4">  <span class="co">// amount. Markov starts out with $5,000.</span></a>
<a class="sourceLine" id="cb283-5" title="5"></a>
<a class="sourceLine" id="cb283-6" title="6">  <span class="co">// Fetch Markov and Curie&#39;s accounts.</span></a>
<a class="sourceLine" id="cb283-7" title="7">  <span class="kw">const</span> markovAccount <span class="op">=</span> <span class="cf">await</span> <span class="va">BankAccount</span>.<span class="at">findByPk</span>(<span class="dv">1</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb283-8" title="8">  <span class="kw">const</span> curieAccount <span class="op">=</span> <span class="cf">await</span> <span class="va">BankAccount</span>.<span class="at">findByPk</span>(<span class="dv">2</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb283-9" title="9"></a>
<a class="sourceLine" id="cb283-10" title="10">  <span class="co">// ***</span></a>
<a class="sourceLine" id="cb283-11" title="11">  <span class="co">// Imagine that right now some other program transfers the $5,000 out</span></a>
<a class="sourceLine" id="cb283-12" title="12">  <span class="co">// of Markov&#39;s account. Markov&#39;s true account **in the database** now</span></a>
<a class="sourceLine" id="cb283-13" title="13">  <span class="co">// has a balance of $0. But `markovAccount.balance` is still $5,000,</span></a>
<a class="sourceLine" id="cb283-14" title="14">  <span class="co">// because we fetched Markov&#39;s `BankAccount` **before** the transfer</span></a>
<a class="sourceLine" id="cb283-15" title="15">  <span class="co">// was made!</span></a>
<a class="sourceLine" id="cb283-16" title="16">  <span class="co">// ***</span></a>
<a class="sourceLine" id="cb283-17" title="17"></a>
<a class="sourceLine" id="cb283-18" title="18">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb283-19" title="19">    <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">transaction</span>(<span class="kw">async</span> (tx) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb283-20" title="20">      <span class="co">// Increment Curie&#39;s balance by $5,000 (to $15,000).</span></a>
<a class="sourceLine" id="cb283-21" title="21">      <span class="va">curieAccount</span>.<span class="at">balance</span> <span class="op">+=</span> <span class="dv">5000</span><span class="op">;</span></a>
<a class="sourceLine" id="cb283-22" title="22">      <span class="cf">await</span> <span class="va">curieAccount</span>.<span class="at">save</span>(<span class="op">{</span> <span class="dt">transaction</span><span class="op">:</span> tx <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb283-23" title="23"></a>
<a class="sourceLine" id="cb283-24" title="24">      <span class="co">// Decrement `markovAccount.balance` by $5,000.</span></a>
<a class="sourceLine" id="cb283-25" title="25">      <span class="co">// `markovAccount.balance` is set to zero.</span></a>
<a class="sourceLine" id="cb283-26" title="26">      <span class="va">markovAccount</span>.<span class="at">balance</span> <span class="op">-=</span> <span class="dv">5000</span><span class="op">;</span></a>
<a class="sourceLine" id="cb283-27" title="27">      <span class="co">// Save and set Markov&#39;s balance to zero.</span></a>
<a class="sourceLine" id="cb283-28" title="28">      <span class="cf">await</span> <span class="va">markovAccount</span>.<span class="at">save</span>(<span class="op">{</span> <span class="dt">transaction</span><span class="op">:</span> tx <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb283-29" title="29"></a>
<a class="sourceLine" id="cb283-30" title="30">      <span class="co">// Problem: Markov&#39;s balance in the database was *already* zero.</span></a>
<a class="sourceLine" id="cb283-31" title="31">      <span class="co">// Markov had no money to transfer. He should not have been able</span></a>
<a class="sourceLine" id="cb283-32" title="32">      <span class="co">// to transfer the $5,000.</span></a>
<a class="sourceLine" id="cb283-33" title="33">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb283-34" title="34">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb283-35" title="35">    <span class="co">// ...</span></a>
<a class="sourceLine" id="cb283-36" title="36">  <span class="op">}</span></a>
<a class="sourceLine" id="cb283-37" title="37"></a>
<a class="sourceLine" id="cb283-38" title="38">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb283-39" title="39"><span class="op">}</span></a>
<a class="sourceLine" id="cb283-40" title="40"></a>
<a class="sourceLine" id="cb283-41" title="41"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>Because another program can "race in between" (1) the reading of the account balances and (2) the updating of the balances, we call this potential problem a <em>race condition</em>. The easiest way to fix the race condition is to prohibit anyone else from modifying Markovâ€™s account balance in between (1) and (2).</p>
<p>Luckily, the solution is simple. Any data used in a transaction will be <em>locked</em> until the transaction completes. Data that is locked can be neither read nor written by other transactions. If our transaction reads (or writes) data, no one else can read or write that data until our transaction completes. When we <code>COMMIT</code> (or <code>ROLLBACK</code>) all the locked data is freed (the locks are <em>released</em>).</p>
<p>We donâ€™t have to lock the data ourselves. Simply by doing all our queries inside the same transaction, the database will lock the data for us. Therefore, to fix the problem, we should move the initial account fetching by <code>findByPk</code> into the transaction (i.e., pass it <code>{ transaction: tx }</code>):</p>
<div class="sourceCode" id="cb284"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb284-1" title="1"><span class="kw">async</span> <span class="kw">function</span> <span class="at">main</span>() <span class="op">{</span></a>
<a class="sourceLine" id="cb284-2" title="2">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb284-3" title="3">    <span class="co">// Do all database access within the transaction.</span></a>
<a class="sourceLine" id="cb284-4" title="4">    <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">transaction</span>(<span class="kw">async</span> (tx) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb284-5" title="5">      <span class="co">// Fetch Markov and Curie&#39;s accounts.</span></a>
<a class="sourceLine" id="cb284-6" title="6">      <span class="kw">const</span> markovAccount <span class="op">=</span> <span class="cf">await</span> <span class="va">BankAccount</span>.<span class="at">findByPk</span>(</a>
<a class="sourceLine" id="cb284-7" title="7">        <span class="dv">1</span><span class="op">,</span> <span class="op">{</span> <span class="dt">transaction</span><span class="op">:</span> tx <span class="op">},</span></a>
<a class="sourceLine" id="cb284-8" title="8">      )<span class="op">;</span></a>
<a class="sourceLine" id="cb284-9" title="9">      <span class="kw">const</span> curieAccount <span class="op">=</span> <span class="cf">await</span> <span class="va">BankAccount</span>.<span class="at">findByPk</span>(</a>
<a class="sourceLine" id="cb284-10" title="10">        <span class="dv">2</span><span class="op">,</span> <span class="op">{</span> <span class="dt">transaction</span><span class="op">:</span> tx <span class="op">}</span></a>
<a class="sourceLine" id="cb284-11" title="11">      )<span class="op">;</span></a>
<a class="sourceLine" id="cb284-12" title="12"></a>
<a class="sourceLine" id="cb284-13" title="13">      <span class="co">// No one can mess with Markov or Curie&#39;s accounts until the</span></a>
<a class="sourceLine" id="cb284-14" title="14">      <span class="co">// transaction completes! The account data has been locked!</span></a>
<a class="sourceLine" id="cb284-15" title="15"></a>
<a class="sourceLine" id="cb284-16" title="16">      <span class="co">// Increment Curie&#39;s balance by $5,000.</span></a>
<a class="sourceLine" id="cb284-17" title="17">      <span class="va">curieAccount</span>.<span class="at">balance</span> <span class="op">+=</span> <span class="dv">5000</span><span class="op">;</span></a>
<a class="sourceLine" id="cb284-18" title="18">      <span class="cf">await</span> <span class="va">curieAccount</span>.<span class="at">save</span>(<span class="op">{</span> <span class="dt">transaction</span><span class="op">:</span> tx <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb284-19" title="19"></a>
<a class="sourceLine" id="cb284-20" title="20">      <span class="co">// Decrement Markov&#39;s balance by $5,000.</span></a>
<a class="sourceLine" id="cb284-21" title="21">      <span class="va">markovAccount</span>.<span class="at">balance</span> <span class="op">-=</span> <span class="dv">5000</span><span class="op">;</span></a>
<a class="sourceLine" id="cb284-22" title="22">      <span class="cf">await</span> <span class="va">markovAccount</span>.<span class="at">save</span>(<span class="op">{</span> <span class="dt">transaction</span><span class="op">:</span> tx <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb284-23" title="23">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb284-24" title="24">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb284-25" title="25">    <span class="co">// ...</span></a>
<a class="sourceLine" id="cb284-26" title="26">  <span class="op">}</span></a>
<a class="sourceLine" id="cb284-27" title="27"></a>
<a class="sourceLine" id="cb284-28" title="28">  <span class="cf">await</span> <span class="va">sequelize</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb284-29" title="29"><span class="op">}</span></a>
<a class="sourceLine" id="cb284-30" title="30"></a>
<a class="sourceLine" id="cb284-31" title="31"><span class="at">main</span>()<span class="op">;</span></a></code></pre></div>
<p>This prints:</p>
<pre><code>Executing (76321a03-93c5-47c0-861a-cf24c3e6f3bf): START TRANSACTION;
Executing (76321a03-93c5-47c0-861a-cf24c3e6f3bf): SELECT &quot;id&quot;, &quot;clientName&quot;, &quot;balance&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;BankAccounts&quot; AS &quot;BankAccount&quot; WHERE &quot;BankAccount&quot;.&quot;id&quot; = 1;
Executing (76321a03-93c5-47c0-861a-cf24c3e6f3bf): SELECT &quot;id&quot;, &quot;clientName&quot;, &quot;balance&quot;, &quot;createdAt&quot;, &quot;updatedAt&quot; FROM &quot;BankAccounts&quot; AS &quot;BankAccount&quot; WHERE &quot;BankAccount&quot;.&quot;id&quot; = 2;
Executing (76321a03-93c5-47c0-861a-cf24c3e6f3bf): UPDATE &quot;BankAccounts&quot; SET &quot;balance&quot;=$1,&quot;updatedAt&quot;=$2 WHERE &quot;id&quot; = $3
Executing (76321a03-93c5-47c0-861a-cf24c3e6f3bf): UPDATE &quot;BankAccounts&quot; SET &quot;balance&quot;=$1,&quot;updatedAt&quot;=$2 WHERE &quot;id&quot; = $3
Executing (76321a03-93c5-47c0-861a-cf24c3e6f3bf): COMMIT;</code></pre>
<p>Notice that now <em>everything</em> is done in the transaction <code>76321a03-93c5-47c0-861a-cf24c3e6f3bf</code>. This includes the initial fetching of the accounts. Because the fetching is done within the transaction, other users are not allowed to modify the accounts until the transaction is finished.</p>
<p>Moving our read operations into the transaction has solved our race condition problem. Every Sequelize operation - whether reading or writing - can take a <code>transaction: tx</code> option. This includes:</p>
<ol type="1">
<li><code>findByPk</code></li>
<li><code>findAll</code></li>
<li><code>save</code></li>
<li><code>create</code></li>
<li><code>destroy</code></li>
</ol>
<h2 id="conclusion-5">Conclusion</h2>
<p>Having completed this reading, here are the important things to take away:</p>
<ol type="1">
<li>You should know that any SQL update operation may fail, often through no fault of your own.</li>
<li>You should know that you must write code resilient to SQL failures.</li>
<li>You should know that when performing multiple update operations as part of a group, you must use a transaction.</li>
<li>You should know how to use <code>sequelize.transaction</code> to run commands within a SQL transaction.</li>
<li>You should know how to pass a transaction object as the <code>{ transaction: tx }</code> parameter to a Sequelize command (such as <code>save</code>).</li>
<li>You should know what a <em>race condition</em> is: the possibility that someone else modifies previously fetched data before you are finished using/updating it.</li>
<li>You should know how to use transactions to guard against race conditions. That is: you should know that both reading and writing operations should be put in the same transaction.</li>
</ol>
<hr />
<h1 id="recipe-box-with-sequelize-project">Recipe Box With Sequelize Project</h1>
<p>In this project, you will build the Data Access Layer to power a Web application. Unlike previously, you will use the Sequelize library and tools to do this to build a more maintainable application.</p>
<p>It has more steps than the SQL version, but itâ€™s more maintainable in the long run. Also, the SQL version hid a lot of complexity from you with respect to the running of the SQL. Go look at the SQL version of the files in the <strong>controllers</strong> directory to see what we had to do to load the SQL and execute it.</p>
<p>Now, compare the <em>simplicity</em> of those with the simplicity of the files in the <strong>controllers</strong> directory for <em>this</em> version of the application. Itâ€™s easier to understand <em>this</em> version. You want to know where to add a column to a table? Go to the migrations. You want to know where to fix a query? Go to the proper repository file.</p>
<p>Itâ€™s just <em>so</em> much better organized.</p>
<p>Quite often, you will see that you will have more files and, overall, more lines of code in well-organized, highly-maintainable software project. Remembering where code is <em>is hard</em>. Thatâ€™s why having clearly-named files and directories is so very important.</p>
<h2 id="the-data-model-analysis-1">The data model analysis</h2>
<p>This looks no different because itâ€™s the same application.</p>
<p>What goes into a recipe box? Why, recipes, of course! Hereâ€™s an example recipe card.</p>
<figure>
<img src="images/sql-recipe-card.jpeg" alt="Recipe card" /><figcaption>Recipe card</figcaption>
</figure>
<p>You can see that a recipe is made up of three basic parts:</p>
<ul>
<li>A title,</li>
<li>A list of ingredients, and</li>
<li>A list of instructions.</li>
</ul>
<p>Youâ€™re going to add a little more to that, too. It will also have</p>
<ul>
<li>The date/time that it was entered into the recipe box, and</li>
<li>The date/time it was last updated in the recipe box.</li>
</ul>
<p>These are good pieces of data to have so that you can show them "most recent" for example.</p>
<p>Ingredients themselves are complex data types and need their own structure. They "belong" to a recipe. That means theyâ€™ll need to reference that recipe. That means an ingredient is made up of:</p>
<ul>
<li>An amount (optional),</li>
<li>A unit of measure (optional),</li>
<li>The actual food stuff, and</li>
<li>The id of the recipe that it belongs to.</li>
</ul>
<p>That unit of measure is a good candidate for normalization, donâ€™t you think? Itâ€™s a predefined list of options that should not change and that you donâ€™t want people just typing whatever they want in there, not if you want to maintain data integrity. Otherwise, youâ€™ll end up with "C", "c", "cup", "CUP", "Cup", and all the other permutations, each of which is a distinct value but means the same thing.</p>
<p>Instructions are also complex objects, but not by looking at them. Initially, one might only see text that comprises an instruction. But, very importantly, instructions have <em>order</em>. They also <em>belong</em> to the recipe. With that in mind, an instruction is made up of:</p>
<ul>
<li>The text of the instruction,</li>
<li>The order that it appears in the recipe, and</li>
<li>The id of the recipe that it belongs to.</li>
</ul>
<p>That is enough to make a good model for the recipe box.</p>
<figure>
<img src="images/sql-recipe-box-data-model.png" alt="recipe box data model" /><figcaption>recipe box data model</figcaption>
</figure>
<h2 id="the-application-1">The application</h2>
<p>The application is a standard <a href="https://www.expressjs.com">express.js</a> application using the <a href="https://pugjs.org">pug</a> library to generate the HTML and the <a href="https://node-postgres.com">node-postgres</a> library to connect to the database.</p>
<p>It already has <a href="https://www.npmjs.com/package/sequelize">sequelize</a> and <a href="https://www.npmjs.com/package/sequelize-cli">sequelize-cli</a> installed.</p>
<h2 id="getting-started-2">Getting started</h2>
<ul>
<li>Clone the starter project from https://github.com/-starters/sql-orm-recipe-box</li>
<li>Run <code>npm install</code> to install the packages</li>
<li>Run <code>npm run dev</code> to start the server on port 3000</li>
</ul>
<p>Youâ€™ll do all of your work in the <strong>data-access-layer</strong> directory. In there, you will find a series of JS files. Each of these will hold your JavaScript code rather than SQL code.</p>
<h2 id="your-code">Your code</h2>
<p>Youâ€™re going to be using JavaScript and the tools of Sequelize. Keep the <a href="https://sequelize.org/v5/">Sequelize documentation</a> open and handy. Even developers that use ORMs every day will keep the documentation open because thereâ€™s so much to know about them.</p>
<h2 id="phase-1-initialize-the-sequelize-project">Phase 1: Initialize the Sequelize project</h2>
<p>Because this project already has <a href="https://www.npmjs.com/package/sequelize-cli">sequelize-cli</a> installed, you can initialize the project by typing <code>npx sequelize-cli init</code>. The <code>npx</code> command runs locally-installed tools. That will create the project structure that Sequelize expects for us to continue to use its tools.</p>
<h2 id="phase-2-create-a-database-user-for-the-project">Phase 2: Create a database user for the project</h2>
<p>Using a PostgreSQL client like <code>psql</code> or Postbird, create a new user for this application named "sequelize_recipe_box_app" with the password "HfKfK79k" <em>and</em> the ability to create a database. Hereâ€™s the <a href="https://www.postgresql.org/docs/current/sql-createuser.html">link to the CREATE USER documentation</a> so that you can determine which options to give.</p>
<h2 id="phase-2-change-the-connection-configuration">Phase 2: Change the connection configuration</h2>
<p>The project contains a directory named <strong>config</strong>. Inside there, you will find a file named <strong>config.json</strong>. You need to make some configuration changes.</p>
<ul>
<li>Change all the "user" and "password" values to the information for the user that you created in Phase 2.</li>
<li>Change the "database" values to be "recipe_box_development", "recipe_box_test", and "recipe_box_production".</li>
<li>Change all of the "dialect" values from "mysql" to "postgres".</li>
<li>Delete all of the "operatorAliases" entries. Itâ€™s to support earlier versions of the Sequelize library. Make sure to remove the comma from the preceding line so that itâ€™s valid JSON.</li>
<li>Because youâ€™ll be using seed data in this project, add <code>"seederStorage": "sequelize"</code> to each of the different blocks so that Sequelize CLI wonâ€™t run a seeder more than once causing duplicate entries in the database.</li>
</ul>
<p>That will configure the application and the Sequelize tools to properly connect to your development database.</p>
<h2 id="phase-3-create-your-database">Phase 3: Create your database</h2>
<p>Rather than writing SQL to do this, you will use the tools. Run</p>
<pre><code>npx sequelize-cli db:create</code></pre>
<p>That runs the Sequelize CLI with the command <code>db:create</code>.</p>
<p>When you run this, it will default to the "development" setting and read the information from the configuration file to create your database for you! It should print out something like</p>
<pre><code>Sequelize CLI [Node: 10.19.0, CLI: 5.5.1, ORM: 5.21.5]

Loaded configuration file &quot;config/config.json&quot;.
Using environment &quot;development&quot;.
Database recipe_box_development created.</code></pre>
<p>You can also drop the database by typing â€¦ you guessed it! The Sequelize CLI with the command <code>db:drop</code>!</p>
<pre><code>npx sequelize-cli db:drop</code></pre>
<p>If you run that, run the "create" command, again, so the database exists.</p>
<h2 id="phase-4-the-units-of-measurement-data">Phase 4: The units of measurement data</h2>
<p>Just as a review, here is the specification for the table that holds units of measurement.</p>
<table>
<thead>
<tr class="header">
<th>Column Name</th>
<th>Column Type</th>
<th>Constraints</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>SERIAL</td>
<td>PK</td>
</tr>
<tr class="even">
<td>name</td>
<td>VARCHAR(20)</td>
<td>NOT NULL</td>
</tr>
</tbody>
</table>
<p>Luckily, the Sequelize models and migrations take care of the "id" property for you without you having to do anything. So, you can just focus on that "name" property.</p>
<h3 id="create-a-migration">Create a migration</h3>
<p>Itâ€™s time to create the first migration, the one that defines the table that will hold units of measure. You can use the Sequelize CLI to generate the migration for you. You can <em>also</em> tell it to create a model for you, and it will create a migration along <em>with</em> the model. You should do that to get the biggest return on investment for the characters that you will type.</p>
<p>The command is <code>model:generate</code> and it takes a couple of arguments, "â€“name" which contains the name of the model (as a singular noun) to generate, and "â€“attributes" which has a comma-separated list of "property-name:data-type" pairs.</p>
<p><strong>Learning Tip</strong>: It is <em>so very important</em> that you donâ€™t copy and paste this. Type these things out so it has a better chance of creating durable knowledge.</p>
<pre><code>npx sequelize-cli model:generate \
  --name MeasurementUnit \
  --attributes name:string</code></pre>
<p>That will create two files, if everything works well. (The name of your migration file will be different because itâ€™s time-based.)</p>
<pre><code>New model was created at models/measurementunit.js
New migration was created at migrations/20200101012349-MeasurementUnit.js</code></pre>
<p>The <strong>model</strong> file will be used by the application to query the database. It will be used by the express.js application. It is part of the running software.</p>
<p>The <strong>migration</strong> file is used to construct the database. It is only used by the Sequelize CLI tool to build the database. Unlike those schema and seed files that you had in the SQL version of this project which destroyed <em>everything</em> when run, migrations are designed to change your database as your application grows. This is a much better strategy so that existing data in the databases that other people use arenâ€™t damaged.</p>
<p>Because the data model requires the "name" column to be both non-null <em>and</em> unique, you have to add some information to the migration file. Open it and, for the "name" property, make non-nullable by looking at how the other properties are configured. Then, add the "unique" property set to <code>true</code> to the "name" configuration, as well. That should be enough for Sequelize to create the table for you.</p>
<p>The last thing to do is to change the length of the "name" property. By default, Sequelize will make it 255 characters long. The specification for the table says it should really only be 20 characters. To tell the migration that, change the type for "name" from <code>Sequelize.STRING</code> to <code>Sequelize.STRING(20)</code>.</p>
<h2 id="run-your-migration">Run your migration</h2>
<p>If you now run your migration with the Sequelize CLI, it will create the table for you.</p>
<pre><code>npx sequelize-cli db:migrate</code></pre>
<p>That should give you some output that looks similar to this.</p>
<pre><code>Loaded configuration file &quot;config/config.json&quot;.
Using environment &quot;development&quot;.
== 20200101012349-create-measurement-unit: migrating =======
== 20200101012349-create-measurement-unit: migrated (0.021s)</code></pre>
<p>You can confirm that the table "MeasurementUnits" is created by using your PostgreSQL client. Youâ€™ll also see that another table is created, "SequelizeMeta", which contains information about which migration has most recently been run. It contains a single column, "name". Each row contains an entry of which migration file has run. Now that youâ€™ve run your migration file, the table contains one entry, the name of your migration file. When you run more migrations, you will see more rows, each containing the name of the file that youâ€™ve run.</p>
<p><strong>psql Note</strong>: If you are using <code>psql</code> as you PostgreSQL command, be aware that it will lowercase any entity and column names you type in there. If you type <code>SELECT * FROM MeasurementUnits</code>, it converts that to <code>SELECT * FROM measurementunits</code> before running it. To prevent that from happening, use quotation marks around the table name. <code>SELECT * FROM "MeasurementUnits"</code> will do the trick.</p>
<p>Itâ€™s important that you <em>never</em> change the name of a migration file after itâ€™s been run.</p>
<p>In the real world, you should <em>never</em> change the content of a migration file after itâ€™s been committed and shared in your Git repository. Asking others to rollback their migrations just because you changed one of yours is bad manners. Instead, you should add a new migration that makes the change that you want.</p>
<h2 id="create-the-seed-data">Create the seed data</h2>
<p>You can create the seed data for the unit of measurements by creating a <strong>seeder</strong> as the Sequelize CLI calls them. You can create one using the Sequelize CLI tool. Run the following and make sure you donâ€™t get any errors.</p>
<pre><code>npx sequelize-cli seed:generate --name default-measurement-units</code></pre>
<p>Now, you want to insert the seed data. You will do this by using the <code>bulkInsert</code> method of the object passed in through the <code>queryInterface</code> parameter of the <code>up</code> method. Feel free to delete the comment in the <code>up</code> method and replace it with this.</p>
<div class="sourceCode" id="cb294"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb294-1" title="1"><span class="cf">return</span> <span class="va">queryInterface</span>.<span class="at">bulkInsert</span>(<span class="st">&#39;MeasurementUnits&#39;</span><span class="op">,</span> [</a>
<a class="sourceLine" id="cb294-2" title="2">  <span class="op">{</span> <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;cups&#39;</span><span class="op">,</span> <span class="dt">createdAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>()<span class="op">,</span> <span class="dt">updatedAt</span><span class="op">:</span> <span class="kw">new</span> <span class="at">Date</span>() <span class="op">},</span></a>
<a class="sourceLine" id="cb294-3" title="3">])<span class="op">;</span></a></code></pre></div>
<p>The <code>bulkInsert</code> method takes two parameters:</p>
<ul>
<li>The name of the table to insert into, and</li>
<li>An array of objects that have property names that match the column names in the table.</li>
</ul>
<p>You can see that the first object has been provided by the example. Now, create objects for all of these values, as well. (The empty item in the list is an empty string and is intentional) Make sure you do them <strong>in this order,</strong> or when we get to the seed data for the other tables it wonâ€™t work. (Weâ€™ve supplied you with files for the seed data for the other tables because there is a lot of it)</p>
<ul>
<li>"fluid ounces"</li>
<li>"gallons"</li>
<li>"grams"</li>
<li>"liters"</li>
<li>"milliliters"</li>
<li>"ounces"</li>
<li>"pinch"</li>
<li>"pints"</li>
<li>"pounds"</li>
<li>"quarts"</li>
<li>"tablespoons"</li>
<li>"teaspoons"</li>
<li>""</li>
<li>"cans"</li>
<li>"slices"</li>
<li>"splash"</li>
</ul>
<p>Now, run the Sequelize CLI with the command <code>db:seed:all</code>.</p>
<p>After you get that done, you can confirm that all of the records (rows) were created in the "MeasurementUnits" table.</p>
<h2 id="phase-5-the-recipe-table-model">Phase 5: The recipe table model</h2>
<p>This will go much like the last one, except thereâ€™s no seed data. Just to refresh your memory, hereâ€™s the specification for the "recipes" table.</p>
<table>
<thead>
<tr class="header">
<th>Column Name</th>
<th>Column Type</th>
<th>Constraints</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>SERIAL</td>
<td>PK</td>
</tr>
<tr class="even">
<td>title</td>
<td>VARCHAR(200)</td>
<td>NOT NULL</td>
</tr>
<tr class="odd">
<td>created</td>
<td>TIMESTAMP</td>
<td>NOT NULL, DEFAULT CURRENT_TIMESTAMP</td>
</tr>
<tr class="even">
<td>updated</td>
<td>TIMESTAMP</td>
<td>NOT NULL, DEFAULT CURRENT_TIMESTAMP</td>
</tr>
</tbody>
</table>
<p>As youâ€™ve discovered, Sequelize takes care of the "id" for you <em>and</em> the columns to track when the recipe has been created and updated! Your job is to</p>
<ul>
<li>Generate a model for the "recipe"</li>
<li>Customize the migration so the "title" column is not nullable</li>
</ul>
<p>Run your migration and confirm that you defined it correctly by checking the attributes in the description of the table. The important parts to check are that the "title" column is a VARCHAR(200) and is non-nullable. (The "Collation" column has been removed for brevity.)</p>
<pre><code>                  Table &quot;public.Recipes&quot;
  Column   |           Type           | Nullable |  Default
-----------+--------------------------+----------+------------
 id        | integer                  | not null | nextval(...
 title     | character varying(200)   | not null |
 createdAt | timestamp with time zone | not null |
 updatedAt | timestamp with time zone | not null |
Indexes:
    &quot;Recipes_pkey&quot; PRIMARY KEY, btree (id)</code></pre>
<h2 id="phase-6-the-instruction-table-model">Phase 6: The instruction table model</h2>
<p>Now, things get a little trickier because this model will reference the recipe model. Hereâ€™s the specification for the "instructions" table.</p>
<table>
<thead>
<tr class="header">
<th>Column Name</th>
<th>Column Type</th>
<th>Constraints</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>SERIAL</td>
<td>PK</td>
</tr>
<tr class="even">
<td>specification</td>
<td>TEXT</td>
<td>NOT NULL</td>
</tr>
<tr class="odd">
<td>listOrder</td>
<td>INTEGER</td>
<td>NOT NULL</td>
</tr>
<tr class="even">
<td>recipeId</td>
<td>INTEGER</td>
<td>FK, NOT NULL</td>
</tr>
</tbody>
</table>
<p>When you type out your migration generation command, the "â€“attributes" parameter will look like this:</p>
<pre><code>--attributes column1:type1,column2:type2,column3:type3</code></pre>
<p>Instead of using "string" for the "specification" column of the table, use "text" to generate a TEXT column.</p>
<p>After it generates the migration file, modify each of the column descriptors in the migration so that the columns are not nullable. Then, add a new property to the one for "recipeId" called "references" that is an object that contains a "model" property set to "Recipes". It should look like this.</p>
<div class="sourceCode" id="cb297"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb297-1" title="1">recipeId<span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb297-2" title="2">  <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb297-3" title="3">  <span class="dt">references</span><span class="op">:</span> <span class="op">{</span> <span class="dt">model</span><span class="op">:</span> <span class="st">&quot;Recipes&quot;</span> <span class="op">},</span></a>
<a class="sourceLine" id="cb297-4" title="4">  <span class="dt">type</span><span class="op">:</span> <span class="va">Sequelize</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb297-5" title="5"><span class="op">},</span></a></code></pre></div>
<p>With that in place, run the migration. Then, check the table definition in your PostgreSQL client.</p>
<pre><code>                   Table &quot;public.Instructions&quot;
    Column     |           Type           | Nullable |     Default
---------------+--------------------------+----------+-----------------
 id            | integer                  | not null | nextval(&#39;&quot;Ins...
 specification | text                     | not null |
 listOrder     | integer                  | not null |
 recipeId      | integer                  | not null |
 createdAt     | timestamp with time zone | not null |
 updatedAt     | timestamp with time zone | not null |
Indexes:
    &quot;Instructions_pkey&quot; PRIMARY KEY, btree (id)
Foreign-key constraints:
    &quot;Instructions_recipeId_fkey&quot; FOREIGN KEY (&quot;recipeId&quot;)
                                 REFERENCES &quot;Recipes&quot;(id)</code></pre>
<p>You should see all non-null columns and a foreign key between the "Instructions" table and the "Recipes" table.</p>
<h2 id="phase-7-the-ingredients-model">Phase 7: The ingredients model</h2>
<p>The model for ingredients has <em>two</em> foreign keys. Create the model and migration for it. Hereâ€™s the table specification.</p>
<table>
<thead>
<tr class="header">
<th>Column Name</th>
<th>Column Type</th>
<th>Constraints</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>SERIAL</td>
<td>PK</td>
</tr>
<tr class="even">
<td>amount</td>
<td>NUMERIC(5, 2)</td>
<td>NOT NULL</td>
</tr>
<tr class="odd">
<td>measurementUnitId</td>
<td>INTEGER</td>
<td>FK, NOT NULL</td>
</tr>
<tr class="even">
<td>foodStuff</td>
<td>VARCHAR(500)</td>
<td>NOT NULL</td>
</tr>
<tr class="odd">
<td>recipeId</td>
<td>INTEGER</td>
<td>FK, NOT NULL</td>
</tr>
</tbody>
</table>
<p>After you modify and run your migration, you should have a table in your database that looks like this, with two foreign keys, one to the "Recipes" table and the other to the "MeasurementUnits" table.</p>
<pre><code>                       Table &quot;public.Ingredients&quot;
      Column       |           Type           | Nullable |      Default
-------------------+--------------------------+----------+-----------------
 id                | integer                  | not null | nextval(&#39;&quot;Ing...
 amount            | numeric(5,2)             | not null |
 measurementUnitId | integer                  | not null |
 foodStuff         | character varying(500)   | not null |
 recipeId          | integer                  | not null |
 createdAt         | timestamp with time zone | not null |
 updatedAt         | timestamp with time zone | not null |
Indexes:
    &quot;Ingredients_pkey&quot; PRIMARY KEY, btree (id)
Foreign-key constraints:
    &quot;Ingredients_measurementUnitId_fkey&quot;
        FOREIGN KEY (&quot;measurementUnitId&quot;)
        REFERENCES &quot;MeasurementUnits&quot;(id)
    &quot;Ingredients_recipeId_fkey&quot;
        FOREIGN KEY (&quot;recipeId&quot;)
        REFERENCES &quot;Recipes&quot;(id)</code></pre>
<h2 id="phase-8-seed-data-for-all-of-the-tables">Phase 8: Seed data for all of the tables</h2>
<p>Now that you have tables in the database, itâ€™s time to create some seed data for all of them. In the <strong>data-access-layer</strong> directory, you will find three text files each containing JavaScript objects on each row that match the tables in the previous three sections.</p>
<p>If you didnâ€™t seed the MeasurementUnits data in the correct order listed in the section above, you may have to redo that seed file, because the data from the text files depends on the ids of the data in the <code>MeasurementUnits</code> table being correct.</p>
<p>There are three tables to seed: Ingredients, Instructions, and Recipes. It is important to note that you will need to seed them in the correct order due to foreign key dependencies.</p>
<p>Look at the data model for the application, again.</p>
<figure>
<img src="images/sql-recipe-box-data-model.png" alt="recipe box data model" /><figcaption>recipe box data model</figcaption>
</figure>
<p>You can see that the Instructions depends on Recipes because it has the foreign key "recipeId" to the Recipes table. You can also see that the Ingredients table has dependencies on the Recipes and MeasurementUnits tables because of its foreign keys "measurementUnitId" and "recipeId". (Youâ€™ve already seeded the MeasurementUnits table in Phase 4, so that data exists for use by the Ingredients table.) Recipes does not have any foreign keys. You need to seed Recipes, first, because it does not have any foreign keys and, therefore, does not have any data dependencies. Then, you can seed the Instructions and Ingredients tables in either order because their data dependencies will have been met.</p>
<p>Create seeder files for them in that order: Recipes, first, then Ingredients and Instructions. Use the contents of each of the text files in <strong>data-access-layer</strong> to do bulk inserts.</p>
<p>After you create each seed file, run</p>
<pre><code>npx sequelize-cli db:seed:all</code></pre>
<p>to make sure you donâ€™t have any errors. If you do, fix them before moving onto the next seed file.</p>
<p>If you end up seeding the data in the wrong order and getting a foreign key constraint error, just use the CLI to drop the database, create the database, migrate the database, and then you can try running your seeders, again. You may need to rename your migration filenames to get your seeds running in the correct order.</p>
<h2 id="phase-9-updating-models-with-references">Phase 9: Updating models with references</h2>
<p>Now that you have all of the migrations set up correctly and a database defined, it is time for you to turn your attention to the model files that were generated in the previous phases.</p>
<p>Consider the relationship between an Instruction and a Recipe. A Recipe <em>has many</em> Instructions. In the other direction, you would say that an Instruction <em>has one</em> Recipe, or that Instruction <em>belongs to</em> the Recipe. To set that up in your model, open the file <strong>models/recipe.js</strong>. In there, you will see the following.</p>
<div class="sourceCode" id="cb301"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb301-1" title="1"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb301-2" title="2"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb301-3" title="3">  <span class="kw">const</span> Recipe <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Recipe&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb301-4" title="4">    <span class="dt">title</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span></a>
<a class="sourceLine" id="cb301-5" title="5">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb301-6" title="6">  <span class="va">Recipe</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb301-7" title="7">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb301-8" title="8">  <span class="op">};</span></a>
<a class="sourceLine" id="cb301-9" title="9">  <span class="cf">return</span> Recipe<span class="op">;</span></a>
<a class="sourceLine" id="cb301-10" title="10"><span class="op">};</span></a></code></pre></div>
<p>In the <code>associate</code> function is where you can define the association between the Recipe and the Instruction. Replace the comment with the following statement.</p>
<div class="sourceCode" id="cb302"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb302-1" title="1"><span class="va">Recipe</span>.<span class="at">hasMany</span>(<span class="va">models</span>.<span class="at">Instruction</span><span class="op">,</span> <span class="op">{</span> <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&#39;recipeId&#39;</span> <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>This instructs Sequelize that Recipe should have a collection of Instruction objects associated with it. To insure that Sequelize uses the foreign key column that you created on the "Instructions" table in your migration, you must specify it as part of the collection definition.</p>
<p>In the file <strong>models/instruction.js</strong>, replace the comment with the following to define the other side of the relationship.</p>
<div class="sourceCode" id="cb303"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb303-1" title="1"><span class="va">Instruction</span>.<span class="at">belongsTo</span>(<span class="va">models</span>.<span class="at">Recipe</span><span class="op">,</span> <span class="op">{</span> <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&#39;recipeId&#39;</span> <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<p>This instructs Sequelize that Instruction has a single Recipe object associated with it. Again, because of inconsistent naming conventions used by Sequelize, you must specify the foreign key column name in the "Instructions" table.</p>
<p>Think about the many-to-one and one-to-many relationships between Ingredient, MeasurementUnit, and Recipe. Then, modify those model files accordingly with the <code>hasMany</code> and <code>belongsTo</code> associations, always specifying the name of the foreign key column that binds the two tables together.</p>
<h2 id="phase-10-updating-models-with-validations">Phase 10: Updating models with validations</h2>
<p>Now that you have seed data created, it will be important to prevent users from entering data that does not meet the expectations of the data model.</p>
<p>Consider the content of <strong>models/instruction.js</strong></p>
<div class="sourceCode" id="cb304"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb304-1" title="1"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb304-2" title="2"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb304-3" title="3">  <span class="kw">const</span> Instruction <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Instruction&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb304-4" title="4">    <span class="dt">specification</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">TEXT</span><span class="op">,</span></a>
<a class="sourceLine" id="cb304-5" title="5">    <span class="dt">listOrder</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb304-6" title="6">    <span class="dt">recipeId</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span></a>
<a class="sourceLine" id="cb304-7" title="7">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb304-8" title="8">  <span class="va">Instruction</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb304-9" title="9">    <span class="va">Instruction</span>.<span class="at">belongsTo</span>(<span class="va">models</span>.<span class="at">Recipe</span><span class="op">,</span> <span class="op">{</span> <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&#39;recipeId&#39;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb304-10" title="10">  <span class="op">};</span></a>
<a class="sourceLine" id="cb304-11" title="11">  <span class="cf">return</span> Instruction<span class="op">;</span></a>
<a class="sourceLine" id="cb304-12" title="12"><span class="op">};</span></a></code></pre></div>
<p>It would be nice if the model could validate each of those properties to make sure that no one sets them to null and that <code>listOrder</code> is greater than 0, for example. You can do that with <a href="https://sequelize.org/master/manual/validations-and-constraints.html#per-attribute-validations">per-attribute validations</a>.</p>
<p>For example, you can change the above code to the following to make sure that the "specification" property wonâ€™t get set to an empty string when someone tries to save the object.</p>
<div class="sourceCode" id="cb305"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb305-1" title="1"><span class="st">&#39;use strict&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb305-2" title="2"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb305-3" title="3">  <span class="kw">const</span> Instruction <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(<span class="st">&#39;Instruction&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb305-4" title="4">    <span class="dt">specification</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb305-5" title="5">      <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">TEXT</span><span class="op">,</span></a>
<a class="sourceLine" id="cb305-6" title="6">      <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb305-7" title="7">        <span class="dt">notEmpty</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb305-8" title="8">      <span class="op">},</span></a>
<a class="sourceLine" id="cb305-9" title="9">    <span class="op">},</span></a>
<a class="sourceLine" id="cb305-10" title="10">    <span class="dt">listOrder</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb305-11" title="11">    <span class="dt">recipeId</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span></a>
<a class="sourceLine" id="cb305-12" title="12">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb305-13" title="13">  <span class="va">Instruction</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span>(models) <span class="op">{</span></a>
<a class="sourceLine" id="cb305-14" title="14">    <span class="va">Instruction</span>.<span class="at">belongsTo</span>(<span class="va">models</span>.<span class="at">Recipe</span><span class="op">,</span> <span class="op">{</span> <span class="dt">foreignKey</span><span class="op">:</span> <span class="st">&#39;recipeId&#39;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb305-15" title="15">  <span class="op">};</span></a>
<a class="sourceLine" id="cb305-16" title="16">  <span class="cf">return</span> Instruction<span class="op">;</span></a>
<a class="sourceLine" id="cb305-17" title="17"><span class="op">};</span></a></code></pre></div>
<p>Make sure all of the other string properties in the models wonâ€™t allow the empty string to be set on them.</p>
<h2 id="phase-11-cascade-delete-for-recipes">Phase 11: Cascade delete for recipes</h2>
<p>The Recipe model has dependencies: the Instruction and the Ingredient both have <em>belongs to</em> relationships. This means that the row in the "Recipes" table must exist to have records in the "Ingredients" and "Instructions" table. If you try to delete a Recipe row from the database that has either Instructions or Ingredients, it wonâ€™t work due to referential integrity. You would have to delete all of the Ingredients and Instructions <em>before</em> being able to delete the Recipe.</p>
<p>Sequelize provides a handy shortcut for that and will manage deleting the associated records for you when you delete a row from the Recipes table. Itâ€™s called a <em>cascading delete</em>. Open the <strong>models/recipe.js</strong> file. In there, modify the second argument of each of the <code>hasMany</code> calls to include two new property/value pairs:</p>
<ul>
<li><code>onDelete: 'CASCADE'</code></li>
<li><code>hooks: true</code></li>
</ul>
<p>Refer to the documentation on <a href="https://sequelize.org/master/manual/hooks.html#associations">Associations</a> to see an example. But, donâ€™t delete the <code>foreignKey</code> property that you put there in Phase 9.</p>
<h2 id="phase-12-building-the-repositories">Phase 12: Building the repositories</h2>
<p>Now that you have the seeds, models, and migrations out of the way, you can build the data access layer with a lot of speed. Sequelize will now handle all of the SQL generation for you. You can just use the models that youâ€™ve painstakingly crafted.</p>
<p>Because you are writing JavaScript files, you want the server to restart because it wonâ€™t automatically reload the changed JavaScript that youâ€™re writing. To that end, you will use a different command while developing.</p>
<pre><code>npm run dev</code></pre>
<p>This runs a special script that will reload the JavaScript in the data access layer every time you make a change. You can see whatâ€™s run in the <strong>package.json</strong> file in this project in the "scripts" section for the "dev" property.</p>
<p>You will work in the three files named</p>
<ul>
<li><strong>recipes-repository.js</strong>: The collection of functions needed to interact with recipes for the application</li>
<li><strong>instructions-repository.js</strong>: The collection of functions needed to interact with the instructions for the application</li>
<li><strong>ingredients-repository.js</strong>: The collection of functions needed to interact with the ingredients for the application</li>
</ul>
<p>Each of the files imports your models and makes them available to you. Then, you can use them in your querying. Follow the hints in each of the repository functions.</p>
</body></html>
