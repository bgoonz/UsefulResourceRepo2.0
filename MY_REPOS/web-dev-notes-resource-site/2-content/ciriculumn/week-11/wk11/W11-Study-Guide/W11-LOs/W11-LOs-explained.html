<h1 id="regex-express-and-full-stack-development-week-11---learning-objectives">Regex, Express, and Full-Stack Development (Week 11) - Learning Objectives</h1>
<h2 id="assessment-structure">Assessment Structure</h2>
<ul>
<li>2 hours, 45 minutes</li>
<li>Mixture of multiple choice (5-10), and VSCode problems (20-30 specs).
<ul>
<li>For the coding section, be comfortable with creating an express application from scratch. The projects from Thursday and Friday are good examples (on a smaller scale for an assessment environment).</li>
<li>This includes connecting database material introduced last week, such as making your database, initializing sequelize, creating migrations and models, adding seeders for your models, etc.</li>
<li>Be able to work within the express framework, creating the app, adding in middleware for csrf protection, urlencoded body parsing, etc., making route handlers to respond to various requests and pull in database information, etc.</li>
<li>Be able to display that information to the user using Pug templates, including csrf-protected forms for post routes, iterating over database data to display content of records, etc.</li>
</ul></li>
<li>Standard assessment procedures
<ul>
<li>You will be in an individual breakout room</li>
<li>Use a single monitor and share your screen</li>
<li>Only have open those resources needed to complete the assessment:
<ul>
<li>Zoom</li>
<li>VSCode</li>
<li>Browser with AAO and Progress Tracker (to ask questions)</li>
<li>Approved Resources for this assessment:
<ul>
<li>Express Docs: http://expressjs.com/</li>
<li>Pug Docs: http://pugjs.org/</li>
<li>csurf Docs: https://github.com/expressjs/csurf#readme</li>
<li>Sequelize Docs: https://sequelize.org/</li>
<li>Sequelize “Cheatsheet"</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
<h2 id="regular-expressions-and-node-http-w11d1---learning-objectives">Regular Expressions and Node HTTP (W11D1) - Learning Objectives</h2>
<h3 id="regular-expressions">Regular Expressions</h3>
<ol type="1">
<li>Define the effect of the * operator and use it in a regular expression</li>
<li>Define the effect of the ? operator and use it in a regular expression</li>
<li>Define the effect of the + operator and use it in a regular expression</li>
<li>Define the effect of the . operator and use it in a regular expression</li>
<li>Define the effect of the ^ operator and use it in a regular expression</li>
<li>Define the effect of the $ operator and use it in a regular expression</li>
<li>Define the effect of the [] bracket expression and use it in a regular expression</li>
<li>Define the effect of the - inside brackets and use it in a regular expression</li>
<li>Define the effect of the ^ inside brackets and use it in a regular expression</li>
</ol>
<h3 id="regex-cheatsheet">Regex cheatsheet:</h3>
<table>
<thead>
<tr class="header">
<th style="text-align: center;">Regex Symbol</th>
<th style="text-align: left;">Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">*</td>
<td style="text-align: left;">zero or more</td>
</tr>
<tr class="even">
<td style="text-align: center;">+</td>
<td style="text-align: left;">one or more</td>
</tr>
<tr class="odd">
<td style="text-align: center;">?</td>
<td style="text-align: left;">zero or one</td>
</tr>
<tr class="even">
<td style="text-align: center;">{m, n}</td>
<td style="text-align: left;">from m to n number of characters</td>
</tr>
<tr class="odd">
<td style="text-align: center;">^</td>
<td style="text-align: left;">start of input</td>
</tr>
<tr class="even">
<td style="text-align: center;">$</td>
<td style="text-align: left;">end of input</td>
</tr>
<tr class="odd">
<td style="text-align: center;">.</td>
<td style="text-align: left;">any single character</td>
</tr>
<tr class="even">
<td style="text-align: center;">\</td>
<td style="text-align: left;">escape a special character</td>
</tr>
<tr class="odd">
<td style="text-align: center;">[]</td>
<td style="text-align: left;">match anything inside (or)</td>
</tr>
<tr class="even">
<td style="text-align: center;">[a-z] or [0-9]</td>
<td style="text-align: left;">range of characters</td>
</tr>
<tr class="odd">
<td style="text-align: center;">[^a-za-z]</td>
<td style="text-align: left;">not those characters</td>
</tr>
<tr class="even">
<td style="text-align: center;">()</td>
<td style="text-align: left;">group these characters</td>
</tr>
<tr class="odd">
<td style="text-align: center;"></td>
<td style="text-align: left;">whitespace</td>
</tr>
<tr class="even">
<td style="text-align: center;"> digit</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;"></td>
<td style="text-align: left;">wordy (letter, digit, or _)</td>
</tr>
<tr class="even">
<td style="text-align: center;"></td>
<td style="text-align: left;">not whitespace</td>
</tr>
<tr class="odd">
<td style="text-align: center;"></td>
<td style="text-align: left;">not digit</td>
</tr>
<tr class="even">
<td style="text-align: center;"></td>
<td style="text-align: left;">not wordy</td>
</tr>
</tbody>
</table>
<h3 id="using-regex-in-javascript---aka-how-do-i-apply-this-stuff">Using Regex in JavaScript - aka How Do I Apply This Stuff?</h3>
<ul>
<li>To create a regular expression we use / at the beginning and end of the pattern</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" title="1"><span class="kw">const</span> regex <span class="op">=</span> <span class="ss">/pattern/</span><span class="op">;</span></a></code></pre></div>
<ul>
<li>Two flags that we can use at the end of our regex to make them even more powerful are <code>i</code> and <code>g</code>
<ul>
<li><code>i</code> indicates that we want our regex to be case-insensitive. We can accomplish the same thing by expanding our pattern to include either case (<code>/[Hh][Ii]/</code> instead of <code>hi</code>, for example), but this is a convenient shorthand</li>
<li><code>g</code> indicates that we want the regex to apply globally, meaning catch all matches, not just the first one. This is especially useful when we use regex in a <code>.replace()</code> function, indicating we want to change all matches.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">const</span> regex <span class="op">=</span> <span class="ss">/pattern/gi</span><span class="op">;</span></a></code></pre></div>
<ul>
<li>We can use a regex’s <code>.test()</code> method to see if a match is found within a string argument.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">const</span> pattern <span class="op">=</span> <span class="ss">/pattern/</span><span class="op">;</span></a>
<a class="sourceLine" id="cb3-2" title="2"></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="va">console</span>.<span class="at">log</span>(<span class="va">pattern</span>.<span class="at">test</span>(<span class="st">&#39;this pattern is plaid&#39;</span>))<span class="op">;</span> <span class="co">// true</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="va">console</span>.<span class="at">log</span>(<span class="va">pattern</span>.<span class="at">test</span>(<span class="st">&#39;THIS PATTERN IS PLAID&#39;</span>))<span class="op">;</span> <span class="co">// false (case-sensitive)</span></a></code></pre></div>
<ul>
<li>We can use a string’s <code>.replace()</code> method and pass in regex as the first argument in order to replace many instances of our matching pattern, no matter how complicated.</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">const</span> s <span class="op">=</span> <span class="st">&#39;An Advancing Aardvark&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">const</span> replaced <span class="op">=</span> <span class="va">s</span>.<span class="at">replace</span>(<span class="ss">/a/gi</span><span class="op">,</span> <span class="st">&#39;X&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="va">console</span>.<span class="at">log</span>(replaced)<span class="op">;</span> <span class="co">// Xn XdvXncing XXrdvXrk</span></a></code></pre></div>
<ul>
<li>The <code>.replace()</code> method can also take a callback function. The return value of the callback is what will be replaced. This allows us to change the value that is being inserted dynamically.</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">let</span> index <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="kw">const</span> s <span class="op">=</span> <span class="st">&#39;An Advancing Aardvark&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="kw">const</span> replaced <span class="op">=</span> <span class="va">s</span>.<span class="at">replace</span>(<span class="ss">/a/gi</span><span class="op">,</span> (match) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb5-4" title="4">  index <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></a>
<a class="sourceLine" id="cb5-5" title="5">  <span class="cf">return</span> index<span class="op">;</span></a>
<a class="sourceLine" id="cb5-6" title="6"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="va">console</span>.<span class="at">log</span>(replaced)<span class="op">;</span> <span class="co">// 1n 2dv3ncing 45rdv6rk</span></a></code></pre></div>
<ul>
<li>The <code>.search()</code> method of a string can take regex as an argument instead of a string, as well. It returns the starting index of the match</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">let</span> test <span class="op">=</span> [<span class="st">&#39;this&#39;</span><span class="op">,</span> <span class="st">&#39;that&#39;</span><span class="op">,</span> <span class="st">&#39;the other&#39;</span><span class="op">,</span> <span class="st">&#39;and this?&#39;</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="kw">let</span> indices <span class="op">=</span> <span class="va">test</span>.<span class="at">map</span>(<span class="kw">function</span> (e) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-3" title="3">  <span class="co">// search is returning the index that starts the match, or -1 if not found</span></a>
<a class="sourceLine" id="cb6-4" title="4">  <span class="cf">return</span> <span class="va">e</span>.<span class="at">search</span>(<span class="ss">/</span><span class="sc">(</span><span class="ss">this</span><span class="sc">)|(</span><span class="ss">that</span><span class="sc">)</span><span class="ss">/</span>)<span class="op">;</span> <span class="co">// [0, 0, -1, 4]</span></a>
<a class="sourceLine" id="cb6-5" title="5"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-6" title="6"><span class="va">console</span>.<span class="at">log</span>(indices)<span class="op">;</span></a></code></pre></div>
<h3 id="http-full-stack">HTTP Full-Stack</h3>
<ol type="1">
<li>Identify the five parts of a URL</li>
</ol>
<pre class="text"><code>  foo://example.com:8042/over/there?name=ferret#nose
  \_/   \______________/\_________/ \_________/ \__/
   |           |            |            |        |
scheme     authority       path        query   fragment</code></pre>
<ul>
<li><code>Scheme</code>: Formerly known as “protocol", tells the browser what kind of connection you are making.
    Examples would include <code>http</code>, <code>https</code>, <code>file</code>, <code>ws</code>, etc.</li>
<li><code>Authority</code>: Normally the domain name, but may include the port, such as <code>localhost:3000</code></li>
<li><code>Path</code>: The first part of an HTTP request, they indicate the location within the application. <code>https://google.com/images</code> has a path of <code>/images</code>. If no path is specified in the URL, it is assumed to be <code>/</code></li>
<li><code>Query</code>: Extra information sent to the browser for processing the request. They are URL encoded key-value pairs, with an <code>=</code> between key and value, and pairs concatenated by <code>&amp;</code>. Special characters are replaed with ASCII Code value, such as <code>$</code> being replaced with <code>%24</code>.</li>
<li><code>Fragment</code>: This part is not sent to the server; it’s used by the browser to navigate to a specific section of the page on load. Often seen when clicking a navigation link that takes to you a spot further down the page. Changing this value will not reload the page</li>
</ul>
<ol start="2" type="1">
<li>Identify at least three protocols handled by the browser</li>
</ol>
<ul>
<li>See above. <code>http</code>, <code>https</code>, and <code>file</code> have all been used in this course so far.</li>
</ul>
<ol start="3" type="1">
<li>Use an <code>IncomingMessage</code> (typically called the <code>req</code>) object to</li>
</ol>
<ul>
<li>access the headers sent by a client (like a Web browser) as part of the HTTP request</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">const</span> headers <span class="op">=</span> <span class="va">req</span>.<span class="at">headers</span><span class="op">;</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="co">// The headers are represented as a POJO with header names as keys</span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="co">// { &#39;user-agent&#39;: &#39;curl/7.22.0&#39;,</span></a>
<a class="sourceLine" id="cb8-4" title="4"><span class="co">//   host: &#39;127.0.0.1:8000&#39;,</span></a>
<a class="sourceLine" id="cb8-5" title="5"><span class="co">//   accept: &#39;*/*&#39; }</span></a></code></pre></div>
<ul>
<li>access the HTTP method of the request</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">const</span> method <span class="op">=</span> <span class="va">req</span>.<span class="at">method</span><span class="op">;</span></a>
<a class="sourceLine" id="cb9-2" title="2"><span class="co">// The headers are represented as a string such as &#39;GET&#39; or &#39;POST&#39;</span></a></code></pre></div>
<ul>
<li><p>access the path of the request</p>
<ul>
<li>If we want to work with the full path we can use <code>req.url</code></li>
</ul>
<div class="sourceCode" id="cb10"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">const</span> path <span class="op">=</span> <span class="va">req</span>.<span class="at">url</span><span class="op">;</span> <span class="co">// gives full path of request, such as &#39;/images&#39;</span></a></code></pre></div>
<ul>
<li>If we want to manipulate the path, we can use the <code>path</code> library, as well. This can be useful if we want to check the extension name that is being requested.</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">const</span> path <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;path&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-2" title="2"></a>
<a class="sourceLine" id="cb11-3" title="3"><span class="kw">const</span> server <span class="op">=</span> <span class="va">http</span>.<span class="at">createServer</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb11-4" title="4">  <span class="kw">const</span> ext <span class="op">=</span> <span class="va">path</span>.<span class="at">extname</span>(<span class="va">req</span>.<span class="at">url</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb11-5" title="5"></a>
<a class="sourceLine" id="cb11-6" title="6">  <span class="cf">if</span> (ext <span class="op">===</span> <span class="st">&#39;.jpg&#39;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb11-7" title="7">    <span class="co">// ...</span></a>
<a class="sourceLine" id="cb11-8" title="8">  <span class="op">}</span></a>
<a class="sourceLine" id="cb11-9" title="9"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div></li>
<li><p>access and read the stream of content for requests that have a body</p>
<ul>
<li>The body of a request comes in to the server in pieces, or “chunks". We’ll see this a lot when we make a <code>POST</code> request with a form. We can wait for the body to arrive and build it back up:</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb12-1" title="1"><span class="cf">if</span> (<span class="va">req</span>.<span class="at">method</span> <span class="op">===</span> <span class="st">&#39;POST&#39;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-2" title="2">  <span class="kw">let</span> bodyContent <span class="op">=</span> <span class="st">&#39;&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb12-3" title="3">  <span class="cf">for</span> <span class="cf">await</span> (<span class="kw">let</span> chunk <span class="kw">of</span> req) <span class="op">{</span></a>
<a class="sourceLine" id="cb12-4" title="4">    bodyContent <span class="op">+=</span> chunk<span class="op">;</span></a>
<a class="sourceLine" id="cb12-5" title="5">  <span class="op">}</span></a></code></pre></div>
<ul>
<li>At this point the <code>bodyContent</code> is in the form <code>key1=encoded+value+1&amp;key2=encoded+value+2</code>, etc., where key/value pairs are joined with <code>=</code>, pairs are separated with <code>&amp;</code> and the values supplied use <code>+</code> for spaces and url encoding for special characters. We can split and map over this string in order to convert it into a more user-friendly POJO (this doesn’t need to be memorized, but the process should make sense)</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb13-1" title="1"><span class="co">// bodyContent = &#39;my-input=In+this+box%3&amp;another-input=Yes%2C+this+box%2C+here.&#39;</span></a>
<a class="sourceLine" id="cb13-2" title="2"></a>
<a class="sourceLine" id="cb13-3" title="3"><span class="kw">const</span> keyValuePairs <span class="op">=</span> bodyContent</a>
<a class="sourceLine" id="cb13-4" title="4">  .<span class="at">split</span>(<span class="st">&#39;&amp;&#39;</span>) <span class="co">// [&#39;my-input=In+this+box%3&#39;, &#39;another-input=Yes%2C+this+box%2C+here.&#39;]</span></a>
<a class="sourceLine" id="cb13-5" title="5">  .<span class="at">map</span>((keyValuePair) <span class="kw">=&gt;</span> <span class="va">keyValuePair</span>.<span class="at">split</span>(<span class="st">&#39;=&#39;</span>)) <span class="co">// [[&#39;my-input&#39;, &#39;In+this+box%3&#39;], [&#39;another-input&#39;, &#39;Yes%2C+this+box%2C+here.&#39;]]</span></a>
<a class="sourceLine" id="cb13-6" title="6">  .<span class="at">map</span>(([key<span class="op">,</span> value]) <span class="kw">=&gt;</span> [key<span class="op">,</span> <span class="va">value</span>.<span class="at">replace</span>(<span class="ss">/</span><span class="sc">\+</span><span class="ss">/g</span><span class="op">,</span> <span class="st">&#39; &#39;</span>)]) <span class="co">// [[&#39;my-input&#39;, &#39;In this box%3&#39;], [&#39;another-input&#39;, &#39;Yes%2C this box%2C here.&#39;]]</span></a>
<a class="sourceLine" id="cb13-7" title="7">  .<span class="at">map</span>(([key<span class="op">,</span> value]) <span class="kw">=&gt;</span> [key<span class="op">,</span> <span class="at">decodeURIComponent</span>(value)]) <span class="co">// [[&#39;my-input&#39;, &#39;In this box?&#39;], [&#39;another-input&#39;, &#39;Yes, this box, here.&#39;]]</span></a>
<a class="sourceLine" id="cb13-8" title="8">  .<span class="at">reduce</span>((acc<span class="op">,</span> [key<span class="op">,</span> value]) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb13-9" title="9">    acc[key] <span class="op">=</span> value<span class="op">;</span> <span class="co">// { &#39;my-input&#39;: &#39;In this box?&#39;, &#39;another-input&#39;: &#39;Yes, this box, here.&#39; }</span></a>
<a class="sourceLine" id="cb13-10" title="10">    <span class="cf">return</span> acc<span class="op">;</span> <span class="co">// We have to return acc to make sure we use the updated value for the next iteration (adding in new key/value pairs for each iteration)</span></a>
<a class="sourceLine" id="cb13-11" title="11">  <span class="op">},</span> <span class="op">{}</span>)<span class="op">;</span> <span class="co">// This {} is the starting value of acc (the accumulator). It&#39;s allowing us to make a key/value pair for each inner array that we are destructuring.</span></a>
<a class="sourceLine" id="cb13-12" title="12"></a>
<a class="sourceLine" id="cb13-13" title="13"><span class="co">// keyValuePairs = { &#39;my-input&#39;: &#39;In this box?&#39;, &#39;another-input&#39;: &#39;Yes, this box, here.&#39; }</span></a></code></pre></div></li>
</ul>
<ol start="4" type="1">
<li>Use a <code>ServerResponse</code> (typically called the <code>res</code>) object to</li>
</ol>
<ul>
<li>write the status code, message, and headers for an HTTP response</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb14-1" title="1"><span class="va">res</span>.<span class="at">statusCode</span> <span class="op">=</span> <span class="dv">400</span><span class="op">;</span> <span class="co">// We can set the statusCode directly through assignment</span></a>
<a class="sourceLine" id="cb14-2" title="2"><span class="va">res</span>.<span class="at">statusMessage</span> <span class="op">=</span> <span class="st">&quot;That password doesn&#39;t match&quot;</span><span class="op">;</span> <span class="co">// We can specify a custom status message if it differs from the default related to the code</span></a>
<a class="sourceLine" id="cb14-3" title="3"><span class="va">res</span>.<span class="at">setHeader</span>(<span class="st">&#39;Content-Type&#39;</span><span class="op">,</span> <span class="st">&#39;text/plain&#39;</span>)<span class="op">;</span> <span class="co">// .setHeader(&lt;&lt;headerName&gt;&gt;, &lt;&lt;headerContent&gt;&gt;)</span></a></code></pre></div>
<ul>
<li>write the content of the body of the response</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb15-1" title="1"><span class="co">// If we have a single string to pass as the content we can give it as the argument directly to .end()</span></a>
<a class="sourceLine" id="cb15-2" title="2"><span class="va">res</span>.<span class="at">end</span>(<span class="st">&#39;NOT FOUND&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb15-3" title="3"></a>
<a class="sourceLine" id="cb15-4" title="4"><span class="co">// instead of using .end(&#39;message&#39;), we can build up our response with .write(&#39;messagePart&#39;)</span></a>
<a class="sourceLine" id="cb15-5" title="5"><span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;=</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb15-6" title="6">  <span class="va">res</span>.<span class="at">write</span>(<span class="vs">`&lt;p&gt;This is p-tag #</span><span class="sc">${</span>i<span class="sc">}</span><span class="vs">&lt;/p&gt;`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb15-7" title="7"><span class="op">}</span></a>
<a class="sourceLine" id="cb15-8" title="8"><span class="va">res</span>.<span class="at">end</span>()<span class="op">;</span></a></code></pre></div>
<ul>
<li>properly end the response to indicate to the client (like a Web browser) that all content has been written
<ul>
<li>As above, we need to include <code>.end()</code> to indicate that the content is written and can be sent back to the client. If no arguments are given, it will send what has been built up with <code>.write()</code> (if anything) as the content. If an argument is given, it will add it on before sending back that content. (A common approach would be to build up a <code>content</code> variable in the javascript above, then pass the built up result to end, with <code>res.end(content)</code>)</li>
</ul></li>
</ul>
<h2 id="express-and-pug-templates-w11d2---learning-objectives">Express and Pug Templates (W11D2) - Learning Objectives</h2>
<h3 id="express">Express</h3>
<ol type="1">
<li>Send plain text responses for any HTTP request</li>
</ol>
<ul>
<li>In order to set up express in our application, we need to package with <code>npm install express</code></li>
<li>With express installed, we can create a file that we will use to kick off our application. You’ll often see this as <code>app.js</code> or <code>index.js</code> at the top level of your server, but can be customized for the individual project.</li>
<li>In our <code>app.js</code>, we can require the express package and invoke it to create our server application:</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb16-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb16-2" title="2"></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="co">// Create the Express app.</span></a>
<a class="sourceLine" id="cb16-4" title="4"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a></code></pre></div>
<ul>
<li>The <code>app</code> object that we created here is able to respond to incoming requests by defining routes with these helpful functions:
<ul>
<li><code>get()</code> responds to HTTP GET requests</li>
<li><code>post()</code> responds to HTTP POST requests</li>
<li><code>put()</code> responds to HTTP PUT requests</li>
<li><code>delete()</code> responds to HTTP DELETE requests</li>
</ul></li>
<li>Each of these functions accepts two arguments: the route as a string or regex, as well as a callback function to define what we would like to do with the request. The format generally takes the form:
<ul>
<li><code>app.get({path}, (req, res) =&gt; {functionality})</code></li>
</ul></li>
<li>To start our app listening for traffic on a specific port, we can us the <code>app.listen({portNumber}, {successCallback})</code> function of our <code>app</code> object. We often use the callback just as a confirmation that the app started up successfully.</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb17-1" title="1"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">8081</span><span class="op">;</span></a>
<a class="sourceLine" id="cb17-2" title="2"></a>
<a class="sourceLine" id="cb17-3" title="3"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a></code></pre></div>
<ul>
<li>Now that the app is set up and we know how to create a route, responding with plain text is as easy as using the <code>res.send({text response})</code> method inside the route.</li>
</ul>
<div class="sourceCode" id="cb18"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb18-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb18-2" title="2">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Hello from Express!&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb18-3" title="3"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<ol start="2" type="1">
<li>Use pattern matching to match HTTP request paths to route handlers</li>
</ol>
<ul>
<li><p>When defining routes, express offers us some flexibility in a couple different ways.</p>
<ul>
<li>We are able to capture parameters from our routes and set up restrictions on what characters will match these parameters.</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb19-1" title="1"><span class="co">// Capturing a parameter</span></a>
<a class="sourceLine" id="cb19-2" title="2"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/product/:id&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb19-3" title="3">  <span class="va">res</span>.<span class="at">send</span>(<span class="vs">`Product ID: </span><span class="sc">${</span><span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-4" title="4"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-5" title="5"></a>
<a class="sourceLine" id="cb19-6" title="6"><span class="co">// Putting a restriction on the parameter</span></a>
<a class="sourceLine" id="cb19-7" title="7"><span class="co">// This route will only be used if what follows the /product/ is a series of numbers (the + allows for multiple characters)</span></a>
<a class="sourceLine" id="cb19-8" title="8"><span class="co">// We still capture it as a string, so it needs to be parsed into a number if it is going to be used as such in our function</span></a>
<a class="sourceLine" id="cb19-9" title="9"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/product/:id(</span><span class="sc">\\</span><span class="st">d+)&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb19-10" title="10">  <span class="kw">const</span> productId <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-11" title="11">  <span class="va">res</span>.<span class="at">send</span>(<span class="vs">`Product ID: </span><span class="sc">${</span>productId<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb19-12" title="12"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<ul>
<li>We can set up a string pattern, which is a similar concept to regex. Express sees the special characters in our string and is able to interpret patterns that match those characters.
<ul>
<li>The <code>?</code> indicates that the previous character is optional (either 0 or 1 instances will occur)</li>
<li>The <code>+</code> indicates that the previous character may be repeated (at least 1, but possibly more instances will occur)</li>
<li>The <code>*</code> indicates a wildcard. Any character and any number of characters will match.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb20"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb20-1" title="1"><span class="co">// Within the string, we can use special characters to define patterns, similar to regex.</span></a>
<a class="sourceLine" id="cb20-2" title="2"><span class="co">// The pattern below can start will any base string (because of the `*`), then must have `prod`, has an optional `u`, must have a `c`, has at least one but possibly more `t` characters, then ends with an optional `s`.</span></a>
<a class="sourceLine" id="cb20-3" title="3"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/*produ?ct+s?&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb20-4" title="4">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Products&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb20-5" title="5"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<ul>
<li>We can use actual regex to define a pattern.</li>
</ul>
<div class="sourceCode" id="cb21"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb21-1" title="1"><span class="co">// Regex allows us to be much more specific and complex with the patterns that we are matching.</span></a>
<a class="sourceLine" id="cb21-2" title="2"><span class="co">// Don&#39;t worry if this looks crazy! You would very rarely need to construct anything so complex, this is just showing the possibilities.</span></a>
<a class="sourceLine" id="cb21-3" title="3"><span class="va">app</span>.<span class="at">get</span>(<span class="ss">/</span><span class="sc">^\/((</span><span class="ss">our-</span><span class="sc">)?</span><span class="ss">produ</span><span class="sc">?</span><span class="ss">ct</span><span class="sc">{1,2}</span><span class="ss">s</span><span class="sc">?|</span><span class="ss">productos</span><span class="sc">)\/?$</span><span class="ss">/i</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb21-4" title="4">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Products&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb21-5" title="5"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<ul>
<li>We can use any combination of these in an array to provide multiple options to match.</li>
</ul>
<div class="sourceCode" id="cb22"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb22-1" title="1"><span class="co">// Our array of options can have a mixture of the previous pattern definitions, as well as multiple options of each.</span></a>
<a class="sourceLine" id="cb22-2" title="2"><span class="va">app</span>.<span class="at">get</span>([<span class="ss">/</span><span class="sc">^\/(</span><span class="ss">our-</span><span class="sc">)?</span><span class="ss">produ</span><span class="sc">?</span><span class="ss">ct</span><span class="sc">{1,2}</span><span class="ss">s</span><span class="sc">?\/?$</span><span class="ss">/i</span><span class="op">,</span> <span class="st">&#39;/productos&#39;</span>]<span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb22-3" title="3">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Products&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb22-4" title="4"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div></li>
</ul>
<ol start="3" type="1">
<li>Use the Pug template engine to generate HTML from Pug templates to send to the browser</li>
</ol>
<ul>
<li>To use pug templates in our application we can install the package with <code>npm install pug@^2.0.0</code> to install pug 2.0.</li>
<li>With pug in our application, we can tell express to use it as the view engine:</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb23-1" title="1"><span class="va">app</span>.<span class="at">set</span>(<span class="st">&#39;view engine&#39;</span><span class="op">,</span> <span class="st">&#39;pug&#39;</span>)<span class="op">;</span></a></code></pre></div>
<ul>
<li>Instead of rendering plain text with <code>send</code>, we can render a template by using <code>res.render({templateName})</code>.</li>
<li>By default, express will look in a <code>views</code> directory for each template. We can set up this folder with a <code>{templateName}.pug</code> file inside that will be rendered.</li>
</ul>
<div class="sourceCode" id="cb24"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb24-1" title="1"><span class="co">// Define a route.</span></a>
<a class="sourceLine" id="cb24-2" title="2"><span class="va">app</span>.<span class="at">all</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb24-3" title="3">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Request method: </span><span class="sc">${</span><span class="va">req</span>.<span class="at">method</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb24-4" title="4">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Request path: </span><span class="sc">${</span><span class="va">req</span>.<span class="at">path</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb24-5" title="5"></a>
<a class="sourceLine" id="cb24-6" title="6">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;layout&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb24-7" title="7"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<ul>
<li>In that <code>layout.pug</code> file used in the above demo route, we can start setting up our template.
<ul>
<li>The names of tags we would like to create are written out as plain text.</li>
<li>To nest tags, we use indentation. Spaces vs. tabs do not matter as long as we are consistent in our files.</li>
<li>The content of the tag can be written directly after the tag name</li>
</ul></li>
</ul>
<pre class="pug"><code>html
  head
    title My Awesome Title
  body
    h1 My Super Cool Heading</code></pre>
<ol start="4" type="1">
<li>Pass data to Pug templates to generate dynamic content</li>
</ol>
<ul>
<li>The <code>render()</code> method on our <code>app</code> can also take in a second argument with an object definining variables to make available within our Pug templates.</li>
</ul>
<div class="sourceCode" id="cb26"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb26-1" title="1"><span class="va">app</span>.<span class="at">all</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb26-2" title="2">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Request method: </span><span class="sc">${</span><span class="va">req</span>.<span class="at">method</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-3" title="3">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Request path: </span><span class="sc">${</span><span class="va">req</span>.<span class="at">path</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-4" title="4"></a>
<a class="sourceLine" id="cb26-5" title="5">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;layout&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Pug Template Syntax Sandbox&#39;</span><span class="op">,</span> <span class="dt">heading</span><span class="op">:</span> <span class="st">&#39;Welcome to the Sandbox!&#39;</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb26-6" title="6"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<ul>
<li>We would now be able to utilize the variables in the template file.
<ul>
<li>To use the value directly as content we can use the <code>=</code> operator for the element</li>
<li>If we want to interpolate the value within a larger string we can use Pug interpolation, which takes the form <code>My interpolated value is #{variableName}</code></li>
</ul></li>
</ul>
<pre class="pug"><code>html
  head
    title= title
  body
    h1 My heading says #{heading}</code></pre>
<ol start="5" type="1">
<li>Use the <code>Router</code> class to modularize the definition of routes</li>
</ol>
<ul>
<li>In addition to defining routes directly on the <code>app</code> instance that we created, we can create multiple routers from the <code>express.Router()</code> function and then utilize them from different base routes.</li>
<li>This functionality supports the modularity of our app. We’ll often want to break up our routes into categories, such as routes for our users vs routes for our tweets, instead of having all of our routes defined in one location.</li>
<li>When we have an instance of the <code>Router</code> we can define routes with the same <code>get()</code>, <code>post()</code>, <code>put()</code>, and <code>delete()</code> methods.</li>
</ul>
<div class="sourceCode" id="cb28"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb28-1" title="1"><span class="co">// In our main app.js file</span></a>
<a class="sourceLine" id="cb28-2" title="2"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb28-3" title="3"><span class="kw">const</span> userRoutes <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./routes/users.js&#39;</span>)<span class="op">;</span> <span class="co">// see following code block</span></a>
<a class="sourceLine" id="cb28-4" title="4"><span class="kw">const</span> tweetRoutes <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./routes/tweets.js&#39;</span>)<span class="op">;</span> <span class="co">// see following code block</span></a>
<a class="sourceLine" id="cb28-5" title="5"></a>
<a class="sourceLine" id="cb28-6" title="6"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb28-7" title="7"></a>
<a class="sourceLine" id="cb28-8" title="8"><span class="va">app</span>.<span class="at">use</span>(<span class="st">&#39;/users&#39;</span><span class="op">,</span> userRoutes)<span class="op">;</span></a>
<a class="sourceLine" id="cb28-9" title="9"><span class="va">app</span>.<span class="at">use</span>(<span class="st">&#39;/tweets&#39;</span><span class="op">,</span> tweetRoutes)<span class="op">;</span></a>
<a class="sourceLine" id="cb28-10" title="10"></a>
<a class="sourceLine" id="cb28-11" title="11"><span class="kw">const</span> port <span class="op">=</span> <span class="dv">4000</span><span class="op">;</span></a>
<a class="sourceLine" id="cb28-12" title="12"></a>
<a class="sourceLine" id="cb28-13" title="13"><span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb28-14" title="14">  <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb28-15" title="15"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb29-1" title="1"><span class="co">// In a users route file</span></a>
<a class="sourceLine" id="cb29-2" title="2"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-3" title="3"></a>
<a class="sourceLine" id="cb29-4" title="4"><span class="kw">const</span> router <span class="op">=</span> <span class="va">express</span>.<span class="at">Router</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb29-5" title="5"></a>
<a class="sourceLine" id="cb29-6" title="6"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-7" title="7">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Hello from the base user route. We got here from /users/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-8" title="8"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb29-9" title="9"></a>
<a class="sourceLine" id="cb29-10" title="10"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/:id&#39;</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb29-11" title="11">  <span class="va">res</span>.<span class="at">send</span>(<span class="vs">`This is the page for user with id </span><span class="sc">${</span><span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="sc">}</span><span class="vs">. We got here from /users/:id`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb29-12" title="12"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb29-13" title="13"></a>
<a class="sourceLine" id="cb29-14" title="14"><span class="co">// other routes, such as editing a profile, deleting a user, etc.</span></a>
<a class="sourceLine" id="cb29-15" title="15"></a>
<a class="sourceLine" id="cb29-16" title="16"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> router<span class="op">;</span></a></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb30-1" title="1"><span class="co">// In a tweets route file</span></a>
<a class="sourceLine" id="cb30-2" title="2"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-3" title="3"></a>
<a class="sourceLine" id="cb30-4" title="4"><span class="kw">const</span> router <span class="op">=</span> <span class="va">express</span>.<span class="at">Router</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb30-5" title="5"></a>
<a class="sourceLine" id="cb30-6" title="6"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/&#39;</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb30-7" title="7">  <span class="va">res</span>.<span class="at">send</span>(<span class="st">&#39;Hello from the base tweets route. We got here from /tweets/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-8" title="8"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb30-9" title="9"></a>
<a class="sourceLine" id="cb30-10" title="10"><span class="va">router</span>.<span class="at">get</span>(<span class="st">&#39;/:id&#39;</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb30-11" title="11">  <span class="va">res</span>.<span class="at">send</span>(<span class="vs">`This is the page for tweet with id </span><span class="sc">${</span><span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="sc">}</span><span class="vs">. We got here from /tweets/:id`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb30-12" title="12"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb30-13" title="13"></a>
<a class="sourceLine" id="cb30-14" title="14"><span class="co">// other routes, such as posting a tweet, editing, deleting, etc.</span></a>
<a class="sourceLine" id="cb30-15" title="15"></a>
<a class="sourceLine" id="cb30-16" title="16"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> router<span class="op">;</span></a></code></pre></div>
<h3 id="pug-templates">Pug Templates</h3>
<ol type="1">
<li>Declare HTML tags and their associated ids, classes, attributes, and content</li>
</ol>
<ul>
<li>To declare a tag, we can use the name of the tag directly in the pug file.</li>
<li>Nesting tags can be accomplished by indenting, with either spaces or tabs (just be consistent!)</li>
<li>Ids and classes can be added by attaching them to the tag name, just like they are selected in a CSS file.</li>
<li>Attributes can be given to a tag (like an href for an a tag, a src for an image, etc.) by supplying their values in parentheses:</li>
</ul>
<pre class="pug"><code>html
  head
    title My Page
  body
    div#main
      div.blue
      div.yellow
        a(href=&quot;http://google.com&quot;) Click here</code></pre>
<ol start="2" type="1">
<li>Use conditional statements to determine whether or not to render a block</li>
</ol>
<ul>
<li>Inside of our Pug files we can include some logic, allowing our template to be even more dynamic.</li>
<li>An <code>if</code> statement can be used with the condition directly following. Anything indented will only be included if the condition is true. We can similarly include an <code>else</code> as part of the condition:</li>
</ul>
<pre class="pug"><code>if isEOD
  h2 Welcome back!
else
  h2 Keep coding!

if (time &gt; 17)
  p See ya tomorrow!</code></pre>
<ol start="3" type="1">
<li>Use interpolation to mix static text and dynamic values in content and attributes</li>
</ol>
<ul>
<li>Whenever we want to interpolate a value inside our pug template’s content, we can use the <code>#{}</code> syntax.</li>
<li>It’s important to distinguish this interpolation from JavaScript string interpolation. If we were to provide strings within this template that we needed to interpolate within, such as an href attribute, we are working with JavaScript at that point and would need to use our standard <code>${}</code> within backticks to interpolate those values:</li>
</ul>
<div class="sourceCode" id="cb33"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb33-1" title="1"><span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;layout&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb33-2" title="2">  <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Pug demo page&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb33-3" title="3">  <span class="dt">header</span><span class="op">:</span> <span class="st">&#39;interpolation&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb33-4" title="4">  <span class="dt">route</span><span class="op">:</span> <span class="st">&#39;tweets&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb33-5" title="5"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<pre class="pug"><code>html
  head
    title= title
    style
      include style.css
  body
    h1 Pug does #{header}
    h2 Pug allows you to do many things
    ul
      li: a(href=&#39;http://google.com&#39;) This is a link to google.com
      li: a(href=`http://mycoolsite.com/${route}`) This is a link to my cool site&#39;s #{route} route</code></pre>
<ol start="4" type="1">
<li>Use iteration to generate multiple blocks of HTML based on data provided to the template</li>
</ol>
<ul>
<li>We can iterate through variables within our pug templates using the <code>each ... in ...</code> syntax.</li>
</ul>
<div class="sourceCode" id="cb35"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb35-1" title="1"><span class="co">// app.js</span></a>
<a class="sourceLine" id="cb35-2" title="2"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/pug&#39;</span><span class="op">,</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb35-3" title="3">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;eod&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">colors</span><span class="op">:</span> [<span class="st">&#39;blue&#39;</span><span class="op">,</span> <span class="st">&#39;red&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span>] <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb35-4" title="4"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<pre class="pug"><code>ul
  each color in colors
    li= color</code></pre>
<h2 id="html-forms-w11d3---learning-objectives">HTML Forms (W11D3) - Learning Objectives</h2>
<h3 id="html-forms">HTML Forms</h3>
<ol type="1">
<li>Describe the interaction between the client and server when an HTML form is loaded into the browser, the user submits it, and the server processes it</li>
</ol>
<ul>
<li>Below is an example of a form in regular HTML for our reference (not Pug).</li>
</ul>
<div class="sourceCode" id="cb37"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb37-1" title="1"><span class="kw">&lt;form</span><span class="ot"> action=</span><span class="st">&quot;/users&quot;</span><span class="ot"> method=</span><span class="st">&quot;post&quot;</span><span class="kw">&gt;</span></a>
<a class="sourceLine" id="cb37-2" title="2">  <span class="kw">&lt;label</span></a>
<a class="sourceLine" id="cb37-3" title="3">    <span class="kw">&gt;</span>Username:</a>
<a class="sourceLine" id="cb37-4" title="4">    <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;text&quot;</span><span class="ot"> name=</span><span class="st">&quot;user[username]&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb37-5" title="5">  <span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb37-6" title="6">  <span class="kw">&lt;label</span></a>
<a class="sourceLine" id="cb37-7" title="7">    <span class="kw">&gt;</span>Email:</a>
<a class="sourceLine" id="cb37-8" title="8">    <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;email&quot;</span><span class="ot"> name=</span><span class="st">&quot;user[email]&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb37-9" title="9">  <span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb37-10" title="10">  <span class="kw">&lt;label</span></a>
<a class="sourceLine" id="cb37-11" title="11">    <span class="kw">&gt;</span>Age:</a>
<a class="sourceLine" id="cb37-12" title="12">    <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;number&quot;</span><span class="ot"> name=</span><span class="st">&quot;user[age]&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb37-13" title="13">  <span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb37-14" title="14">  <span class="kw">&lt;label</span></a>
<a class="sourceLine" id="cb37-15" title="15">    <span class="kw">&gt;</span>Password:</a>
<a class="sourceLine" id="cb37-16" title="16">    <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;password&quot;</span><span class="ot"> name=</span><span class="st">&quot;user[password]&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb37-17" title="17">  <span class="kw">&lt;/label&gt;</span></a>
<a class="sourceLine" id="cb37-18" title="18">  <span class="kw">&lt;input</span><span class="ot"> type=</span><span class="st">&quot;submit&quot;</span><span class="ot"> value=</span><span class="st">&quot;Sign Up&quot;</span> <span class="kw">/&gt;</span></a>
<a class="sourceLine" id="cb37-19" title="19"><span class="kw">&lt;/form&gt;</span></a></code></pre></div>
<ul>
<li>The <code>action</code> attribute of the form element defines the url that the request is made to, ie what route our request is going to hit on our server.
<ul>
<li>We can use multiple formats for this url:
<ul>
<li>absolute URL: A complete url path such as https://www.wellsfargo.com/transfers</li>
<li>relative URL: Just providing a route will send the request to the same domain that we are one. Using <code>/users</code> when we are running on localhost in development will send the request to localhost:3000/users</li>
<li>no URL - form will be sent to the same page(url) the form is present on</li>
</ul></li>
</ul></li>
<li>The <code>method</code> attribute defines the HTTP verb that will be used with the request (‘GET’ or ‘POST’)
<ul>
<li>If the <code>POST</code> method is used, form data is appended to the body of the HTTP request.</li>
<li>Only the <code>GET</code> and <code>POST</code> methods may be specified on the form. In order to do <code>PUT</code>, <code>DELETE</code>, or other methods, we must use <code>AJAX</code> requests using the <code>fetch</code> API, for example.</li>
</ul></li>
<li>The server receives a string that will be parsed in order to get the data as a list of key/value pairs.
<ul>
<li>The <code>name</code> attribute of each input is used as the key, with the value of the input used value in the key/value pair.</li>
<li>We can create nested objects within the parsed data by providing a name format <code>outerKey[innerKey]</code>. When this is parsed by express (see LO 3 and 4 below), we end up with a a nested <code>req.body</code>. From the example above we would see:</li>
</ul>
<div class="sourceCode" id="cb38"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb38-1" title="1"><span class="va">console</span>.<span class="at">log</span>(<span class="va">req</span>.<span class="at">body</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb38-2" title="2"><span class="co">/*</span></a>
<a class="sourceLine" id="cb38-3" title="3"><span class="co">{</span></a>
<a class="sourceLine" id="cb38-4" title="4"><span class="co">  user: {</span></a>
<a class="sourceLine" id="cb38-5" title="5"><span class="co">    username: _value_,</span></a>
<a class="sourceLine" id="cb38-6" title="6"><span class="co">    email: _value_,</span></a>
<a class="sourceLine" id="cb38-7" title="7"><span class="co">    age: _value_,</span></a>
<a class="sourceLine" id="cb38-8" title="8"><span class="co">    password: _value_</span></a>
<a class="sourceLine" id="cb38-9" title="9"><span class="co">  }</span></a>
<a class="sourceLine" id="cb38-10" title="10"><span class="co">}</span></a>
<a class="sourceLine" id="cb38-11" title="11"><span class="co">*/</span></a></code></pre></div>
<ul>
<li>This could be extra helpful if we have multiple categories of information in the form we are submitting and want to have a way to easily distinguish between them.</li>
</ul></li>
</ul>
<ol start="2" type="1">
<li>Create an HTML form using the Pug template engine</li>
</ol>
<ul>
<li>We can translate the above form into Pug fairly directly.</li>
<li>Any attributes that we would include on an HTML tag would be included in parentheses in the template, with nested tags being indented.</li>
<li>We’ve added some functionality in this example by including the hidden input for our csrf token (See LO 8) as well as providing values for our inputs. The values will help us retain content when a user sends an incorrectly filled out form instead of sending back a blank form and losing their input. Notice no <code>value</code> is used for password because we always want the user to type in that information.</li>
</ul>
<pre class="pug"><code>form(method=&quot;post&quot; action=&quot;/users&quot;)
  input(type=&quot;hidden&quot; name=&quot;_csrf&quot; value=csrfToken)
  label(for=&quot;user[username]&quot;) Username:
    input(type=&quot;username&quot; id=&quot;username&quot; name=&quot;username&quot; value=username)
  label(for=&quot;user[email]&quot;) Email:
    input(type=&quot;email&quot; id=&quot;email&quot; name=&quot;email&quot; value=email)
  label(for=&quot;user[age]&quot;) Age:
    input(type=&quot;age&quot; id=&quot;age&quot; name=&quot;user[age]&quot; value=age)
  label(for=&quot;user[password]&quot;) Password:
    input(type=&quot;password&quot; id=&quot;password&quot; name=&quot;user[password]&quot;)
  input(type=&quot;submit&quot; value=&quot;Sign Up&quot;)</code></pre>
<ol start="3" type="1">
<li>Use express to handle a form’s POST request</li>
</ol>
<ul>
<li>In the ‘POST’ route, we can check that our user’s input passes all of our data validation checks, then, if successful, create a new record for that user within our database. (In the project for today we just added an object into an array to simulate this process.)</li>
<li>After we create our new record, we can redirect the user to another page. In this example, we are redirecting to our root page, but we could have redirected to a user page, an index, a welcome page, etc.</li>
</ul>
<div class="sourceCode" id="cb40"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb40-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/create&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb40-2" title="2">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;create&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb40-3" title="3">    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Create a user&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb40-4" title="4">    <span class="dt">errors</span><span class="op">:</span> []<span class="op">,</span></a>
<a class="sourceLine" id="cb40-5" title="5">    <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb40-6" title="6">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-7" title="7"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-8" title="8"></a>
<a class="sourceLine" id="cb40-9" title="9"><span class="va">app</span>.<span class="at">post</span>(<span class="vs">`/users`</span><span class="op">,</span> csrfProtection<span class="op">,</span> checkFields<span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb40-10" title="10">  <span class="kw">const</span> <span class="op">{</span> username<span class="op">,</span> email<span class="op">,</span> age<span class="op">,</span> password <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="va">body</span>.<span class="at">user</span><span class="op">;</span></a>
<a class="sourceLine" id="cb40-11" title="11"></a>
<a class="sourceLine" id="cb40-12" title="12">  <span class="co">// Our errors attribute was created by our checkFields middleware</span></a>
<a class="sourceLine" id="cb40-13" title="13">  <span class="co">// If we had errors, we&#39;re rendering the &#39;create&#39; form again, passing along the errors as well as the user data so that we can prepopulate those fields with the values that were originally submitted</span></a>
<a class="sourceLine" id="cb40-14" title="14">  <span class="cf">if</span> (<span class="va">req</span>.<span class="va">errors</span>.<span class="at">length</span> <span class="op">&gt;=</span> <span class="dv">1</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb40-15" title="15">    <span class="va">res</span>.<span class="at">render</span>(<span class="vs">`create`</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb40-16" title="16">      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Create a user&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb40-17" title="17">      <span class="dt">errors</span><span class="op">:</span> <span class="va">req</span>.<span class="at">errors</span><span class="op">,</span></a>
<a class="sourceLine" id="cb40-18" title="18">      username<span class="op">,</span></a>
<a class="sourceLine" id="cb40-19" title="19">      email<span class="op">,</span></a>
<a class="sourceLine" id="cb40-20" title="20">      age<span class="op">,</span></a>
<a class="sourceLine" id="cb40-21" title="21">      <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb40-22" title="22">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-23" title="23">    <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb40-24" title="24">  <span class="op">}</span></a>
<a class="sourceLine" id="cb40-25" title="25"></a>
<a class="sourceLine" id="cb40-26" title="26">  <span class="cf">await</span> <span class="va">User</span>.<span class="at">create</span>(<span class="op">{</span> username<span class="op">,</span> email<span class="op">,</span> age<span class="op">,</span> password <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-27" title="27"></a>
<a class="sourceLine" id="cb40-28" title="28">  <span class="va">res</span>.<span class="at">redirect</span>(<span class="vs">`/`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb40-29" title="29"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<ol start="4" type="1">
<li>Use the built-in <code>express.urlencoded()</code> middleware function to parse incoming request body form data</li>
</ol>
<ul>
<li>The express middleware <code>urlencoded</code> comes with the express library, we just need to tell our app to use it on all requests.</li>
<li>Invoking <code>app.use({middlewareFunction})</code> will set up all requests to pass through this function.</li>
<li>The <code>urlencoded</code> function will decode the body of our form post requests, allowing our routes to access the <code>req.body</code> property with each field as a property on this object.</li>
<li>The <code>extended: true</code> is a newer parsing library compared to leaving it off or false, which allows for objects and arrays to be encoded. We’ll always want to use this (you’ll most likely see warnings in your terminal if you leave it off).</li>
</ul>
<div class="sourceCode" id="cb41"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb41-1" title="1"><span class="va">app</span>.<span class="at">use</span>(</a>
<a class="sourceLine" id="cb41-2" title="2">  <span class="va">express</span>.<span class="at">urlencoded</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb41-3" title="3">    <span class="dt">extended</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></a>
<a class="sourceLine" id="cb41-4" title="4">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb41-5" title="5">)<span class="op">;</span></a></code></pre></div>
<ol start="5" type="1">
<li>Explain what data validation is and why it’s necessary for the server to validate incoming data</li>
</ol>
<ul>
<li>Data validation is the process of ensuring that the incoming data is correct.</li>
<li>This could mean anything related to the format or content of the data such as:
<ul>
<li>the type of data (is this actually a number?)</li>
<li>the value makes sense (is the age a positive number?)</li>
<li>length of content (is the password at least 8 characters long?)</li>
<li>etc.</li>
</ul></li>
<li>Even though you could add add validations on the client side, client-side validations are not as secure and can be circumvented. We could send a postman request to our server’s routes, for example, and not utilize our client-side application at all.</li>
<li>Because client-side validations can be circumvented, it’s necessary to implement server-side data validations as well.</li>
<li>Handling bad request data in our route handlers allows us to return 400 level messages with appropriate messaging to allow the user to correct their bad request.</li>
<li>If we didn’t have data validations on our server and allowed the bad data to go all the way to the database, the system would return a the generic “500: Internal Server Error", which is not helpful for the user.</li>
</ul>
<ol start="6" type="1">
<li>Validate user-provided data from within an Express route handler function</li>
</ol>
<ul>
<li>Before we attempt to create a record for this new user, we can verify that the information submitted by the user exists, is in a valid format, etc.</li>
<li>If anything is outside of our expectation, we can handle the request differently (rendering the form again, displaying errors, etc.) as opposed to if the information is valid (where we would typically want to redirect the user to a new page).</li>
</ul>
<div class="sourceCode" id="cb42"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb42-1" title="1"><span class="va">app</span>.<span class="at">post</span>(<span class="st">&#39;/create&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb42-2" title="2">  <span class="kw">const</span> <span class="op">{</span> username<span class="op">,</span> email<span class="op">,</span> age<span class="op">,</span> password<span class="op">,</span> confirmedPassword <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb42-3" title="3">  <span class="kw">const</span> errors <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb42-4" title="4"></a>
<a class="sourceLine" id="cb42-5" title="5">  <span class="cf">if</span> (<span class="op">!</span>username) <span class="op">{</span></a>
<a class="sourceLine" id="cb42-6" title="6">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&#39;Please provide a username.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb42-7" title="7">  <span class="op">}</span></a>
<a class="sourceLine" id="cb42-8" title="8"></a>
<a class="sourceLine" id="cb42-9" title="9">  <span class="cf">if</span> (<span class="op">!</span>email) <span class="op">{</span></a>
<a class="sourceLine" id="cb42-10" title="10">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&#39;Please provide an email.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb42-11" title="11">  <span class="op">}</span></a>
<a class="sourceLine" id="cb42-12" title="12"></a>
<a class="sourceLine" id="cb42-13" title="13">  <span class="cf">if</span> (<span class="op">!</span>age) <span class="op">{</span></a>
<a class="sourceLine" id="cb42-14" title="14">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&#39;Please provide an age.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb42-15" title="15">  <span class="op">}</span></a>
<a class="sourceLine" id="cb42-16" title="16"></a>
<a class="sourceLine" id="cb42-17" title="17">  <span class="kw">const</span> ageAsNum <span class="op">=</span> <span class="va">Number</span>.<span class="at">parseInt</span>(age<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb42-18" title="18"></a>
<a class="sourceLine" id="cb42-19" title="19">  <span class="cf">if</span> (age <span class="op">&amp;&amp;</span> (ageAsNum <span class="op">&lt;</span> <span class="dv">0</span> <span class="op">||</span> ageAsNum <span class="op">&gt;</span> <span class="dv">120</span>)) <span class="op">{</span></a>
<a class="sourceLine" id="cb42-20" title="20">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&#39;Please provide an age between 0 and 120&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb42-21" title="21">  <span class="op">}</span></a>
<a class="sourceLine" id="cb42-22" title="22"></a>
<a class="sourceLine" id="cb42-23" title="23">  <span class="cf">if</span> (<span class="op">!</span>password) <span class="op">{</span></a>
<a class="sourceLine" id="cb42-24" title="24">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&#39;Please provide a password.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb42-25" title="25">  <span class="op">}</span></a>
<a class="sourceLine" id="cb42-26" title="26"></a>
<a class="sourceLine" id="cb42-27" title="27">  <span class="cf">if</span> (password <span class="op">&amp;&amp;</span> password <span class="op">!==</span> confirmedPassword) <span class="op">{</span></a>
<a class="sourceLine" id="cb42-28" title="28">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&#39;The provided values for the password and password confirmation fields did not match.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb42-29" title="29">  <span class="op">}</span></a>
<a class="sourceLine" id="cb42-30" title="30"></a>
<a class="sourceLine" id="cb42-31" title="31">  <span class="cf">if</span> (<span class="va">errors</span>.<span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb42-32" title="32">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;create&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb42-33" title="33">      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Create a user&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb42-34" title="34">      username<span class="op">,</span></a>
<a class="sourceLine" id="cb42-35" title="35">      email<span class="op">,</span></a>
<a class="sourceLine" id="cb42-36" title="36">      age<span class="op">,</span></a>
<a class="sourceLine" id="cb42-37" title="37">      <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb42-38" title="38">      errors<span class="op">,</span></a>
<a class="sourceLine" id="cb42-39" title="39">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb42-40" title="40">    <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb42-41" title="41">  <span class="op">}</span></a>
<a class="sourceLine" id="cb42-42" title="42"></a>
<a class="sourceLine" id="cb42-43" title="43">  <span class="kw">const</span> newUser <span class="op">=</span> <span class="cf">await</span> <span class="va">User</span>.<span class="at">create</span>(<span class="op">{</span> username<span class="op">,</span> email<span class="op">,</span> age<span class="op">,</span> password <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb42-44" title="44">  <span class="va">res</span>.<span class="at">redirect</span>(<span class="vs">`/user/</span><span class="sc">${</span><span class="va">newUser</span>.<span class="at">id</span><span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb42-45" title="45"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<ol start="7" type="1">
<li>Write a custom middleware function that validates user-provided data</li>
</ol>
<ul>
<li>Separating out the validation of our inputs into its own middleware allows us to reuse this functionality for multiple routes.</li>
<li>When writing middleware, we take in the request, response, and a reference to the <code>next</code> function, which express is going to utilize to set up our chain of functions to invoke.</li>
<li>Our middleware can interact with and modify our request and response objects however we like. For validating user input, it’s convenient for us to be able to add in custom error messages to our request object if any of the data does not match our expectations. That way our routes can check to see if any of these errors occurred and respond appropriately.</li>
<li>After implementing the functionality of our middleware, we invoke the <code>next</code> function in order to continue the middleware chain. I like to think of this as similar to invoking the <code>resolve</code> function of a Promise when the functionality we are implementing is complete.</li>
</ul>
<div class="sourceCode" id="cb43"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb43-1" title="1"><span class="kw">const</span> validationMiddleware <span class="op">=</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb43-2" title="2">  <span class="kw">const</span> <span class="op">{</span> username<span class="op">,</span> email<span class="op">,</span> age<span class="op">,</span> password<span class="op">,</span> confirmedPassword <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb43-3" title="3">  <span class="kw">const</span> ageAsNum <span class="op">=</span> <span class="va">Number</span>.<span class="at">parseInt</span>(age<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb43-4" title="4">  <span class="kw">const</span> errors <span class="op">=</span> []<span class="op">;</span></a>
<a class="sourceLine" id="cb43-5" title="5"></a>
<a class="sourceLine" id="cb43-6" title="6">  <span class="cf">if</span> (<span class="op">!</span>username) <span class="op">{</span></a>
<a class="sourceLine" id="cb43-7" title="7">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&#39;Please provide a username.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb43-8" title="8">  <span class="op">}</span></a>
<a class="sourceLine" id="cb43-9" title="9"></a>
<a class="sourceLine" id="cb43-10" title="10">  <span class="cf">if</span> (<span class="op">!</span>email) <span class="op">{</span></a>
<a class="sourceLine" id="cb43-11" title="11">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&#39;Please provide an email.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb43-12" title="12">  <span class="op">}</span></a>
<a class="sourceLine" id="cb43-13" title="13"></a>
<a class="sourceLine" id="cb43-14" title="14">  <span class="cf">if</span> (<span class="op">!</span>age) <span class="op">{</span></a>
<a class="sourceLine" id="cb43-15" title="15">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&#39;Please provide an age.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb43-16" title="16">  <span class="op">}</span></a>
<a class="sourceLine" id="cb43-17" title="17"></a>
<a class="sourceLine" id="cb43-18" title="18">  <span class="cf">if</span> (age <span class="op">&amp;&amp;</span> (ageAsNum <span class="op">&lt;</span> <span class="dv">0</span> <span class="op">||</span> ageAsNum <span class="op">&gt;</span> <span class="dv">120</span>)) <span class="op">{</span></a>
<a class="sourceLine" id="cb43-19" title="19">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&#39;Please provide an age between 0 and 120&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb43-20" title="20">  <span class="op">}</span></a>
<a class="sourceLine" id="cb43-21" title="21"></a>
<a class="sourceLine" id="cb43-22" title="22">  <span class="cf">if</span> (<span class="op">!</span>password) <span class="op">{</span></a>
<a class="sourceLine" id="cb43-23" title="23">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&#39;Please provide a password.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb43-24" title="24">  <span class="op">}</span></a>
<a class="sourceLine" id="cb43-25" title="25"></a>
<a class="sourceLine" id="cb43-26" title="26">  <span class="cf">if</span> (password <span class="op">&amp;&amp;</span> password <span class="op">!==</span> confirmedPassword) <span class="op">{</span></a>
<a class="sourceLine" id="cb43-27" title="27">    <span class="va">errors</span>.<span class="at">push</span>(<span class="st">&#39;The provided values for the password and password confirmation fields did not match.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb43-28" title="28">  <span class="op">}</span></a>
<a class="sourceLine" id="cb43-29" title="29"></a>
<a class="sourceLine" id="cb43-30" title="30">  <span class="va">req</span>.<span class="at">errors</span> <span class="op">=</span> errors<span class="op">;</span></a>
<a class="sourceLine" id="cb43-31" title="31">  <span class="at">next</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb43-32" title="32"><span class="op">};</span></a></code></pre></div>
<ul>
<li>With this function written, we can pass it as middleware to any route that requires it.</li>
<li>With the validations being run, we can then interact with the <code>req.errors</code> array that our middleware created.</li>
</ul>
<div class="sourceCode" id="cb44"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb44-1" title="1"><span class="va">app</span>.<span class="at">post</span>(<span class="st">&#39;/create&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> validationMiddleware<span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb44-2" title="2">  <span class="kw">const</span> <span class="op">{</span> firstName<span class="op">,</span> lastName<span class="op">,</span> email<span class="op">,</span> password<span class="op">,</span> confirmedPassword <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb44-3" title="3">  <span class="kw">const</span> errors <span class="op">=</span> <span class="va">req</span>.<span class="at">errors</span><span class="op">;</span></a>
<a class="sourceLine" id="cb44-4" title="4"></a>
<a class="sourceLine" id="cb44-5" title="5">  <span class="cf">if</span> (<span class="va">errors</span>.<span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb44-6" title="6">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;create&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb44-7" title="7">      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Create a user&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb44-8" title="8">      username<span class="op">,</span></a>
<a class="sourceLine" id="cb44-9" title="9">      email<span class="op">,</span></a>
<a class="sourceLine" id="cb44-10" title="10">      age<span class="op">,</span></a>
<a class="sourceLine" id="cb44-11" title="11">      <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb44-12" title="12">      errors<span class="op">,</span></a>
<a class="sourceLine" id="cb44-13" title="13">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb44-14" title="14">    <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb44-15" title="15">  <span class="op">}</span></a>
<a class="sourceLine" id="cb44-16" title="16"></a>
<a class="sourceLine" id="cb44-17" title="17">  <span class="cf">await</span> <span class="va">User</span>.<span class="at">create</span>(<span class="op">{</span> username<span class="op">,</span> email<span class="op">,</span> age<span class="op">,</span> password <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb44-18" title="18">  <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb44-19" title="19"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<ol start="8" type="1">
<li>Use the csurf middleware to embed a token value in forms to protect against Cross-Site Request Forgery exploits</li>
</ol>
<ul>
<li>To set up CSRF protection, we want to utilize two tools: the <code>csurf</code> library and the <code>cookie-parser</code> library (since we’ll use cookies for our csrf protection implementation)</li>
<li>Once pulled in to our main file, we can create a csrfProtection middleware as well as tell our app to use the cookie parser:</li>
</ul>
<div class="sourceCode" id="cb45"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb45-1" title="1"><span class="va">app</span>.<span class="at">use</span>(<span class="at">cookieParser</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb45-2" title="2"><span class="kw">const</span> csrfProtection <span class="op">=</span> <span class="at">csrf</span>(<span class="op">{</span> <span class="dt">cookie</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<ul>
<li>Creating the middleware function is not enough to implement csrf protection. Anywhere that requires us to create or submit forms we need to utilize the middleware within the route. We do this by passing it as an argument to our <code>app.get</code> or <code>app.post</code> function calls.</li>
<li>When creating our forms, we want to be able to provide a <code>_csrf</code> input field, hidden from the user.</li>
<li>The value that we supply to this field is obtained from invoking our <code>req.csrfToken()</code> function that was created for us from the middleware.</li>
<li>The middleware is also supplied to the ‘POST’ routes that respond to these submissions in order to check that the token was actually created by our application.</li>
</ul>
<div class="sourceCode" id="cb46"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb46-1" title="1"><span class="kw">const</span> express <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-2" title="2"><span class="kw">const</span> cookieParser <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;cookie-parser&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-3" title="3"><span class="kw">const</span> csrf <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;csurf&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-4" title="4"></a>
<a class="sourceLine" id="cb46-5" title="5"><span class="kw">const</span> <span class="op">{</span> User <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./models&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-6" title="6"></a>
<a class="sourceLine" id="cb46-7" title="7"><span class="kw">const</span> app <span class="op">=</span> <span class="at">express</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb46-8" title="8"></a>
<a class="sourceLine" id="cb46-9" title="9"><span class="kw">const</span> port <span class="op">=</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">PORT</span> <span class="op">||</span> <span class="dv">3000</span><span class="op">;</span></a>
<a class="sourceLine" id="cb46-10" title="10"></a>
<a class="sourceLine" id="cb46-11" title="11"><span class="kw">const</span> csrfProtection <span class="op">=</span> <span class="at">csrf</span>(<span class="op">{</span> <span class="dt">cookie</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-12" title="12"></a>
<a class="sourceLine" id="cb46-13" title="13"><span class="va">app</span>.<span class="at">use</span>(<span class="at">cookieParser</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb46-14" title="14"><span class="va">app</span>.<span class="at">use</span>(<span class="va">express</span>.<span class="at">urlencoded</span>(<span class="op">{</span> <span class="dt">extended</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb46-15" title="15"><span class="va">app</span>.<span class="at">set</span>(<span class="st">&#39;view engine&#39;</span><span class="op">,</span> <span class="st">&#39;pug&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-16" title="16"></a>
<a class="sourceLine" id="cb46-17" title="17"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;/create&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb46-18" title="18">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;create&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb46-19" title="19">    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Create a user&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb46-20" title="20">    <span class="dt">messages</span><span class="op">:</span> []<span class="op">,</span></a>
<a class="sourceLine" id="cb46-21" title="21">    <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb46-22" title="22">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-23" title="23"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-24" title="24"></a>
<a class="sourceLine" id="cb46-25" title="25"><span class="va">app</span>.<span class="at">post</span>(<span class="st">&#39;/create&#39;</span><span class="op">,</span> csrfProtection<span class="op">,</span> validationMiddleware<span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb46-26" title="26">  <span class="kw">const</span> <span class="op">{</span> username<span class="op">,</span> email<span class="op">,</span> password <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb46-27" title="27">  <span class="kw">const</span> errors <span class="op">=</span> <span class="va">req</span>.<span class="at">errors</span><span class="op">;</span></a>
<a class="sourceLine" id="cb46-28" title="28"></a>
<a class="sourceLine" id="cb46-29" title="29">  <span class="cf">if</span> (<span class="va">errors</span>.<span class="at">length</span> <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb46-30" title="30">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;create&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb46-31" title="31">      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Create a user&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb46-32" title="32">      username<span class="op">,</span></a>
<a class="sourceLine" id="cb46-33" title="33">      email<span class="op">,</span></a>
<a class="sourceLine" id="cb46-34" title="34">      age<span class="op">,</span></a>
<a class="sourceLine" id="cb46-35" title="35">      <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb46-36" title="36">      errors<span class="op">,</span></a>
<a class="sourceLine" id="cb46-37" title="37">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-38" title="38">    <span class="cf">return</span><span class="op">;</span></a>
<a class="sourceLine" id="cb46-39" title="39">  <span class="op">}</span></a>
<a class="sourceLine" id="cb46-40" title="40"></a>
<a class="sourceLine" id="cb46-41" title="41">  <span class="cf">await</span> <span class="va">User</span>.<span class="at">create</span>(<span class="op">{</span> username<span class="op">,</span> email<span class="op">,</span> age<span class="op">,</span> password <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-42" title="42">  <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb46-43" title="43"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<ul>
<li>The Pug files that create thes forms can simply create a hidden input field:</li>
</ul>
<pre class="pug"><code>// Other content before the form
form(action=&#39;/create&#39; method=&#39;post&#39;)
  input(type=&#39;hidden&#39; name=&quot;_csrf&quot; value=csrfToken)
  div(class=&quot;form-group&quot;)
    label(for=&#39;username&#39;) Username:
    input(id=&#39;username&#39; class=&quot;form-control&quot; name=&#39;username&#39; value=username type=&#39;text&#39;)
  // Other form fields
  div
    input(type=&#39;submit&#39; value=&quot;Create User&quot; class=&#39;btn btn-primary&#39;)</code></pre>
<h2 id="full-stack-data-driven-web-sites-w11d4---learning-objectives">Full-Stack (Data-Driven Web Sites) (W11D4) - Learning Objectives</h2>
<h3 id="data-driven-web-sites">Data-Driven Web Sites</h3>
<ol type="1">
<li>Use environment variables to specify configuration of or provide sensitive information for your code</li>
</ol>
<ul>
<li>We can specify environment variables in the command line or script by setting them before the command we are running:
<ul>
<li><code>PORT=8080 node app.js</code> in the terminal</li>
<li><code>"start": "PORT=8080 node app.js"</code> in our scripts</li>
</ul></li>
<li>In our app, we can use <code>process.env.VARIABLE_NAME</code> to access any environment variables that have been set.</li>
<li><p>We can also create a <code>.env</code> file to store all of our variables in one location. In order to access these variables, we use the <code>dotenv</code> package (see LO #2)</p>
<pre><code>PORT=8080
DB_NAME=cool_app
DB_USER=cool_app_user
DB_PASSWORD=cool_app_user_password</code></pre></li>
</ul>
<ol start="2" type="1">
<li>Use the <code>dotenv</code> npm package to load environment variables defined in an <code>.env</code> file</li>
</ol>
<ul>
<li>Adding the <code>dotenv</code> package to our project gives us three ways to load environment variables.
<ol type="1">
<li>In our app, we can require the <code>dotenv</code> package and invoke its <code>configure</code> method. Any point after this configuration will have access to environment variables defined in <code>.env</code>:</li>
</ol>
<div class="sourceCode" id="cb49"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb49-1" title="1"><span class="at">require</span>(<span class="st">&#39;dotenv&#39;</span>).<span class="at">config</span>()<span class="op">;</span></a></code></pre></div>
<ol start="2" type="1">
<li>When starting our application, either in the terminal directly or in a script, we can use <code>node</code> or <code>nodemon</code>’s <code>-r</code> flag to indicate we want to require a package at the very start. By requiring <code>dotenv/config</code>, we can omit the line above from our application code.</li>
</ol>
<ul>
<li><code>"start": "nodemon -r dotenv/config app.js"</code></li>
</ul>
<ol start="3" type="1">
<li>Similar to how <code>sequelize-cli</code> allows us to run sequelize commands in the command line, we can install <code>dotenv-cli</code> to our project with <code>npm install dotenv-cli</code> and then use <code>dotenv</code> before our commands that need to utilize these variables:</li>
</ol>
<ul>
<li><code>npx dotenv sequelize-cli db:migrate</code></li>
</ul></li>
</ul>
<ol start="3" type="1">
<li>Recall that Express cannot process unhandled Promise rejections from within route handler (or middleware) functions.</li>
</ol>
<ul>
<li>If an error is thrown in a synchronous route handler or middleware, it will be caught by express error handlers and an error message will be sent back to the client.</li>
<li>For asynchronous functions, unhandled rejected promises (errors not caught by a <code>catch</code> block or <code>catch</code> method in a promise chain) will not be handled by the error handlers. The server will not send a response back and the client’s browser will hang. We need to catch the error and pass it along to the error handlers in order for the standard error-handling functionality to occur.</li>
</ul>
<ol start="4" type="1">
<li>Use a Promise catch block or a <code>try</code>/<code>catch</code> statement with <code>async</code>/<code>await</code> to properly handle errors thrown from within an asynchronous route handler (or middleware) function</li>
</ol>
<ul>
<li>To catch asynchronous errors, we’ve seen that we can use a <code>try</code>/<code>catch</code> block when using the <code>async</code>/<code>await</code> syntax, or we can chain a <code>.catch</code> on to a Promise directly.</li>
<li>With express, we can indicate that an error has occurred by invoking the <code>next</code> function with an argument. The argument is the error that has occurred from our asynchronous code.</li>
<li>Using our <code>try</code>/<code>catch</code> syntax:</li>
</ul>
<div class="sourceCode" id="cb50"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb50-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb50-2" title="2">  <span class="co">// we specify an async function and capture the &#39;next&#39; parameter</span></a>
<a class="sourceLine" id="cb50-3" title="3">  <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb50-4" title="4">    <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> <span class="at">someAsynchronousFunction</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb50-5" title="5">    <span class="va">res</span>.<span class="at">send</span>(result)<span class="op">;</span></a>
<a class="sourceLine" id="cb50-6" title="6">  <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb50-7" title="7">    <span class="co">// If an error occurs in the above try block, it is captured as err</span></a>
<a class="sourceLine" id="cb50-8" title="8">    <span class="at">next</span>(err)<span class="op">;</span> <span class="co">// The err variable that we captured is passed to next so that error handlers can interact with it</span></a>
<a class="sourceLine" id="cb50-9" title="9">  <span class="op">}</span></a>
<a class="sourceLine" id="cb50-10" title="10"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<ul>
<li>Using our Promise chains:</li>
</ul>
<div class="sourceCode" id="cb51"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb51-1" title="1"><span class="va">app</span>.<span class="at">get</span>(<span class="st">&#39;*&#39;</span><span class="op">,</span> <span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb51-2" title="2">  <span class="at">someAsyncFunction</span>()</a>
<a class="sourceLine" id="cb51-3" title="3">    .<span class="at">then</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb51-4" title="4">      <span class="co">// Assume some command is here that throws an error</span></a>
<a class="sourceLine" id="cb51-5" title="5">    <span class="op">}</span>)</a>
<a class="sourceLine" id="cb51-6" title="6">    .<span class="at">catch</span>((err) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb51-7" title="7">      <span class="co">// We catch it here to make express happy</span></a>
<a class="sourceLine" id="cb51-8" title="8">      <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-9" title="9">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb51-10" title="10"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<ol start="5" type="1">
<li>Write a wrapper function to simplify catching errors thrown within asynchronous route handler (or middleware) functions</li>
</ol>
<ul>
<li><p>The process of wrapping our asynchronous handlers in <code>try</code>/<code>catch</code> blocks is so common that we will often create a helper wrapper function in order to DRY up our code. It also makes the route handlers that we create look more similar to the synchronous ones that we are used to:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb52-1" title="1"><span class="kw">const</span> asyncHandler <span class="op">=</span> (handler) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb52-2" title="2">  <span class="cf">return</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb52-3" title="3">    <span class="cf">return</span> <span class="at">handler</span>(req<span class="op">,</span> res<span class="op">,</span> next).<span class="at">catch</span>((err) <span class="kw">=&gt;</span> <span class="at">next</span>(err))<span class="op">;</span></a>
<a class="sourceLine" id="cb52-4" title="4">  <span class="op">};</span></a>
<a class="sourceLine" id="cb52-5" title="5"><span class="op">};</span></a>
<a class="sourceLine" id="cb52-6" title="6"></a>
<a class="sourceLine" id="cb52-7" title="7"><span class="co">// We are utilizing ES6 implicit returns of single-line =&gt; functions to shrink this to one line.</span></a>
<a class="sourceLine" id="cb52-8" title="8"><span class="co">// This can be a little confusing, so you&#39;ll still often see the above implementatin.</span></a>
<a class="sourceLine" id="cb52-9" title="9"><span class="co">// THIS IS THE SAME AS THE ABOVE FUNCTION! Just a different structure.</span></a>
<a class="sourceLine" id="cb52-10" title="10"><span class="kw">const</span> asyncHandler <span class="op">=</span> (handler) <span class="kw">=&gt;</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="at">handler</span>(req<span class="op">,</span> res<span class="op">,</span> next).<span class="at">catch</span>(next)<span class="op">;</span></a>
<a class="sourceLine" id="cb52-11" title="11"></a>
<a class="sourceLine" id="cb52-12" title="12"><span class="co">// By wrapping our normal route handler in the custom asyncHandler that we created, we don&#39;t have to worry about writing try/catch blocks or chaining .catch onto promises for all of our different routes</span></a>
<a class="sourceLine" id="cb52-13" title="13"><span class="va">app</span>.<span class="at">get</span>(</a>
<a class="sourceLine" id="cb52-14" title="14">  <span class="st">&#39;*&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb52-15" title="15">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb52-16" title="16">    <span class="co">// our asyncHandler is returning the function that invokes our handler defined here, with the addition of the catch method and invocation of next(err) if an error occurs</span></a>
<a class="sourceLine" id="cb52-17" title="17">    <span class="kw">const</span> result <span class="op">=</span> <span class="cf">await</span> <span class="at">someAsynchronousFunction</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb52-18" title="18">    <span class="va">res</span>.<span class="at">send</span>(result)<span class="op">;</span></a>
<a class="sourceLine" id="cb52-19" title="19">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb52-20" title="20">)<span class="op">;</span></a></code></pre></div></li>
</ul>
<ol start="6" type="1">
<li>Use the <code>morgan</code> npm package to log requests to the terminal window to assist with auditing and debugging</li>
</ol>
<ul>
<li>Adding the <code>morgan</code> package lets us log the requests that hit our server. The <code>dev</code> format specifies the HTTP method/verb, the path, status code, response time, and content length of the response.</li>
<li><p><code>npm install morgan</code></p>
<div class="sourceCode" id="cb53"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb53-1" title="1"><span class="kw">const</span> morgan <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;morgan&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb53-2" title="2"><span class="va">app</span>.<span class="at">use</span>(<span class="at">morgan</span>(<span class="st">&#39;dev&#39;</span>))<span class="op">;</span></a></code></pre></div></li>
</ul>
<ol start="7" type="1">
<li>Add support for the Bootstrap front-end component library to a Pug layout template</li>
</ol>
<ul>
<li>Adding in the Bootstrap stylesheet and script to our template allows us to use classes that Bootstrap has defined for us with default styles. These are lines that you would copy over from Bootstrap template, not things that you would memorize https://getbootstrap.com/docs/4.4/getting-started/introduction/#starter-template</li>
<li>The important takeaway is knowing that these lines are what are allowing us to use the classes Bootstrap has defined for us.</li>
</ul>
<pre class="pug"><code>  doctype html
  html
    head
      meta(charset=&#39;utf-8&#39;)
      meta(name=&#39;viewport&#39; content=&#39;width=device-width, initial-scale=1, shrink-to-fit=no&#39;)

      // The following line is importing the bootstrap css file
      link(rel=&#39;stylesheet&#39; href=&#39;https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css&#39; integrity=&#39;sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh&#39; crossorigin=&#39;anonymous&#39;)

      title Reading List - #{title}
    body
      nav(class=&#39;navbar navbar-expand-lg navbar-dark bg-primary&#39;)
        a(class=&#39;navbar-brand&#39; href=&#39;/&#39;) Reading List
      .container
        h2(class=&#39;py-4&#39;) #{title}
        block content

      // The following lines are importing the bootstrap js files
      script(src=&#39;https://code.jquery.com/jquery-3.4.1.slim.min.js&#39; integrity=&#39;sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n&#39; crossorigin=&#39;anonymous&#39;)
      script(src=&#39;https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js&#39; integrity=&#39;sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo&#39; crossorigin=&#39;anonymous&#39;)
      script(src=&#39;https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js&#39; integrity=&#39;sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6&#39; crossorigin=&#39;anonymous&#39;)</code></pre>
<ol start="8" type="1">
<li>Install and configure Sequelize within an Express application.</li>
</ol>
<ul>
<li><p>We need to install packages associated with sequelize and postgres:</p>
<pre><code>npm install sequelize@^5.0.0 pg@^8.0.0
npm install sequelize-cli@^5.0.0 --save-dev</code></pre></li>
<li><p>Creating a <code>.sequelizerc</code> file at the root of our app allows us to specify the paths to where our config file should be read from and where the directories for models, migrations, and seeds should be created:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb56-1" title="1"><span class="kw">const</span> path <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;path&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb56-2" title="2"></a>
<a class="sourceLine" id="cb56-3" title="3"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb56-4" title="4">  <span class="dt">config</span><span class="op">:</span> <span class="va">path</span>.<span class="at">resolve</span>(<span class="st">&#39;config&#39;</span><span class="op">,</span> <span class="st">&#39;database.js&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb56-5" title="5">  <span class="st">&#39;models-path&#39;</span><span class="op">:</span> <span class="va">path</span>.<span class="at">resolve</span>(<span class="st">&#39;db&#39;</span><span class="op">,</span> <span class="st">&#39;models&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb56-6" title="6">  <span class="st">&#39;seeders-path&#39;</span><span class="op">:</span> <span class="va">path</span>.<span class="at">resolve</span>(<span class="st">&#39;db&#39;</span><span class="op">,</span> <span class="st">&#39;seeders&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb56-7" title="7">  <span class="st">&#39;migrations-path&#39;</span><span class="op">:</span> <span class="va">path</span>.<span class="at">resolve</span>(<span class="st">&#39;db&#39;</span><span class="op">,</span> <span class="st">&#39;migrations&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb56-8" title="8"><span class="op">};</span></a></code></pre></div></li>
<li>Run our sequelize initialization. This reads from <code>.sequelizerc</code> to see if we are overwriting any of the default config values, then generates the directories and config file.
<ul>
<li><code>npx sequelize init</code></li>
</ul></li>
<li><p>Create our database and user in <code>psql</code></p>
<pre><code>CREATE USER reading_list_app WITH PASSWORD &#39;strongpassword&#39; CREATEDB;
CREATE DATABASE reading_list WITH OWNER reading_list_app;</code></pre></li>
<li><p>Add environment variables to <code>.env</code></p>
<pre><code>DB_USERNAME=reading_list_app
DB_PASSWORD=strongpassword
DB_DATABASE=reading_list
DB_HOST=localhost</code></pre></li>
<li><p>If we are using a config module, add these new variables in:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb59-1" title="1"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb59-2" title="2">  <span class="dt">environment</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">NODE_ENV</span> <span class="op">||</span> <span class="st">&#39;development&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb59-3" title="3">  <span class="dt">port</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">PORT</span> <span class="op">||</span> <span class="dv">8080</span><span class="op">,</span></a>
<a class="sourceLine" id="cb59-4" title="4">  <span class="dt">db</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb59-5" title="5">    <span class="dt">username</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_USERNAME</span><span class="op">,</span></a>
<a class="sourceLine" id="cb59-6" title="6">    <span class="dt">password</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_PASSWORD</span><span class="op">,</span></a>
<a class="sourceLine" id="cb59-7" title="7">    <span class="dt">database</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_DATABASE</span><span class="op">,</span></a>
<a class="sourceLine" id="cb59-8" title="8">    <span class="dt">host</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_HOST</span><span class="op">,</span></a>
<a class="sourceLine" id="cb59-9" title="9">  <span class="op">},</span></a>
<a class="sourceLine" id="cb59-10" title="10"><span class="op">};</span></a></code></pre></div></li>
<li><p>In the config file generated by sequelize (we specified <code>./config/database.js</code> in our example), set up the configuration to point to these values for any environment that we need:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb60-1" title="1"><span class="kw">const</span> <span class="op">{</span> username<span class="op">,</span> password<span class="op">,</span> database<span class="op">,</span> host <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./index&#39;</span>).<span class="at">db</span><span class="op">;</span></a>
<a class="sourceLine" id="cb60-2" title="2"></a>
<a class="sourceLine" id="cb60-3" title="3"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb60-4" title="4">  <span class="dt">development</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb60-5" title="5">    username<span class="op">,</span></a>
<a class="sourceLine" id="cb60-6" title="6">    password<span class="op">,</span></a>
<a class="sourceLine" id="cb60-7" title="7">    database<span class="op">,</span></a>
<a class="sourceLine" id="cb60-8" title="8">    host<span class="op">,</span></a>
<a class="sourceLine" id="cb60-9" title="9">    <span class="dt">dialect</span><span class="op">:</span> <span class="st">&#39;postgres&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb60-10" title="10">    <span class="dt">seederStorage</span><span class="op">:</span> <span class="st">&#39;sequelize&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb60-11" title="11">  <span class="op">},</span></a>
<a class="sourceLine" id="cb60-12" title="12"><span class="op">};</span></a></code></pre></div></li>
<li><p>If we didn’t have a config module, we could use the environment variables directly:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb61-1" title="1"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb61-2" title="2">  <span class="dt">development</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb61-3" title="3">    <span class="dt">username</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_USERNAME</span><span class="op">,</span></a>
<a class="sourceLine" id="cb61-4" title="4">    <span class="dt">password</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_PASSWORD</span><span class="op">,</span></a>
<a class="sourceLine" id="cb61-5" title="5">    <span class="dt">database</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_DATABASE</span><span class="op">,</span></a>
<a class="sourceLine" id="cb61-6" title="6">    <span class="dt">host</span><span class="op">:</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">DB_HOST</span><span class="op">,</span></a>
<a class="sourceLine" id="cb61-7" title="7">    <span class="dt">dialect</span><span class="op">:</span> <span class="st">&#39;postgres&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb61-8" title="8">    <span class="dt">seederStorage</span><span class="op">:</span> <span class="st">&#39;sequelize&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb61-9" title="9">  <span class="op">},</span></a>
<a class="sourceLine" id="cb61-10" title="10"><span class="op">};</span></a></code></pre></div></li>
</ul>
<ol start="9" type="1">
<li>Use Sequelize to test the connection to a database before starting the HTTP server on application startup</li>
</ol>
<ul>
<li><p>To test our connection, we get a reference to our database through the models directory that was created for us. We can call <code>.authenticate</code> on the instance of <code>sequelize</code> that is exported from this module.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb62-1" title="1"><span class="co">#!/usr/bin/env node</span></a>
<a class="sourceLine" id="cb62-2" title="2"><span class="co">// This file is being run to kick off our server. The app is being imported separately. If these concerns were in the same file, the process of importing the db and invoking authenticate would remain the same.</span></a>
<a class="sourceLine" id="cb62-3" title="3"></a>
<a class="sourceLine" id="cb62-4" title="4"><span class="kw">const</span> <span class="op">{</span> port <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;../config&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb62-5" title="5"></a>
<a class="sourceLine" id="cb62-6" title="6"><span class="kw">const</span> app <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;../app&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb62-7" title="7"><span class="kw">const</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;../db/models&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb62-8" title="8"></a>
<a class="sourceLine" id="cb62-9" title="9"><span class="co">// Check the database connection before starting the app.</span></a>
<a class="sourceLine" id="cb62-10" title="10"><span class="va">db</span>.<span class="at">sequelize</span></a>
<a class="sourceLine" id="cb62-11" title="11">  .<span class="at">authenticate</span>()</a>
<a class="sourceLine" id="cb62-12" title="12">  .<span class="at">then</span>(() <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb62-13" title="13">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;Database connection success! Sequelize is ready to use...&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb62-14" title="14"></a>
<a class="sourceLine" id="cb62-15" title="15">    <span class="co">// Start listening for connections.</span></a>
<a class="sourceLine" id="cb62-16" title="16">    <span class="va">app</span>.<span class="at">listen</span>(port<span class="op">,</span> () <span class="kw">=&gt;</span> <span class="va">console</span>.<span class="at">log</span>(<span class="vs">`Listening on port </span><span class="sc">${</span>port<span class="sc">}</span><span class="vs">...`</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb62-17" title="17">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb62-18" title="18">  .<span class="at">catch</span>((err) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb62-19" title="19">    <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;Database connection failure.&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb62-20" title="20">    <span class="va">console</span>.<span class="at">error</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb62-21" title="21">  <span class="op">}</span>)<span class="op">;</span></a></code></pre></div></li>
</ul>
<ol start="10" type="1">
<li>Define a collection of routes (and views) that perform CRUD operations against a single resource using Sequelize</li>
</ol>
<ul>
<li>Before creating routes and views, we should generate models, migrations, and seeds in order to have data to work with. This is the same process as working with sequelize previously.
<ol type="1">
<li>Generate our model and migration</li>
</ol>
<ul>
<li><code>npx sequelize model:generate --name Book --attributes "title:string, author:string, releaseDate:dateonly, pageCount:integer, publisher:string"</code></li>
</ul>
<ol start="2" type="1">
<li>Update the model and migration files to include constraints such as character liimts, <code>allowNull</code>, and <code>unique: true</code>, how to drop the table in the migration, etc.</li>
<li>Apply the migrations to our database. Remember to include <code>dotenv</code> to include the environment variables. This is needed because <code>db:migrate</code> has to connect to our database, and the credential information is stored in our environment variables.</li>
</ol>
<ul>
<li><code>npx dotenv sequelize db:migrate</code></li>
</ul>
<ol start="4" type="1">
<li>Generate a seed file</li>
</ol>
<ul>
<li><code>npx sequelize seed:generate --name test-data</code></li>
</ul>
<ol start="5" type="1">
<li>Update the seed file to include records that we want to add to the database, as well as what to delete if we want to undo the seed.</li>
<li>Apply the seed file. We need to prepend <code>dotenv</code> for the same reasons as our migrations.</li>
</ol>
<ul>
<li><code>npx dotenv sequelize db:seed:all</code></li>
</ul></li>
<li>Now that we have our database created and seeded, we can proceed with making our routes.</li>
<li><p>In the file that we are creating our routes, require the models directory.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb63-1" title="1"><span class="kw">const</span> db <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;./db/models&#39;</span>)<span class="op">;</span></a></code></pre></div></li>
<li><p>If we have any routes that need to post data (creating, updating, destroying records), we need to provide csrf protection. Add the <code>csurf</code> and <code>cookie-parser</code> packages to our project. Within our app, indicate that we are using cookieParser and parsing our requests:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb64-1" title="1"><span class="kw">const</span> cookieParser <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;cookie-parser&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb64-2" title="2"></a>
<a class="sourceLine" id="cb64-3" title="3"><span class="va">app</span>.<span class="at">use</span>(<span class="at">cookieParser</span>())<span class="op">;</span></a>
<a class="sourceLine" id="cb64-4" title="4"><span class="va">app</span>.<span class="at">use</span>(<span class="va">express</span>.<span class="at">urlencoded</span>(<span class="op">{</span> <span class="dt">extended</span><span class="op">:</span> <span class="kw">false</span> <span class="op">}</span>))<span class="op">;</span></a>
<a class="sourceLine" id="cb64-5" title="5"><span class="co">// We can also use the bodyParser library instead of express&#39;s urlencoded function</span></a>
<a class="sourceLine" id="cb64-6" title="6"><span class="co">// app.use(bodyParser.urlencoded({ extended: false }))</span></a></code></pre></div></li>
<li><p>Our routes need to have access to the csrfProtection middleware that comes from the <code>csurf</code> package we added.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb65-1" title="1"><span class="kw">const</span> csrf <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;csurf&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb65-2" title="2"></a>
<a class="sourceLine" id="cb65-3" title="3"><span class="kw">const</span> csrfProtection <span class="op">=</span> <span class="at">csrf</span>(<span class="op">{</span> <span class="dt">cookie</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)<span class="op">;</span></a></code></pre></div></li>
<li><p>In our routes, set up asynchronous route handlers and await the query to our database. We can then pass the results to our views.</p>
<ul>
<li><p>Getting an index of records</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb66-1" title="1"><span class="va">router</span>.<span class="at">get</span>(</a>
<a class="sourceLine" id="cb66-2" title="2">  <span class="st">&#39;/&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb66-3" title="3">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb66-4" title="4">    <span class="kw">const</span> books <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">findAll</span>(<span class="op">{</span> <span class="dt">order</span><span class="op">:</span> [[<span class="st">&#39;title&#39;</span><span class="op">,</span> <span class="st">&#39;ASC&#39;</span>]] <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb66-5" title="5">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-list&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Books&#39;</span><span class="op">,</span> books <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb66-6" title="6">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb66-7" title="7">)<span class="op">;</span></a></code></pre></div></li>
<li><p>Getting a single records</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb67-1" title="1"><span class="va">router</span>.<span class="at">get</span>(</a>
<a class="sourceLine" id="cb67-2" title="2">  <span class="st">&#39;/book/:id(</span><span class="sc">\\</span><span class="st">d+)&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb67-3" title="3">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb67-4" title="4">    <span class="kw">const</span> bookId <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span> <span class="co">// converting the string into an integer</span></a>
<a class="sourceLine" id="cb67-5" title="5">    <span class="kw">const</span> book <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">findByPk</span>(bookId)<span class="op">;</span> <span class="co">// get a reference to our Book instance</span></a>
<a class="sourceLine" id="cb67-6" title="6">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-display&#39;</span><span class="op">,</span> <span class="op">{</span> <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Book Display&#39;</span><span class="op">,</span> book <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb67-7" title="7">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb67-8" title="8">)<span class="op">;</span></a></code></pre></div></li>
<li><p>Posting to create a record</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb68-1" title="1"><span class="va">router</span>.<span class="at">post</span>(</a>
<a class="sourceLine" id="cb68-2" title="2">  <span class="st">&#39;/book/add&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb68-3" title="3">  csrfProtection<span class="op">,</span></a>
<a class="sourceLine" id="cb68-4" title="4">  bookValidators<span class="op">,</span></a>
<a class="sourceLine" id="cb68-5" title="5">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb68-6" title="6">    <span class="co">// destructure the fields of the book from the request body</span></a>
<a class="sourceLine" id="cb68-7" title="7">    <span class="kw">const</span> <span class="op">{</span> title<span class="op">,</span> author<span class="op">,</span> releaseDate<span class="op">,</span> pageCount<span class="op">,</span> publisher <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb68-8" title="8"></a>
<a class="sourceLine" id="cb68-9" title="9">    <span class="co">// build the instance of the book. We&#39;re doing this before validation redirection because our</span></a>
<a class="sourceLine" id="cb68-10" title="10">    <span class="kw">const</span> book <span class="op">=</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb68-11" title="11">      title<span class="op">,</span></a>
<a class="sourceLine" id="cb68-12" title="12">      author<span class="op">,</span></a>
<a class="sourceLine" id="cb68-13" title="13">      releaseDate<span class="op">,</span></a>
<a class="sourceLine" id="cb68-14" title="14">      pageCount<span class="op">,</span></a>
<a class="sourceLine" id="cb68-15" title="15">      publisher<span class="op">,</span></a>
<a class="sourceLine" id="cb68-16" title="16">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb68-17" title="17"></a>
<a class="sourceLine" id="cb68-18" title="18">    <span class="kw">const</span> validatorErrors <span class="op">=</span> <span class="at">validationResult</span>(req)<span class="op">;</span></a>
<a class="sourceLine" id="cb68-19" title="19"></a>
<a class="sourceLine" id="cb68-20" title="20">    <span class="cf">if</span> (<span class="va">validatorErrors</span>.<span class="at">isEmpty</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb68-21" title="21">      <span class="cf">await</span> <span class="va">book</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb68-22" title="22">      <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb68-23" title="23">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb68-24" title="24">      <span class="kw">const</span> errors <span class="op">=</span> <span class="va">validatorErrors</span>.<span class="at">array</span>().<span class="at">map</span>((error) <span class="kw">=&gt;</span> <span class="va">error</span>.<span class="at">msg</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb68-25" title="25">      <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-add&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb68-26" title="26">        <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Add Book&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb68-27" title="27">        book<span class="op">,</span></a>
<a class="sourceLine" id="cb68-28" title="28">        errors<span class="op">,</span></a>
<a class="sourceLine" id="cb68-29" title="29">        <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb68-30" title="30">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb68-31" title="31">    <span class="op">}</span></a>
<a class="sourceLine" id="cb68-32" title="32">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb68-33" title="33">)<span class="op">;</span></a></code></pre></div></li>
<li><p>Editing a record</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb69-1" title="1"><span class="va">router</span>.<span class="at">post</span>(</a>
<a class="sourceLine" id="cb69-2" title="2">  <span class="st">&#39;/book/edit/:id(</span><span class="sc">\\</span><span class="st">d+)&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb69-3" title="3">  csrfProtection<span class="op">,</span></a>
<a class="sourceLine" id="cb69-4" title="4">  bookValidators<span class="op">,</span></a>
<a class="sourceLine" id="cb69-5" title="5">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb69-6" title="6">    <span class="kw">const</span> bookId <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span> <span class="co">// converting the string into an integer</span></a>
<a class="sourceLine" id="cb69-7" title="7">    <span class="kw">const</span> bookToUpdate <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">findByPk</span>(bookId)<span class="op">;</span> <span class="co">// get a reference to our Book instance</span></a>
<a class="sourceLine" id="cb69-8" title="8"></a>
<a class="sourceLine" id="cb69-9" title="9">    <span class="kw">const</span> <span class="op">{</span> title<span class="op">,</span> author<span class="op">,</span> releaseDate<span class="op">,</span> pageCount<span class="op">,</span> publisher <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb69-10" title="10"></a>
<a class="sourceLine" id="cb69-11" title="11">    <span class="co">// we extracted and then repackaged the relevent terms from the request&#39;s body</span></a>
<a class="sourceLine" id="cb69-12" title="12">    <span class="kw">const</span> book <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb69-13" title="13">      title<span class="op">,</span></a>
<a class="sourceLine" id="cb69-14" title="14">      author<span class="op">,</span></a>
<a class="sourceLine" id="cb69-15" title="15">      releaseDate<span class="op">,</span></a>
<a class="sourceLine" id="cb69-16" title="16">      pageCount<span class="op">,</span></a>
<a class="sourceLine" id="cb69-17" title="17">      publisher<span class="op">,</span></a>
<a class="sourceLine" id="cb69-18" title="18">    <span class="op">};</span></a>
<a class="sourceLine" id="cb69-19" title="19"></a>
<a class="sourceLine" id="cb69-20" title="20">    <span class="co">// The validation results can be accessed by invoking the function with our request</span></a>
<a class="sourceLine" id="cb69-21" title="21">    <span class="kw">const</span> validatorErrors <span class="op">=</span> <span class="at">validationResult</span>(req)<span class="op">;</span></a>
<a class="sourceLine" id="cb69-22" title="22"></a>
<a class="sourceLine" id="cb69-23" title="23">    <span class="co">// If the fields all passed validation, validatorErrors will be an empty array</span></a>
<a class="sourceLine" id="cb69-24" title="24">    <span class="co">// This means that we can update the book and send the user back to the main page</span></a>
<a class="sourceLine" id="cb69-25" title="25">    <span class="cf">if</span> (<span class="va">validatorErrors</span>.<span class="at">isEmpty</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb69-26" title="26">      <span class="cf">await</span> <span class="va">bookToUpdate</span>.<span class="at">update</span>(book)<span class="op">;</span></a>
<a class="sourceLine" id="cb69-27" title="27">      <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb69-28" title="28">      <span class="co">// If some fields did not pass the validator, we want to keep them on the form page</span></a>
<a class="sourceLine" id="cb69-29" title="29">      <span class="co">// and display the message associated with each error</span></a>
<a class="sourceLine" id="cb69-30" title="30">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb69-31" title="31">      <span class="co">// Convert the error objects into just their message strings</span></a>
<a class="sourceLine" id="cb69-32" title="32">      <span class="kw">const</span> errors <span class="op">=</span> <span class="va">validatorErrors</span>.<span class="at">array</span>().<span class="at">map</span>((error) <span class="kw">=&gt;</span> <span class="va">error</span>.<span class="at">msg</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb69-33" title="33">      <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-edit&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb69-34" title="34">        <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Edit Book&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb69-35" title="35">        <span class="dt">book</span><span class="op">:</span> <span class="op">{</span> ...<span class="at">book</span><span class="op">,</span> bookId <span class="op">},</span></a>
<a class="sourceLine" id="cb69-36" title="36">        errors<span class="op">,</span></a>
<a class="sourceLine" id="cb69-37" title="37">        <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb69-38" title="38">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb69-39" title="39">    <span class="op">}</span></a>
<a class="sourceLine" id="cb69-40" title="40">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb69-41" title="41">)<span class="op">;</span></a></code></pre></div></li>
<li><p>Deleting a record</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb70-1" title="1"><span class="va">router</span>.<span class="at">post</span>(</a>
<a class="sourceLine" id="cb70-2" title="2">  <span class="st">&#39;/book/delete/:id(</span><span class="sc">\\</span><span class="st">d+)&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb70-3" title="3">  csrfProtection<span class="op">,</span></a>
<a class="sourceLine" id="cb70-4" title="4">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb70-5" title="5">    <span class="co">// 1. Convert the id in the route from a string to an integer</span></a>
<a class="sourceLine" id="cb70-6" title="6">    <span class="co">// 2. Get a reference to the book that matches this id</span></a>
<a class="sourceLine" id="cb70-7" title="7">    <span class="co">// 3. Destroy the book record</span></a>
<a class="sourceLine" id="cb70-8" title="8">    <span class="kw">const</span> bookId <span class="op">=</span> <span class="at">parseInt</span>(<span class="va">req</span>.<span class="va">params</span>.<span class="at">id</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb70-9" title="9">    <span class="kw">const</span> book <span class="op">=</span> <span class="cf">await</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">findByPk</span>(bookId)<span class="op">;</span></a>
<a class="sourceLine" id="cb70-10" title="10">    <span class="cf">await</span> <span class="va">book</span>.<span class="at">destroy</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb70-11" title="11"></a>
<a class="sourceLine" id="cb70-12" title="12">    <span class="co">// Instead of finding and then deleting an instance, we could combine these into one method on the class</span></a>
<a class="sourceLine" id="cb70-13" title="13">    <span class="co">// db.Book.destroy({ where: { id: bookId } })</span></a>
<a class="sourceLine" id="cb70-14" title="14"></a>
<a class="sourceLine" id="cb70-15" title="15">    <span class="co">// Redirect to the main page</span></a>
<a class="sourceLine" id="cb70-16" title="16">    <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb70-17" title="17">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb70-18" title="18">)<span class="op">;</span></a></code></pre></div></li>
</ul></li>
</ul>
<ol start="11" type="1">
<li>Handle Sequelize validation errors when users are attempting to create or update data and display error messages to the user so that they can resolve any data quality issues</li>
</ol>
<ul>
<li>We’ve seen two ways to implement data validation on the server. First is through sequelize model validations, and the second is from the <code>express-validator</code> package.</li>
<li><p>For sequelize validations, we add a <code>validate</code> key on the model for each field we would like to validate:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb71-1" title="1"><span class="va">module</span>.<span class="at">exports</span> <span class="op">=</span> (sequelize<span class="op">,</span> DataTypes) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-2" title="2">  <span class="kw">const</span> Book <span class="op">=</span> <span class="va">sequelize</span>.<span class="at">define</span>(</a>
<a class="sourceLine" id="cb71-3" title="3">    <span class="st">&#39;Book&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-4" title="4">    <span class="op">{</span></a>
<a class="sourceLine" id="cb71-5" title="5">      <span class="dt">title</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-6" title="6">        <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-7" title="7">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-8" title="8">        <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-9" title="9">          <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-10" title="10">            <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Please provide a value for Title&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-11" title="11">          <span class="op">},</span></a>
<a class="sourceLine" id="cb71-12" title="12">          <span class="dt">notEmpty</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-13" title="13">            <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Please provide a value for Title&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-14" title="14">          <span class="op">},</span></a>
<a class="sourceLine" id="cb71-15" title="15">          <span class="dt">len</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-16" title="16">            <span class="dt">args</span><span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">255</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb71-17" title="17">            <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Title must not be more than 255 characters long&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-18" title="18">          <span class="op">},</span></a>
<a class="sourceLine" id="cb71-19" title="19">        <span class="op">},</span></a>
<a class="sourceLine" id="cb71-20" title="20">      <span class="op">},</span></a>
<a class="sourceLine" id="cb71-21" title="21">      <span class="dt">author</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-22" title="22">        <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span>(<span class="dv">100</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb71-23" title="23">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-24" title="24">        <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-25" title="25">          <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-26" title="26">            <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Please provide a value for Author&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-27" title="27">          <span class="op">},</span></a>
<a class="sourceLine" id="cb71-28" title="28">          <span class="dt">notEmpty</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-29" title="29">            <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Please provide a value for Author&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-30" title="30">          <span class="op">},</span></a>
<a class="sourceLine" id="cb71-31" title="31">          <span class="dt">len</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-32" title="32">            <span class="dt">args</span><span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">100</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb71-33" title="33">            <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Author must not be more than 100 characters long&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-34" title="34">          <span class="op">},</span></a>
<a class="sourceLine" id="cb71-35" title="35">        <span class="op">},</span></a>
<a class="sourceLine" id="cb71-36" title="36">      <span class="op">},</span></a>
<a class="sourceLine" id="cb71-37" title="37">      <span class="dt">releaseDate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-38" title="38">        <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">DATEONLY</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-39" title="39">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-40" title="40">        <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-41" title="41">          <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-42" title="42">            <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Please provide a value for Release Date&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-43" title="43">          <span class="op">},</span></a>
<a class="sourceLine" id="cb71-44" title="44">          <span class="dt">isDate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-45" title="45">            <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Please provide a valid date for Release Date&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-46" title="46">          <span class="op">},</span></a>
<a class="sourceLine" id="cb71-47" title="47">        <span class="op">},</span></a>
<a class="sourceLine" id="cb71-48" title="48">      <span class="op">},</span></a>
<a class="sourceLine" id="cb71-49" title="49">      <span class="dt">pageCount</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-50" title="50">        <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">INTEGER</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-51" title="51">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-52" title="52">        <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-53" title="53">          <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-54" title="54">            <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Please provide a value for Page Count&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-55" title="55">          <span class="op">},</span></a>
<a class="sourceLine" id="cb71-56" title="56">          <span class="dt">isInt</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-57" title="57">            <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Please provide a valid integer for Page Count&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-58" title="58">          <span class="op">},</span></a>
<a class="sourceLine" id="cb71-59" title="59">        <span class="op">},</span></a>
<a class="sourceLine" id="cb71-60" title="60">      <span class="op">},</span></a>
<a class="sourceLine" id="cb71-61" title="61">      <span class="dt">publisher</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-62" title="62">        <span class="dt">type</span><span class="op">:</span> <span class="va">DataTypes</span>.<span class="at">STRING</span>(<span class="dv">100</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb71-63" title="63">        <span class="dt">allowNull</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-64" title="64">        <span class="dt">validate</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-65" title="65">          <span class="dt">notNull</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-66" title="66">            <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Please provide a value for Publisher&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-67" title="67">          <span class="op">},</span></a>
<a class="sourceLine" id="cb71-68" title="68">          <span class="dt">notEmpty</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-69" title="69">            <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Please provide a value for Publisher&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-70" title="70">          <span class="op">},</span></a>
<a class="sourceLine" id="cb71-71" title="71">          <span class="dt">len</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb71-72" title="72">            <span class="dt">args</span><span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">100</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb71-73" title="73">            <span class="dt">msg</span><span class="op">:</span> <span class="st">&#39;Publisher must not be more than 100 characters long&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb71-74" title="74">          <span class="op">},</span></a>
<a class="sourceLine" id="cb71-75" title="75">        <span class="op">},</span></a>
<a class="sourceLine" id="cb71-76" title="76">      <span class="op">},</span></a>
<a class="sourceLine" id="cb71-77" title="77">    <span class="op">},</span></a>
<a class="sourceLine" id="cb71-78" title="78">    <span class="op">{}</span></a>
<a class="sourceLine" id="cb71-79" title="79">  )<span class="op">;</span></a>
<a class="sourceLine" id="cb71-80" title="80">  <span class="va">Book</span>.<span class="at">associate</span> <span class="op">=</span> <span class="kw">function</span> (models) <span class="op">{</span></a>
<a class="sourceLine" id="cb71-81" title="81">    <span class="co">// associations can be defined here</span></a>
<a class="sourceLine" id="cb71-82" title="82">  <span class="op">};</span></a>
<a class="sourceLine" id="cb71-83" title="83">  <span class="cf">return</span> Book<span class="op">;</span></a>
<a class="sourceLine" id="cb71-84" title="84"><span class="op">};</span></a></code></pre></div></li>
<li><p>With these validations in place, when we attempt to save a new instance (Book in this case), we will result in an error being thrown. This error will have a <code>name</code> property equal to <code>SequelizeValidationError</code>. We can implement a <code>try</code>/<code>catch</code> block to see if this error occurred, and if it did, render our form again with the error messages:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb72-1" title="1"><span class="va">router</span>.<span class="at">post</span>(</a>
<a class="sourceLine" id="cb72-2" title="2">  <span class="st">&#39;/book/add&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb72-3" title="3">  csrfProtection<span class="op">,</span></a>
<a class="sourceLine" id="cb72-4" title="4">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb72-5" title="5">    <span class="kw">const</span> <span class="op">{</span> title<span class="op">,</span> author<span class="op">,</span> releaseDate<span class="op">,</span> pageCount<span class="op">,</span> publisher <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb72-6" title="6"></a>
<a class="sourceLine" id="cb72-7" title="7">    <span class="kw">const</span> book <span class="op">=</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb72-8" title="8">      title<span class="op">,</span></a>
<a class="sourceLine" id="cb72-9" title="9">      author<span class="op">,</span></a>
<a class="sourceLine" id="cb72-10" title="10">      releaseDate<span class="op">,</span></a>
<a class="sourceLine" id="cb72-11" title="11">      pageCount<span class="op">,</span></a>
<a class="sourceLine" id="cb72-12" title="12">      publisher<span class="op">,</span></a>
<a class="sourceLine" id="cb72-13" title="13">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb72-14" title="14"></a>
<a class="sourceLine" id="cb72-15" title="15">    <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb72-16" title="16">      <span class="cf">await</span> <span class="va">book</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb72-17" title="17">      <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb72-18" title="18">    <span class="op">}</span> <span class="cf">catch</span> (err) <span class="op">{</span></a>
<a class="sourceLine" id="cb72-19" title="19">      <span class="cf">if</span> (<span class="va">err</span>.<span class="at">name</span> <span class="op">===</span> <span class="st">&#39;SequelizeValidationError&#39;</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb72-20" title="20">        <span class="kw">const</span> errors <span class="op">=</span> <span class="va">err</span>.<span class="va">errors</span>.<span class="at">map</span>((error) <span class="kw">=&gt;</span> <span class="va">error</span>.<span class="at">message</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb72-21" title="21">        <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-add&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb72-22" title="22">          <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Add Book&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb72-23" title="23">          book<span class="op">,</span></a>
<a class="sourceLine" id="cb72-24" title="24">          errors<span class="op">,</span></a>
<a class="sourceLine" id="cb72-25" title="25">          <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb72-26" title="26">        <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb72-27" title="27">      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb72-28" title="28">        <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb72-29" title="29">      <span class="op">}</span></a>
<a class="sourceLine" id="cb72-30" title="30">    <span class="op">}</span></a>
<a class="sourceLine" id="cb72-31" title="31">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb72-32" title="32">)<span class="op">;</span></a></code></pre></div></li>
<li>We can also implement validations using the <code>express-validator</code> package, which we can use as middleware in our routes.</li>
<li><p>We extract a reference to the <code>check</code> and <code>validationResult</code> functions from the <code>express-validator</code> library:</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb73-1" title="1"><span class="kw">const</span> <span class="op">{</span> check<span class="op">,</span> validationResult <span class="op">}</span> <span class="op">=</span> <span class="at">require</span>(<span class="st">&#39;express-validator&#39;</span>)<span class="op">;</span></a></code></pre></div></li>
<li><p>We can set up a group of validations using an array. Each individual validation invokes <code>check</code> with the field that we are validating, then chains on the specific validations and messages we want to associate with that field:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb74-1" title="1"><span class="kw">const</span> bookValidators <span class="op">=</span> [</a>
<a class="sourceLine" id="cb74-2" title="2">  <span class="at">check</span>(<span class="st">&#39;title&#39;</span>)</a>
<a class="sourceLine" id="cb74-3" title="3">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb74-4" title="4">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Title&#39;</span>)</a>
<a class="sourceLine" id="cb74-5" title="5">    .<span class="at">isLength</span>(<span class="op">{</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">255</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb74-6" title="6">    .<span class="at">withMessage</span>(<span class="st">&#39;Title must not be more than 255 characters long&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb74-7" title="7">  <span class="at">check</span>(<span class="st">&#39;author&#39;</span>)</a>
<a class="sourceLine" id="cb74-8" title="8">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb74-9" title="9">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Author&#39;</span>)</a>
<a class="sourceLine" id="cb74-10" title="10">    .<span class="at">isLength</span>(<span class="op">{</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">100</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb74-11" title="11">    .<span class="at">withMessage</span>(<span class="st">&#39;Author must not be more than 100 characters long&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb74-12" title="12">  <span class="at">check</span>(<span class="st">&#39;releaseDate&#39;</span>)</a>
<a class="sourceLine" id="cb74-13" title="13">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb74-14" title="14">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Release Date&#39;</span>)</a>
<a class="sourceLine" id="cb74-15" title="15">    .<span class="at">isISO8601</span>()</a>
<a class="sourceLine" id="cb74-16" title="16">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a valid date for Release Date&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb74-17" title="17">  <span class="at">check</span>(<span class="st">&#39;pageCount&#39;</span>)</a>
<a class="sourceLine" id="cb74-18" title="18">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb74-19" title="19">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Page Count&#39;</span>)</a>
<a class="sourceLine" id="cb74-20" title="20">    .<span class="at">isInt</span>(<span class="op">{</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb74-21" title="21">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a valid integer for Page Count&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb74-22" title="22">  <span class="at">check</span>(<span class="st">&#39;publisher&#39;</span>)</a>
<a class="sourceLine" id="cb74-23" title="23">    .<span class="at">exists</span>(<span class="op">{</span> <span class="dt">checkFalsy</span><span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb74-24" title="24">    .<span class="at">withMessage</span>(<span class="st">&#39;Please provide a value for Publisher&#39;</span>)</a>
<a class="sourceLine" id="cb74-25" title="25">    .<span class="at">isLength</span>(<span class="op">{</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">100</span> <span class="op">}</span>)</a>
<a class="sourceLine" id="cb74-26" title="26">    .<span class="at">withMessage</span>(<span class="st">&#39;Publisher must not be more than 100 characters long&#39;</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb74-27" title="27">]<span class="op">;</span></a></code></pre></div></li>
<li><p>With these validations set up, we can pass the array of middleware to any route that needs to validate the input. Inside the route we can invoke <code>validationResult</code> with the request object to get access to an array of any errors that occurred with the validations. From there, we can determine if we need to render the route as normal if the the array is empty, or if we need to display errors to the user because of the failed validations.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb75-1" title="1"><span class="co">// This is the same route as above, repeated for convenience</span></a>
<a class="sourceLine" id="cb75-2" title="2"><span class="co">// Notice the bookValidators array passed in as middleware</span></a>
<a class="sourceLine" id="cb75-3" title="3"><span class="va">router</span>.<span class="at">post</span>(</a>
<a class="sourceLine" id="cb75-4" title="4">  <span class="st">&#39;/book/add&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb75-5" title="5">  csrfProtection<span class="op">,</span></a>
<a class="sourceLine" id="cb75-6" title="6">  bookValidators<span class="op">,</span></a>
<a class="sourceLine" id="cb75-7" title="7">  <span class="at">asyncHandler</span>(<span class="kw">async</span> (req<span class="op">,</span> res) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb75-8" title="8">    <span class="kw">const</span> <span class="op">{</span> title<span class="op">,</span> author<span class="op">,</span> releaseDate<span class="op">,</span> pageCount<span class="op">,</span> publisher <span class="op">}</span> <span class="op">=</span> <span class="va">req</span>.<span class="at">body</span><span class="op">;</span></a>
<a class="sourceLine" id="cb75-9" title="9"></a>
<a class="sourceLine" id="cb75-10" title="10">    <span class="kw">const</span> book <span class="op">=</span> <span class="va">db</span>.<span class="va">Book</span>.<span class="at">build</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb75-11" title="11">      title<span class="op">,</span></a>
<a class="sourceLine" id="cb75-12" title="12">      author<span class="op">,</span></a>
<a class="sourceLine" id="cb75-13" title="13">      releaseDate<span class="op">,</span></a>
<a class="sourceLine" id="cb75-14" title="14">      pageCount<span class="op">,</span></a>
<a class="sourceLine" id="cb75-15" title="15">      publisher<span class="op">,</span></a>
<a class="sourceLine" id="cb75-16" title="16">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb75-17" title="17"></a>
<a class="sourceLine" id="cb75-18" title="18">    <span class="co">// The results of the validations are being captured by validatorErrors. If all of the validations passed, it will be an empty array.</span></a>
<a class="sourceLine" id="cb75-19" title="19">    <span class="kw">const</span> validatorErrors <span class="op">=</span> <span class="at">validationResult</span>(req)<span class="op">;</span></a>
<a class="sourceLine" id="cb75-20" title="20"></a>
<a class="sourceLine" id="cb75-21" title="21">    <span class="cf">if</span> (<span class="va">validatorErrors</span>.<span class="at">isEmpty</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb75-22" title="22">      <span class="co">// No errors occurred, so save the new book</span></a>
<a class="sourceLine" id="cb75-23" title="23">      <span class="cf">await</span> <span class="va">book</span>.<span class="at">save</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb75-24" title="24">      <span class="va">res</span>.<span class="at">redirect</span>(<span class="st">&#39;/&#39;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb75-25" title="25">    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb75-26" title="26">      <span class="co">// Validations failed. Extract the `msg` from each error and pass the array to the form template so that it can iterate over them and display them to the user</span></a>
<a class="sourceLine" id="cb75-27" title="27">      <span class="kw">const</span> errors <span class="op">=</span> <span class="va">validatorErrors</span>.<span class="at">array</span>().<span class="at">map</span>((error) <span class="kw">=&gt;</span> <span class="va">error</span>.<span class="at">msg</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb75-28" title="28">      <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;book-add&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb75-29" title="29">        <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Add Book&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb75-30" title="30">        book<span class="op">,</span></a>
<a class="sourceLine" id="cb75-31" title="31">        errors<span class="op">,</span></a>
<a class="sourceLine" id="cb75-32" title="32">        <span class="dt">csrfToken</span><span class="op">:</span> <span class="va">req</span>.<span class="at">csrfToken</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb75-33" title="33">      <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb75-34" title="34">    <span class="op">}</span></a>
<a class="sourceLine" id="cb75-35" title="35">  <span class="op">}</span>)</a>
<a class="sourceLine" id="cb75-36" title="36">)<span class="op">;</span></a></code></pre></div></li>
</ul>
<ol start="12" type="1">
<li>Describe how an Express.js error handler function differs from middleware and route handler functions</li>
</ol>
<ul>
<li>Error handlers have a very similar syntax to middleware and route handlers that we create. In addition to the <code>req</code>, <code>res</code>, and <code>next</code> arguments that we captured, we also capture the error (typically <code>err</code>) as the first argument to the handler.</li>
<li>Error handlers are invoked whenever an error occurs in a synchronous route handler or if <code>next</code> is invoked <em>with and argument</em>.</li>
<li>When either of these occur, express will continue parsing the file to see if we have any handlers defined below the route to take care of the error. This is why it’s important to have our middleware up top so that it is used before routes are encountered, then our routes, then our error handlers at the bottom.</li>
<li>Just like middleware, we can chain multiple error handlers on to each other. In order to pass control off to the next error handler, we simply invoke <code>next(err)</code>, making sure to pass the error in as the argument.</li>
<li>If we don’t have any custom error handlers, express has a default one that will respond to the client with a status of <code>500</code> and, if in development, display the error’s stack trace. It’s important to note that if an asynchronous function is rejected and not caught, the error handlers will not be triggered, causing the server to hang and no response sent back to the client.</li>
</ul>
<ol start="13" type="1">
<li>Define a global Express.js error-handling function to catch and process unhandled errors</li>
</ol>
<ul>
<li>Our handler uses <code>app.use()</code> with a callback that takes in <code>err</code>, <code>req</code>, <code>res</code>, and <code>next</code>.</li>
<li>If the err object has a status key set on it, we set our res’s status to that value, otherwise we use a generic 500 to indicate an internal server error occurred.</li>
<li>We render a custom error template with the error information. In the example below, we set up different displays based on whether we are in a production environment or not. If we are, we simply state that an error occurred. The idea is that the end-user doesn’t need to know the inner workings of our server, just that we messed up. If we aren’t in production, we also pass the specific error message and stack trace to the template in order to render it to the page. This allows us to debug our code in development.</li>
</ul>
<div class="sourceCode" id="cb76"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb76-1" title="1"><span class="co">// (middleware and routes defined above)</span></a>
<a class="sourceLine" id="cb76-2" title="2"></a>
<a class="sourceLine" id="cb76-3" title="3"><span class="co">// Generic error handler.</span></a>
<a class="sourceLine" id="cb76-4" title="4"><span class="va">app</span>.<span class="at">use</span>((err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb76-5" title="5">  <span class="va">res</span>.<span class="at">status</span>(<span class="va">err</span>.<span class="at">status</span> <span class="op">||</span> <span class="dv">500</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb76-6" title="6">  <span class="kw">const</span> isProduction <span class="op">=</span> <span class="va">process</span>.<span class="va">env</span>.<span class="at">NODE_ENV</span> <span class="op">===</span> <span class="st">&#39;production&#39;</span><span class="op">;</span></a>
<a class="sourceLine" id="cb76-7" title="7">  <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;error&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb76-8" title="8">    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Server Error&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb76-9" title="9">    <span class="dt">message</span><span class="op">:</span> isProduction <span class="op">?</span> <span class="st">&#39;An error occurred!&#39;</span> : <span class="va">err</span>.<span class="at">message</span><span class="op">,</span></a>
<a class="sourceLine" id="cb76-10" title="10">    <span class="dt">stack</span><span class="op">:</span> isProduction <span class="op">?</span> <span class="kw">null</span> : <span class="va">err</span>.<span class="at">stack</span><span class="op">,</span></a>
<a class="sourceLine" id="cb76-11" title="11">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb76-12" title="12"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div>
<ol start="14" type="1">
<li>Define a middleware function to handle requests for unknown routes by returning a 404 NOT FOUND error</li>
</ol>
<ul>
<li>If a request comes in for a route that does not match anything that we have created, we can capture the request and throw a specific error for it.</li>
<li>After all of our routes are defined, we use <code>app.use</code> just like our middleware up above. This ensures that the request passes through this handler if it makes it this far without encountering an error.</li>
<li><p>In this function we create an error, set the <code>status</code> key of the error to 404 (for later use in the error handler), then invoke our error-handling chain by calling <code>next(err)</code> with the error we just made:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb77-1" title="1"><span class="co">// Catch unhandled requests and forward to error handler.</span></a>
<a class="sourceLine" id="cb77-2" title="2"><span class="va">app</span>.<span class="at">use</span>((req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb77-3" title="3">  <span class="kw">const</span> err <span class="op">=</span> <span class="kw">new</span> <span class="at">Error</span>(<span class="st">&quot;The requested page couldn&#39;t be found.&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb77-4" title="4">  <span class="va">err</span>.<span class="at">status</span> <span class="op">=</span> <span class="dv">404</span><span class="op">;</span></a>
<a class="sourceLine" id="cb77-5" title="5">  <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb77-6" title="6"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div></li>
<li><p>Before our generic error handler, we can define a specific 404 error handler in order to generate a custom page. If an error passes through this handler, we check to see if its status is 404. If the error was created because of the missing route, then this will be the case. When that occurs, we set our response’s status to 404 and render our custom template.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb78-1" title="1"><span class="co">// Error handler for 404 errors.</span></a>
<a class="sourceLine" id="cb78-2" title="2"><span class="va">app</span>.<span class="at">use</span>((err<span class="op">,</span> req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb78-3" title="3">  <span class="cf">if</span> (<span class="va">err</span>.<span class="at">status</span> <span class="op">===</span> <span class="dv">404</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb78-4" title="4">    <span class="va">res</span>.<span class="at">status</span>(<span class="dv">404</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb78-5" title="5">    <span class="va">res</span>.<span class="at">render</span>(<span class="st">&#39;page-not-found&#39;</span><span class="op">,</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb78-6" title="6">      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Page Not Found&#39;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb78-7" title="7">    <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb78-8" title="8">  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb78-9" title="9">    <span class="at">next</span>(err)<span class="op">;</span></a>
<a class="sourceLine" id="cb78-10" title="10">  <span class="op">}</span></a>
<a class="sourceLine" id="cb78-11" title="11"><span class="op">}</span>)<span class="op">;</span></a></code></pre></div></li>
<li><p>If the error didn’t have a status of 404 (if the error happened inside one of our other routes or middleware), then we simply invoked <code>next(err)</code> to pass it along to the next error handler in the chain.</p></li>
</ul>
